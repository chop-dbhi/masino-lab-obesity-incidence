{\rtf1\ansi\ansicpg1252\cocoartf1504\cocoasubrtf830
{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\margl1440\margr1440\vieww10800\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 library('RPostgreSQL')\
library(getPass)\
library(sqldf)\
library(data.table)\
library(e1071)\
pg = dbDriver("PostgreSQL")\
con = dbConnect(pg, user="campbelle2", password=getPass::getPass(), host="reslnpbddb01.research.chop.edu",\
                port=5432, dbname="pbd_cohort")\
case_pop = read.csv('~/case_population.csv')\
control_pop = read.csv('~/control_population3.csv')\
setDT(case_pop)\
setDT(control_pop)\
\
case_pop <- case_pop[,c(2,3,4,5,6)]\
control_pop <- control_pop[,c(2,3,4,5,6)]\
\
case_pop_m  = case_pop[!case_pop$gender== 8532,]\
case_pop_f = case_pop[!case_pop$gender== 8507,]\
control_pop_m= control_pop[!control_pop$gender== 8532,]\
control_pop_f= control_pop[!control_pop$gender== 8507,]\
\
##store control populations for future reference\
control_m_storage <- setDT(control_pop_m)\
control_f_storage <- setDT(control_pop_f)\
\
##Ensure that controls have clinical conditions\
control_pop_f <-control_pop_f[person_id %in% conditions2$person_id]\
control_pop_m <-control_pop_m[person_id %in% conditions2$person_id]\
\
#Iteratively create and match by gendered age groups\
##730-780 days olds\
\
#males\
case1_m <- subset(case_pop_m, index_age >=730 & index_age <780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case1_m)\
control1_m <- subset(control_pop_m, index_age >=720 & index_age<=790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control1_m)\
match_age1m <- rbind(case1_m, control1_m)\
m_age1m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age1m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age1m$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full1 <- cbind(match_age1m, r2)\
match_full1 = match_full1[!match_full1$r== 'NA',]\
\
#Check for duplicates\
match_full1[,.N,by=person_id]\
\
md_controls1 <- subset(match_full1, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases1 <- subset(match_full1, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases1[,.N,by=person_id]\
md_controls1[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls2 <-md_controls1[order(person_id)]\
md_controls2[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_1m <- subset(md_controls2, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_1m <- subset(md_controls2, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_1m2 <- multi_1m[,c(1,2,3,4)]\
multi_1m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full1$person_id)]\
\
##Rematch the used PIDs\
\
control1_m_d2 <- subset(control_pop_m, index_age >=720 & index_age<=790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control1_m_d2)\
match_age1m_d2 <- rbind(multi_1m2, control1_m_d2)\
m_age1m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age1m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age1m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full1_d2 <- cbind(match_age1m_d2, r2)\
match_full1_d2 = match_full1_d2[!match_full1_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_1m <- unique_1m[,c(1,2,3,4,5,6,7)]\
match_full1_d3 <-rbind(unique_1m, match_full1_d2)\
match_full1_d3 <- subset(match_full1_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full1_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full1_d3$person_id)]\
\
#females\
case1_f <- subset(case_pop_f, index_age >=730 & index_age <780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case1_f)\
control1_f <- subset(control_pop_f, index_age >=720 & index_age<790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control1_f)\
match_age1f <- rbind(case1_f, control1_f)\
setDT(match_age1f)\
\
m_age1f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age1f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age1f$factor\
r3 <- as.data.table(r)\
r3$ID2 <- seq.int(nrow(r))\
\
match_full2 <- cbind(match_age1f, r3)\
match_full2 = match_full2[!match_full2$r== 'NA',]\
\
md_controls1f <- subset(match_full2, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases1f <- subset(match_full2, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases1f[,.N,by=person_id]\
md_controls1f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
fd_controls2 <-md_controls1f[order(person_id)]\
fd_controls2[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_1f <- subset(fd_controls2, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_1f <- subset(fd_controls2, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_1f2 <- multi_1f[,c(1,2,3,4)]\
multi_1f2$casecont = 'case'\
\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full2$person_id)]\
\
##Rematch the used PIDs\
\
control1_f_d2 <- subset(control_pop_f, index_age >=720 & index_age<=790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control1_f_d2)\
match_age1f_d2 <- rbind(multi_1f2, control1_f_d2)\
m_age1f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age1f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age1f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full2_d2 <- cbind(match_age1f_d2, r2)\
match_full2_d2 = match_full2_d2[!match_full2_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_1f <- unique_1f[,c(1,2,3,4,5,6,7)]\
match_full2_d3 <-rbind(unique_1f, match_full2_d2)\
match_full2_d3 <- subset(match_full2_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full2_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full1_d3$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_full2_d3$person_id)]\
\
## 780-830 days old\
##Ensure that the person IDs in the control pool were not used\
#males\
\
case2_m <- subset(case_pop_m, index_age >=780 & index_age <830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case2_m)\
control2_m <- subset(control_pop_m, index_age >=770 & index_age<840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control2_m)\
match_age2m <- rbind(case2_m, control2_m)\
setDT(match_age2m)\
\
m_age2m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age2m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age2m$factor\
r4 <- as.data.table(r)\
r4$ID2 <- seq.int(nrow(r4))\
\
match_full3 <- cbind(match_age2m, r4)\
match_full3 = match_full3[!match_full3$r== 'NA',]\
\
md_controls2m <- subset(match_full3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases2m <- subset(match_full3, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases2m[,.N,by=person_id]\
md_controls2m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls3 <-md_controls2m[order(person_id)]\
md_controls3[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_2m <- subset(md_controls3, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_2m <- subset(md_controls3, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_2m2 <- multi_2m[,c(1,2,3,4)]\
multi_2m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full3$person_id)]\
\
##Rematch the used PIDs\
\
control2_m_d2 <- subset(control_pop_m, index_age >=770 & index_age<=840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control2_m_d2)\
match_age2m_d2 <- rbind(multi_2m2, control2_m_d2)\
m_age2m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age2m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age2m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full2_d2 <- cbind(match_age2m_d2, r2)\
match_full2_d2 = match_full2_d2[!match_full2_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_2m <- unique_2m[,c(1,2,3,4,5,6,7)]\
match_full3_d3 <-rbind(unique_2m, match_full2_d2)\
match_full3_d3 <- subset(match_full3_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full3_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full3_d3$person_id)]\
\
#Count the number of times each person ID was used\
md_controls3 <-match_full3_d3[order(person_id)]\
md_controls3[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_2m <- subset(md_controls3, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_2m <- subset(md_controls3, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_2m2 <- multi_2m[,c(1,2,3,4)]\
multi_2m2$casecont = 'case'\
\
##Rematch the used PIDs\
\
control2_m_d2 <- subset(control_pop_m, index_age >=770 & index_age<=840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control2_m_d2)\
match_age2m_d2 <- rbind(multi_2m2, control2_m_d2)\
m_age2m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age2m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age2m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full2_d2 <- cbind(match_age2m_d2, r2)\
match_full2_d2 = match_full2_d2[!match_full2_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_2m <- unique_2m[,c(1,2,3,4,5,6,7)]\
match_full3_d3 <-rbind(unique_2m, match_full2_d2)\
match_full3_d3 <- subset(match_full3_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full3_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full3_d3$person_id)]\
\
\
#females\
case2_f <- subset(case_pop_f, index_age >=780 & index_age <830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case2_f)\
control2_f <- subset(control_pop_f, index_age >=770 & index_age<840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control2_f)\
match_age2f <- rbind(case2_f, control2_f)\
setDT(match_age2f)\
\
m_age2f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age2f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age2f$factor\
r5 <- as.data.table(r)\
r5$ID2 <- seq.int(nrow(r5))\
\
match_full4 <- cbind(match_age2f, r5)\
match_full4 = match_full4[!match_full4$r== 'NA',]\
\
\
md_controls2f <- subset(match_full4, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases2f <- subset(match_full4, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases2f[,.N,by=person_id]\
md_controls2f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls4 <-md_controls2f[order(person_id)]\
md_controls4[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_2f <- subset(md_controls4, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_2f <- subset(md_controls4, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_2f2 <- multi_2f[,c(1,2,3,4)]\
multi_2f2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full4$person_id)]\
\
##Rematch the used PIDs\
\
control2_f_d2 <- subset(control_pop_f, index_age >=770 & index_age<=840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control2_f_d2)\
match_age2f_d2 <- rbind(multi_2f2, control2_f_d2)\
m_age2f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age2f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age2f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full4_d2 <- cbind(match_age2f_d2, r2)\
match_full4_d2 = match_full4_d2[!match_full4_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_2f <- unique_2f[,c(1,2,3,4,5,6,7)]\
match_full4_d3 <-rbind(unique_2f, match_full4_d2)\
match_full4_d3 <- subset(match_full4_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full4_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full4_d3$person_id)]\
\
## 830-880 days old\
#males\
\
case3_m <- subset(case_pop_m, index_age >=830 & index_age <880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case3_m)\
control3_m <- subset(control_pop_m, index_age >=820 & index_age<890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control3_m)\
match_age3m <- rbind(case3_m, control3_m)\
setDT(match_age3m)\
\
m_age3m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age3m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age3m$factor\
r6 <- as.data.table(r)\
r6$ID2 <- seq.int(nrow(r6))\
\
match_full5 <- cbind(match_age3m, r6)\
match_full5 = match_full5[!match_full5$r== 'NA',]\
\
md_controls3m <- subset(match_full5, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases3m <- subset(match_full5, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases3m[,.N,by=person_id]\
md_controls3m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls5 <-md_controls3m[order(person_id)]\
md_controls5[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_3m <- subset(md_controls5, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_3m <- subset(md_controls5, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_3m2 <- multi_3m[,c(1,2,3,4)]\
multi_3m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full5$person_id)]\
\
##Rematch the used PIDs\
\
control3_m_d2 <- subset(control_pop_m, index_age >=820 & index_age<=890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control3_m_d2)\
match_age3m_d2 <- rbind(multi_3m2, control3_m_d2)\
m_age3m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age3m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age3m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full5_d2 <- cbind(match_age3m_d2, r2)\
match_full5_d2 = match_full5_d2[!match_full5_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_3m <- unique_3m[,c(1,2,3,4,5,6,7)]\
match_full5_d3 <-rbind(unique_3m, match_full5_d2)\
match_full5_d3 <- subset(match_full5_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full5_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full5_d3$person_id)]\
\
#females\
case3_f <- subset(case_pop_f, index_age >=830 & index_age < 880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case3_f)\
control3_f <- subset(control_pop_f, index_age >=820 & index_age<890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control3_f)\
match_age3f <- rbind(case3_f, control3_f)\
setDT(match_age3f)\
\
m_age3f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age3f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age3f$factor\
f3 <- as.data.table(r)\
f3$ID2 <- seq.int(nrow(f3))\
\
match_full6 <- cbind(match_age3f, f3)\
match_full6 = match_full6[!match_full6$r== 'NA',]\
\
md_controls3f <- subset(match_full6, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases3f <- subset(match_full6, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases3f[,.N,by=person_id]\
md_controls3f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls6 <-md_controls3f[order(person_id)]\
md_controls6[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_3f <- subset(md_controls6, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_3f <- subset(md_controls6, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_3f2 <- multi_3f[,c(1,2,3,4)]\
multi_3f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full6$person_id)]\
\
##Rematch the used PIDs\
\
control3_f_d2 <- subset(control_pop_f, index_age >=820 & index_age<=890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control3_f_d2)\
match_age3f_d2 <- rbind(multi_3f2, control3_f_d2)\
m_age3f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age3f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age3f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full6_d2 <- cbind(match_age3f_d2, r2)\
match_full6_d2 = match_full6_d2[!match_full6_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_3f <- unique_3f[,c(1,2,3,4,5,6,7)]\
match_full6_d3 <-rbind(unique_3f, match_full6_d2)\
match_full6_d3 <- subset(match_full6_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full6_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full6_d3$person_id)]\
\
## 880-930 days old\
#males\
\
case4_m <- subset(case_pop_m, index_age >=880 & index_age <930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case4_m)\
control4_m <- subset(control_pop_m, index_age >=870 & index_age<940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control4_m)\
match_age4m <- rbind(case4_m, control4_m)\
setDT(match_age4m)\
\
m_age4m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age4m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age4m$factor\
m4 <- as.data.table(r)\
m4$ID2 <- seq.int(nrow(m4))\
\
match_full7 <- cbind(match_age4m, m4)\
match_full7 = match_full7[!match_full7$r== 'NA',]\
\
md_controls4m <- subset(match_full7, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases4m <- subset(match_full7, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases4m[,.N,by=person_id]\
md_controls4m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls7 <-md_controls4m[order(person_id)]\
md_controls7[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_4m <- subset(md_controls7, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_4m <- subset(md_controls7, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_4m2 <- multi_4m[,c(1,2,3,4)]\
multi_4m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full7$person_id)]\
\
##Rematch the used PIDs\
\
control4_m_d2 <- subset(control_pop_m, index_age >=870 & index_age<940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control4_m_d2)\
match_age4m_d2 <- rbind(multi_4m2, control4_m_d2)\
m_age4m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age4m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age4m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full7_d2 <- cbind(match_age4m_d2, r2)\
match_full7_d2 = match_full7_d2[!match_full7_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_4m <- unique_4m[,c(1,2,3,4,5,6,7)]\
match_full7_d3 <-rbind(unique_4m, match_full7_d2)\
match_full7_d3 <- subset(match_full7_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full7_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full7_d3$person_id)]\
\
#females\
case4_f <- subset(case_pop_f, index_age >=880 & index_age < 930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case4_f)\
control4_f <- subset(control_pop_f, index_age >=870 & index_age<940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control4_f)\
match_age4f <- rbind(case4_f, control4_f)\
setDT(match_age4f)\
\
m_age4f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age4f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age4f$factor\
f4 <- as.data.table(r)\
f4$ID2 <- seq.int(nrow(f4))\
\
match_full8 <- cbind(match_age4f, f4)\
match_full8 = match_full8[!match_full8$r== 'NA',]\
\
md_controls4f <- subset(match_full8, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases4f <- subset(match_full8, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases4f[,.N,by=person_id]\
md_controls4f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls8 <-md_controls4f[order(person_id)]\
md_controls8[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_4f <- subset(md_controls8, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_4f <- subset(md_controls8, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_4f2 <- multi_4f[,c(1,2,3,4)]\
multi_4f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full8$person_id)]\
\
##Rematch the used PIDs\
\
control4_f_d2 <- subset(control_pop_f, index_age >=870 & index_age<940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control4_f_d2)\
match_age4f_d2 <- rbind(multi_4f2, control4_f_d2)\
m_age4f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age4f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age4f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full8_d2 <- cbind(match_age4f_d2, r2)\
match_full8_d2 = match_full8_d2[!match_full8_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_4f <- unique_4f[,c(1,2,3,4,5,6,7)]\
match_full8_d3 <-rbind(unique_4f, match_full8_d2)\
match_full8_d3 <- subset(match_full8_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full8_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full8_d3$person_id)]\
\
## 930-980 days old\
#males\
\
case5_m <- subset(case_pop_m, index_age >=930 & index_age <980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case5_m)\
control5_m <- subset(control_pop_m, index_age >=920 & index_age<990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control5_m)\
match_age5m <- rbind(case5_m, control5_m)\
setDT(match_age5m)\
\
m_age5m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age5m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age5m$factor\
m5 <- as.data.table(r)\
m5$ID2 <- seq.int(nrow(m5))\
\
match_full9 <- cbind(match_age5m, m5)\
match_full9 = match_full9[!match_full9$r== 'NA',]\
\
md_controls5m <- subset(match_full9, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases5m <- subset(match_full9, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases5m[,.N,by=person_id]\
md_controls5m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls9 <-md_controls5m[order(person_id)]\
md_controls9[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_5m <- subset(md_controls9, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_5m <- subset(md_controls9, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_5m2 <- multi_5m[,c(1,2,3,4)]\
multi_5m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full9$person_id)]\
\
##Rematch the used PIDs\
\
control5_m_d2 <- subset(control_pop_m, index_age >=920 & index_age<990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control5_m_d2)\
match_age5m_d2 <- rbind(multi_5m2, control5_m_d2)\
m_age5m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age5m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age5m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full9_d2 <- cbind(match_age5m_d2, r2)\
match_full9_d2 = match_full9_d2[!match_full9_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_5m <- unique_5m[,c(1,2,3,4,5,6,7)]\
match_full9_d3 <-rbind(unique_5m, match_full9_d2)\
match_full9_d3 <- subset(match_full9_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full9_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full9_d3$person_id)]\
\
#Count the number of times each person ID was used\
md_controls9 <-match_full9_d3[order(person_id)]\
md_controls9[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_5m <- subset(md_controls9, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_5m <- subset(md_controls9, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_5m2 <- multi_5m[,c(1,2,3,4)]\
multi_5m2$casecont = 'case'\
\
##Rematch the used PIDs\
\
control5_m_d2 <- subset(control_pop_m, index_age >=920 & index_age<990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control5_m_d2)\
match_age5m_d2 <- rbind(multi_5m2, control5_m_d2)\
m_age5m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age5m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age5m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full9_d2 <- cbind(match_age5m_d2, r2)\
match_full9_d2 = match_full9_d2[!match_full9_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_5m <- unique_5m[,c(1,2,3,4,5,6,7)]\
match_full9_d3 <-rbind(unique_5m, match_full9_d2)\
match_full9_d3 <- subset(match_full9_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full9_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full9_d3$person_id)]\
\
#females\
case5_f <- subset(case_pop_f, index_age >=930 & index_age < 980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case5_f)\
control5_f <- subset(control_pop_f, index_age >=920 & index_age<990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control5_f)\
match_age5f <- rbind(case5_f, control5_f)\
setDT(match_age5f)\
\
m_age5f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age5f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age5f$factor\
f5 <- as.data.table(r)\
f5$ID2 <- seq.int(nrow(f5))\
\
match_full10 <- cbind(match_age5f, f5)\
match_full10 = match_full10[!match_full10$r== 'NA',]\
\
md_controls5f <- subset(match_full10, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases5f <- subset(match_full10, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases5f[,.N,by=person_id]\
md_controls5f[,.N,by=person_id]\
\
\
#Count the number of times each person ID was used\
md_controls10 <-md_controls5f[order(person_id)]\
md_controls10[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_5f <- subset(md_controls10, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_5f <- subset(md_controls10, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_5f2 <- multi_5f[,c(1,2,3,4)]\
multi_5f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full10$person_id)]\
\
##Rematch the used PIDs\
\
control5_f_d2 <- subset(control_pop_f, index_age >=920 & index_age<990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control5_f_d2)\
match_age5f_d2 <- rbind(multi_5f2, control5_f_d2)\
m_age5f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age5f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age5f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full10_d2 <- cbind(match_age5f_d2, r2)\
match_full10_d2 = match_full10_d2[!match_full10_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_5f <- unique_5f[,c(1,2,3,4,5,6,7)]\
match_full10_d3 <-rbind(unique_5f, match_full10_d2)\
match_full10_d3 <- subset(match_full10_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full10_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full10_d3$person_id)]\
\
control_f_storage[,.N,by=person_id]\
control_pop_f[,.N,by=person_id]\
control_m_storage[,.N,by=person_id]\
control_pop_m[,.N,by=person_id]\
\
##combine all matched data: round 1\
\
colnames(match_full1_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full2_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full3_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full4_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full5_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full6_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full7_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full8_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full9_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full10_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_1 <- rbind(match_full1_d3, match_full2_d3, match_full3_d3, match_full4_d3, match_full5_d3, match_full6_d3, match_full7_d3, match_full8_d3, match_full9_d3, match_full10_d3)\
setDT(match_total_1)\
\
match_total_1[,.N,by=person_id]\
\
write.csv(match_total_1, 'match_total_1.csv')\
\
match_total_1 = read.csv('~/match_total_1.csv')\
setDT(match_total_1)\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_1,  c("person_id","num_of_prior_visits"))\
\
matched_measures= measure_control_dates2[match_total_1]\
matched_measures2 <- matched_measures[,c(2,3,4,5,7,8,9)]\
setDT(matched_measures2)\
\
matched_measures3= f[match_total_1]\
matched_measures4 <- matched_measures3[,c(1,2,3,4,5,6)]\
setDT(matched_measures4)\
\
setkeyv(matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
control_conditions= conditions2[matched_measures4]\
\
control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
cont_pre_index <- match_total_1[,c(2,5)]\
cont_pre_index$pre <- cont_pre_index[, 2] -1\
cont_pre_index2 <- cont_pre_index[,c(1,3)]\
colnames(cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(cont_pre_index2)\
setkeyv(cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
matched_pre_measures= f[cont_pre_index2]\
\
matched_pre_measures2 <- matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(matched_pre_measures2)\
\
setkeyv(matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
control_conditions_pre= conditions2[matched_pre_measures2]\
\
control_conditions_pre[,.N,by=person_id]\
\
#Post index\
cont_post_index <- match_total_1[,c(2,5)]\
cont_post_index$post <- cont_pre_index[, 2] +1\
cont_post_index2 <- cont_post_index[,c(1,3)]\
colnames(cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(cont_post_index2)\
setkeyv(cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
matched_post_measures= f[cont_post_index2]\
\
matched_post_measures2 <- matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(matched_post_measures2)\
\
setkeyv(matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
control_conditions_post= conditions2[matched_post_measures2]\
\
control_conditions_post[,.N,by=person_id]\
##Eliminate patients who did not have a post-index visit\
control_conditions_post= control_conditions_post[!control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
control_conditions_post$Timing_Class = '3'\
control_conditions_pre$Timing_Class = '1'\
control_conditions$Timing_Class = '2'\
\
##Rbind all clinical observations for the first matched set\
\
full_con_1 <- rbind(control_conditions_pre, control_conditions, control_conditions_post)\
setDT(full_con_1)\
full_con_1[,.N,by=person_id]\
\
## 980-1030 days old\
#males\
\
case6_m <- subset(case_pop_m, index_age >=980 & index_age <1030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case6_m)\
control6_m <- subset(control_pop_m, index_age >=970 & index_age<1040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control6_m)\
match_age6m <- rbind(case6_m, control6_m)\
setDT(match_age6m)\
\
m_age6m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age6m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age6m$factor\
m6 <- as.data.table(r)\
m6$ID2 <- seq.int(nrow(m6))\
\
match_full11 <- cbind(match_age6m, m6)\
match_full11 = match_full11[!match_full11$r== 'NA',]\
\
md_controls6m <- subset(match_full11, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases6m <- subset(match_full11, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases6m[,.N,by=person_id]\
md_controls6m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls11 <-md_controls6m[order(person_id)]\
md_controls11[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_6m <- subset(md_controls11, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_6m <- subset(md_controls11, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_6m2 <- multi_6m[,c(1,2,3,4)]\
multi_6m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full11$person_id)]\
\
##Rematch the used PIDs\
\
control6_m_d2 <- subset(control_pop_m, index_age >=970 & index_age<1040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control6_m_d2)\
match_age6m_d2 <- rbind(multi_6m2, control6_m_d2)\
m_age6m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age6m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age6m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full11_d2 <- cbind(match_age6m_d2, r2)\
match_full11_d2 = match_full11_d2[!match_full11_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_6m <- unique_6m[,c(1,2,3,4,5,6,7)]\
match_full11_d3 <-rbind(unique_6m, match_full11_d2)\
match_full11_d3 <- subset(match_full11_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full11_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full11_d3$person_id)]\
\
#females\
case6_f <- subset(case_pop_f, index_age >=980 & index_age < 1030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case6_f)\
control6_f <- subset(control_pop_f, index_age >=970 & index_age<1040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control6_f)\
match_age6f <- rbind(case6_f, control6_f)\
setDT(match_age6f)\
\
m_age6f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age6f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age6f$factor\
f6 <- as.data.table(r)\
f6$ID2 <- seq.int(nrow(f6))\
\
match_full12 <- cbind(match_age6f, f6)\
match_full12 = match_full12[!match_full12$r== 'NA',]\
\
md_controls6f <- subset(match_full12, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases6f <- subset(match_full12, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases6f[,.N,by=person_id]\
md_controls6f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls12 <-md_controls6f[order(person_id)]\
md_controls12[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_6f <- subset(md_controls12, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_6f <- subset(md_controls12, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_6f2 <- multi_6f[,c(1,2,3,4)]\
multi_6f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full12$person_id)]\
\
##Rematch the used PIDs\
\
control6_f_d2 <- subset(control_pop_f, index_age >=970 & index_age<1040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control6_f_d2)\
match_age6f_d2 <- rbind(multi_6f2, control6_f_d2)\
m_age6f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age6f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age6f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full12_d2 <- cbind(match_age6f_d2, r2)\
match_full12_d2 = match_full12_d2[!match_full12_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_6f <- unique_6f[,c(1,2,3,4,5,6,7)]\
match_full12_d3 <-rbind(unique_6f, match_full12_d2)\
match_full12_d3 <- subset(match_full12_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full12_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full12_d3$person_id)]\
\
##Rematch the duplicate\
md_controls6f <- subset(match_full12_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
#Count the number of times each person ID was used\
md_controls12 <-md_controls6f[order(person_id)]\
md_controls12[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_6f <- subset(md_controls12, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_6f <- subset(md_controls12, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_6f2 <- multi_6f[,c(1,2,3,4)]\
multi_6f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full12$person_id)]\
\
##Rematch the used PIDs\
\
control6_f_d2 <- subset(control_pop_f, index_age >=970 & index_age<1040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control6_f_d2)\
match_age6f_d2 <- rbind(multi_6f2, control6_f_d2)\
m_age6f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age6f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age6f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full12_d2 <- cbind(match_age6f_d2, r2)\
match_full12_d2 = match_full12_d2[!match_full12_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_6f <- unique_6f[,c(1,2,3,4,5,6,7)]\
match_full12_d3 <-rbind(unique_6f, match_full12_d2)\
match_full12_d3 <- subset(match_full12_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full12_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full12_d3$person_id)]\
\
## 1030-1080 days old\
#males\
\
case7_m <- subset(case_pop_m, index_age >=1030 & index_age <1080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case7_m)\
control7_m <- subset(control_pop_m, index_age >=1020 & index_age<1090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control7_m)\
match_age7m <- rbind(case7_m, control7_m)\
setDT(match_age7m)\
\
m_age7m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age7m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age7m$factor\
m7 <- as.data.table(r)\
m7$ID2 <- seq.int(nrow(m7))\
\
match_full13 <- cbind(match_age7m, m7)\
match_full13 = match_full13[!match_full13$r== 'NA',]\
\
md_controls7m <- subset(match_full13, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases7m <- subset(match_full13, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases7m[,.N,by=person_id]\
md_controls7m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls13 <-md_controls7m[order(person_id)]\
md_controls13[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_7m <- subset(md_controls13, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_7m <- subset(md_controls13, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_7m2 <- multi_7m[,c(1,2,3,4)]\
multi_7m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full13$person_id)]\
\
##Rematch the used PIDs\
\
control7_m_d2 <- subset(control_pop_m, index_age >=1020 & index_age<1090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control7_m_d2)\
match_age7m_d2 <- rbind(multi_7m2, control7_m_d2)\
m_age7m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age7m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age7m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full13_d2 <- cbind(match_age7m_d2, r2)\
match_full13_d2 = match_full13_d2[!match_full13_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_7m <- unique_7m[,c(1,2,3,4,5,6,7)]\
match_full13_d3 <-rbind(unique_7m, match_full13_d2)\
match_full13_d3 <- subset(match_full13_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full13_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full13_d3$person_id)]\
\
#females\
case7_f <- subset(case_pop_f, index_age >=1030 & index_age < 1080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case7_f)\
control7_f <- subset(control_pop_f, index_age >=1020 & index_age<1090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control7_f)\
match_age7f <- rbind(case7_f, control7_f)\
setDT(match_age7f)\
\
m_age7f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age7f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age7f$factor\
f7 <- as.data.table(r)\
f7$ID2 <- seq.int(nrow(f7))\
\
match_full14 <- cbind(match_age7f, f7)\
match_full14 = match_full14[!match_full14$r== 'NA',]\
\
md_controls7f <- subset(match_full14, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases7f <- subset(match_full14, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases7f[,.N,by=person_id]\
md_controls7f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls14 <-md_controls7f[order(person_id)]\
md_controls14[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_7f <- subset(md_controls14, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_7f <- subset(md_controls14, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_7f2 <- multi_7f[,c(1,2,3,4)]\
multi_7f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full14$person_id)]\
\
##Rematch the used PIDs\
\
control7_f_d2 <- subset(control_pop_f,index_age >=1020 & index_age<1090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control7_f_d2)\
match_age7f_d2 <- rbind(multi_7f2, control7_f_d2)\
m_age7f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age7f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age7f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full14_d2 <- cbind(match_age7f_d2, r2)\
match_full14_d2 = match_full14_d2[!match_full14_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_7f <- unique_7f[,c(1,2,3,4,5,6,7)]\
match_full14_d3 <-rbind(unique_7f, match_full14_d2)\
match_full14_d3 <- subset(match_full14_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full14_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full14_d3$person_id)]\
\
## 1080-1130 days old\
#males\
\
case8_m <- subset(case_pop_m, index_age >=1080 & index_age <1130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case8_m)\
control8_m <- subset(control_pop_m, index_age >=1070 & index_age<1140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control8_m)\
match_age8m <- rbind(case8_m, control8_m)\
setDT(match_age8m)\
\
m_age8m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age8m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age8m$factor\
m8 <- as.data.table(r)\
m8$ID2 <- seq.int(nrow(m8))\
\
match_full15 <- cbind(match_age8m, m8)\
match_full15 = match_full15[!match_full15$r== 'NA',]\
\
md_controls8m <- subset(match_full15, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases8m <- subset(match_full15, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases8m[,.N,by=person_id]\
md_controls8m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls15 <-md_controls8m[order(person_id)]\
md_controls15[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_8m <- subset(md_controls15, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_8m <- subset(md_controls15, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_8m2 <- multi_8m[,c(1,2,3,4)]\
multi_8m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full15$person_id)]\
\
##Rematch the used PIDs\
\
control8_m_d2 <- subset(control_pop_m, index_age >=1070 & index_age<1140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control8_m_d2)\
match_age8m_d2 <- rbind(multi_8m2, control8_m_d2)\
m_age8m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age8m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age8m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full15_d2 <- cbind(match_age8m_d2, r2)\
match_full15_d2 = match_full15_d2[!match_full15_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_8m <- unique_8m[,c(1,2,3,4,5,6,7)]\
match_full15_d3 <-rbind(unique_8m, match_full15_d2)\
match_full15_d3 <- subset(match_full15_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full15_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full15_d3$person_id)]\
\
#females\
case8_f <- subset(case_pop_f, index_age >=1080 & index_age < 1130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case8_f)\
control8_f <- subset(control_pop_f, index_age >=1070 & index_age<1140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control8_f)\
match_age8f <- rbind(case8_f, control8_f)\
setDT(match_age8f)\
\
m_age8f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age8f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age8f$factor\
f8 <- as.data.table(r)\
f8$ID2 <- seq.int(nrow(f8))\
\
match_full16 <- cbind(match_age8f, f8)\
match_full16 = match_full16[!match_full16$r== 'NA',]\
\
md_controls8f <- subset(match_full16, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases8f <- subset(match_full16, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases8f[,.N,by=person_id]\
md_controls8f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls16 <-md_controls8f[order(person_id)]\
md_controls16[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_8f <- subset(md_controls16, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_8f <- subset(md_controls16, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_8f2 <- multi_8f[,c(1,2,3,4)]\
multi_8f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full16$person_id)]\
\
##Rematch the used PIDs\
\
control8_f_d2 <- subset(control_pop_f,index_age >=1070 & index_age<1140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control8_f_d2)\
match_age8f_d2 <- rbind(multi_8f2, control8_f_d2)\
m_age8f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age8f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age8f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full16_d2 <- cbind(match_age8f_d2, r2)\
match_full16_d2 = match_full16_d2[!match_full16_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_8f <- unique_8f[,c(1,2,3,4,5,6,7)]\
match_full16_d3 <-rbind(unique_8f, match_full16_d2)\
match_full16_d3 <- subset(match_full16_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full16_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full16_d3$person_id)]\
\
## 1130-1180 days old\
#males\
\
case9_m <- subset(case_pop_m, index_age >=1130 & index_age <1180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case9_m)\
control9_m <- subset(control_pop_m, index_age >=1120 & index_age<1190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control9_m)\
match_age9m <- rbind(case9_m, control9_m)\
setDT(match_age9m)\
\
m_age9m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age9m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age9m$factor\
m9 <- as.data.table(r)\
m9$ID2 <- seq.int(nrow(m9))\
\
match_full17 <- cbind(match_age9m, m9)\
match_full17 = match_full17[!match_full17$r== 'NA',]\
\
md_controls9m <- subset(match_full17, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases9m <- subset(match_full17, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases9m[,.N,by=person_id]\
md_controls9m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls17 <-md_controls9m[order(person_id)]\
md_controls17[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_9m <- subset(md_controls17, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_9m <- subset(md_controls17, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_9m2 <- multi_9m[,c(1,2,3,4)]\
multi_9m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full17$person_id)]\
\
##Rematch the used PIDs\
\
control9_m_d2 <- subset(control_pop_m, index_age >=1120 & index_age<1190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control9_m_d2)\
match_age9m_d2 <- rbind(multi_9m2, control9_m_d2)\
m_age9m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age9m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age9m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full17_d2 <- cbind(match_age9m_d2, r2)\
match_full17_d2 = match_full17_d2[!match_full17_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_9m <- unique_9m[,c(1,2,3,4,5,6,7)]\
match_full17_d3 <-rbind(unique_9m, match_full17_d2)\
match_full17_d3 <- subset(match_full17_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full17_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full17_d3$person_id)]\
\
#females\
case9_f <- subset(case_pop_f, index_age >=1130 & index_age < 1180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case9_f)\
control9_f <- subset(control_pop_f, index_age >=1120 & index_age<1190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control9_f)\
match_age9f <- rbind(case9_f, control9_f)\
setDT(match_age9f)\
\
m_age9f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age9f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age9f$factor\
f9 <- as.data.table(r)\
f9$ID2 <- seq.int(nrow(f9))\
\
match_full18 <- cbind(match_age9f, f9)\
match_full18 = match_full18[!match_full18$r== 'NA',]\
\
md_controls9f <- subset(match_full18, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases9f <- subset(match_full18, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases9f[,.N,by=person_id]\
md_controls9f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls18 <-md_controls9f[order(person_id)]\
md_controls18[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_9f <- subset(md_controls18, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_9f <- subset(md_controls18, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_9f2 <- multi_9f[,c(1,2,3,4)]\
multi_9f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full18$person_id)]\
\
##Rematch the used PIDs\
\
control9_f_d2 <- subset(control_pop_f,index_age >=1120 & index_age<1190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control9_f_d2)\
match_age9f_d2 <- rbind(multi_9f2, control9_f_d2)\
m_age9f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age9f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age9f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full18_d2 <- cbind(match_age9f_d2, r2)\
match_full18_d2 = match_full18_d2[!match_full18_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_9f <- unique_9f[,c(1,2,3,4,5,6,7)]\
match_full18_d3 <-rbind(unique_9f, match_full18_d2)\
match_full18_d3 <- subset(match_full18_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full18_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full18_d3$person_id)]\
\
## 1180-1230 days old\
#males\
\
case10_m <- subset(case_pop_m, index_age >=1180 & index_age <1230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case10_m)\
control10_m <- subset(control_pop_m, index_age >=1170 & index_age<1240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control10_m)\
match_age10m <- rbind(case10_m, control10_m)\
setDT(match_age10m)\
\
m_age10m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age10m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age10m$factor\
m10 <- as.data.table(r)\
m10$ID2 <- seq.int(nrow(m10))\
\
match_full19 <- cbind(match_age10m, m10)\
match_full19 = match_full19[!match_full19$r== 'NA',]\
\
md_controls10m <- subset(match_full19, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases10m <- subset(match_full19, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases10m[,.N,by=person_id]\
md_controls10m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls19 <-md_controls10m[order(person_id)]\
md_controls19[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_10m <- subset(md_controls19, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_10m <- subset(md_controls19, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_10m2 <- multi_10m[,c(1,2,3,4)]\
multi_10m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full19$person_id)]\
\
##Rematch the used PIDs\
\
control10_m_d2 <- subset(control_pop_m, index_age >=1170 & index_age<1240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control10_m_d2)\
match_age10m_d2 <- rbind(multi_10m2, control10_m_d2)\
m_age10m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age10m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age10m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full19_d2 <- cbind(match_age10m_d2, r2)\
match_full19_d2 = match_full19_d2[!match_full19_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_10m <- unique_10m[,c(1,2,3,4,5,6,7)]\
match_full19_d3 <-rbind(unique_10m, match_full19_d2)\
match_full19_d3 <- subset(match_full19_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full19_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full19_d3$person_id)]\
\
#females\
case10_f <- subset(case_pop_f, index_age >=1180 & index_age < 1230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case10_f)\
control10_f <- subset(control_pop_f, index_age >=1170 & index_age<1240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control10_f)\
match_age10f <- rbind(case10_f, control10_f)\
setDT(match_age10f)\
\
m_age10f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age10f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age10f$factor\
f10 <- as.data.table(r)\
f10$ID2 <- seq.int(nrow(f10))\
\
match_full20 <- cbind(match_age10f, f10)\
match_full20 = match_full20[!match_full20$r== 'NA',]\
\
md_controls10f <- subset(match_full20, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases10f <- subset(match_full20, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases10f[,.N,by=person_id]\
md_controls10f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls20 <-md_controls10f[order(person_id)]\
md_controls20[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_10f <- subset(md_controls20, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_10f <- subset(md_controls20, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_10f2 <- multi_10f[,c(1,2,3,4)]\
multi_10f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full20$person_id)]\
\
##Rematch the used PIDs\
\
control10_f_d2 <- subset(control_pop_f,index_age >=1170 & index_age<1240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control10_f_d2)\
match_age10f_d2 <- rbind(multi_10f2, control10_f_d2)\
m_age10f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age10f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age10f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full20_d2 <- cbind(match_age10f_d2, r2)\
match_full20_d2 = match_full20_d2[!match_full20_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_10f <- unique_10f[,c(1,2,3,4,5,6,7)]\
match_full20_d3 <-rbind(unique_10f, match_full20_d2)\
match_full20_d3 <- subset(match_full20_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full20_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full20_d3$person_id)]\
\
##combine all matched data: round 2\
\
colnames(match_full11_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full12_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full13_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full14_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full15_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full16_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full17_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full18_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full19_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full20_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_2 <- rbind(match_full11_d3, match_full12_d3, match_full13_d3, match_full14_d3, match_full15_d3, match_full16_d3, match_full17_d3, match_full18_d3, match_full19_d3, match_full20_d3)\
setDT(match_total_2)\
\
match_total_2[,.N,by=person_id]\
write.csv(match_total_2, 'match_total_2.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_2,  c("person_id","num_of_prior_visits"))\
\
mt2_matched_measures3= f[match_total_2]\
mt2_matched_measures4 <- mt2_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt2_matched_measures4)\
\
setkeyv(mt2_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt2_control_conditions= conditions2[mt2_matched_measures4]\
\
mt2_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt2_cont_pre_index <- match_total_2[,c(1,4)]\
mt2_cont_pre_index$pre <- mt2_cont_pre_index[, 2] -1\
mt2_cont_pre_index2 <- mt2_cont_pre_index[,c(1,3)]\
colnames(mt2_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt2_cont_pre_index2)\
setkeyv(mt2_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt2_matched_pre_measures= f[mt2_cont_pre_index2]\
\
mt2_matched_pre_measures2 <- mt2_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt2_matched_pre_measures2)\
\
setkeyv(mt2_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt2_control_conditions_pre= conditions2[mt2_matched_pre_measures2]\
\
mt2_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt2_cont_post_index <- match_total_2[,c(1,4)]\
mt2_cont_post_index$post <- mt2_cont_pre_index[, 2] +1\
mt2_cont_post_index2 <- mt2_cont_post_index[,c(1,3)]\
colnames(mt2_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt2_cont_post_index2)\
setkeyv(mt2_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt2_matched_post_measures= f[mt2_cont_post_index2]\
\
mt2_matched_post_measures2 <- mt2_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt2_matched_post_measures2)\
\
setkeyv(mt2_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt2_control_conditions_post= conditions2[mt2_matched_post_measures2]\
\
mt2_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt2_control_conditions_post= mt2_control_conditions_post[!mt2_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt2_control_conditions_post$Timing_Class = '3'\
mt2_control_conditions_pre$Timing_Class = '1'\
mt2_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_2$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_2$person_id)]\
\
##Rbind all clinical observations for the second matched set\
\
full_con_2 <- rbind(mt2_control_conditions_pre, mt2_control_conditions, mt2_control_conditions_post)\
setDT(full_con_2)\
full_con_2[,.N,by=person_id]\
\
## 1230-1280 days old\
#males\
\
case11_m <- subset(case_pop_m, index_age >=1230 & index_age <1280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case11_m)\
control11_m <- subset(control_pop_m, index_age >=1220 & index_age<1290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control11_m)\
match_age11m <- rbind(case11_m, control11_m)\
setDT(match_age11m)\
\
m_age11m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age11m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age11m$factor\
m11 <- as.data.table(r)\
m11$ID2 <- seq.int(nrow(m11))\
\
match_full21 <- cbind(match_age11m, m11)\
match_full21 = match_full21[!match_full21$r== 'NA',]\
\
md_controls11m <- subset(match_full21, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases11m <- subset(match_full21, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases11m[,.N,by=person_id]\
md_controls11m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls21 <-md_controls11m[order(person_id)]\
md_controls21[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_11m <- subset(md_controls21, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_11m <- subset(md_controls21, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_11m2 <- multi_11m[,c(1,2,3,4)]\
multi_11m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full21$person_id)]\
\
##Rematch the used PIDs\
\
control11_m_d2 <- subset(control_pop_m, index_age >=1220 & index_age<1290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control11_m_d2)\
match_age11m_d2 <- rbind(multi_11m2, control11_m_d2)\
m_age11m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age11m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age11m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full21_d2 <- cbind(match_age11m_d2, r2)\
match_full21_d2 = match_full21_d2[!match_full21_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_11m <- unique_11m[,c(1,2,3,4,5,6,7)]\
match_full21_d3 <-rbind(unique_11m, match_full21_d2)\
match_full21_d3 <- subset(match_full21_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full21_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full21_d3$person_id)]\
\
#females\
case11_f <- subset(case_pop_f, index_age >=1230 & index_age < 1280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case11_f)\
control11_f <- subset(control_pop_f, index_age >=1220 & index_age<1290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control11_f)\
match_age11f <- rbind(case11_f, control11_f)\
setDT(match_age11f)\
\
m_age11f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age11f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age11f$factor\
f11 <- as.data.table(r)\
f11$ID2 <- seq.int(nrow(f11))\
\
match_full22 <- cbind(match_age11f, f11)\
match_full22 = match_full22[!match_full22$r== 'NA',]\
\
md_controls11f <- subset(match_full22, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases11f <- subset(match_full22, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases11f[,.N,by=person_id]\
md_controls11f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls22 <-md_controls11f[order(person_id)]\
md_controls22[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_11f <- subset(md_controls22, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_11f <- subset(md_controls22, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_11f2 <- multi_11f[,c(1,2,3,4)]\
multi_11f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full22$person_id)]\
\
##Rematch the used PIDs\
\
control11_f_d2 <- subset(control_pop_f,index_age >=1220 & index_age<1290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control11_f_d2)\
match_age11f_d2 <- rbind(multi_11f2, control11_f_d2)\
m_age11f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age11f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age11f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full22_d2 <- cbind(match_age11f_d2, r2)\
match_full22_d2 = match_full22_d2[!match_full22_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_11f <- unique_11f[,c(1,2,3,4,5,6,7)]\
match_full22_d3 <-rbind(unique_11f, match_full22_d2)\
match_full22_d3 <- subset(match_full22_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full22_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full22_d3$person_id)]\
\
## 1280-1330 days old\
#males\
\
case12_m <- subset(case_pop_m, index_age >=1280 & index_age <1330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case12_m)\
control12_m <- subset(control_pop_m, index_age >=1270 & index_age<1340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control12_m)\
match_age12m <- rbind(case12_m, control12_m)\
setDT(match_age12m)\
\
m_age12m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age12m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age12m$factor\
m12 <- as.data.table(r)\
m12$ID2 <- seq.int(nrow(m12))\
\
match_full23 <- cbind(match_age12m, m12)\
match_full23 = match_full23[!match_full23$r== 'NA',]\
\
md_controls12m <- subset(match_full23, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases12m <- subset(match_full23, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases12m[,.N,by=person_id]\
md_controls12m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls23 <-md_controls12m[order(person_id)]\
md_controls23[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_12m <- subset(md_controls23, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_12m <- subset(md_controls23, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_12m2 <- multi_12m[,c(1,2,3,4)]\
multi_12m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full23$person_id)]\
\
##Rematch the used PIDs\
\
control12_m_d2 <- subset(control_pop_m,  index_age >=1270 & index_age<1340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control12_m_d2)\
match_age12m_d2 <- rbind(multi_12m2, control12_m_d2)\
m_age12m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age12m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age12m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full23_d2 <- cbind(match_age12m_d2, r2)\
match_full23_d2 = match_full23_d2[!match_full23_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_12m <- unique_12m[,c(1,2,3,4,5,6,7)]\
match_full23_d3 <-rbind(unique_12m, match_full23_d2)\
match_full23_d3 <- subset(match_full23_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full23_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full23_d3$person_id)]\
\
#females\
case12_f <- subset(case_pop_f, index_age >=1280 & index_age < 1330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case12_f)\
control12_f <- subset(control_pop_f, index_age >=1270 & index_age<1340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control12_f)\
match_age12f <- rbind(case12_f, control12_f)\
setDT(match_age12f)\
\
m_age12f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age12f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age12f$factor\
f12 <- as.data.table(r)\
f12$ID2 <- seq.int(nrow(f12))\
\
match_full24 <- cbind(match_age12f, f12)\
match_full24 = match_full24[!match_full24$r== 'NA',]\
\
md_controls12f <- subset(match_full24, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases12f <- subset(match_full24, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases12f[,.N,by=person_id]\
md_controls12f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls24 <-md_controls12f[order(person_id)]\
md_controls24[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_12f <- subset(md_controls24, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_12f <- subset(md_controls24, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_12f2 <- multi_12f[,c(1,2,3,4)]\
multi_12f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full24$person_id)]\
\
##Rematch the used PIDs\
\
control12_f_d2 <- subset(control_pop_f, index_age >=1270 & index_age<1340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control12_f_d2)\
match_age12f_d2 <- rbind(multi_12f2, control12_f_d2)\
m_age12f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age12f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age12f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full24_d2 <- cbind(match_age12f_d2, r2)\
match_full24_d2 = match_full24_d2[!match_full24_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_12f <- unique_12f[,c(1,2,3,4,5,6,7)]\
match_full24_d3 <-rbind(unique_12f, match_full24_d2)\
match_full24_d3 <- subset(match_full24_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full24_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full24_d3$person_id)]\
\
## 1330-1380 days old\
#males\
\
case13_m <- subset(case_pop_m, index_age >=1330 & index_age <1380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case13_m)\
control13_m <- subset(control_pop_m, index_age >=1320 & index_age<1390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control13_m)\
match_age13m <- rbind(case13_m, control13_m)\
setDT(match_age13m)\
\
m_age13m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age13m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age13m$factor\
m13 <- as.data.table(r)\
m13$ID2 <- seq.int(nrow(m13))\
\
match_full25 <- cbind(match_age13m, m13)\
match_full25 = match_full25[!match_full25$r== 'NA',]\
\
md_controls13m <- subset(match_full25, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases13m <- subset(match_full25, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases13m[,.N,by=person_id]\
md_controls13m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls25 <-md_controls13m[order(person_id)]\
md_controls25[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_13m <- subset(md_controls25, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_13m <- subset(md_controls25, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_13m2 <- multi_13m[,c(1,2,3,4)]\
multi_13m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full25$person_id)]\
\
##Rematch the used PIDs\
\
control13_m_d2 <- subset(control_pop_m, index_age >=1320 & index_age<1390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control13_m_d2)\
match_age13m_d2 <- rbind(multi_13m2, control13_m_d2)\
m_age13m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age13m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age13m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full25_d2 <- cbind(match_age13m_d2, r2)\
match_full25_d2 = match_full25_d2[!match_full25_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_13m <- unique_13m[,c(1,2,3,4,5,6,7)]\
match_full25_d3 <-rbind(unique_13m, match_full25_d2)\
match_full25_d3 <- subset(match_full25_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full25_d3[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls25 <-match_full25_d3[order(person_id)]\
md_controls25[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_13m <- subset(md_controls25, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_13m <- subset(md_controls25, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_13m2 <- multi_13m[,c(1,2,3,4)]\
multi_13m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full25_d3$person_id)]\
\
##Rematch the used PIDs\
\
control13_m_d2 <- subset(control_pop_m, index_age >=1320 & index_age<1390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control13_m_d2)\
match_age13m_d2 <- rbind(multi_13m2, control13_m_d2)\
m_age13m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age13m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age13m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full25_d2 <- cbind(match_age13m_d2, r2)\
match_full25_d2 = match_full25_d2[!match_full25_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_13m <- unique_13m[,c(1,2,3,4,5,6,7)]\
match_full25_d3 <-rbind(unique_13m, match_full25_d2)\
match_full25_d3 <- subset(match_full25_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full25_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full25_d3$person_id)]\
\
\
#females\
case13_f <- subset(case_pop_f, index_age >=1330 & index_age < 1380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case13_f)\
control13_f <- subset(control_pop_f, index_age >=1320 & index_age<1390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control13_f)\
match_age13f <- rbind(case13_f, control13_f)\
setDT(match_age13f)\
\
m_age13f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age13f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age13f$factor\
f13 <- as.data.table(r)\
f13$ID2 <- seq.int(nrow(f13))\
\
match_full26 <- cbind(match_age13f, f13)\
match_full26 = match_full26[!match_full26$r== 'NA',]\
\
md_controls13f <- subset(match_full26, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases13f <- subset(match_full26, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases13f[,.N,by=person_id]\
md_controls13f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls26 <-md_controls13f[order(person_id)]\
md_controls26[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_13f <- subset(md_controls26, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_13f <- subset(md_controls26, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_13f2 <- multi_13f[,c(1,2,3,4)]\
multi_13f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full26$person_id)]\
\
##Rematch the used PIDs\
\
control13_f_d2 <- subset(control_pop_f, index_age >=1320 & index_age<1390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control13_f_d2)\
match_age13f_d2 <- rbind(multi_13f2, control13_f_d2)\
m_age13f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age13f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age13f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full26_d2 <- cbind(match_age13f_d2, r2)\
match_full26_d2 = match_full26_d2[!match_full26_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_13f <- unique_13f[,c(1,2,3,4,5,6,7)]\
match_full26_d3 <-rbind(unique_13f, match_full26_d2)\
match_full26_d3 <- subset(match_full26_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full26_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full26_d3$person_id)]\
\
## 1380-1430 days old\
#males\
\
case14_m <- subset(case_pop_m, index_age >=1380 & index_age <1430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case14_m)\
control14_m <- subset(control_pop_m, index_age >=1370 & index_age<1440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control14_m)\
match_age14m <- rbind(case14_m, control14_m)\
setDT(match_age14m)\
\
m_age14m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age14m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age14m$factor\
m14 <- as.data.table(r)\
m14$ID2 <- seq.int(nrow(m14))\
\
match_full27 <- cbind(match_age14m, m14)\
match_full27 = match_full27[!match_full27$r== 'NA',]\
\
md_controls14m <- subset(match_full27, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases14m <- subset(match_full27, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases14m[,.N,by=person_id]\
md_controls14m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls27 <-md_controls14m[order(person_id)]\
md_controls27[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_14m <- subset(md_controls27, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_14m <- subset(md_controls27, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_14m2 <- multi_14m[,c(1,2,3,4)]\
multi_14m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full27$person_id)]\
\
##Rematch the used PIDs\
\
control14_m_d2 <- subset(control_pop_m, index_age >=1370 & index_age<1440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control14_m_d2)\
match_age14m_d2 <- rbind(multi_14m2, control14_m_d2)\
m_age14m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age14m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age14m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full27_d2 <- cbind(match_age14m_d2, r2)\
match_full27_d2 = match_full27_d2[!match_full27_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_14m <- unique_14m[,c(1,2,3,4,5,6,7)]\
match_full27_d3 <-rbind(unique_14m, match_full27_d2)\
match_full27_d3 <- subset(match_full27_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full27_d3[,.N,by=person_id]\
\
#Rematch duplicate\
md_controls27 <-match_full27_d3[order(person_id)]\
md_controls27[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_14m <- subset(md_controls27, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_14m <- subset(md_controls27, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_14m2 <- multi_14m[,c(1,2,3,4)]\
multi_14m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full27_d3$person_id)]\
\
##Rematch the used PIDs\
\
control14_m_d2 <- subset(control_pop_m, index_age >=1370 & index_age<1440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control14_m_d2)\
match_age14m_d2 <- rbind(multi_14m2, control14_m_d2)\
m_age14m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age14m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age14m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full27_d2 <- cbind(match_age14m_d2, r2)\
match_full27_d2 = match_full27_d2[!match_full27_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_14m <- unique_14m[,c(1,2,3,4,5,6,7)]\
match_full27_d3 <-rbind(unique_14m, match_full27_d2)\
match_full27_d3 <- subset(match_full27_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full27_d3[,.N,by=person_id]\
\
#females\
case14_f <- subset(case_pop_f, index_age >=1380 & index_age < 1430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case14_f)\
control14_f <- subset(control_pop_f, index_age >=1370 & index_age<1440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control14_f)\
match_age14f <- rbind(case14_f, control14_f)\
setDT(match_age14f)\
\
m_age14f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age14f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age14f$factor\
f14 <- as.data.table(r)\
f14$ID2 <- seq.int(nrow(f14))\
\
match_full28 <- cbind(match_age14f, f14)\
match_full28 = match_full28[!match_full28$r== 'NA',]\
\
md_controls14f <- subset(match_full28, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases14f <- subset(match_full28, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases14f[,.N,by=person_id]\
md_controls14f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls28 <-md_controls14f[order(person_id)]\
md_controls28[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_14f <- subset(md_controls28, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_14f <- subset(md_controls28, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_14f2 <- multi_14f[,c(1,2,3,4)]\
multi_14f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full28$person_id)]\
\
##Rematch the used PIDs\
\
control14_f_d2 <- subset(control_pop_f, index_age >=1370 & index_age<1440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control14_f_d2)\
match_age14f_d2 <- rbind(multi_14f2, control14_f_d2)\
m_age14f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age14f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age14f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full28_d2 <- cbind(match_age14f_d2, r2)\
match_full28_d2 = match_full28_d2[!match_full28_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_14f <- unique_14f[,c(1,2,3,4,5,6,7)]\
match_full28_d3 <-rbind(unique_14f, match_full28_d2)\
match_full28_d3 <- subset(match_full28_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full28_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full28_d3$person_id)]\
\
## 1430-1480 days old\
#males\
\
case15_m <- subset(case_pop_m, index_age >=1430 & index_age <1480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case15_m)\
control15_m <- subset(control_pop_m, index_age >=1420 & index_age<1490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control15_m)\
match_age15m <- rbind(case15_m, control15_m)\
setDT(match_age15m)\
\
m_age15m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age15m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age15m$factor\
m15 <- as.data.table(r)\
m15$ID2 <- seq.int(nrow(m15))\
\
match_full29 <- cbind(match_age15m, m15)\
match_full29 = match_full29[!match_full29$r== 'NA',]\
\
md_controls15m <- subset(match_full29, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases15m <- subset(match_full29, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases15m[,.N,by=person_id]\
md_controls15m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls29 <-md_controls15m[order(person_id)]\
md_controls29[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_15m <- subset(md_controls29, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_15m <- subset(md_controls29, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_15m2 <- multi_15m[,c(1,2,3,4)]\
multi_15m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full29$person_id)]\
\
##Rematch the used PIDs\
\
control15_m_d2 <- subset(control_pop_m, index_age >=1420 & index_age<1490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control15_m_d2)\
match_age15m_d2 <- rbind(multi_15m2, control15_m_d2)\
m_age15m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age15m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age15m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full29_d2 <- cbind(match_age15m_d2, r2)\
match_full29_d2 = match_full29_d2[!match_full29_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_15m <- unique_15m[,c(1,2,3,4,5,6,7)]\
match_full29_d3 <-rbind(unique_15m, match_full29_d2)\
match_full29_d3 <- subset(match_full29_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full29_d3[,.N,by=person_id]\
\
#Rematch duplicate\
md_controls29 <-match_full29_d3[order(person_id)]\
md_controls29[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_15m <- subset(md_controls29, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_15m <- subset(md_controls29, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_15m2 <- multi_15m[,c(1,2,3,4)]\
multi_15m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full29_d3$person_id)]\
\
##Rematch the used PIDs\
\
control15_m_d2 <- subset(control_pop_m, index_age >=1420 & index_age<1490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control15_m_d2)\
match_age15m_d2 <- rbind(multi_15m2, control15_m_d2)\
m_age15m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age15m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age15m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full29_d2 <- cbind(match_age15m_d2, r2)\
match_full29_d2 = match_full29_d2[!match_full29_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_15m <- unique_15m[,c(1,2,3,4,5,6,7)]\
match_full29_d3 <-rbind(unique_15m, match_full29_d2)\
match_full29_d3 <- subset(match_full29_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full29_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full29_d3$person_id)]\
\
\
#females\
case15_f <- subset(case_pop_f, index_age >=1430 & index_age < 1480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case15_f)\
control15_f <- subset(control_pop_f, index_age >=1420 & index_age<1490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control15_f)\
match_age15f <- rbind(case15_f, control15_f)\
setDT(match_age15f)\
\
m_age15f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age15f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age15f$factor\
f15 <- as.data.table(r)\
f15$ID2 <- seq.int(nrow(f15))\
\
match_full30 <- cbind(match_age15f, f15)\
match_full30 = match_full30[!match_full30$r== 'NA',]\
\
md_controls15f <- subset(match_full30, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases15f <- subset(match_full30, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases15f[,.N,by=person_id]\
md_controls15f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls30 <-md_controls15f[order(person_id)]\
md_controls30[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_15f <- subset(md_controls30, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_15f <- subset(md_controls30, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_15f2 <- multi_15f[,c(1,2,3,4)]\
multi_15f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full30$person_id)]\
\
##Rematch the used PIDs\
\
control15_f_d2 <- subset(control_pop_f, index_age >=1420 & index_age<1490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control15_f_d2)\
match_age15f_d2 <- rbind(multi_15f2, control15_f_d2)\
m_age15f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age15f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age15f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full30_d2 <- cbind(match_age15f_d2, r2)\
match_full30_d2 = match_full30_d2[!match_full30_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_15f <- unique_15f[,c(1,2,3,4,5,6,7)]\
match_full30_d3 <-rbind(unique_15f, match_full30_d2)\
match_full30_d3 <- subset(match_full30_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full30_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full30_d3$person_id)]\
\
##combine all matched data: round 3\
\
colnames(match_full21_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full22_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full23_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full24_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full25_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full26_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full27_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full28_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full29_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full30_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_3 <- rbind(match_full21_d3, match_full22_d3, match_full23_d3, match_full24_d3, match_full25_d3, match_full26_d3, match_full27_d3, match_full28_d3, match_full29_d3, match_full30_d3)\
setDT(match_total_3)\
\
match_total_3[,.N,by=person_id]\
\
##One duplicate match; rematch this\
md_controls_tot3 <-match_total_3[order(person_id)]\
md_controls_tot3[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_tot3 <- subset(md_controls_tot3, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID, num_matches))\
\
unique_tot3 <- subset(md_controls_tot3, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID, num_matches))\
\
multi_tot3 <- multi_tot3[,c(1,2,3,4)]\
multi_tot3$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_total_3$person_id)]\
\
##Rematch the used PIDs\
\
controltot3_d2 <- subset(control_pop_m, index_age >=1370 & index_age<1440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(controltot3_d2)\
match_tot3_d2 <- rbind(multi_tot3, controltot3_d2)\
m_tot3_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_tot3_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_tot3_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_fulltot3_d2 <- cbind(match_tot3_d2, r2)\
match_fulltot3_d2 = match_fulltot3_d2[!match_fulltot3_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_tot3 <- unique_tot3[,c(1,2,3,4,5,6,7)]\
colnames(match_fulltot3_d2) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_fulltot3_d3 <-rbind(unique_tot3, match_fulltot3_d2)\
match_fulltot3_d3 <- subset(match_fulltot3_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_fulltot3_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_fulltot3_d3$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_fulltot3_d3$person_id)]\
\
match_total_3 <- setDT(match_fulltot3_d3)\
#Eliminate the duplicate entry\
md2_controls_tot3 <-match_total_3[order(person_id)]\
md2_controls_tot3[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
match_total_3 = md2_controls_tot3[!md2_controls_tot3$num_matches==1]\
\
write.csv(match_total_3, 'match_total_3.csv')\
\
match_total_3 <- match_total_3[,c(1,2,3,4,5,6,7)]\
match_total_1 <- match_total_1[,c(2,3,4,5,6,7,8)]\
x<- rbind(match_total_1, match_total_2, match_total_3)\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_3,  c("person_id","num_of_prior_visits"))\
\
mt3_matched_measures3= f[match_total_3]\
mt3_matched_measures4 <- mt3_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt3_matched_measures4)\
\
setkeyv(mt3_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt3_control_conditions= conditions2[mt3_matched_measures4]\
\
mt3_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt3_cont_pre_index <- match_total_3[,c(1,4)]\
mt3_cont_pre_index$pre <- mt3_cont_pre_index[, 2] -1\
mt3_cont_pre_index2 <- mt3_cont_pre_index[,c(1,3)]\
colnames(mt3_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt3_cont_pre_index2)\
setkeyv(mt3_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt3_matched_pre_measures= f[mt3_cont_pre_index2]\
\
mt3_matched_pre_measures2 <- mt3_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt3_matched_pre_measures2)\
\
setkeyv(mt3_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt3_control_conditions_pre= conditions2[mt3_matched_pre_measures2]\
\
mt3_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt3_cont_post_index <- match_total_3[,c(1,4)]\
mt3_cont_post_index$post <- mt3_cont_pre_index[, 2] +1\
mt3_cont_post_index2 <- mt3_cont_post_index[,c(1,3)]\
colnames(mt3_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt3_cont_post_index2)\
setkeyv(mt3_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt3_matched_post_measures= f[mt3_cont_post_index2]\
\
mt3_matched_post_measures2 <- mt3_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt3_matched_post_measures2)\
\
setkeyv(mt3_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt3_control_conditions_post= conditions2[mt3_matched_post_measures2]\
\
mt3_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt3_control_conditions_post= mt3_control_conditions_post[!mt3_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt3_control_conditions_post$Timing_Class = '3'\
mt3_control_conditions_pre$Timing_Class = '1'\
mt3_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_3$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_3$person_id)]\
\
#Combine all clinical observations for the third set\
full_con_3 <- rbind(mt3_control_conditions_pre, mt3_control_conditions, mt3_control_conditions_post)\
setDT(full_con_3)\
full_con_3[,.N,by=person_id]\
\
## 1480-1530 days old\
#males\
\
case16_m <- subset(case_pop_m, index_age >=1480 & index_age <1530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case16_m)\
control16_m <- subset(control_pop_m, index_age >=1470 & index_age<1540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control16_m)\
match_age16m <- rbind(case16_m, control16_m)\
setDT(match_age16m)\
\
m_age16m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age16m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age16m$factor\
m16 <- as.data.table(r)\
m16$ID2 <- seq.int(nrow(m16))\
\
match_full31 <- cbind(match_age16m, m16)\
match_full31 = match_full31[!match_full31$r== 'NA',]\
\
md_controls16m <- subset(match_full31, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases16m <- subset(match_full31, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases16m[,.N,by=person_id]\
md_controls16m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls31 <-md_controls16m[order(person_id)]\
md_controls31[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_16m <- subset(md_controls31, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_16m <- subset(md_controls31, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_16m2 <- multi_16m[,c(1,2,3,4)]\
multi_16m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full31$person_id)]\
\
##Rematch the used PIDs\
\
control16_m_d2 <- subset(control_pop_m, index_age >=1470 & index_age<1540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control16_m_d2)\
match_age16m_d2 <- rbind(multi_16m2, control16_m_d2)\
m_age16m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age16m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age16m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full31_d2 <- cbind(match_age16m_d2, r2)\
match_full31_d2 = match_full31_d2[!match_full31_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_16m <- unique_16m[,c(1,2,3,4,5,6,7)]\
match_full31_d3 <-rbind(unique_16m, match_full31_d2)\
match_full31_d3 <- subset(match_full31_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full31_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full31_d3$person_id)]\
\
#Rematch the duplicate\
md_controls31 <-match_full31_d3[order(person_id)]\
md_controls31[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_16m <- subset(md_controls31, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_16m <- subset(md_controls31, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_16m2 <- multi_16m[,c(1,2,3,4)]\
multi_16m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full31$person_id)]\
\
##Rematch the used PIDs\
\
control16_m_d2 <- subset(control_pop_m, index_age >=1470 & index_age<1540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control16_m_d2)\
match_age16m_d2 <- rbind(multi_16m2, control16_m_d2)\
m_age16m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age16m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age16m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full31_d2 <- cbind(match_age16m_d2, r2)\
match_full31_d2 = match_full31_d2[!match_full31_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_16m <- unique_16m[,c(1,2,3,4,5,6,7)]\
match_full31_d3 <-rbind(unique_16m, match_full31_d2)\
match_full31_d3 <- subset(match_full31_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full31_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full31_d3$person_id)]\
\
#females\
case16_f <- subset(case_pop_f, index_age >=1480 & index_age < 1530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case16_f)\
control16_f <- subset(control_pop_f, index_age >=1470 & index_age<1540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control16_f)\
match_age16f <- rbind(case16_f, control16_f)\
setDT(match_age16f)\
\
m_age16f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age16f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age16f$factor\
f16 <- as.data.table(r)\
f16$ID2 <- seq.int(nrow(f16))\
\
match_full32 <- cbind(match_age16f, f16)\
match_full32 = match_full32[!match_full32$r== 'NA',]\
\
md_controls16f <- subset(match_full32, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases16f <- subset(match_full32, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases16f[,.N,by=person_id]\
md_controls16f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls32 <-md_controls16f[order(person_id)]\
md_controls32[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_16f <- subset(md_controls32, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_16f <- subset(md_controls32, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_16f2 <- multi_16f[,c(1,2,3,4)]\
multi_16f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full32$person_id)]\
\
##Rematch the used PIDs\
\
control16_f_d2 <- subset(control_pop_f, index_age >=1470 & index_age<1540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control16_f_d2)\
match_age16f_d2 <- rbind(multi_16f2, control16_f_d2)\
m_age16f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age16f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age16f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full32_d2 <- cbind(match_age16f_d2, r2)\
match_full32_d2 = match_full32_d2[!match_full32_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_16f <- unique_16f[,c(1,2,3,4,5,6,7)]\
match_full32_d3 <-rbind(unique_16f, match_full32_d2)\
match_full32_d3 <- subset(match_full32_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full32_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full32_d3$person_id)]\
\
## 1530-1580 days old\
#males\
\
case17_m <- subset(case_pop_m, index_age >=1530 & index_age <1580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case17_m)\
control17_m <- subset(control_pop_m, index_age >=1520 & index_age<1590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control17_m)\
match_age17m <- rbind(case17_m, control17_m)\
setDT(match_age17m)\
\
m_age17m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age17m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age17m$factor\
m17 <- as.data.table(r)\
m17$ID2 <- seq.int(nrow(m17))\
\
match_full33 <- cbind(match_age17m, m17)\
match_full33 = match_full33[!match_full33$r== 'NA',]\
\
md_controls17m <- subset(match_full33, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases17m <- subset(match_full33, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases17m[,.N,by=person_id]\
md_controls17m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls33 <-md_controls17m[order(person_id)]\
md_controls33[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_17m <- subset(md_controls33, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_17m <- subset(md_controls33, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_17m2 <- multi_17m[,c(1,2,3,4)]\
multi_17m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full33$person_id)]\
\
##Rematch the used PIDs\
\
control17_m_d2 <- subset(control_pop_m,index_age >=1520 & index_age<1590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control17_m_d2)\
match_age17m_d2 <- rbind(multi_17m2, control17_m_d2)\
m_age17m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age17m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age17m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full33_d2 <- cbind(match_age17m_d2, r2)\
match_full33_d2 = match_full33_d2[!match_full33_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_17m <- unique_17m[,c(1,2,3,4,5,6,7)]\
match_full33_d3 <-rbind(unique_17m, match_full33_d2)\
match_full33_d3 <- subset(match_full33_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full33_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full33_d3$person_id)]\
\
#females\
case17_f <- subset(case_pop_f, index_age >=1530 & index_age < 1580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case17_f)\
control17_f <- subset(control_pop_f, index_age >=1520 & index_age<1590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control17_f)\
match_age17f <- rbind(case17_f, control17_f)\
setDT(match_age17f)\
\
m_age17f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age17f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age17f$factor\
f17 <- as.data.table(r)\
f17$ID2 <- seq.int(nrow(f17))\
\
match_full34 <- cbind(match_age17f, f17)\
match_full34 = match_full34[!match_full34$r== 'NA',]\
\
md_controls17f <- subset(match_full34, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases17f <- subset(match_full34, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases17f[,.N,by=person_id]\
md_controls17f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls34 <-md_controls17f[order(person_id)]\
md_controls34[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_17f <- subset(md_controls34, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_17f <- subset(md_controls34, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_17f2 <- multi_17f[,c(1,2,3,4)]\
multi_17f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full34$person_id)]\
\
##Rematch the used PIDs\
\
control17_f_d2 <- subset(control_pop_f, index_age >=1520 & index_age<1590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control17_f_d2)\
match_age17f_d2 <- rbind(multi_17f2, control17_f_d2)\
m_age17f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age17f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age17f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full34_d2 <- cbind(match_age17f_d2, r2)\
match_full34_d2 = match_full34_d2[!match_full34_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_17f <- unique_17f[,c(1,2,3,4,5,6,7)]\
match_full34_d3 <-rbind(unique_17f, match_full34_d2)\
match_full34_d3 <- subset(match_full34_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full34_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full34_d3$person_id)]\
\
## 1580-1630 days old\
#males\
\
case18_m <- subset(case_pop_m, index_age >=1580 & index_age <1630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case18_m)\
control18_m <- subset(control_pop_m, index_age >=1570 & index_age<1640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control18_m)\
match_age18m <- rbind(case18_m, control18_m)\
setDT(match_age18m)\
\
m_age18m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age18m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age18m$factor\
m18 <- as.data.table(r)\
m18$ID2 <- seq.int(nrow(m18))\
\
match_full35 <- cbind(match_age18m, m18)\
match_full35 = match_full35[!match_full35$r== 'NA',]\
\
md_controls18m <- subset(match_full35, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases18m <- subset(match_full35, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases18m[,.N,by=person_id]\
md_controls18m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls35 <-md_controls18m[order(person_id)]\
md_controls35[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_18m <- subset(md_controls35, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_18m <- subset(md_controls35, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_18m2 <- multi_18m[,c(1,2,3,4)]\
multi_18m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full35$person_id)]\
\
##Rematch the used PIDs\
\
control18_m_d2 <- subset(control_pop_m,index_age >=1570 & index_age<1640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control18_m_d2)\
match_age18m_d2 <- rbind(multi_18m2, control18_m_d2)\
m_age18m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age18m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age18m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full35_d2 <- cbind(match_age18m_d2, r2)\
match_full35_d2 = match_full35_d2[!match_full35_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_18m <- unique_18m[,c(1,2,3,4,5,6,7)]\
match_full35_d3 <-rbind(unique_18m, match_full35_d2)\
match_full35_d3 <- subset(match_full35_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full35_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full35_d3$person_id)]\
\
\
#females\
case18_f <- subset(case_pop_f, index_age >=1580 & index_age < 1630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case18_f)\
control18_f <- subset(control_pop_f, index_age >=1570 & index_age<1640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control18_f)\
match_age18f <- rbind(case18_f, control18_f)\
setDT(match_age18f)\
\
m_age18f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age18f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age18f$factor\
f18 <- as.data.table(r)\
f18$ID2 <- seq.int(nrow(f18))\
\
match_full36 <- cbind(match_age18f, f18)\
match_full36 = match_full36[!match_full36$r== 'NA',]\
\
md_controls18f <- subset(match_full36, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases18f <- subset(match_full36, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases18f[,.N,by=person_id]\
md_controls18f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls36 <-md_controls18f[order(person_id)]\
md_controls36[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_18f <- subset(md_controls36, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_18f <- subset(md_controls36, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_18f2 <- multi_18f[,c(1,2,3,4)]\
multi_18f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full36$person_id)]\
\
##Rematch the used PIDs\
\
control18_f_d2 <- subset(control_pop_f, index_age >=1570 & index_age<1640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control18_f_d2)\
match_age18f_d2 <- rbind(multi_18f2, control18_f_d2)\
m_age18f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age18f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age18f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full36_d2 <- cbind(match_age18f_d2, r2)\
match_full36_d2 = match_full36_d2[!match_full36_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_18f <- unique_18f[,c(1,2,3,4,5,6,7)]\
match_full36_d3 <-rbind(unique_18f, match_full36_d2)\
match_full36_d3 <- subset(match_full36_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full36_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full36_d3$person_id)]\
\
## 1630-1680 days old\
#males\
\
case19_m <- subset(case_pop_m, index_age >=1630 & index_age <1680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case19_m)\
control19_m <- subset(control_pop_m, index_age >=1620 & index_age<1690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control19_m)\
match_age19m <- rbind(case19_m, control19_m)\
setDT(match_age19m)\
\
m_age19m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age19m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age19m$factor\
m19 <- as.data.table(r)\
m19$ID2 <- seq.int(nrow(m19))\
\
match_full37 <- cbind(match_age19m, m19)\
match_full37 = match_full37[!match_full37$r== 'NA',]\
\
md_controls19m <- subset(match_full37, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases19m <- subset(match_full37, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases19m[,.N,by=person_id]\
md_controls19m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls37 <-md_controls19m[order(person_id)]\
md_controls37[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_19m <- subset(md_controls37, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_19m <- subset(md_controls37, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_19m2 <- multi_19m[,c(1,2,3,4)]\
multi_19m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full37$person_id)]\
\
##Rematch the used PIDs\
\
control19_m_d2 <- subset(control_pop_m, index_age >=1620 & index_age<1690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control19_m_d2)\
match_age19m_d2 <- rbind(multi_19m2, control19_m_d2)\
m_age19m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age19m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age19m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full37_d2 <- cbind(match_age19m_d2, r2)\
match_full37_d2 = match_full37_d2[!match_full37_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_19m <- unique_19m[,c(1,2,3,4,5,6,7)]\
match_full37_d3 <-rbind(unique_19m, match_full37_d2)\
match_full37_d3 <- subset(match_full37_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full37_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full37_d3$person_id)]\
\
#females\
case19_f <- subset(case_pop_f, index_age >=1630 & index_age < 1680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case19_f)\
control19_f <- subset(control_pop_f, index_age >=1620 & index_age<1690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control19_f)\
match_age19f <- rbind(case19_f, control19_f)\
setDT(match_age19f)\
\
m_age19f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age19f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age19f$factor\
f19 <- as.data.table(r)\
f19$ID2 <- seq.int(nrow(f19))\
\
match_full38 <- cbind(match_age19f, f19)\
match_full38 = match_full38[!match_full38$r== 'NA',]\
\
md_controls19f <- subset(match_full38, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases19f <- subset(match_full38, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases19f[,.N,by=person_id]\
md_controls19f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls38 <-md_controls19f[order(person_id)]\
md_controls38[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_19f <- subset(md_controls38, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_19f <- subset(md_controls38, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_19f2 <- multi_19f[,c(1,2,3,4)]\
multi_19f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full38$person_id)]\
\
##Rematch the used PIDs\
\
control19_f_d2 <- subset(control_pop_f, index_age >=1620 & index_age<1690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control19_f_d2)\
match_age19f_d2 <- rbind(multi_19f2, control19_f_d2)\
m_age19f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age19f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age19f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full38_d2 <- cbind(match_age19f_d2, r2)\
match_full38_d2 = match_full38_d2[!match_full38_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_19f <- unique_19f[,c(1,2,3,4,5,6,7)]\
match_full38_d3 <-rbind(unique_19f, match_full38_d2)\
match_full38_d3 <- subset(match_full38_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full38_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full38_d3$person_id)]\
\
## 1680-1730 days old\
#males\
\
case20_m <- subset(case_pop_m, index_age >=1680 & index_age <1730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case20_m)\
control20_m <- subset(control_pop_m, index_age >=1670 & index_age<1740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control20_m)\
match_age20m <- rbind(case20_m, control20_m)\
setDT(match_age20m)\
\
m_age20m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age20m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age20m$factor\
m20 <- as.data.table(r)\
m20$ID2 <- seq.int(nrow(m20))\
\
match_full39 <- cbind(match_age20m, m20)\
match_full39 = match_full39[!match_full39$r== 'NA',]\
\
md_controls20m <- subset(match_full39, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases20m <- subset(match_full39, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases20m[,.N,by=person_id]\
md_controls20m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls39 <-md_controls20m[order(person_id)]\
md_controls39[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_20m <- subset(md_controls39, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_20m <- subset(md_controls39, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_20m2 <- multi_20m[,c(1,2,3,4)]\
multi_20m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full39$person_id)]\
\
##Rematch the used PIDs\
\
control20_m_d2 <- subset(control_pop_m, index_age >=1670 & index_age<1740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control20_m_d2)\
match_age20m_d2 <- rbind(multi_20m2, control20_m_d2)\
m_age20m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age20m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age20m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full39_d2 <- cbind(match_age20m_d2, r2)\
match_full39_d2 = match_full39_d2[!match_full39_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_20m <- unique_20m[,c(1,2,3,4,5,6,7)]\
match_full39_d3 <-rbind(unique_20m, match_full39_d2)\
match_full39_d3 <- subset(match_full39_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full39_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full39_d3$person_id)]\
\
#females\
case20_f <- subset(case_pop_f, index_age >=1680 & index_age < 1730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case20_f)\
control20_f <- subset(control_pop_f, index_age >=1670 & index_age<1740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control20_f)\
match_age20f <- rbind(case20_f, control20_f)\
setDT(match_age20f)\
\
m_age20f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age20f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age20f$factor\
f20 <- as.data.table(r)\
f20$ID2 <- seq.int(nrow(f20))\
\
match_full40 <- cbind(match_age20f, f20)\
match_full40 = match_full40[!match_full40$r== 'NA',]\
\
md_controls20f <- subset(match_full40, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases20f <- subset(match_full40, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases20f[,.N,by=person_id]\
md_controls20f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls40 <-md_controls20f[order(person_id)]\
md_controls40[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_20f <- subset(md_controls40, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_20f <- subset(md_controls40, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_20f2 <- multi_20f[,c(1,2,3,4)]\
multi_20f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full40$person_id)]\
\
##Rematch the used PIDs\
\
control20_f_d2 <- subset(control_pop_f, index_age >=1670 & index_age<1740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control20_f_d2)\
match_age20f_d2 <- rbind(multi_20f2, control20_f_d2)\
m_age20f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age20f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age20f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full40_d2 <- cbind(match_age20f_d2, r2)\
match_full40_d2 = match_full40_d2[!match_full40_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_20f <- unique_20f[,c(1,2,3,4,5,6,7)]\
match_full40_d3 <-rbind(unique_20f, match_full40_d2)\
match_full40_d3 <- subset(match_full40_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full40_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full40_d3$person_id)]\
\
\
##combine all matched data: round 4\
\
colnames(match_full31_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full32_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full33_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full34_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full35_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full36_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full37_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full38_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full39_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full40_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_4 <- rbind(match_full31_d3, match_full32_d3, match_full33_d3, match_full34_d3, match_full35_d3, match_full36_d3, match_full37_d3, match_full38_d3, match_full39_d3, match_full40_d3)\
setDT(match_total_4)\
\
match_total_4[,.N,by=person_id]\
\
write.csv(match_total_4, 'match_total_4.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_4,  c("person_id","num_of_prior_visits"))\
\
mt4_matched_measures3= f[match_total_4]\
mt4_matched_measures4 <- mt4_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt4_matched_measures4)\
\
setkeyv(mt4_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt4_control_conditions= conditions2[mt4_matched_measures4]\
\
mt4_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt4_cont_pre_index <- match_total_4[,c(1,4)]\
mt4_cont_pre_index$pre <- mt4_cont_pre_index[, 2] -1\
mt4_cont_pre_index2 <- mt4_cont_pre_index[,c(1,3)]\
colnames(mt4_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt4_cont_pre_index2)\
setkeyv(mt4_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt4_matched_pre_measures= f[mt4_cont_pre_index2]\
\
mt4_matched_pre_measures2 <- mt4_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt4_matched_pre_measures2)\
\
setkeyv(mt4_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt4_control_conditions_pre= conditions2[mt4_matched_pre_measures2]\
\
mt4_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt4_cont_post_index <- match_total_4[,c(1,4)]\
mt4_cont_post_index$post <- mt4_cont_pre_index[, 2] +1\
mt4_cont_post_index2 <- mt4_cont_post_index[,c(1,3)]\
colnames(mt4_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt4_cont_post_index2)\
setkeyv(mt4_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt4_matched_post_measures= f[mt4_cont_post_index2]\
\
mt4_matched_post_measures2 <- mt4_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt4_matched_post_measures2)\
\
setkeyv(mt4_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt4_control_conditions_post= conditions2[mt4_matched_post_measures2]\
\
mt4_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt4_control_conditions_post= mt4_control_conditions_post[!mt4_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt4_control_conditions_post$Timing_Class = '3'\
mt4_control_conditions_pre$Timing_Class = '1'\
mt4_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_4$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_4$person_id)]\
\
#Combine all clinical observations for the fourth set\
full_con_4 <- rbind(mt4_control_conditions_pre, mt4_control_conditions, mt4_control_conditions_post)\
setDT(full_con_4)\
full_con_4[,.N,by=person_id]\
\
## 1730-1780 days old\
#males\
\
case21_m <- subset(case_pop_m, index_age >=1730 & index_age <1780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case21_m)\
control21_m <- subset(control_pop_m, index_age >=1720 & index_age<1790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control21_m)\
match_age21m <- rbind(case21_m, control21_m)\
setDT(match_age21m)\
\
m_age21m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age21m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age21m$factor\
m21 <- as.data.table(r)\
m21$ID2 <- seq.int(nrow(m21))\
\
match_full41 <- cbind(match_age21m, m21)\
match_full41 = match_full41[!match_full41$r== 'NA',]\
\
md_controls21m <- subset(match_full41, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases21m <- subset(match_full41, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases21m[,.N,by=person_id]\
md_controls21m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls41 <-md_controls21m[order(person_id)]\
md_controls41[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_21m <- subset(md_controls41, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_21m <- subset(md_controls41, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_21m2 <- multi_21m[,c(1,2,3,4)]\
multi_21m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full41$person_id)]\
\
##Rematch the used PIDs\
\
control21_m_d2 <- subset(control_pop_m, index_age >=1720 & index_age<1790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control21_m_d2)\
match_age21m_d2 <- rbind(multi_21m2, control21_m_d2)\
m_age21m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age21m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age21m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full41_d2 <- cbind(match_age21m_d2, r2)\
match_full41_d2 = match_full41_d2[!match_full41_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_21m <- unique_21m[,c(1,2,3,4,5,6,7)]\
match_full41_d3 <-rbind(unique_21m, match_full41_d2)\
match_full41_d3 <- subset(match_full41_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full41_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full41_d3$person_id)]\
\
#females\
case21_f <- subset(case_pop_f, index_age >=1730 & index_age < 1780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case21_f)\
control21_f <- subset(control_pop_f, index_age >=1720 & index_age<1790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control21_f)\
match_age21f <- rbind(case21_f, control21_f)\
setDT(match_age21f)\
\
m_age21f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age21f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age21f$factor\
f21 <- as.data.table(r)\
f21$ID2 <- seq.int(nrow(f21))\
\
match_full42 <- cbind(match_age21f, f21)\
match_full42 = match_full42[!match_full42$r== 'NA',]\
\
md_controls21f <- subset(match_full42, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases21f <- subset(match_full42, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases21f[,.N,by=person_id]\
md_controls21f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls42 <-md_controls21f[order(person_id)]\
md_controls42[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_21f <- subset(md_controls42, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_21f <- subset(md_controls42, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_21f2 <- multi_21f[,c(1,2,3,4)]\
multi_21f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full42$person_id)]\
\
##Rematch the used PIDs\
\
control21_f_d2 <- subset(control_pop_f,  index_age >=1720 & index_age<1790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control21_f_d2)\
match_age21f_d2 <- rbind(multi_21f2, control21_f_d2)\
m_age21f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age21f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age21f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full42_d2 <- cbind(match_age21f_d2, r2)\
match_full42_d2 = match_full42_d2[!match_full42_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_21f <- unique_21f[,c(1,2,3,4,5,6,7)]\
match_full42_d3 <-rbind(unique_21f, match_full42_d2)\
match_full42_d3 <- subset(match_full42_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full42_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full42_d3$person_id)]\
\
## 1780-1830 days old\
#males\
\
case22_m <- subset(case_pop_m, index_age >=1780 & index_age <1830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case22_m)\
control22_m <- subset(control_pop_m, index_age >=1770 & index_age<1840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control22_m)\
match_age22m <- rbind(case22_m, control22_m)\
setDT(match_age22m)\
\
m_age22m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age22m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age22m$factor\
m22 <- as.data.table(r)\
m22$ID2 <- seq.int(nrow(m22))\
\
match_full43 <- cbind(match_age22m, m22)\
match_full43 = match_full43[!match_full43$r== 'NA',]\
\
md_controls22m <- subset(match_full43, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases22m <- subset(match_full43, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases22m[,.N,by=person_id]\
md_controls22m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls43 <-md_controls22m[order(person_id)]\
md_controls43[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_22m <- subset(md_controls43, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_22m <- subset(md_controls43, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_22m2 <- multi_22m[,c(1,2,3,4)]\
multi_22m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full43$person_id)]\
\
##Rematch the used PIDs\
\
control22_m_d2 <- subset(control_pop_m, index_age >=1770 & index_age<1840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control22_m_d2)\
match_age22m_d2 <- rbind(multi_22m2, control22_m_d2)\
m_age22m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age22m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age22m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full43_d2 <- cbind(match_age22m_d2, r2)\
match_full43_d2 = match_full43_d2[!match_full43_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_22m <- unique_22m[,c(1,2,3,4,5,6,7)]\
match_full43_d3 <-rbind(unique_22m, match_full43_d2)\
match_full43_d3 <- subset(match_full43_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full43_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full43_d3$person_id)]\
\
#females\
case22_f <- subset(case_pop_f, index_age >=1780 & index_age < 1830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case22_f)\
control22_f <- subset(control_pop_f, index_age >=1770 & index_age<1840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control22_f)\
match_age22f <- rbind(case22_f, control22_f)\
setDT(match_age22f)\
\
m_age22f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age22f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age22f$factor\
f22 <- as.data.table(r)\
f22$ID2 <- seq.int(nrow(f22))\
\
match_full44 <- cbind(match_age22f, f22)\
match_full44 = match_full44[!match_full44$r== 'NA',]\
\
md_controls22f <- subset(match_full44, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases22f <- subset(match_full44, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases22f[,.N,by=person_id]\
md_controls22f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls44 <-md_controls22f[order(person_id)]\
md_controls44[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_22f <- subset(md_controls44, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_22f <- subset(md_controls44, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_22f2 <- multi_22f[,c(1,2,3,4)]\
multi_22f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full44$person_id)]\
\
##Rematch the used PIDs\
\
control22_f_d2 <- subset(control_pop_f,  index_age >=1770 & index_age<1840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control22_f_d2)\
match_age22f_d2 <- rbind(multi_22f2, control22_f_d2)\
m_age22f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age22f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age22f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full44_d2 <- cbind(match_age22f_d2, r2)\
match_full44_d2 = match_full44_d2[!match_full44_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_22f <- unique_22f[,c(1,2,3,4,5,6,7)]\
match_full44_d3 <-rbind(unique_22f, match_full44_d2)\
match_full44_d3 <- subset(match_full44_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full44_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full44_d3$person_id)]\
\
## 1830-1880 days old\
#males\
\
case23_m <- subset(case_pop_m, index_age >=1830 & index_age <1880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case23_m)\
control23_m <- subset(control_pop_m, index_age >=1820 & index_age<1890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control23_m)\
match_age23m <- rbind(case23_m, control23_m)\
setDT(match_age23m)\
\
m_age23m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age23m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age23m$factor\
m23 <- as.data.table(r)\
m23$ID2 <- seq.int(nrow(m23))\
\
match_full45 <- cbind(match_age23m, m23)\
match_full45 = match_full45[!match_full45$r== 'NA',]\
\
md_controls23m <- subset(match_full45, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases23m <- subset(match_full45, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases23m[,.N,by=person_id]\
md_controls23m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls45 <-md_controls23m[order(person_id)]\
md_controls45[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_23m <- subset(md_controls45, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_23m <- subset(md_controls45, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_23m2 <- multi_23m[,c(1,2,3,4)]\
multi_23m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full45$person_id)]\
\
##Rematch the used PIDs\
\
control23_m_d2 <- subset(control_pop_m, index_age >=1820 & index_age<1890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control23_m_d2)\
match_age23m_d2 <- rbind(multi_23m2, control23_m_d2)\
m_age23m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age23m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age23m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full45_d2 <- cbind(match_age23m_d2, r2)\
match_full45_d2 = match_full45_d2[!match_full45_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_23m <- unique_23m[,c(1,2,3,4,5,6,7)]\
match_full45_d3 <-rbind(unique_23m, match_full45_d2)\
match_full45_d3 <- subset(match_full45_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full45_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full45_d3$person_id)]\
\
#females\
case23_f <- subset(case_pop_f, index_age >=1830 & index_age < 1880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case23_f)\
control23_f <- subset(control_pop_f, index_age >=1820 & index_age<1890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control23_f)\
match_age23f <- rbind(case23_f, control23_f)\
setDT(match_age23f)\
\
m_age23f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age23f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age23f$factor\
f23 <- as.data.table(r)\
f23$ID2 <- seq.int(nrow(f23))\
\
match_full46 <- cbind(match_age23f, f23)\
match_full46 = match_full46[!match_full46$r== 'NA',]\
\
md_controls23f <- subset(match_full46, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases23f <- subset(match_full46, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases23f[,.N,by=person_id]\
md_controls23f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls23f$person_id)]\
\
## 1880-1930 days old\
#males\
\
case24_m <- subset(case_pop_m, index_age >=1880 & index_age <1930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case24_m)\
control24_m <- subset(control_pop_m, index_age >=1870 & index_age<1940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control24_m)\
match_age24m <- rbind(case24_m, control24_m)\
setDT(match_age24m)\
\
m_age24m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age24m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age24m$factor\
m24 <- as.data.table(r)\
m24$ID2 <- seq.int(nrow(m24))\
\
match_full47 <- cbind(match_age24m, m24)\
match_full47 = match_full47[!match_full47$r== 'NA',]\
\
md_controls24m <- subset(match_full47, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases24m <- subset(match_full47, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases24m[,.N,by=person_id]\
md_controls24m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls47 <-md_controls24m[order(person_id)]\
md_controls47[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_24m <- subset(md_controls47, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_24m <- subset(md_controls47, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_24m2 <- multi_24m[,c(1,2,3,4)]\
multi_24m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full47$person_id)]\
\
##Rematch the used PIDs\
\
control24_m_d2 <- subset(control_pop_m, index_age >=1870 & index_age<1940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control24_m_d2)\
match_age24m_d2 <- rbind(multi_24m2, control24_m_d2)\
m_age24m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age24m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age24m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full47_d2 <- cbind(match_age24m_d2, r2)\
match_full47_d2 = match_full47_d2[!match_full47_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_24m <- unique_24m[,c(1,2,3,4,5,6,7)]\
match_full47_d3 <-rbind(unique_24m, match_full47_d2)\
match_full47_d3 <- subset(match_full47_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full47_d3[,.N,by=person_id]\
\
#Rematch the duplicate\
md_controls47 <-match_full47_d3[order(person_id)]\
md_controls47[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_24m <- subset(md_controls47, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_24m <- subset(md_controls47, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_24m2 <- multi_24m[,c(1,2,3,4)]\
multi_24m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full47_d3$person_id)]\
\
##Rematch the used PIDs\
\
control24_m_d2 <- subset(control_pop_m, index_age >=1870 & index_age<1940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control24_m_d2)\
match_age24m_d2 <- rbind(multi_24m2, control24_m_d2)\
m_age24m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age24m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age24m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full47_d2 <- cbind(match_age24m_d2, r2)\
match_full47_d2 = match_full47_d2[!match_full47_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_24m <- unique_24m[,c(1,2,3,4,5,6,7)]\
match_full47_d3 <-rbind(unique_24m, match_full47_d2)\
match_full47_d3 <- subset(match_full47_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full47_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full47_d3$person_id)]\
\
#females\
case24_f <- subset(case_pop_f, index_age >=1880 & index_age < 1930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case24_f)\
control24_f <- subset(control_pop_f, index_age >=1870 & index_age<1940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control24_f)\
match_age24f <- rbind(case24_f, control24_f)\
setDT(match_age24f)\
\
m_age24f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age24f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age24f$factor\
f24 <- as.data.table(r)\
f24$ID2 <- seq.int(nrow(f24))\
\
match_full48 <- cbind(match_age24f, f24)\
match_full48 = match_full48[!match_full48$r== 'NA',]\
\
md_controls24f <- subset(match_full48, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases24f <- subset(match_full48, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases24f[,.N,by=person_id]\
md_controls24f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls48 <-md_controls24f[order(person_id)]\
md_controls48[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_24f <- subset(md_controls48, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_24f <- subset(md_controls48, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_24f2 <- multi_24f[,c(1,2,3,4)]\
multi_24f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full48$person_id)]\
\
##Rematch the used PIDs\
\
control24_f_d2 <- subset(control_pop_f,  index_age >=1870 & index_age<1940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control24_f_d2)\
match_age24f_d2 <- rbind(multi_24f2, control24_f_d2)\
m_age24f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age24f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age24f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full48_d2 <- cbind(match_age24f_d2, r2)\
match_full48_d2 = match_full48_d2[!match_full48_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_24f <- unique_24f[,c(1,2,3,4,5,6,7)]\
match_full48_d3 <-rbind(unique_24f, match_full48_d2)\
match_full48_d3 <- subset(match_full48_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full48_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full48_d3$person_id)]\
\
## 1930-1980 days old\
#males\
\
case25_m <- subset(case_pop_m, index_age >=1930 & index_age <1980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case25_m)\
control25_m <- subset(control_pop_m, index_age >=1920 & index_age<1990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control25_m)\
match_age25m <- rbind(case25_m, control25_m)\
setDT(match_age25m)\
\
m_age25m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age25m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age25m$factor\
m25 <- as.data.table(r)\
m25$ID2 <- seq.int(nrow(m25))\
\
match_full49 <- cbind(match_age25m, m25)\
match_full49 = match_full49[!match_full49$r== 'NA',]\
\
md_controls25m <- subset(match_full49, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases25m <- subset(match_full49, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases25m[,.N,by=person_id]\
md_controls25m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls49 <-md_controls25m[order(person_id)]\
md_controls49[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_25m <- subset(md_controls49, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_25m <- subset(md_controls49, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_25m2 <- multi_25m[,c(1,2,3,4)]\
multi_25m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full49$person_id)]\
\
##Rematch the used PIDs\
\
control25_m_d2 <- subset(control_pop_m, index_age >=1920 & index_age<1990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control25_m_d2)\
match_age25m_d2 <- rbind(multi_25m2, control25_m_d2)\
m_age25m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age25m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age25m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full49_d2 <- cbind(match_age25m_d2, r2)\
match_full49_d2 = match_full49_d2[!match_full49_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_25m <- unique_25m[,c(1,2,3,4,5,6,7)]\
match_full49_d3 <-rbind(unique_25m, match_full49_d2)\
match_full49_d3 <- subset(match_full49_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full49_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full49_d3$person_id)]\
\
#females\
case25_f <- subset(case_pop_f, index_age >=1930 & index_age < 1980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case25_f)\
control25_f <- subset(control_pop_f, index_age >=1920 & index_age<1990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control25_f)\
match_age25f <- rbind(case25_f, control25_f)\
setDT(match_age25f)\
\
m_age25f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age25f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age25f$factor\
f25 <- as.data.table(r)\
f25$ID2 <- seq.int(nrow(f25))\
\
match_full50 <- cbind(match_age25f, f25)\
match_full50 = match_full50[!match_full50$r== 'NA',]\
\
\
md_controls25f <- subset(match_full50, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases25f <- subset(match_full50, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases25f[,.N,by=person_id]\
md_controls25f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls50 <-md_controls25f[order(person_id)]\
md_controls50[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_25f <- subset(md_controls50, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_25f <- subset(md_controls50, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_25f2 <- multi_25f[,c(1,2,3,4)]\
multi_25f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full50$person_id)]\
\
##Rematch the used PIDs\
\
control25_f_d2 <- subset(control_pop_f, index_age >=1920 & index_age<1990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control25_f_d2)\
match_age25f_d2 <- rbind(multi_25f2, control25_f_d2)\
m_age25f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age25f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age25f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full50_d2 <- cbind(match_age25f_d2, r2)\
match_full50_d2 = match_full50_d2[!match_full50_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_25f <- unique_25f[,c(1,2,3,4,5,6,7)]\
match_full50_d3 <-rbind(unique_25f, match_full50_d2)\
match_full50_d3 <- subset(match_full50_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full50_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full50_d3$person_id)]\
\
##combine all matched data: round 5\
\
colnames(match_full41_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full42_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full43_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full44_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full45_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls23f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full47_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full48_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full49_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full50_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_5 <- rbind(match_full41_d3, match_full42_d3, match_full43_d3, match_full44_d3, match_full45_d3, md_controls23f, match_full47_d3, match_full48_d3, match_full49_d3, match_full50_d3)\
setDT(match_total_5)\
\
match_total_5[,.N,by=person_id]\
\
write.csv(match_total_5, 'match_total_5.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_5,  c("person_id","num_of_prior_visits"))\
\
mt5_matched_measures3= f[match_total_5]\
mt5_matched_measures4 <- mt5_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt5_matched_measures4)\
\
setkeyv(mt5_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt5_control_conditions= conditions2[mt5_matched_measures4]\
\
mt5_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt5_cont_pre_index <- match_total_5[,c(1,4)]\
mt5_cont_pre_index$pre <- mt5_cont_pre_index[, 2] -1\
mt5_cont_pre_index2 <- mt5_cont_pre_index[,c(1,3)]\
colnames(mt5_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt5_cont_pre_index2)\
setkeyv(mt5_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt5_matched_pre_measures= f[mt5_cont_pre_index2]\
\
mt5_matched_pre_measures2 <- mt5_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt5_matched_pre_measures2)\
\
setkeyv(mt5_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt5_control_conditions_pre= conditions2[mt5_matched_pre_measures2]\
\
mt5_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt5_cont_post_index <- match_total_5[,c(1,4)]\
mt5_cont_post_index$post <- mt5_cont_pre_index[, 2] +1\
mt5_cont_post_index2 <- mt5_cont_post_index[,c(1,3)]\
colnames(mt5_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt5_cont_post_index2)\
setkeyv(mt5_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt5_matched_post_measures= f[mt5_cont_post_index2]\
\
mt5_matched_post_measures2 <- mt5_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt5_matched_post_measures2)\
\
setkeyv(mt5_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt5_control_conditions_post= conditions2[mt5_matched_post_measures2]\
\
mt5_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt5_control_conditions_post= mt5_control_conditions_post[!mt5_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt5_control_conditions_post$Timing_Class = '3'\
mt5_control_conditions_pre$Timing_Class = '1'\
mt5_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_5$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_5$person_id)]\
\
#Combine all clinical observations for the fifth set\
full_con_5 <- rbind(mt5_control_conditions_pre, mt5_control_conditions, mt5_control_conditions_post)\
setDT(full_con_5)\
full_con_5[,.N,by=person_id]\
\
\
## 1980-2030 days old\
#males\
\
case26_m <- subset(case_pop_m, index_age >=1980 & index_age <2030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case26_m)\
control26_m <- subset(control_pop_m, index_age >=1970 & index_age<2040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control26_m)\
match_age26m <- rbind(case26_m, control26_m)\
setDT(match_age26m)\
\
m_age26m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age26m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age26m$factor\
m26 <- as.data.table(r)\
m26$ID2 <- seq.int(nrow(m26))\
\
match_full51 <- cbind(match_age26m, m26)\
match_full51 = match_full51[!match_full51$r== 'NA',]\
\
md_controls26m <- subset(match_full51, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases26m <- subset(match_full51, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases26m[,.N,by=person_id]\
md_controls26m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls51 <-md_controls26m[order(person_id)]\
md_controls51[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_26m <- subset(md_controls51, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_26m <- subset(md_controls51, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_26m2 <- multi_26m[,c(1,2,3,4)]\
multi_26m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full51$person_id)]\
\
##Rematch the used PIDs\
\
control26_m_d2 <- subset(control_pop_m, index_age >=1970 & index_age<2040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control26_m_d2)\
match_age26m_d2 <- rbind(multi_26m2, control26_m_d2)\
m_age26m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age26m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age26m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full51_d2 <- cbind(match_age26m_d2, r2)\
match_full51_d2 = match_full51_d2[!match_full51_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_26m <- unique_26m[,c(1,2,3,4,5,6,7)]\
match_full51_d3 <-rbind(unique_26m, match_full51_d2)\
match_full51_d3 <- subset(match_full51_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full51_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full51_d3$person_id)]\
\
#females\
case26_f <- subset(case_pop_f, index_age >=1980 & index_age < 2030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case26_f)\
control26_f <- subset(control_pop_f, index_age >=1970 & index_age<2040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control26_f)\
match_age26f <- rbind(case26_f, control26_f)\
setDT(match_age26f)\
\
m_age26f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age26f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age26f$factor\
f26 <- as.data.table(r)\
f26$ID2 <- seq.int(nrow(f26))\
\
match_full52 <- cbind(match_age26f, f26)\
match_full52 = match_full52[!match_full52$r== 'NA',]\
\
md_controls26f <- subset(match_full52, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases26f <- subset(match_full52, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases26f[,.N,by=person_id]\
md_controls26f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls52 <-md_controls26f[order(person_id)]\
md_controls52[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_26f <- subset(md_controls52, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_26f <- subset(md_controls52, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_26f2 <- multi_26f[,c(1,2,3,4)]\
multi_26f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full52$person_id)]\
\
##Rematch the used PIDs\
\
control26_f_d2 <- subset(control_pop_f, index_age >=1970 & index_age<2040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control26_f_d2)\
match_age26f_d2 <- rbind(multi_26f2, control26_f_d2)\
m_age26f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age26f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age26f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full52_d2 <- cbind(match_age26f_d2, r2)\
match_full52_d2 = match_full52_d2[!match_full52_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_26f <- unique_26f[,c(1,2,3,4,5,6,7)]\
match_full52_d3 <-rbind(unique_26f, match_full52_d2)\
match_full52_d3 <- subset(match_full52_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full52_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full52_d3$person_id)]\
\
## 2030-2080 days old\
#males\
\
case27_m <- subset(case_pop_m, index_age >=2030 & index_age <2080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case27_m)\
control27_m <- subset(control_pop_m, index_age >=2020 & index_age<2090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control27_m)\
match_age27m <- rbind(case27_m, control27_m)\
setDT(match_age27m)\
\
m_age27m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age27m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age27m$factor\
m27 <- as.data.table(r)\
m27$ID2 <- seq.int(nrow(m27))\
\
match_full53 <- cbind(match_age27m, m27)\
match_full53 = match_full53[!match_full53$r== 'NA',]\
\
\
md_controls27m <- subset(match_full53, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases27m <- subset(match_full53, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases27m[,.N,by=person_id]\
md_controls27m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls53 <-md_controls27m[order(person_id)]\
md_controls53[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_27m <- subset(md_controls53, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_27m <- subset(md_controls53, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_27m2 <- multi_27m[,c(1,2,3,4)]\
multi_27m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full53$person_id)]\
\
##Rematch the used PIDs\
\
control27_m_d2 <- subset(control_pop_m, index_age >=2020 & index_age<2090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control27_m_d2)\
match_age27m_d2 <- rbind(multi_27m2, control27_m_d2)\
m_age27m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age27m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age27m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full53_d2 <- cbind(match_age27m_d2, r2)\
match_full53_d2 = match_full53_d2[!match_full53_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_27m <- unique_27m[,c(1,2,3,4,5,6,7)]\
match_full53_d3 <-rbind(unique_27m, match_full53_d2)\
match_full53_d3 <- subset(match_full53_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full53_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full53_d3$person_id)]\
\
#females\
case27_f <- subset(case_pop_f, index_age >=2030 & index_age < 2080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case27_f)\
control27_f <- subset(control_pop_f, index_age >=2020 & index_age<2090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control27_f)\
match_age27f <- rbind(case27_f, control27_f)\
setDT(match_age27f)\
\
m_age27f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age27f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age27f$factor\
f27 <- as.data.table(r)\
f27$ID2 <- seq.int(nrow(f27))\
\
match_full54 <- cbind(match_age27f, f27)\
match_full54 = match_full54[!match_full54$r== 'NA',]\
\
md_controls27f <- subset(match_full54, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases27f <- subset(match_full54, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases27f[,.N,by=person_id]\
md_controls27f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls54 <-md_controls27f[order(person_id)]\
md_controls54[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_27f <- subset(md_controls54, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_27f <- subset(md_controls54, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_27f2 <- multi_27f[,c(1,2,3,4)]\
multi_27f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full54$person_id)]\
\
##Rematch the used PIDs\
\
control27_f_d2 <- subset(control_pop_f, index_age >=2020 & index_age<2090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control27_f_d2)\
match_age27f_d2 <- rbind(multi_27f2, control27_f_d2)\
m_age27f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age27f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age27f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full54_d2 <- cbind(match_age27f_d2, r2)\
match_full54_d2 = match_full54_d2[!match_full54_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_27f <- unique_27f[,c(1,2,3,4,5,6,7)]\
match_full54_d3 <-rbind(unique_27f, match_full54_d2)\
match_full54_d3 <- subset(match_full54_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full54_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full54_d3$person_id)]\
\
## 2080-2130 days old\
#males\
\
case28_m <- subset(case_pop_m, index_age >=2080 & index_age <2130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case28_m)\
control28_m <- subset(control_pop_m, index_age >=2070 & index_age<2140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control28_m)\
match_age28m <- rbind(case28_m, control28_m)\
setDT(match_age28m)\
\
m_age28m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age28m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age28m$factor\
m28 <- as.data.table(r)\
m28$ID2 <- seq.int(nrow(m28))\
\
match_full55 <- cbind(match_age28m, m28)\
match_full55 = match_full55[!match_full55$r== 'NA',]\
\
md_controls28m <- subset(match_full55, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases28m <- subset(match_full55, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases28m[,.N,by=person_id]\
md_controls28m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls28m$person_id)]\
\
\
#females\
case28_f <- subset(case_pop_f, index_age >=2080 & index_age < 2130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case28_f)\
control28_f <- subset(control_pop_f, index_age >=2070 & index_age<2140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control28_f)\
match_age28f <- rbind(case28_f, control28_f)\
setDT(match_age28f)\
\
m_age28f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age28f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age28f$factor\
f28 <- as.data.table(r)\
f28$ID2 <- seq.int(nrow(f28))\
\
match_full56 <- cbind(match_age28f, f28)\
match_full56 = match_full56[!match_full56$r== 'NA',]\
\
md_controls28f <- subset(match_full56, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases28f <- subset(match_full56, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases28f[,.N,by=person_id]\
md_controls28f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls56 <-md_controls28f[order(person_id)]\
md_controls56[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_28f <- subset(md_controls56, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_28f <- subset(md_controls56, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_28f2 <- multi_28f[,c(1,2,3,4)]\
multi_28f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full56$person_id)]\
\
##Rematch the used PIDs\
\
control28_f_d2 <- subset(control_pop_f, index_age >=2070 & index_age<2140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control28_f_d2)\
match_age28f_d2 <- rbind(multi_28f2, control28_f_d2)\
m_age28f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age28f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age28f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full56_d2 <- cbind(match_age28f_d2, r2)\
match_full56_d2 = match_full56_d2[!match_full56_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_28f <- unique_28f[,c(1,2,3,4,5,6,7)]\
match_full56_d3 <-rbind(unique_28f, match_full56_d2)\
match_full56_d3 <- subset(match_full56_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full56_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full56_d3$person_id)]\
\
## 2130-2180 days old\
#males\
\
case29_m <- subset(case_pop_m, index_age >=2130 & index_age <2180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case29_m)\
control29_m <- subset(control_pop_m, index_age >=2120 & index_age<2190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control29_m)\
match_age29m <- rbind(case29_m, control29_m)\
setDT(match_age29m)\
\
m_age29m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age29m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age29m$factor\
m29 <- as.data.table(r)\
m29$ID2 <- seq.int(nrow(m29))\
\
match_full57 <- cbind(match_age29m, m29)\
match_full57 = match_full57[!match_full57$r== 'NA',]\
\
md_controls29m <- subset(match_full57, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases29m <- subset(match_full57, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases29m[,.N,by=person_id]\
md_controls29m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls57 <-md_controls29m[order(person_id)]\
md_controls57[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_29m <- subset(md_controls57, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_29m <- subset(md_controls57, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_29m2 <- multi_29m[,c(1,2,3,4)]\
multi_29m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full57$person_id)]\
\
##Rematch the used PIDs\
\
control29_m_d2 <- subset(control_pop_m,index_age >=2120 & index_age<2190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control29_m_d2)\
match_age29m_d2 <- rbind(multi_29m2, control29_m_d2)\
m_age29m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age29m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age29m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full57_d2 <- cbind(match_age29m_d2, r2)\
match_full57_d2 = match_full57_d2[!match_full57_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_29m <- unique_29m[,c(1,2,3,4,5,6,7)]\
match_full57_d3 <-rbind(unique_29m, match_full57_d2)\
match_full57_d3 <- subset(match_full57_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full57_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full57_d3$person_id)]\
\
#females\
case29_f <- subset(case_pop_f, index_age >=2130 & index_age < 2180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case29_f)\
control29_f <- subset(control_pop_f, index_age >=2120 & index_age<2190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control29_f)\
match_age29f <- rbind(case29_f, control29_f)\
setDT(match_age29f)\
\
m_age29f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age29f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age29f$factor\
f29 <- as.data.table(r)\
f29$ID2 <- seq.int(nrow(f29))\
\
match_full58 <- cbind(match_age29f, f29)\
match_full58 = match_full58[!match_full58$r== 'NA',]\
\
\
md_controls29f <- subset(match_full58, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases29f <- subset(match_full58, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases29f[,.N,by=person_id]\
md_controls29f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls58 <-md_controls29f[order(person_id)]\
md_controls58[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_29f <- subset(md_controls58, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_29f <- subset(md_controls58, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_29f2 <- multi_29f[,c(1,2,3,4)]\
multi_29f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full58$person_id)]\
\
##Rematch the used PIDs\
\
control29_f_d2 <- subset(control_pop_f, index_age >=2120 & index_age<2190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control29_f_d2)\
match_age29f_d2 <- rbind(multi_29f2, control29_f_d2)\
m_age29f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age29f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age29f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full58_d2 <- cbind(match_age29f_d2, r2)\
match_full58_d2 = match_full58_d2[!match_full58_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_29f <- unique_29f[,c(1,2,3,4,5,6,7)]\
match_full58_d3 <-rbind(unique_29f, match_full58_d2)\
match_full58_d3 <- subset(match_full58_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full58_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full58_d3$person_id)]\
\
## 2180-2230 days old\
#males\
\
case30_m <- subset(case_pop_m, index_age >=2180 & index_age <2230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case30_m)\
control30_m <- subset(control_pop_m, index_age >=2170 & index_age<2240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control30_m)\
match_age30m <- rbind(case30_m, control30_m)\
setDT(match_age30m)\
\
m_age30m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age30m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age30m$factor\
m30 <- as.data.table(r)\
m30$ID2 <- seq.int(nrow(m30))\
\
match_full59 <- cbind(match_age30m, m30)\
match_full59 = match_full59[!match_full59$r== 'NA',]\
\
md_controls30m <- subset(match_full59, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases30m <- subset(match_full59, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases30m[,.N,by=person_id]\
md_controls30m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls59 <-md_controls30m[order(person_id)]\
md_controls59[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_30m <- subset(md_controls59, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_30m <- subset(md_controls59, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_30m2 <- multi_30m[,c(1,2,3,4)]\
multi_30m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full59$person_id)]\
\
##Rematch the used PIDs\
\
control30_m_d2 <- subset(control_pop_m, index_age >=2170 & index_age<2240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control30_m_d2)\
match_age30m_d2 <- rbind(multi_30m2, control30_m_d2)\
m_age30m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age30m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age30m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full59_d2 <- cbind(match_age30m_d2, r2)\
match_full59_d2 = match_full59_d2[!match_full59_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_30m <- unique_30m[,c(1,2,3,4,5,6,7)]\
match_full59_d3 <-rbind(unique_30m, match_full59_d2)\
match_full59_d3 <- subset(match_full59_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full59_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full59_d3$person_id)]\
\
#females\
case30_f <- subset(case_pop_f, index_age >=2180 & index_age < 2230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case30_f)\
control30_f <- subset(control_pop_f, index_age >=2170 & index_age<2240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control30_f)\
match_age30f <- rbind(case30_f, control30_f)\
setDT(match_age30f)\
\
m_age30f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age30f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age30f$factor\
f30 <- as.data.table(r)\
f30$ID2 <- seq.int(nrow(f30))\
\
match_full60 <- cbind(match_age30f, f30)\
match_full60 = match_full60[!match_full60$r== 'NA',]\
\
md_controls30f <- subset(match_full60, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases30f <- subset(match_full60, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases30f[,.N,by=person_id]\
md_controls30f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls60 <-md_controls30f[order(person_id)]\
md_controls60[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_30f <- subset(md_controls60, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_30f <- subset(md_controls60, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_30f2 <- multi_30f[,c(1,2,3,4)]\
multi_30f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full60$person_id)]\
\
##Rematch the used PIDs\
\
control30_f_d2 <- subset(control_pop_f, index_age >=2170 & index_age<2240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control30_f_d2)\
match_age30f_d2 <- rbind(multi_30f2, control30_f_d2)\
m_age30f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age30f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age30f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full60_d2 <- cbind(match_age30f_d2, r2)\
match_full60_d2 = match_full60_d2[!match_full60_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_30f <- unique_30f[,c(1,2,3,4,5,6,7)]\
match_full60_d3 <-rbind(unique_30f, match_full60_d2)\
match_full60_d3 <- subset(match_full60_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full60_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full60_d3$person_id)]\
\
##combine all matched data: round 6\
\
colnames(match_full51_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full52_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full53_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full54_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls28m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full56_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full57_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full58_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full59_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full60_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_6 <- rbind(match_full51_d3, match_full52_d3, match_full53_d3, match_full54_d3, md_controls28m, match_full56_d3, match_full57_d3, match_full58_d3, match_full59_d3, match_full60_d3)\
setDT(match_total_6)\
\
match_total_6[,.N,by=person_id]\
\
write.csv(match_total_6, 'match_total_6.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_6,  c("person_id","num_of_prior_visits"))\
\
mt6_matched_measures3= f[match_total_6]\
mt6_matched_measures4 <- mt6_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt6_matched_measures4)\
\
setkeyv(mt6_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt6_control_conditions= conditions2[mt6_matched_measures4]\
\
mt6_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt6_cont_pre_index <- match_total_6[,c(1,4)]\
mt6_cont_pre_index$pre <- mt6_cont_pre_index[, 2] -1\
mt6_cont_pre_index2 <- mt6_cont_pre_index[,c(1,3)]\
colnames(mt6_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt6_cont_pre_index2)\
setkeyv(mt6_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt6_matched_pre_measures= f[mt6_cont_pre_index2]\
\
mt6_matched_pre_measures2 <- mt6_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt6_matched_pre_measures2)\
\
setkeyv(mt6_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt6_control_conditions_pre= conditions2[mt6_matched_pre_measures2]\
\
mt6_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt6_cont_post_index <- match_total_6[,c(1,4)]\
mt6_cont_post_index$post <- mt6_cont_pre_index[, 2] +1\
mt6_cont_post_index2 <- mt6_cont_post_index[,c(1,3)]\
colnames(mt6_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt6_cont_post_index2)\
setkeyv(mt6_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt6_matched_post_measures= f[mt6_cont_post_index2]\
\
mt6_matched_post_measures2 <- mt6_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt6_matched_post_measures2)\
\
setkeyv(mt6_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt6_control_conditions_post= conditions2[mt6_matched_post_measures2]\
\
mt6_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt6_control_conditions_post= mt6_control_conditions_post[!mt6_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt6_control_conditions_post$Timing_Class = '3'\
mt6_control_conditions_pre$Timing_Class = '1'\
mt6_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_6$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_6$person_id)]\
\
#Combine all clinical observations from the 6th set\
full_con_6 <- rbind(mt6_control_conditions_pre, mt6_control_conditions, mt6_control_conditions_post)\
setDT(full_con_6)\
full_con_6[,.N,by=person_id]\
\
\
## 2230-2280 days old\
#males\
\
case31_m <- subset(case_pop_m, index_age >=2230 & index_age <2280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case31_m)\
control31_m <- subset(control_pop_m, index_age >=2220 & index_age<2290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control31_m)\
control31_m <- control31_m[!(person_id %in% match_full59$person_id)]\
match_age31m <- rbind(case31_m, control31_m)\
setDT(match_age31m)\
\
m_age31m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age31m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age31m$factor\
m31 <- as.data.table(r)\
m31$ID2 <- seq.int(nrow(m31))\
\
match_full61 <- cbind(match_age31m, m31)\
match_full61 = match_full61[!match_full61$r== 'NA',]\
\
md_controls31m <- subset(match_full61, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases31m <- subset(match_full61, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases31m[,.N,by=person_id]\
md_controls31m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls61 <-md_controls31m[order(person_id)]\
md_controls61[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_31m <- subset(md_controls61, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_31m <- subset(md_controls61, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_31m2 <- multi_31m[,c(1,2,3,4)]\
multi_31m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full61$person_id)]\
\
##Rematch the used PIDs\
\
control31_m_d2 <- subset(control_pop_m, index_age >=2220 & index_age<2290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control31_m_d2)\
match_age31m_d2 <- rbind(multi_31m2, control31_m_d2)\
m_age31m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age31m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age31m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full61_d2 <- cbind(match_age31m_d2, r2)\
match_full61_d2 = match_full61_d2[!match_full61_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_31m <- unique_31m[,c(1,2,3,4,5,6,7)]\
match_full61_d3 <-rbind(unique_31m, match_full61_d2)\
match_full61_d3 <- subset(match_full61_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full61_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full61_d3$person_id)]\
\
#females\
case31_f <- subset(case_pop_f, index_age >=2230 & index_age < 2280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case31_f)\
control31_f <- subset(control_pop_f, index_age >=2220 & index_age<2290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control31_f)\
match_age31f <- rbind(case31_f, control31_f)\
setDT(match_age31f)\
\
m_age31f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age31f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age31f$factor\
f31 <- as.data.table(r)\
f31$ID2 <- seq.int(nrow(f31))\
\
match_full62 <- cbind(match_age31f, f31)\
match_full62 = match_full62[!match_full62$r== 'NA',]\
\
md_controls31f <- subset(match_full62, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases31f <- subset(match_full62, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases31f[,.N,by=person_id]\
md_controls31f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls62 <-md_controls31f[order(person_id)]\
md_controls62[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_31f <- subset(md_controls62, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_31f <- subset(md_controls62, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_31f2 <- multi_31f[,c(1,2,3,4)]\
multi_31f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full62$person_id)]\
\
##Rematch the used PIDs\
\
control31_f_d2 <- subset(control_pop_f, index_age >=2220 & index_age<2290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control31_f_d2)\
match_age31f_d2 <- rbind(multi_31f2, control31_f_d2)\
m_age31f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age31f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age31f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full62_d2 <- cbind(match_age31f_d2, r2)\
match_full62_d2 = match_full62_d2[!match_full62_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_31f <- unique_31f[,c(1,2,3,4,5,6,7)]\
match_full62_d3 <-rbind(unique_31f, match_full62_d2)\
match_full62_d3 <- subset(match_full62_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full62_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full62_d3$person_id)]\
\
## 2280-2330 days old\
#males\
\
case32_m <- subset(case_pop_m, index_age >=2280 & index_age <2330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case32_m)\
control32_m <- subset(control_pop_m, index_age >=2270 & index_age<2340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control32_m)\
match_age32m <- rbind(case32_m, control32_m)\
setDT(match_age32m)\
\
m_age32m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age32m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age32m$factor\
m32 <- as.data.table(r)\
m32$ID2 <- seq.int(nrow(m32))\
\
match_full63 <- cbind(match_age32m, m32)\
match_full63 = match_full63[!match_full63$r== 'NA',]\
\
md_controls32m <- subset(match_full63, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases32m <- subset(match_full63, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases32m[,.N,by=person_id]\
md_controls32m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls32m$person_id)]\
\
#females\
case32_f <- subset(case_pop_f, index_age >=2280 & index_age < 2330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case32_f)\
control32_f <- subset(control_pop_f, index_age >=2270 & index_age<2340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control32_f)\
match_age32f <- rbind(case32_f, control32_f)\
setDT(match_age32f)\
\
m_age32f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age32f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age32f$factor\
f32 <- as.data.table(r)\
f32$ID2 <- seq.int(nrow(f32))\
\
match_full64 <- cbind(match_age32f, f32)\
match_full64 = match_full64[!match_full64$r== 'NA',]\
\
match_full62 <- cbind(match_age31f, f31)\
match_full62 = match_full62[!match_full62$r== 'NA',]\
\
md_controls32f <- subset(match_full64, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases32f <- subset(match_full64, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases32f[,.N,by=person_id]\
md_controls32f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls32f$person_id)]\
\
## 2330-2380 days old\
#males\
\
case33_m <- subset(case_pop_m, index_age >=2330 & index_age <2380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case33_m)\
control33_m <- subset(control_pop_m, index_age >=2320 & index_age<2390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control33_m)\
match_age33m <- rbind(case33_m, control33_m)\
setDT(match_age33m)\
\
m_age33m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age33m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age33m$factor\
m33 <- as.data.table(r)\
m33$ID2 <- seq.int(nrow(m33))\
\
match_full65 <- cbind(match_age33m, m33)\
match_full65 = match_full65[!match_full65$r== 'NA',]\
\
md_controls33m <- subset(match_full65, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases33m <- subset(match_full65, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases33m[,.N,by=person_id]\
md_controls33m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls65 <-md_controls33m[order(person_id)]\
md_controls65[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_33m <- subset(md_controls65, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_33m <- subset(md_controls65, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_33m2 <- multi_33m[,c(1,2,3,4)]\
multi_33m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full65$person_id)]\
\
##Rematch the used PIDs\
\
control33_m_d2 <- subset(control_pop_m, index_age >=2320 & index_age<2390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control33_m_d2)\
match_age33m_d2 <- rbind(multi_33m2, control33_m_d2)\
m_age33m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age33m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age33m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full65_d2 <- cbind(match_age33m_d2, r2)\
match_full65_d2 = match_full65_d2[!match_full65_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_33m <- unique_33m[,c(1,2,3,4,5,6,7)]\
match_full65_d3 <-rbind(unique_33m, match_full65_d2)\
match_full65_d3 <- subset(match_full65_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full65_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full65_d3$person_id)]\
\
#females\
case33_f <- subset(case_pop_f, index_age >=2330 & index_age < 2380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case33_f)\
control33_f <- subset(control_pop_f, index_age >=2320 & index_age<2390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control33_f)\
match_age33f <- rbind(case33_f, control33_f)\
setDT(match_age33f)\
\
m_age33f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age33f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age33f$factor\
f33 <- as.data.table(r)\
f33$ID2 <- seq.int(nrow(f33))\
\
match_full66 <- cbind(match_age33f, f33)\
match_full66 = match_full66[!match_full66$r== 'NA',]\
\
md_controls33f <- subset(match_full66, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases33f <- subset(match_full66, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases33f[,.N,by=person_id]\
md_controls33f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls66 <-md_controls33f[order(person_id)]\
md_controls66[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_33f <- subset(md_controls66, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_33f <- subset(md_controls66, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_33f2 <- multi_33f[,c(1,2,3,4)]\
multi_33f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full66$person_id)]\
\
##Rematch the used PIDs\
\
control33_f_d2 <- subset(control_pop_f, index_age >=2320 & index_age<2390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control33_f_d2)\
match_age33f_d2 <- rbind(multi_33f2, control33_f_d2)\
m_age33f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age33f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age33f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full66_d2 <- cbind(match_age33f_d2, r2)\
match_full66_d2 = match_full66_d2[!match_full66_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_33f <- unique_33f[,c(1,2,3,4,5,6,7)]\
match_full66_d3 <-rbind(unique_33f, match_full66_d2)\
match_full66_d3 <- subset(match_full66_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full66_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full66_d3$person_id)]\
\
## 2380-2430 days old\
#males\
\
case34_m <- subset(case_pop_m, index_age >=2380 & index_age <2430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case34_m)\
control34_m <- subset(control_pop_m, index_age >=2370 & index_age<2440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control34_m)\
match_age34m <- rbind(case34_m, control34_m)\
setDT(match_age34m)\
\
m_age34m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age34m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age34m$factor\
m34 <- as.data.table(r)\
m34$ID2 <- seq.int(nrow(m34))\
\
match_full67 <- cbind(match_age34m, m34)\
match_full67 = match_full67[!match_full67$r== 'NA',]\
md_controls34m <- subset(match_full67, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases34m <- subset(match_full67, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases34m[,.N,by=person_id]\
md_controls34m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls67 <-md_controls34m[order(person_id)]\
md_controls67[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_34m <- subset(md_controls67, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_34m <- subset(md_controls67, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_34m2 <- multi_34m[,c(1,2,3,4)]\
multi_34m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full67$person_id)]\
\
##Rematch the used PIDs\
\
control34_m_d2 <- subset(control_pop_m,index_age >=2370 & index_age<2440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control34_m_d2)\
match_age34m_d2 <- rbind(multi_34m2, control34_m_d2)\
m_age34m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age34m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age34m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full67_d2 <- cbind(match_age34m_d2, r2)\
match_full67_d2 = match_full67_d2[!match_full67_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_34m <- unique_34m[,c(1,2,3,4,5,6,7)]\
match_full67_d3 <-rbind(unique_34m, match_full67_d2)\
match_full67_d3 <- subset(match_full67_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full67_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full67_d3$person_id)]\
\
#Rematch the duplicate\
md_controls67 <-match_full67_d3[order(person_id)]\
md_controls67[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_34m <- subset(md_controls67, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_34m <- subset(md_controls67, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_34m2 <- multi_34m[,c(1,2,3,4)]\
multi_34m2$casecont = 'case'\
\
##Rematch the used PIDs\
\
control34_m_d2 <- subset(control_pop_m,index_age >=2370 & index_age<2440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control34_m_d2)\
match_age34m_d2 <- rbind(multi_34m2, control34_m_d2)\
m_age34m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age34m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age34m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full67_d2 <- cbind(match_age34m_d2, r2)\
match_full67_d2 = match_full67_d2[!match_full67_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_34m <- unique_34m[,c(1,2,3,4,5,6,7)]\
match_full67_d3 <-rbind(unique_34m, match_full67_d2)\
match_full67_d3 <- subset(match_full67_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full67_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full67_d3$person_id)]\
\
#females\
case34_f <- subset(case_pop_f, index_age >=2380 & index_age < 2430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case34_f)\
control34_f <- subset(control_pop_f, index_age >=2370 & index_age<2440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control34_f)\
match_age34f <- rbind(case34_f, control34_f)\
setDT(match_age34f)\
\
m_age34f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age34f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age34f$factor\
f34 <- as.data.table(r)\
f34$ID2 <- seq.int(nrow(f34))\
\
match_full68 <- cbind(match_age34f, f34)\
match_full68 = match_full68[!match_full68$r== 'NA',]\
\
md_controls34f <- subset(match_full68, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases34f <- subset(match_full68, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases34f[,.N,by=person_id]\
md_controls34f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls68 <-md_controls34f[order(person_id)]\
md_controls68[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_34f <- subset(md_controls68, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_34f <- subset(md_controls68, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_34f2 <- multi_34f[,c(1,2,3,4)]\
multi_34f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full68$person_id)]\
\
##Rematch the used PIDs\
\
control34_f_d2 <- subset(control_pop_f, index_age >=2370 & index_age<2440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control34_f_d2)\
match_age34f_d2 <- rbind(multi_34f2, control34_f_d2)\
m_age34f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age34f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age34f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full68_d2 <- cbind(match_age34f_d2, r2)\
match_full68_d2 = match_full68_d2[!match_full68_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_34f <- unique_34f[,c(1,2,3,4,5,6,7)]\
match_full68_d3 <-rbind(unique_34f, match_full68_d2)\
match_full68_d3 <- subset(match_full68_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full68_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full68_d3$person_id)]\
\
## 2430-2480 days old\
#males\
\
case35_m <- subset(case_pop_m, index_age >=2430 & index_age <2480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case35_m)\
control35_m <- subset(control_pop_m, index_age >=2420 & index_age<2490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control35_m)\
match_age35m <- rbind(case35_m, control35_m)\
setDT(match_age35m)\
\
m_age35m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age35m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age35m$factor\
m35 <- as.data.table(r)\
m35$ID2 <- seq.int(nrow(m35))\
\
match_full69 <- cbind(match_age35m, m35)\
match_full69 = match_full69[!match_full69$r== 'NA',]\
\
md_controls35m <- subset(match_full69, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases35m <- subset(match_full69, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases35m[,.N,by=person_id]\
md_controls35m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls69 <-md_controls35m[order(person_id)]\
md_controls69[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_35m <- subset(md_controls69, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_35m <- subset(md_controls69, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_35m2 <- multi_35m[,c(1,2,3,4)]\
multi_35m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full69$person_id)]\
\
##Rematch the used PIDs\
\
control35_m_d2 <- subset(control_pop_m,index_age >=2420 & index_age<2490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control35_m_d2)\
match_age35m_d2 <- rbind(multi_35m2, control35_m_d2)\
m_age35m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age35m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age35m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full69_d2 <- cbind(match_age35m_d2, r2)\
match_full69_d2 = match_full69_d2[!match_full69_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_35m <- unique_35m[,c(1,2,3,4,5,6,7)]\
match_full69_d3 <-rbind(unique_35m, match_full69_d2)\
match_full69_d3 <- subset(match_full69_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full69_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full69_d3$person_id)]\
\
#females\
case35_f <- subset(case_pop_f, index_age >=2430 & index_age < 2480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case35_f)\
control35_f <- subset(control_pop_f, index_age >=2420 & index_age<2490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control35_f)\
match_age35f <- rbind(case35_f, control35_f)\
setDT(match_age35f)\
\
m_age35f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age35f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age35f$factor\
f35 <- as.data.table(r)\
f35$ID2 <- seq.int(nrow(f35))\
\
match_full70 <- cbind(match_age35f, f35)\
match_full70 = match_full70[!match_full70$r== 'NA',]\
\
md_controls35f <- subset(match_full70, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases35f <- subset(match_full70, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases35f[,.N,by=person_id]\
md_controls35f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls70 <-md_controls35f[order(person_id)]\
md_controls70[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_35f <- subset(md_controls70, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_35f <- subset(md_controls70, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_35f2 <- multi_35f[,c(1,2,3,4)]\
multi_35f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full70$person_id)]\
\
##Rematch the used PIDs\
\
control35_f_d2 <- subset(control_pop_f, index_age >=2420 & index_age<2490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control35_f_d2)\
match_age35f_d2 <- rbind(multi_35f2, control35_f_d2)\
m_age35f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age35f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age35f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full70_d2 <- cbind(match_age35f_d2, r2)\
match_full70_d2 = match_full70_d2[!match_full70_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_35f <- unique_35f[,c(1,2,3,4,5,6,7)]\
match_full70_d3 <-rbind(unique_35f, match_full70_d2)\
match_full70_d3 <- subset(match_full70_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full70_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full70_d3$person_id)]\
\
##combine all matched data: round 7\
\
colnames(match_full61_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full62_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls32m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls32f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full65_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full66_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full67_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full68_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full69_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full70_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_7 <- rbind(match_full61_d3, match_full62_d3, md_controls32m, md_controls32f, match_full65_d3, match_full66_d3, match_full67_d3, match_full68_d3, match_full69_d3, match_full70_d3)\
setDT(match_total_7)\
\
match_total_7[,.N,by=person_id]\
\
write.csv(match_total_7, 'match_total_7.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_7,  c("person_id","num_of_prior_visits"))\
\
mt7_matched_measures3= f[match_total_7]\
mt7_matched_measures4 <- mt7_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt7_matched_measures4)\
\
setkeyv(mt7_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt7_control_conditions= conditions2[mt7_matched_measures4]\
\
mt7_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt7_cont_pre_index <- match_total_7[,c(1,4)]\
mt7_cont_pre_index$pre <- mt7_cont_pre_index[, 2] -1\
mt7_cont_pre_index2 <- mt7_cont_pre_index[,c(1,3)]\
colnames(mt7_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt7_cont_pre_index2)\
setkeyv(mt7_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt7_matched_pre_measures= f[mt7_cont_pre_index2]\
\
mt7_matched_pre_measures2 <- mt7_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt7_matched_pre_measures2)\
\
setkeyv(mt7_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt7_control_conditions_pre= conditions2[mt7_matched_pre_measures2]\
\
mt7_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt7_cont_post_index <- match_total_7[,c(1,4)]\
mt7_cont_post_index$post <- mt7_cont_pre_index[, 2] +1\
mt7_cont_post_index2 <- mt7_cont_post_index[,c(1,3)]\
colnames(mt7_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt7_cont_post_index2)\
setkeyv(mt7_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt7_matched_post_measures= f[mt7_cont_post_index2]\
\
mt7_matched_post_measures2 <- mt7_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt7_matched_post_measures2)\
\
setkeyv(mt7_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt7_control_conditions_post= conditions2[mt7_matched_post_measures2]\
\
mt7_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt7_control_conditions_post= mt7_control_conditions_post[!mt7_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt7_control_conditions_post$Timing_Class = '3'\
mt7_control_conditions_pre$Timing_Class = '1'\
mt7_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_7$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_7$person_id)]\
\
#Combine all clinical observations from the 7th set\
full_con_7 <- rbind(mt7_control_conditions_pre, mt7_control_conditions, mt7_control_conditions_post)\
setDT(full_con_7)\
full_con_7[,.N,by=person_id]\
\
\
## 2480-2530 days old\
#males\
\
case36_m <- subset(case_pop_m, index_age >=2480 & index_age <2530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case36_m)\
control36_m <- subset(control_pop_m, index_age >=2470 & index_age<2540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control36_m)\
match_age36m <- rbind(case36_m, control36_m)\
setDT(match_age36m)\
\
m_age36m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age36m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age36m$factor\
m36 <- as.data.table(r)\
m36$ID2 <- seq.int(nrow(m36))\
\
match_full71 <- cbind(match_age36m, m36)\
match_full71 = match_full71[!match_full71$r== 'NA',]\
\
md_controls36m <- subset(match_full71, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases36m <- subset(match_full71, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases36m[,.N,by=person_id]\
md_controls36m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls71 <-md_controls36m[order(person_id)]\
md_controls71[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_36m <- subset(md_controls71, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_36m <- subset(md_controls71, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_36m2 <- multi_36m[,c(1,2,3,4)]\
multi_36m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full71$person_id)]\
\
##Rematch the used PIDs\
\
control36_m_d2 <- subset(control_pop_m,index_age >=2470 & index_age<2540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control36_m_d2)\
match_age36m_d2 <- rbind(multi_36m2, control36_m_d2)\
m_age36m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age36m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age36m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full71_d2 <- cbind(match_age36m_d2, r2)\
match_full71_d2 = match_full71_d2[!match_full71_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_36m <- unique_36m[,c(1,2,3,4,5,6,7)]\
match_full71_d3 <-rbind(unique_36m, match_full71_d2)\
match_full71_d3 <- subset(match_full71_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full71_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full71_d3$person_id)]\
\
#females\
case36_f <- subset(case_pop_f, index_age >=2480 & index_age < 2530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case36_f)\
control36_f <- subset(control_pop_f, index_age >=2470 & index_age<2540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control36_f)\
match_age36f <- rbind(case36_f, control36_f)\
setDT(match_age36f)\
\
m_age36f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age36f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age36f$factor\
f36 <- as.data.table(r)\
f36$ID2 <- seq.int(nrow(f36))\
\
match_full72 <- cbind(match_age36f, f36)\
match_full72 = match_full72[!match_full72$r== 'NA',]\
\
md_controls36f <- subset(match_full72, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases36f <- subset(match_full72, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases36f[,.N,by=person_id]\
md_controls36f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls72 <-md_controls36f[order(person_id)]\
md_controls72[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_36f <- subset(md_controls72, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_36f <- subset(md_controls72, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_36f2 <- multi_36f[,c(1,2,3,4)]\
multi_36f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full72$person_id)]\
\
##Rematch the used PIDs\
\
control36_f_d2 <- subset(control_pop_f, index_age >=2470 & index_age<2540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control36_f_d2)\
match_age36f_d2 <- rbind(multi_36f2, control36_f_d2)\
m_age36f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age36f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age36f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full72_d2 <- cbind(match_age36f_d2, r2)\
match_full72_d2 = match_full72_d2[!match_full72_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_36f <- unique_36f[,c(1,2,3,4,5,6,7)]\
match_full72_d3 <-rbind(unique_36f, match_full72_d2)\
match_full72_d3 <- subset(match_full72_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full72_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full72_d3$person_id)]\
\
## 2530-2580 days old\
#males\
\
case37_m <- subset(case_pop_m, index_age >=2530 & index_age <2580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case37_m)\
control37_m <- subset(control_pop_m, index_age >=2520 & index_age<2590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control37_m)\
match_age37m <- rbind(case37_m, control37_m)\
setDT(match_age37m)\
\
m_age37m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age37m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age37m$factor\
m37 <- as.data.table(r)\
m37$ID2 <- seq.int(nrow(m37))\
\
match_full73 <- cbind(match_age37m, m37)\
match_full73 = match_full73[!match_full73$r== 'NA',]\
\
\
md_controls37m <- subset(match_full73, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases37m <- subset(match_full73, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases37m[,.N,by=person_id]\
md_controls37m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls73 <-md_controls37m[order(person_id)]\
md_controls73[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_37m <- subset(md_controls73, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_37m <- subset(md_controls73, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_37m2 <- multi_37m[,c(1,2,3,4)]\
multi_37m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full73$person_id)]\
\
##Rematch the used PIDs\
\
control37_m_d2 <- subset(control_pop_m, index_age >=2520 & index_age<2590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control37_m_d2)\
match_age37m_d2 <- rbind(multi_37m2, control37_m_d2)\
m_age37m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age37m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age37m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full73_d2 <- cbind(match_age37m_d2, r2)\
match_full73_d2 = match_full73_d2[!match_full73_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_37m <- unique_37m[,c(1,2,3,4,5,6,7)]\
match_full73_d3 <-rbind(unique_37m, match_full73_d2)\
match_full73_d3 <- subset(match_full73_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full73_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full73_d3$person_id)]\
\
#Rematch the duplicate\
md_controls73 <-match_full73_d3[order(person_id)]\
md_controls73[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_37m <- subset(md_controls73, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_37m <- subset(md_controls73, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_37m2 <- multi_37m[,c(1,2,3,4)]\
multi_37m2$casecont = 'case'\
\
##Rematch the used PIDs\
\
control37_m_d2 <- subset(control_pop_m, index_age >=2520 & index_age<2590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control37_m_d2)\
match_age37m_d2 <- rbind(multi_37m2, control37_m_d2)\
m_age37m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age37m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age37m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full73_d2 <- cbind(match_age37m_d2, r2)\
match_full73_d2 = match_full73_d2[!match_full73_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_37m <- unique_37m[,c(1,2,3,4,5,6,7)]\
match_full73_d3 <-rbind(unique_37m, match_full73_d2)\
match_full73_d3 <- subset(match_full73_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full73_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full73_d3$person_id)]\
\
#females\
case37_f <- subset(case_pop_f, index_age >=2530 & index_age < 2580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case37_f)\
control37_f <- subset(control_pop_f, index_age >=2520 & index_age<2590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control37_f)\
match_age37f <- rbind(case37_f, control37_f)\
setDT(match_age37f)\
\
m_age37f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age37f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age37f$factor\
f37 <- as.data.table(r)\
f37$ID2 <- seq.int(nrow(f37))\
\
match_full74 <- cbind(match_age37f, f37)\
match_full74 = match_full74[!match_full74$r== 'NA',]\
\
md_controls37f <- subset(match_full74, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases37f <- subset(match_full74, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases37f[,.N,by=person_id]\
md_controls37f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls74 <-md_controls37f[order(person_id)]\
md_controls74[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_37f <- subset(md_controls74, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_37f <- subset(md_controls74, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_37f2 <- multi_37f[,c(1,2,3,4)]\
multi_37f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full74$person_id)]\
\
##Rematch the used PIDs\
\
control37_f_d2 <- subset(control_pop_f, index_age >=2520 & index_age<2590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control37_f_d2)\
match_age37f_d2 <- rbind(multi_37f2, control37_f_d2)\
m_age37f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age37f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age37f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full74_d2 <- cbind(match_age37f_d2, r2)\
match_full74_d2 = match_full74_d2[!match_full74_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_37f <- unique_37f[,c(1,2,3,4,5,6,7)]\
match_full74_d3 <-rbind(unique_37f, match_full74_d2)\
match_full74_d3 <- subset(match_full74_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full74_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full74_d3$person_id)]\
\
## 2580-2630 days old\
#males\
\
case38_m <- subset(case_pop_m, index_age >=2580 & index_age <2630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case38_m)\
control38_m <- subset(control_pop_m, index_age >=2570 & index_age<2640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control38_m)\
match_age38m <- rbind(case38_m, control38_m)\
setDT(match_age38m)\
\
m_age38m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age38m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age38m$factor\
m38 <- as.data.table(r)\
m38$ID2 <- seq.int(nrow(m38))\
\
match_full75 <- cbind(match_age38m, m38)\
match_full75 = match_full75[!match_full75$r== 'NA',]\
\
md_controls38m <- subset(match_full75, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases38m <- subset(match_full75, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases38m[,.N,by=person_id]\
md_controls38m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls75 <-md_controls38m[order(person_id)]\
md_controls75[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_38m <- subset(md_controls75, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_38m <- subset(md_controls75, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_38m2 <- multi_38m[,c(1,2,3,4)]\
multi_38m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full75$person_id)]\
\
##Rematch the used PIDs\
\
control38_m_d2 <- subset(control_pop_m, index_age >=2570 & index_age<2640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control38_m_d2)\
match_age38m_d2 <- rbind(multi_38m2, control38_m_d2)\
m_age38m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age38m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age38m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full75_d2 <- cbind(match_age38m_d2, r2)\
match_full75_d2 = match_full75_d2[!match_full75_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_38m <- unique_38m[,c(1,2,3,4,5,6,7)]\
match_full75_d3 <-rbind(unique_38m, match_full75_d2)\
match_full75_d3 <- subset(match_full75_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full75_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full75_d3$person_id)]\
\
#Rematch the duplicate\
md_controls75 <-match_full75_d3[order(person_id)]\
md_controls75[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_38m <- subset(md_controls75, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_38m <- subset(md_controls75, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_38m2 <- multi_38m[,c(1,2,3,4)]\
multi_38m2$casecont = 'case'\
\
\
##Rematch the used PIDs\
\
control38_m_d2 <- subset(control_pop_m, index_age >=2570 & index_age<2640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control38_m_d2)\
match_age38m_d2 <- rbind(multi_38m2, control38_m_d2)\
m_age38m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age38m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age38m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full75_d2 <- cbind(match_age38m_d2, r2)\
match_full75_d2 = match_full75_d2[!match_full75_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_38m <- unique_38m[,c(1,2,3,4,5,6,7)]\
match_full75_d3 <-rbind(unique_38m, match_full75_d2)\
match_full75_d3 <- subset(match_full75_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full75_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full75_d3$person_id)]\
\
\
#females\
case38_f <- subset(case_pop_f, index_age >=2580 & index_age < 2630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case38_f)\
control38_f <- subset(control_pop_f, index_age >=2570 & index_age<2640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control38_f)\
match_age38f <- rbind(case38_f, control38_f)\
setDT(match_age38f)\
\
m_age38f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age38f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age38f$factor\
f38 <- as.data.table(r)\
f38$ID2 <- seq.int(nrow(f38))\
\
match_full76 <- cbind(match_age38f, f38)\
match_full76 = match_full76[!match_full76$r== 'NA',]\
\
md_controls38f <- subset(match_full76, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases38f <- subset(match_full76, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases38f[,.N,by=person_id]\
md_controls38f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls76 <-md_controls38f[order(person_id)]\
md_controls76[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_38f <- subset(md_controls76, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_38f <- subset(md_controls76, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_38f2 <- multi_38f[,c(1,2,3,4)]\
multi_38f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full76$person_id)]\
\
##Rematch the used PIDs\
\
control38_f_d2 <- subset(control_pop_f, index_age >=2570 & index_age<2640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control38_f_d2)\
match_age38f_d2 <- rbind(multi_38f2, control38_f_d2)\
m_age38f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age38f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age38f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full76_d2 <- cbind(match_age38f_d2, r2)\
match_full76_d2 = match_full76_d2[!match_full76_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_38f <- unique_38f[,c(1,2,3,4,5,6,7)]\
match_full76_d3 <-rbind(unique_38f, match_full76_d2)\
match_full76_d3 <- subset(match_full76_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full76_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full76_d3$person_id)]\
\
## 2630-2680 days old\
#males\
\
case39_m <- subset(case_pop_m, index_age >=2630 & index_age <2680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case39_m)\
control39_m <- subset(control_pop_m, index_age >=2620 & index_age<2690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control39_m)\
match_age39m <- rbind(case39_m, control39_m)\
setDT(match_age39m)\
\
m_age39m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age39m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age39m$factor\
m39 <- as.data.table(r)\
m39$ID2 <- seq.int(nrow(m39))\
\
match_full77 <- cbind(match_age39m, m39)\
match_full77 = match_full77[!match_full77$r== 'NA',]\
\
md_controls39m <- subset(match_full77, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases39m <- subset(match_full77, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases39m[,.N,by=person_id]\
md_controls39m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls77 <-md_controls39m[order(person_id)]\
md_controls77[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_39m <- subset(md_controls77, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_39m <- subset(md_controls77, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_39m2 <- multi_39m[,c(1,2,3,4)]\
multi_39m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full77$person_id)]\
\
##Rematch the used PIDs\
\
control39_m_d2 <- subset(control_pop_m, index_age >=2620 & index_age<2690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control39_m_d2)\
match_age39m_d2 <- rbind(multi_39m2, control39_m_d2)\
m_age39m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age39m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age39m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full77_d2 <- cbind(match_age39m_d2, r2)\
match_full77_d2 = match_full77_d2[!match_full77_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_39m <- unique_39m[,c(1,2,3,4,5,6,7)]\
match_full77_d3 <-rbind(unique_39m, match_full77_d2)\
match_full77_d3 <- subset(match_full77_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full77_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full77_d3$person_id)]\
\
#females\
case39_f <- subset(case_pop_f, index_age >=2630 & index_age < 2680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case39_f)\
control39_f <- subset(control_pop_f, index_age >=2620 & index_age<2690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control39_f)\
match_age39f <- rbind(case39_f, control39_f)\
setDT(match_age39f)\
\
m_age39f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age39f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age39f$factor\
f39 <- as.data.table(r)\
f39$ID2 <- seq.int(nrow(f39))\
\
match_full78 <- cbind(match_age39f, f39)\
match_full78 = match_full78[!match_full78$r== 'NA',]\
\
md_controls39f <- subset(match_full78, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases39f <- subset(match_full78, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases39f[,.N,by=person_id]\
md_controls39f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls78 <-md_controls39f[order(person_id)]\
md_controls78[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_39f <- subset(md_controls78, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_39f <- subset(md_controls78, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_39f2 <- multi_39f[,c(1,2,3,4)]\
multi_39f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full78$person_id)]\
\
##Rematch the used PIDs\
\
control39_f_d2 <- subset(control_pop_f, index_age >=2620 & index_age<2690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control39_f_d2)\
match_age39f_d2 <- rbind(multi_39f2, control39_f_d2)\
m_age39f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age39f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age39f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full78_d2 <- cbind(match_age39f_d2, r2)\
match_full78_d2 = match_full78_d2[!match_full78_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_39f <- unique_39f[,c(1,2,3,4,5,6,7)]\
match_full78_d3 <-rbind(unique_39f, match_full78_d2)\
match_full78_d3 <- subset(match_full78_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full78_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full78_d3$person_id)]\
\
## 2680-2730 days old\
#males\
\
case40_m <- subset(case_pop_m, index_age >=2680 & index_age <2730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case40_m)\
control40_m <- subset(control_pop_m, index_age >=2670 & index_age<2740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control40_m)\
match_age40m <- rbind(case40_m, control40_m)\
setDT(match_age40m)\
\
m_age40m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age40m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age40m$factor\
m40 <- as.data.table(r)\
m40$ID2 <- seq.int(nrow(m40))\
\
match_full79 <- cbind(match_age40m, m40)\
match_full79 = match_full79[!match_full79$r== 'NA',]\
\
md_controls40m <- subset(match_full79, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases40m <- subset(match_full79, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases40m[,.N,by=person_id]\
md_controls40m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls79 <-md_controls40m[order(person_id)]\
md_controls79[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_40m <- subset(md_controls79, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_40m <- subset(md_controls79, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_40m2 <- multi_40m[,c(1,2,3,4)]\
multi_40m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full79$person_id)]\
\
##Rematch the used PIDs\
\
control40_m_d2 <- subset(control_pop_m, index_age >=2670 & index_age<2740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control40_m_d2)\
match_age40m_d2 <- rbind(multi_40m2, control40_m_d2)\
m_age40m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age40m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age40m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full79_d2 <- cbind(match_age40m_d2, r2)\
match_full79_d2 = match_full79_d2[!match_full79_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_40m <- unique_40m[,c(1,2,3,4,5,6,7)]\
match_full79_d3 <-rbind(unique_40m, match_full79_d2)\
match_full79_d3 <- subset(match_full79_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full79_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full79_d3$person_id)]\
\
#females\
case40_f <- subset(case_pop_f, index_age >=2680 & index_age < 2730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case40_f)\
control40_f <- subset(control_pop_f, index_age >=2670 & index_age<2740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control40_f)\
match_age40f <- rbind(case40_f, control40_f)\
setDT(match_age40f)\
\
m_age40f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age40f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age40f$factor\
f40 <- as.data.table(r)\
f40$ID2 <- seq.int(nrow(f40))\
\
match_full80 <- cbind(match_age40f, f40)\
match_full80 = match_full80[!match_full80$r== 'NA',]\
\
md_controls40f <- subset(match_full80, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases40f <- subset(match_full80, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases40f[,.N,by=person_id]\
md_controls40f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls40f$person_id)]\
\
##combine all matched data: round 8\
\
colnames(match_full71_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full72_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full73_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full74_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full75_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full76_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full77_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full78_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full79_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls40f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_8 <- rbind(match_full71_d3, match_full72_d3, match_full73_d3, match_full74_d3, match_full75_d3, match_full76_d3, match_full77_d3, match_full78_d3, match_full79_d3, md_controls40f)\
setDT(match_total_8)\
\
match_total_8[,.N,by=person_id]\
\
write.csv(match_total_8, 'match_total_8.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_8,  c("person_id","num_of_prior_visits"))\
\
mt8_matched_measures3= f[match_total_8]\
mt8_matched_measures4 <- mt8_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt8_matched_measures4)\
\
setkeyv(mt8_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt8_control_conditions= conditions2[mt8_matched_measures4]\
\
mt8_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt8_cont_pre_index <- match_total_8[,c(1,4)]\
mt8_cont_pre_index$pre <- mt8_cont_pre_index[, 2] -1\
mt8_cont_pre_index2 <- mt8_cont_pre_index[,c(1,3)]\
colnames(mt8_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt8_cont_pre_index2)\
setkeyv(mt8_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt8_matched_pre_measures= f[mt8_cont_pre_index2]\
\
mt8_matched_pre_measures2 <- mt8_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt8_matched_pre_measures2)\
\
setkeyv(mt8_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt8_control_conditions_pre= conditions2[mt8_matched_pre_measures2]\
\
mt8_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt8_cont_post_index <- match_total_8[,c(1,4)]\
mt8_cont_post_index$post <- mt8_cont_pre_index[, 2] +1\
mt8_cont_post_index2 <- mt8_cont_post_index[,c(1,3)]\
colnames(mt8_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt8_cont_post_index2)\
setkeyv(mt8_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt8_matched_post_measures= f[mt8_cont_post_index2]\
\
mt8_matched_post_measures2 <- mt8_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt8_matched_post_measures2)\
\
setkeyv(mt8_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt8_control_conditions_post= conditions2[mt8_matched_post_measures2]\
\
mt8_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt8_control_conditions_post= mt8_control_conditions_post[!mt8_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt8_control_conditions_post$Timing_Class = '3'\
mt8_control_conditions_pre$Timing_Class = '1'\
mt8_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_8$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_8$person_id)]\
\
#Combine all clinical observations from the 8th set\
full_con_8 <- rbind(mt8_control_conditions_pre, mt8_control_conditions, mt8_control_conditions_post)\
setDT(full_con_8)\
full_con_8[,.N,by=person_id]\
\
\
## 2730-2780 days old\
#males\
\
case41_m <- subset(case_pop_m, index_age >=2730 & index_age <2780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case41_m)\
control41_m <- subset(control_pop_m, index_age >=2720 & index_age<2790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control41_m)\
match_age41m <- rbind(case41_m, control41_m)\
setDT(match_age41m)\
\
m_age41m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age41m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age41m$factor\
m41 <- as.data.table(r)\
m41$ID2 <- seq.int(nrow(m41))\
\
match_full81 <- cbind(match_age41m, m41)\
match_full81 = match_full81[!match_full81$r== 'NA',]\
\
md_controls41m <- subset(match_full81, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases41m <- subset(match_full81, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases41m[,.N,by=person_id]\
md_controls41m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls81 <-md_controls41m[order(person_id)]\
md_controls81[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_41m <- subset(md_controls81, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_41m <- subset(md_controls81, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_41m2 <- multi_41m[,c(1,2,3,4)]\
multi_41m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full81$person_id)]\
\
##Rematch the used PIDs\
\
control41_m_d2 <- subset(control_pop_m, index_age >=2720 & index_age<2790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control41_m_d2)\
match_age41m_d2 <- rbind(multi_41m2, control41_m_d2)\
m_age41m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age41m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age41m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full81_d2 <- cbind(match_age41m_d2, r2)\
match_full81_d2 = match_full81_d2[!match_full81_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_41m <- unique_41m[,c(1,2,3,4,5,6,7)]\
match_full81_d3 <-rbind(unique_41m, match_full81_d2)\
match_full81_d3 <- subset(match_full81_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full81_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full81_d3$person_id)]\
\
#females\
case41_f <- subset(case_pop_f, index_age >=2730 & index_age < 2780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case41_f)\
control41_f <- subset(control_pop_f, index_age >=2720 & index_age<2790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control41_f)\
match_age41f <- rbind(case41_f, control41_f)\
setDT(match_age41f)\
\
m_age41f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age41f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age41f$factor\
f41 <- as.data.table(r)\
f41$ID2 <- seq.int(nrow(f41))\
\
match_full82 <- cbind(match_age41f, f41)\
match_full82 = match_full82[!match_full82$r== 'NA',]\
\
md_controls41f <- subset(match_full82, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases41f <- subset(match_full82, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases41f[,.N,by=person_id]\
md_controls41f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls82 <-md_controls41f[order(person_id)]\
md_controls82[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_41f <- subset(md_controls82, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_41f <- subset(md_controls82, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_41f2 <- multi_41f[,c(1,2,3,4)]\
multi_41f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full82$person_id)]\
\
##Rematch the used PIDs\
\
control41_f_d2 <- subset(control_pop_f, index_age >=2720 & index_age<2790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control41_f_d2)\
match_age41f_d2 <- rbind(multi_41f2, control41_f_d2)\
m_age41f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age41f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age41f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full82_d2 <- cbind(match_age41f_d2, r2)\
match_full82_d2 = match_full82_d2[!match_full82_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_41f <- unique_41f[,c(1,2,3,4,5,6,7)]\
match_full82_d3 <-rbind(unique_41f, match_full82_d2)\
match_full82_d3 <- subset(match_full82_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full82_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full82_d3$person_id)]\
\
## 2780-2830 days old\
#males\
\
case42_m <- subset(case_pop_m, index_age >=2780 & index_age <2830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case42_m)\
control42_m <- subset(control_pop_m, index_age >=2770 & index_age<2840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control42_m)\
match_age42m <- rbind(case42_m, control42_m)\
setDT(match_age42m)\
\
m_age42m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age42m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age42m$factor\
m42 <- as.data.table(r)\
m42$ID2 <- seq.int(nrow(m42))\
\
match_full83 <- cbind(match_age42m, m42)\
match_full83 = match_full83[!match_full83$r== 'NA',]\
\
md_controls42m <- subset(match_full83, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases42m <- subset(match_full83, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases42m[,.N,by=person_id]\
md_controls42m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls83 <-md_controls42m[order(person_id)]\
md_controls83[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_42m <- subset(md_controls83, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_42m <- subset(md_controls83, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_42m2 <- multi_42m[,c(1,2,3,4)]\
multi_42m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full83$person_id)]\
\
##Rematch the used PIDs\
\
control42_m_d2 <- subset(control_pop_m, index_age >=2770 & index_age<2840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control42_m_d2)\
match_age42m_d2 <- rbind(multi_42m2, control42_m_d2)\
m_age42m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age42m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age42m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full83_d2 <- cbind(match_age42m_d2, r2)\
match_full83_d2 = match_full83_d2[!match_full83_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_42m <- unique_42m[,c(1,2,3,4,5,6,7)]\
match_full83_d3 <-rbind(unique_42m, match_full83_d2)\
match_full83_d3 <- subset(match_full83_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full83_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full83_d3$person_id)]\
\
#females\
case42_f <- subset(case_pop_f, index_age >=2780 & index_age < 2830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case42_f)\
control42_f <- subset(control_pop_f, index_age >=2770 & index_age<2840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control42_f)\
match_age42f <- rbind(case42_f, control42_f)\
setDT(match_age42f)\
\
m_age42f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age42f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age42f$factor\
f42 <- as.data.table(r)\
f42$ID2 <- seq.int(nrow(f42))\
\
match_full84 <- cbind(match_age42f, f42)\
match_full84 = match_full84[!match_full84$r== 'NA',]\
\
md_controls42f <- subset(match_full84, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases42f <- subset(match_full84, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases42f[,.N,by=person_id]\
md_controls42f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls84 <-md_controls42f[order(person_id)]\
md_controls84[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_42f <- subset(md_controls84, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_42f <- subset(md_controls84, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_42f2 <- multi_42f[,c(1,2,3,4)]\
multi_42f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full84$person_id)]\
\
##Rematch the used PIDs\
\
control42_f_d2 <- subset(control_pop_f, index_age >=2770 & index_age<2840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control42_f_d2)\
match_age42f_d2 <- rbind(multi_42f2, control42_f_d2)\
m_age42f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age42f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age42f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full84_d2 <- cbind(match_age42f_d2, r2)\
match_full84_d2 = match_full84_d2[!match_full84_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_42f <- unique_42f[,c(1,2,3,4,5,6,7)]\
match_full84_d3 <-rbind(unique_42f, match_full84_d2)\
match_full84_d3 <- subset(match_full84_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full84_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full84_d3$person_id)]\
\
## 2830-2880 days old\
#males\
\
case43_m <- subset(case_pop_m, index_age >=2830 & index_age <2880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case43_m)\
control43_m <- subset(control_pop_m, index_age >=2820 & index_age<2890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control43_m)\
match_age43m <- rbind(case43_m, control43_m)\
setDT(match_age43m)\
\
m_age43m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age43m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age43m$factor\
m43 <- as.data.table(r)\
m43$ID2 <- seq.int(nrow(m43))\
\
match_full85 <- cbind(match_age43m, m43)\
match_full85 = match_full85[!match_full85$r== 'NA',]\
\
md_controls43m <- subset(match_full85, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases43m <- subset(match_full85, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases43m[,.N,by=person_id]\
md_controls43m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls85 <-md_controls43m[order(person_id)]\
md_controls85[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_43m <- subset(md_controls85, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_43m <- subset(md_controls85, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_43m2 <- multi_43m[,c(1,2,3,4)]\
multi_43m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full85$person_id)]\
\
##Rematch the used PIDs\
\
control43_m_d2 <- subset(control_pop_m, index_age >=2820 & index_age<2890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control43_m_d2)\
match_age43m_d2 <- rbind(multi_43m2, control43_m_d2)\
m_age43m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age43m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age43m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full85_d2 <- cbind(match_age43m_d2, r2)\
match_full85_d2 = match_full85_d2[!match_full85_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_43m <- unique_43m[,c(1,2,3,4,5,6,7)]\
match_full85_d3 <-rbind(unique_43m, match_full85_d2)\
match_full85_d3 <- subset(match_full85_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full85_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full85_d3$person_id)]\
\
#females\
case43_f <- subset(case_pop_f, index_age >=2830 & index_age < 2880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case43_f)\
control43_f <- subset(control_pop_f, index_age >=2820 & index_age<2890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control43_f)\
match_age43f <- rbind(case43_f, control43_f)\
setDT(match_age43f)\
\
m_age43f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age43f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age43f$factor\
f43 <- as.data.table(r)\
f43$ID2 <- seq.int(nrow(f43))\
\
match_full86 <- cbind(match_age43f, f43)\
match_full86 = match_full86[!match_full86$r== 'NA',]\
\
md_controls43f <- subset(match_full86, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases43f <- subset(match_full86, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases43f[,.N,by=person_id]\
md_controls43f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls43f$person_id)]\
\
## 2880-2930 days old\
#males\
\
case44_m <- subset(case_pop_m, index_age >=2880 & index_age <2930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case44_m)\
control44_m <- subset(control_pop_m, index_age >=2870 & index_age<2940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control44_m)\
match_age44m <- rbind(case44_m, control44_m)\
setDT(match_age44m)\
\
m_age44m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age44m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age44m$factor\
m44 <- as.data.table(r)\
m44$ID2 <- seq.int(nrow(m44))\
\
match_full87 <- cbind(match_age44m, m44)\
match_full87 = match_full87[!match_full87$r== 'NA',]\
\
md_controls44m <- subset(match_full87, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases44m <- subset(match_full87, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases44m[,.N,by=person_id]\
md_controls44m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls87 <-md_controls44m[order(person_id)]\
md_controls87[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_44m <- subset(md_controls87, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_44m <- subset(md_controls87, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_44m2 <- multi_44m[,c(1,2,3,4)]\
multi_44m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full87$person_id)]\
\
##Rematch the used PIDs\
\
control44_m_d2 <- subset(control_pop_m, index_age >=2870 & index_age<2940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control44_m_d2)\
match_age44m_d2 <- rbind(multi_44m2, control44_m_d2)\
m_age44m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age44m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age44m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full87_d2 <- cbind(match_age44m_d2, r2)\
match_full87_d2 = match_full87_d2[!match_full87_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_44m <- unique_44m[,c(1,2,3,4,5,6,7)]\
match_full87_d3 <-rbind(unique_44m, match_full87_d2)\
match_full87_d3 <- subset(match_full87_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full87_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full87_d3$person_id)]\
\
#females\
case44_f <- subset(case_pop_f, index_age >=2880 & index_age < 2930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case44_f)\
control44_f <- subset(control_pop_f, index_age >=2870 & index_age<2940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control44_f)\
match_age44f <- rbind(case44_f, control44_f)\
setDT(match_age44f)\
\
m_age44f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age44f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age44f$factor\
f44 <- as.data.table(r)\
f44$ID2 <- seq.int(nrow(f44))\
\
match_full88 <- cbind(match_age44f, f44)\
match_full88 = match_full88[!match_full88$r== 'NA',]\
\
md_controls44f <- subset(match_full88, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases44f <- subset(match_full88, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases44f[,.N,by=person_id]\
md_controls44f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls88 <-md_controls44f[order(person_id)]\
md_controls88[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_44f <- subset(md_controls88, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_44f <- subset(md_controls88, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_44f2 <- multi_44f[,c(1,2,3,4)]\
multi_44f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full88$person_id)]\
\
##Rematch the used PIDs\
\
control44_f_d2 <- subset(control_pop_f, index_age >=2870 & index_age<2940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control44_f_d2)\
match_age44f_d2 <- rbind(multi_44f2, control44_f_d2)\
m_age44f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age44f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age44f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full88_d2 <- cbind(match_age44f_d2, r2)\
match_full88_d2 = match_full88_d2[!match_full88_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_44f <- unique_44f[,c(1,2,3,4,5,6,7)]\
match_full88_d3 <-rbind(unique_44f, match_full88_d2)\
match_full88_d3 <- subset(match_full88_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full88_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full88_d3$person_id)]\
\
## 2930-2980 days old\
#males\
case45_m <- subset(case_pop_m, index_age >=2930 & index_age <2980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case45_m)\
control45_m <- subset(control_pop_m, index_age >=2920 & index_age<2990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control45_m)\
match_age45m <- rbind(case45_m, control45_m)\
setDT(match_age45m)\
\
m_age45m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age45m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age45m$factor\
m45 <- as.data.table(r)\
m45$ID2 <- seq.int(nrow(m45))\
\
match_full89 <- cbind(match_age45m, m45)\
match_full89 = match_full89[!match_full89$r== 'NA',]\
\
md_controls45m <- subset(match_full89, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases45m <- subset(match_full89, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases45m[,.N,by=person_id]\
md_controls45m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls89 <-md_controls45m[order(person_id)]\
md_controls89[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_45m <- subset(md_controls89, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_45m <- subset(md_controls89, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_45m2 <- multi_45m[,c(1,2,3,4)]\
multi_45m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full89$person_id)]\
\
##Rematch the used PIDs\
\
control45_m_d2 <- subset(control_pop_m, index_age >=2920 & index_age<2990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control45_m_d2)\
match_age45m_d2 <- rbind(multi_45m2, control45_m_d2)\
m_age45m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age45m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age45m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full89_d2 <- cbind(match_age45m_d2, r2)\
match_full89_d2 = match_full89_d2[!match_full89_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_45m <- unique_45m[,c(1,2,3,4,5,6,7)]\
match_full89_d3 <-rbind(unique_45m, match_full89_d2)\
match_full89_d3 <- subset(match_full89_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full89_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full89_d3$person_id)]\
\
\
#females\
case45_f <- subset(case_pop_f, index_age >=2930 & index_age < 2980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case45_f)\
control45_f <- subset(control_pop_f, index_age >=2920 & index_age<2990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control45_f)\
match_age45f <- rbind(case45_f, control45_f)\
setDT(match_age45f)\
\
m_age45f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age45f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age45f$factor\
f45 <- as.data.table(r)\
f45$ID2 <- seq.int(nrow(f45))\
\
match_full90 <- cbind(match_age45f, f45)\
match_full90 = match_full90[!match_full90$r== 'NA',]\
\
md_controls45f <- subset(match_full90, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases45f <- subset(match_full90, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases45f[,.N,by=person_id]\
md_controls45f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls90 <-md_controls45f[order(person_id)]\
md_controls90[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_45f <- subset(md_controls90, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_45f <- subset(md_controls90, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_45f2 <- multi_45f[,c(1,2,3,4)]\
multi_45f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full90$person_id)]\
\
##Rematch the used PIDs\
\
control45_f_d2 <- subset(control_pop_f, index_age >=2920 & index_age<2990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control45_f_d2)\
match_age45f_d2 <- rbind(multi_45f2, control45_f_d2)\
m_age45f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age45f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age45f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full90_d2 <- cbind(match_age45f_d2, r2)\
match_full90_d2 = match_full90_d2[!match_full90_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_45f <- unique_45f[,c(1,2,3,4,5,6,7)]\
match_full90_d3 <-rbind(unique_45f, match_full90_d2)\
match_full90_d3 <- subset(match_full90_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full90_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full90_d3$person_id)]\
\
##combine all matched data: round 9\
\
colnames(match_full81_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full82_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full83_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full84_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full85_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls43f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full87_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full88_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full89_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full90_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_9 <- rbind(match_full81_d3, match_full82_d3, match_full83_d3, match_full84_d3, match_full85_d3, md_controls43f, match_full87_d3, match_full88_d3, match_full89_d3, match_full90_d3)\
setDT(match_total_9)\
\
match_total_9[,.N,by=person_id]\
\
write.csv(match_total_9, 'match_total_9.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_9,  c("person_id","num_of_prior_visits"))\
\
mt9_matched_measures3= f[match_total_9]\
mt9_matched_measures4 <- mt9_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt9_matched_measures4)\
\
setkeyv(mt9_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt9_control_conditions= conditions2[mt9_matched_measures4]\
\
mt9_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt9_cont_pre_index <- match_total_9[,c(1,4)]\
mt9_cont_pre_index$pre <- mt9_cont_pre_index[, 2] -1\
mt9_cont_pre_index2 <- mt9_cont_pre_index[,c(1,3)]\
colnames(mt9_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt9_cont_pre_index2)\
setkeyv(mt9_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt9_matched_pre_measures= f[mt9_cont_pre_index2]\
\
mt9_matched_pre_measures2 <- mt9_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt9_matched_pre_measures2)\
\
setkeyv(mt9_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt9_control_conditions_pre= conditions2[mt9_matched_pre_measures2]\
\
mt9_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt9_cont_post_index <- match_total_9[,c(1,4)]\
mt9_cont_post_index$post <- mt9_cont_pre_index[, 2] +1\
mt9_cont_post_index2 <- mt9_cont_post_index[,c(1,3)]\
colnames(mt9_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt9_cont_post_index2)\
setkeyv(mt9_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt9_matched_post_measures= f[mt9_cont_post_index2]\
\
mt9_matched_post_measures2 <- mt9_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt9_matched_post_measures2)\
\
setkeyv(mt9_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt9_control_conditions_post= conditions2[mt9_matched_post_measures2]\
\
mt9_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt9_control_conditions_post= mt9_control_conditions_post[!mt9_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt9_control_conditions_post$Timing_Class = '3'\
mt9_control_conditions_pre$Timing_Class = '1'\
mt9_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_9$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_9$person_id)]\
\
#Combine all clinical observations from the 9th set\
full_con_9 <- rbind(mt9_control_conditions_pre, mt9_control_conditions, mt9_control_conditions_post)\
setDT(full_con_9)\
full_con_9[,.N,by=person_id]\
\
## 2980-3030 days old\
#males\
\
case46_m <- subset(case_pop_m, index_age >=2980 & index_age <3030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case46_m)\
control46_m <- subset(control_pop_m, index_age >=2970 & index_age<3040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control46_m)\
match_age46m <- rbind(case46_m, control46_m)\
setDT(match_age46m)\
\
m_age46m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age46m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age46m$factor\
m46 <- as.data.table(r)\
m46$ID2 <- seq.int(nrow(m46))\
\
match_full91 <- cbind(match_age46m, m46)\
match_full91 = match_full91[!match_full91$r== 'NA',]\
\
md_controls46m <- subset(match_full91, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases46m <- subset(match_full91, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases46m[,.N,by=person_id]\
md_controls46m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls91 <-md_controls46m[order(person_id)]\
md_controls91[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_46m <- subset(md_controls91, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_46m <- subset(md_controls91, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_46m2 <- multi_46m[,c(1,2,3,4)]\
multi_46m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full91$person_id)]\
\
##Rematch the used PIDs\
\
control46_m_d2 <- subset(control_pop_m, index_age >=2970 & index_age<3040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control46_m_d2)\
match_age46m_d2 <- rbind(multi_46m2, control46_m_d2)\
m_age46m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age46m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age46m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full91_d2 <- cbind(match_age46m_d2, r2)\
match_full91_d2 = match_full91_d2[!match_full91_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_46m <- unique_46m[,c(1,2,3,4,5,6,7)]\
match_full91_d3 <-rbind(unique_46m, match_full91_d2)\
match_full91_d3 <- subset(match_full91_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full91_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full91_d3$person_id)]\
\
#females\
case46_f <- subset(case_pop_f, index_age >=2980 & index_age < 3030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case46_f)\
control46_f <- subset(control_pop_f, index_age >=2970 & index_age<3040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control46_f)\
match_age46f <- rbind(case46_f, control46_f)\
setDT(match_age46f)\
\
m_age46f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age46f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age46f$factor\
f46 <- as.data.table(r)\
f46$ID2 <- seq.int(nrow(f46))\
\
match_full92 <- cbind(match_age46f, f46)\
match_full92 = match_full92[!match_full92$r== 'NA',]\
\
md_controls46f <- subset(match_full92, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases46f <- subset(match_full92, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases46f[,.N,by=person_id]\
md_controls46f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls92 <-md_controls46f[order(person_id)]\
md_controls92[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_46f <- subset(md_controls92, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_46f <- subset(md_controls92, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_46f2 <- multi_46f[,c(1,2,3,4)]\
multi_46f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full92$person_id)]\
\
##Rematch the used PIDs\
\
control46_f_d2 <- subset(control_pop_f, index_age >=2970 & index_age<3040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control46_f_d2)\
match_age46f_d2 <- rbind(multi_46f2, control46_f_d2)\
m_age46f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age46f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age46f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full92_d2 <- cbind(match_age46f_d2, r2)\
match_full92_d2 = match_full92_d2[!match_full92_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_46f <- unique_46f[,c(1,2,3,4,5,6,7)]\
match_full92_d3 <-rbind(unique_46f, match_full92_d2)\
match_full92_d3 <- subset(match_full92_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full92_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full92_d3$person_id)]\
\
## 3030-3080 days old\
#males\
\
case47_m <- subset(case_pop_m, index_age >=3030 & index_age <3080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case47_m)\
control47_m <- subset(control_pop_m, index_age >=3020 & index_age<3090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control47_m)\
match_age47m <- rbind(case47_m, control47_m)\
setDT(match_age47m)\
\
m_age47m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age47m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age47m$factor\
m47 <- as.data.table(r)\
m47$ID2 <- seq.int(nrow(m47))\
\
match_full93 <- cbind(match_age47m, m47)\
match_full93 = match_full93[!match_full93$r== 'NA',]\
\
md_controls47m <- subset(match_full93, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases47m <- subset(match_full93, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases47m[,.N,by=person_id]\
md_controls47m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls93 <-md_controls47m[order(person_id)]\
md_controls93[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_47m <- subset(md_controls93, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_47m <- subset(md_controls93, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_47m2 <- multi_47m[,c(1,2,3,4)]\
multi_47m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full93$person_id)]\
\
##Rematch the used PIDs\
\
control47_m_d2 <- subset(control_pop_m, index_age >=3020 & index_age<3090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control47_m_d2)\
match_age47m_d2 <- rbind(multi_47m2, control47_m_d2)\
m_age47m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age47m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age47m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full93_d2 <- cbind(match_age47m_d2, r2)\
match_full93_d2 = match_full93_d2[!match_full93_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_47m <- unique_47m[,c(1,2,3,4,5,6,7)]\
match_full93_d3 <-rbind(unique_47m, match_full93_d2)\
match_full93_d3 <- subset(match_full93_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full93_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full93_d3$person_id)]\
\
#females\
case47_f <- subset(case_pop_f, index_age >=3030 & index_age < 3080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case47_f)\
control47_f <- subset(control_pop_f, index_age >=3020 & index_age<3090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control47_f)\
match_age47f <- rbind(case47_f, control47_f)\
setDT(match_age47f)\
\
m_age47f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age47f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age47f$factor\
f47 <- as.data.table(r)\
f47$ID2 <- seq.int(nrow(f47))\
\
match_full94 <- cbind(match_age47f, f47)\
match_full94 = match_full94[!match_full94$r== 'NA',]\
\
md_controls47f <- subset(match_full94, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases47f <- subset(match_full94, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases47f[,.N,by=person_id]\
md_controls47f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls94 <-md_controls47f[order(person_id)]\
md_controls94[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_47f <- subset(md_controls94, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_47f <- subset(md_controls94, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_47f2 <- multi_47f[,c(1,2,3,4)]\
multi_47f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full94$person_id)]\
\
##Rematch the used PIDs\
\
control47_f_d2 <- subset(control_pop_f, index_age >=3020 & index_age<3090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control47_f_d2)\
match_age47f_d2 <- rbind(multi_47f2, control47_f_d2)\
m_age47f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age47f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age47f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full94_d2 <- cbind(match_age47f_d2, r2)\
match_full94_d2 = match_full94_d2[!match_full94_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_47f <- unique_47f[,c(1,2,3,4,5,6,7)]\
match_full94_d3 <-rbind(unique_47f, match_full94_d2)\
match_full94_d3 <- subset(match_full94_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full94_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full94_d3$person_id)]\
\
## 3080-3130 days old\
#males\
\
case48_m <- subset(case_pop_m, index_age >=3080 & index_age <3130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case48_m)\
control48_m <- subset(control_pop_m, index_age >=3070 & index_age<3140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control48_m)\
match_age48m <- rbind(case48_m, control48_m)\
setDT(match_age48m)\
\
m_age48m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age48m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age48m$factor\
m48 <- as.data.table(r)\
m48$ID2 <- seq.int(nrow(m48))\
\
match_full95 <- cbind(match_age48m, m48)\
match_full95 = match_full95[!match_full95$r== 'NA',]\
\
md_controls48m <- subset(match_full95, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases48m <- subset(match_full95, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases48m[,.N,by=person_id]\
md_controls48m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls95 <-md_controls48m[order(person_id)]\
md_controls95[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_48m <- subset(md_controls95, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_48m <- subset(md_controls95, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_48m2 <- multi_48m[,c(1,2,3,4)]\
multi_48m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full95$person_id)]\
\
##Rematch the used PIDs\
\
control48_m_d2 <- subset(control_pop_m, index_age >=3070 & index_age<3140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control48_m_d2)\
match_age48m_d2 <- rbind(multi_48m2, control48_m_d2)\
m_age48m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age48m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age48m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full95_d2 <- cbind(match_age48m_d2, r2)\
match_full95_d2 = match_full95_d2[!match_full95_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_48m <- unique_48m[,c(1,2,3,4,5,6,7)]\
match_full95_d3 <-rbind(unique_48m, match_full95_d2)\
match_full95_d3 <- subset(match_full95_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full95_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full95_d3$person_id)]\
\
#females\
case48_f <- subset(case_pop_f, index_age >=3080 & index_age < 3130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case48_f)\
control48_f <- subset(control_pop_f, index_age >=3070 & index_age<3140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control48_f)\
match_age48f <- rbind(case48_f, control48_f)\
setDT(match_age48f)\
\
m_age48f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age48f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age48f$factor\
f48 <- as.data.table(r)\
f48$ID2 <- seq.int(nrow(f48))\
\
match_full96 <- cbind(match_age48f, f48)\
match_full96 = match_full96[!match_full96$r== 'NA',]\
\
md_controls48f <- subset(match_full96, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases48f <- subset(match_full96, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases48f[,.N,by=person_id]\
md_controls48f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls96 <-md_controls48f[order(person_id)]\
md_controls96[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_48f <- subset(md_controls96, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_48f <- subset(md_controls96, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_48f2 <- multi_48f[,c(1,2,3,4)]\
multi_48f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full96$person_id)]\
\
##Rematch the used PIDs\
\
control48_f_d2 <- subset(control_pop_f, index_age >=3070 & index_age<3140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control48_f_d2)\
match_age48f_d2 <- rbind(multi_48f2, control48_f_d2)\
m_age48f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age48f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age48f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full96_d2 <- cbind(match_age48f_d2, r2)\
match_full96_d2 = match_full96_d2[!match_full96_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_48f <- unique_48f[,c(1,2,3,4,5,6,7)]\
match_full96_d3 <-rbind(unique_48f, match_full96_d2)\
match_full96_d3 <- subset(match_full96_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full96_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full96_d3$person_id)]\
\
## 3130-3180 days old\
#males\
\
case49_m <- subset(case_pop_m, index_age >=3130 & index_age <3180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case49_m)\
control49_m <- subset(control_pop_m, index_age >=3120 & index_age<3190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control49_m)\
match_age49m <- rbind(case49_m, control49_m)\
setDT(match_age49m)\
\
m_age49m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age49m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age49m$factor\
m49 <- as.data.table(r)\
m49$ID2 <- seq.int(nrow(m49))\
\
match_full97 <- cbind(match_age49m, m49)\
match_full97 = match_full97[!match_full97$r== 'NA',]\
\
md_controls49m <- subset(match_full97, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases49m <- subset(match_full97, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases49m[,.N,by=person_id]\
md_controls49m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls49m$person_id)]\
\
#females\
case49_f <- subset(case_pop_f, index_age >=3130 & index_age < 3180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case49_f)\
control49_f <- subset(control_pop_f, index_age >=3120 & index_age<3190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control49_f)\
match_age49f <- rbind(case49_f, control49_f)\
setDT(match_age49f)\
\
m_age49f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age49f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age49f$factor\
f49 <- as.data.table(r)\
f49$ID2 <- seq.int(nrow(f49))\
\
match_full98 <- cbind(match_age49f, f49)\
match_full98 = match_full98[!match_full98$r== 'NA',]\
\
md_controls49f <- subset(match_full98, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases49f <- subset(match_full98, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases49f[,.N,by=person_id]\
md_controls49f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls98 <-md_controls49f[order(person_id)]\
md_controls98[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_49f <- subset(md_controls98, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_49f <- subset(md_controls98, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_49f2 <- multi_49f[,c(1,2,3,4)]\
multi_49f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full98$person_id)]\
\
##Rematch the used PIDs\
\
control49_f_d2 <- subset(control_pop_f, index_age >=3120 & index_age<3190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control49_f_d2)\
match_age49f_d2 <- rbind(multi_49f2, control49_f_d2)\
m_age49f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age49f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age49f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full98_d2 <- cbind(match_age49f_d2, r2)\
match_full98_d2 = match_full98_d2[!match_full98_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_49f <- unique_49f[,c(1,2,3,4,5,6,7)]\
match_full98_d3 <-rbind(unique_49f, match_full98_d2)\
match_full98_d3 <- subset(match_full98_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full98_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full98_d3$person_id)]\
\
## 3180-3230 days old\
#males\
\
case50_m <- subset(case_pop_m, index_age >=3180 & index_age <3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case50_m)\
control50_m <- subset(control_pop_m, index_age >=3170 & index_age<3240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control50_m)\
match_age50m <- rbind(case50_m, control50_m)\
setDT(match_age50m)\
\
m_age50m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age50m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age50m$factor\
m50 <- as.data.table(r)\
m50$ID2 <- seq.int(nrow(m50))\
\
match_full99 <- cbind(match_age50m, m50)\
match_full99 = match_full99[!match_full99$r== 'NA',]\
\
md_controls50m <- subset(match_full99, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases50m <- subset(match_full99, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases50m[,.N,by=person_id]\
md_controls50m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls50m$person_id)]\
\
#females\
case50_f <- subset(case_pop_f, index_age >=3180 & index_age < 3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case50_f)\
control50_f <- subset(control_pop_f, index_age >=3170 & index_age<3240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control50_f)\
match_age50f <- rbind(case50_f, control50_f)\
setDT(match_age50f)\
\
m_age50f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age50f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age50f$factor\
f50 <- as.data.table(r)\
f50$ID2 <- seq.int(nrow(f50))\
\
match_full100 <- cbind(match_age50f, f50)\
match_full100 = match_full100[!match_full100$r== 'NA',]\
\
md_controls50f <- subset(match_full100, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases50f <- subset(match_full100, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases50f[,.N,by=person_id]\
md_controls50f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls100 <-md_controls50f[order(person_id)]\
md_controls100[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_50f <- subset(md_controls100, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_50f <- subset(md_controls100, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_50f2 <- multi_50f[,c(1,2,3,4)]\
multi_50f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full100$person_id)]\
\
##Rematch the used PIDs\
\
control50_f_d2 <- subset(control_pop_f, index_age >=3170 & index_age<3240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control50_f_d2)\
match_age50f_d2 <- rbind(multi_50f2, control50_f_d2)\
m_age50f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age50f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age50f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full100_d2 <- cbind(match_age50f_d2, r2)\
match_full100_d2 = match_full100_d2[!match_full100_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_50f <- unique_50f[,c(1,2,3,4,5,6,7)]\
match_full100_d3 <-rbind(unique_50f, match_full100_d2)\
match_full100_d3 <- subset(match_full100_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full100_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full100_d3$person_id)]\
\
##combine all matched data: round 10\
\
colnames(match_full91_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full92_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full93_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full94_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full95_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full96_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls49m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full98_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls50m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full100_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_10 <- rbind(match_full91_d3, match_full92_d3, match_full93_d3, match_full94_d3, match_full95_d3, match_full96_d3, md_controls49m, match_full98_d3, md_controls50m, match_full100_d3)\
setDT(match_total_10)\
\
match_total_10[,.N,by=person_id]\
\
write.csv(match_total_10, 'match_total_10.csv')\
\
##One duplicate match; rematch this\
md_controls_tot10 <-match_total_10[order(person_id)]\
md_controls_tot10[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_tot10 <- subset(md_controls_tot10, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID, num_matches))\
\
unique_tot10 <- subset(md_controls_tot10, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID, num_matches))\
\
multi_tot10 <- multi_tot10[,c(1,2,3,4)]\
multi_tot10$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_total_10$person_id)]\
\
##Rematch the used PIDs\
\
controltot10_d2 <- subset(control_pop_m, index_age >=3170 & index_age<3240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(controltot10_d2)\
match_tot10_d2 <- rbind(multi_tot10, controltot10_d2)\
m_tot10_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_tot10_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_tot10_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_fulltot10_d2 <- cbind(match_tot10_d2, r2)\
match_fulltot10_d2 = match_fulltot10_d2[!match_fulltot10_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_tot10 <- unique_tot10[,c(1,2,3,4,5,6,7)]\
colnames(match_fulltot10_d2) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_fulltot10_d3 <-rbind(unique_tot10, match_fulltot10_d2)\
match_fulltot10_d3 <- subset(match_fulltot10_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_fulltot10_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_fulltot10_d3$person_id)]\
\
##Remove the original duplicate match\
md_controls_tot10_2 =  md_controls_tot10[!md_controls_tot10$num_matches== '1',]\
match_total_10 <- md_controls_tot10_2[,c(1,2,3,4,5,6,7)]\
setDT(match_total_10)\
\
match_total_10[,.N,by=person_id]\
\
match_total_10 <- rbind(match_total_10, match_fulltot10_d2)\
match_total_10 = match_total_10[!match_total_10$r== 'case',]\
\
write.csv(match_total_10, 'match_total_10.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_10,  c("person_id","num_of_prior_visits"))\
\
mt10_matched_measures3= f[match_total_10]\
mt10_matched_measures4 <- mt10_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt10_matched_measures4)\
\
setkeyv(mt10_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt10_control_conditions= conditions2[mt10_matched_measures4]\
\
mt10_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt10_cont_pre_index <- match_total_10[,c(1,4)]\
mt10_cont_pre_index$pre <- mt10_cont_pre_index[, 2] -1\
mt10_cont_pre_index2 <- mt10_cont_pre_index[,c(1,3)]\
colnames(mt10_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt10_cont_pre_index2)\
setkeyv(mt10_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt10_matched_pre_measures= f[mt10_cont_pre_index2]\
\
mt10_matched_pre_measures2 <- mt10_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt10_matched_pre_measures2)\
\
setkeyv(mt10_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt10_control_conditions_pre= conditions2[mt10_matched_pre_measures2]\
\
mt10_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt10_cont_post_index <- match_total_10[,c(1,4)]\
mt10_cont_post_index$post <- mt10_cont_pre_index[, 2] +1\
mt10_cont_post_index2 <- mt10_cont_post_index[,c(1,3)]\
colnames(mt10_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt10_cont_post_index2)\
setkeyv(mt10_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt10_matched_post_measures= f[mt10_cont_post_index2]\
\
mt10_matched_post_measures2 <- mt10_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt10_matched_post_measures2)\
\
setkeyv(mt10_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt10_control_conditions_post= conditions2[mt10_matched_post_measures2]\
\
mt10_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt10_control_conditions_post= mt10_control_conditions_post[!mt10_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt10_control_conditions_post$Timing_Class = '3'\
mt10_control_conditions_pre$Timing_Class = '1'\
mt10_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_10$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_10$person_id)]\
\
#Combine all clinical observations from the 10th set\
full_con_10 <- rbind(mt10_control_conditions_pre, mt10_control_conditions, mt10_control_conditions_post)\
setDT(full_con_10)\
full_con_10[,.N,by=person_id]\
\
\
##Combine all clinical observations from the first ten sets\
\
set1_full_con <- rbind(full_con_1, full_con_2, full_con_3, full_con_4, full_con_5, full_con_6, full_con_7, full_con_8, full_con_9, full_con_10)\
setDT(set1_full_con)\
set1_full_con[,.N,by=person_id]\
\
write.csv(set1_full_con, 'set1_full_con.csv')\
\
\
## 3230-3280 days old\
#males\
\
case51_m <- subset(case_pop_m, index_age >=3230 & index_age <3280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case51_m)\
control51_m <- subset(control_pop_m, index_age >=3220 & index_age<3290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control51_m)\
match_age51m <- rbind(case51_m, control51_m)\
setDT(match_age51m)\
\
m_age51m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age51m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age51m$factor\
m51 <- as.data.table(r)\
m51$ID2 <- seq.int(nrow(m51))\
\
match_full101 <- cbind(match_age51m, m51)\
match_full101 = match_full101[!match_full101$r== 'NA',]\
\
md_controls51m <- subset(match_full101, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases51m <- subset(match_full101, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases51m[,.N,by=person_id]\
md_controls51m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls101 <-md_controls51m[order(person_id)]\
md_controls101[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_51m <- subset(md_controls101, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_51m <- subset(md_controls101, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_51m2 <- multi_51m[,c(1,2,3,4)]\
multi_51m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full101$person_id)]\
\
##Rematch the used PIDs\
\
control51_m_d2 <- subset(control_pop_m, index_age >=3220 & index_age<3290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control51_m_d2)\
match_age51m_d2 <- rbind(multi_51m2, control51_m_d2)\
m_age51m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age51m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age51m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full101_d2 <- cbind(match_age51m_d2, r2)\
match_full101_d2 = match_full101_d2[!match_full101_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_51m <- unique_51m[,c(1,2,3,4,5,6,7)]\
match_full101_d3 <-rbind(unique_51m, match_full101_d2)\
match_full101_d3 <- subset(match_full101_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full101_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full101_d3$person_id)]\
\
#females\
case51_f <- subset(case_pop_f, index_age >=3230 & index_age < 3280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case51_f)\
control51_f <- subset(control_pop_f, index_age >=3220 & index_age<3290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control51_f)\
match_age51f <- rbind(case51_f, control51_f)\
setDT(match_age51f)\
\
m_age51f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age51f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age51f$factor\
f51 <- as.data.table(r)\
f51$ID2 <- seq.int(nrow(f51))\
\
match_full102 <- cbind(match_age51f, f51)\
match_full102 = match_full102[!match_full102$r== 'NA',]\
\
md_controls51f <- subset(match_full102, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases51f <- subset(match_full102, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases51f[,.N,by=person_id]\
md_controls51f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls102 <-md_controls51f[order(person_id)]\
md_controls102[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_51f <- subset(md_controls102, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_51f <- subset(md_controls102, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_51f2 <- multi_51f[,c(1,2,3,4)]\
multi_51f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full102$person_id)]\
\
##Rematch the used PIDs\
\
control51_f_d2 <- subset(control_pop_f, index_age >=3220 & index_age<3290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control51_f_d2)\
match_age51f_d2 <- rbind(multi_51f2, control51_f_d2)\
m_age51f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age51f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age51f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full102_d2 <- cbind(match_age51f_d2, r2)\
match_full102_d2 = match_full102_d2[!match_full102_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_51f <- unique_51f[,c(1,2,3,4,5,6,7)]\
match_full102_d3 <-rbind(unique_51f, match_full102_d2)\
match_full102_d3 <- subset(match_full102_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full102_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full102_d3$person_id)]\
\
## 3280-3330 days old\
#males\
\
case52_m <- subset(case_pop_m, index_age >=3280 & index_age <3330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case52_m)\
control52_m <- subset(control_pop_m, index_age >=3270 & index_age<3340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control52_m)\
match_age52m <- rbind(case52_m, control52_m)\
setDT(match_age52m)\
\
m_age52m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age52m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age52m$factor\
m52 <- as.data.table(r)\
m52$ID2 <- seq.int(nrow(m52))\
\
match_full103 <- cbind(match_age52m, m52)\
match_full103 = match_full103[!match_full103$r== 'NA',]\
\
md_controls52m <- subset(match_full103, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases52m <- subset(match_full103, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases52m[,.N,by=person_id]\
md_controls52m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls52m$person_id)]\
\
#females\
case52_f <- subset(case_pop_f, index_age >=3280 & index_age < 3330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case52_f)\
control52_f <- subset(control_pop_f, index_age >=3270 & index_age<3340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control52_f)\
match_age52f <- rbind(case52_f, control52_f)\
setDT(match_age52f)\
\
m_age52f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age52f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age52f$factor\
f52 <- as.data.table(r)\
f52$ID2 <- seq.int(nrow(f52))\
\
match_full104 <- cbind(match_age52f, f52)\
match_full104 = match_full104[!match_full104$r== 'NA',]\
\
md_controls52f <- subset(match_full104, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases52f <- subset(match_full104, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases52f[,.N,by=person_id]\
md_controls52f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls104 <-md_controls52f[order(person_id)]\
md_controls104[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_52f <- subset(md_controls104, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_52f <- subset(md_controls104, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_52f2 <- multi_52f[,c(1,2,3,4)]\
multi_52f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full104$person_id)]\
\
##Rematch the used PIDs\
\
control52_f_d2 <- subset(control_pop_f, index_age >=3270 & index_age<3340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control52_f_d2)\
match_age52f_d2 <- rbind(multi_52f2, control52_f_d2)\
m_age52f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age52f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age52f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full104_d2 <- cbind(match_age52f_d2, r2)\
match_full104_d2 = match_full104_d2[!match_full104_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_52f <- unique_52f[,c(1,2,3,4,5,6,7)]\
match_full104_d3 <-rbind(unique_52f, match_full104_d2)\
match_full104_d3 <- subset(match_full104_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full104_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full104_d3$person_id)]\
\
## 3330-3380 days old\
#males\
\
case53_m <- subset(case_pop_m, index_age >=3330 & index_age <3380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case53_m)\
control53_m <- subset(control_pop_m, index_age >=3320 & index_age<3390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control53_m)\
match_age53m <- rbind(case53_m, control53_m)\
setDT(match_age53m)\
\
m_age53m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age53m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age53m$factor\
m53 <- as.data.table(r)\
m53$ID2 <- seq.int(nrow(m53))\
\
match_full105 <- cbind(match_age53m, m53)\
match_full105 = match_full105[!match_full105$r== 'NA',]\
\
md_controls53m <- subset(match_full105, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases53m <- subset(match_full105, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases53m[,.N,by=person_id]\
md_controls53m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls105 <-md_controls53m[order(person_id)]\
md_controls105[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_53m <- subset(md_controls105, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_53m <- subset(md_controls105, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_53m2 <- multi_53m[,c(1,2,3,4)]\
multi_53m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full105$person_id)]\
\
##Rematch the used PIDs\
\
control53_m_d2 <- subset(control_pop_m, index_age >=3320 & index_age<3390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control53_m_d2)\
match_age53m_d2 <- rbind(multi_53m2, control53_m_d2)\
m_age53m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age53m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age53m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full105_d2 <- cbind(match_age53m_d2, r2)\
match_full105_d2 = match_full105_d2[!match_full105_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_53m <- unique_53m[,c(1,2,3,4,5,6,7)]\
match_full105_d3 <-rbind(unique_53m, match_full105_d2)\
match_full105_d3 <- subset(match_full105_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full105_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full105_d3$person_id)]\
\
#Rematch the duplicates\
md_controls105 <-match_full105_d3[order(person_id)]\
md_controls105[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_53m <- subset(md_controls105, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_53m <- subset(md_controls105, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_53m2 <- multi_53m[,c(1,2,3,4)]\
multi_53m2$casecont = 'case'\
\
##Rematch the used PIDs\
\
control53_m_d2 <- subset(control_pop_m, index_age >=3320 & index_age<3390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control53_m_d2)\
match_age53m_d2 <- rbind(multi_53m2, control53_m_d2)\
m_age53m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age53m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age53m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full105_d2 <- cbind(match_age53m_d2, r2)\
match_full105_d2 = match_full105_d2[!match_full105_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_53m <- unique_53m[,c(1,2,3,4,5,6,7)]\
match_full105_d3 <-rbind(unique_53m, match_full105_d2)\
match_full105_d3 <- subset(match_full105_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full105_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full105_d3$person_id)]\
\
#females\
case53_f <- subset(case_pop_f, index_age >=3330 & index_age < 3380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case53_f)\
control53_f <- subset(control_pop_f, index_age >=3320 & index_age<3390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control53_f)\
match_age53f <- rbind(case53_f, control53_f)\
setDT(match_age53f)\
\
m_age53f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age53f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age53f$factor\
f53 <- as.data.table(r)\
f53$ID2 <- seq.int(nrow(f53))\
\
match_full106 <- cbind(match_age53f, f53)\
match_full106 = match_full106[!match_full106$r== 'NA',]\
\
md_controls53f <- subset(match_full106, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases53f <- subset(match_full106, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases53f[,.N,by=person_id]\
md_controls53f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls106 <-md_controls53f[order(person_id)]\
md_controls106[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_53f <- subset(md_controls106, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_53f <- subset(md_controls106, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_53f2 <- multi_53f[,c(1,2,3,4)]\
multi_53f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full106$person_id)]\
\
##Rematch the used PIDs\
\
control53_f_d2 <- subset(control_pop_f, index_age >=3320 & index_age<3390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control53_f_d2)\
match_age53f_d2 <- rbind(multi_53f2, control53_f_d2)\
m_age53f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age53f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age53f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full106_d2 <- cbind(match_age53f_d2, r2)\
match_full106_d2 = match_full106_d2[!match_full106_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_53f <- unique_53f[,c(1,2,3,4,5,6,7)]\
match_full106_d3 <-rbind(unique_53f, match_full106_d2)\
match_full106_d3 <- subset(match_full106_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full106_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full106_d3$person_id)]\
\
## 3380-3430 days old\
#males\
\
case54_m <- subset(case_pop_m, index_age >=3380 & index_age <3430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case54_m)\
control54_m <- subset(control_pop_m, index_age >=3370 & index_age<3440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control54_m)\
match_age54m <- rbind(case54_m, control54_m)\
setDT(match_age54m)\
\
m_age54m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age54m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age54m$factor\
m54 <- as.data.table(r)\
m54$ID2 <- seq.int(nrow(m54))\
\
match_full107 <- cbind(match_age54m, m54)\
match_full107 = match_full107[!match_full107$r== 'NA',]\
\
md_controls54m <- subset(match_full107, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases54m <- subset(match_full107, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases54m[,.N,by=person_id]\
md_controls54m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls107 <-md_controls54m[order(person_id)]\
md_controls107[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_54m <- subset(md_controls107, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_54m <- subset(md_controls107, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_54m2 <- multi_54m[,c(1,2,3,4)]\
multi_54m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full107$person_id)]\
\
##Rematch the used PIDs\
\
control54_m_d2 <- subset(control_pop_m, index_age >=3370 & index_age<3440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control54_m_d2)\
match_age54m_d2 <- rbind(multi_54m2, control54_m_d2)\
m_age54m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age54m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age54m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full107_d2 <- cbind(match_age54m_d2, r2)\
match_full107_d2 = match_full107_d2[!match_full107_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_54m <- unique_54m[,c(1,2,3,4,5,6,7)]\
match_full107_d3 <-rbind(unique_54m, match_full107_d2)\
match_full107_d3 <- subset(match_full107_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full107_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full107_d3$person_id)]\
\
#females\
case54_f <- subset(case_pop_f, index_age >=3380 & index_age < 3430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case54_f)\
control54_f <- subset(control_pop_f, index_age >=3370 & index_age<3440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control54_f)\
match_age54f <- rbind(case54_f, control54_f)\
setDT(match_age54f)\
\
m_age54f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age54f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age54f$factor\
f54 <- as.data.table(r)\
f54$ID2 <- seq.int(nrow(f54))\
\
match_full108 <- cbind(match_age54f, f54)\
match_full108 = match_full108[!match_full108$r== 'NA',]\
\
md_controls54f <- subset(match_full108, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases54f <- subset(match_full108, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases54f[,.N,by=person_id]\
md_controls54f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls54f$person_id)]\
\
## 3430-3480 days old\
#males\
\
case55_m <- subset(case_pop_m, index_age >=3430 & index_age <3480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case55_m)\
control55_m <- subset(control_pop_m, index_age >=3420 & index_age<3490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control55_m)\
match_age55m <- rbind(case55_m, control55_m)\
setDT(match_age55m)\
\
m_age55m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age55m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age55m$factor\
m55 <- as.data.table(r)\
m55$ID2 <- seq.int(nrow(m55))\
\
match_full109 <- cbind(match_age55m, m55)\
match_full109 = match_full109[!match_full109$r== 'NA',]\
\
md_controls55m <- subset(match_full109, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases55m <- subset(match_full109, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases55m[,.N,by=person_id]\
md_controls55m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls109 <-md_controls55m[order(person_id)]\
md_controls109[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_55m <- subset(md_controls109, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_55m <- subset(md_controls109, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_55m2 <- multi_55m[,c(1,2,3,4)]\
multi_55m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full109$person_id)]\
\
##Rematch the used PIDs\
control55_m_d2 <- subset(control_pop_m, index_age >=3420 & index_age<3490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control55_m_d2)\
match_age55m_d2 <- rbind(multi_55m2, control55_m_d2)\
m_age55m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age55m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age55m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full109_d2 <- cbind(match_age55m_d2, r2)\
match_full109_d2 = match_full109_d2[!match_full109_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_55m <- unique_55m[,c(1,2,3,4,5,6,7)]\
match_full109_d3 <-rbind(unique_55m, match_full109_d2)\
match_full109_d3 <- subset(match_full109_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full109_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full109_d3$person_id)]\
\
#females\
case55_f <- subset(case_pop_f, index_age >=3430 & index_age < 3480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case55_f)\
control55_f <- subset(control_pop_f, index_age >=3420 & index_age<3490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control55_f)\
match_age55f <- rbind(case55_f, control55_f)\
setDT(match_age55f)\
\
m_age55f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age55f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age55f$factor\
f55 <- as.data.table(r)\
f55$ID2 <- seq.int(nrow(f55))\
\
match_full110 <- cbind(match_age55f, f55)\
match_full110 = match_full110[!match_full110$r== 'NA',]\
\
md_controls55f <- subset(match_full110, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases55f <- subset(match_full110, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases55f[,.N,by=person_id]\
md_controls55f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls110 <-md_controls55f[order(person_id)]\
md_controls110[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_55f <- subset(md_controls110, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_55f <- subset(md_controls110, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_55f2 <- multi_55f[,c(1,2,3,4)]\
multi_55f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full110$person_id)]\
\
##Rematch the used PIDs\
\
control55_f_d2 <- subset(control_pop_f, index_age >=3420 & index_age<3490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control55_f_d2)\
match_age55f_d2 <- rbind(multi_55f2, control55_f_d2)\
m_age55f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age55f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age55f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full110_d2 <- cbind(match_age55f_d2, r2)\
match_full110_d2 = match_full110_d2[!match_full110_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_55f <- unique_55f[,c(1,2,3,4,5,6,7)]\
match_full110_d3 <-rbind(unique_55f, match_full110_d2)\
match_full110_d3 <- subset(match_full110_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full110_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full110_d3$person_id)]\
\
##combine all matched data: round 11\
\
colnames(match_full101_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full102_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls52m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full104_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full105_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full106_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full107_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls54f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full109_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full110_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_11 <- rbind(match_full101_d3, match_full102_d3, md_controls52m, match_full104_d3, match_full105_d3, match_full106_d3,match_full107_d3, md_controls54f, match_full109_d3, match_full110_d3)\
setDT(match_total_11)\
\
match_total_11[,.N,by=person_id]\
\
write.csv(match_total_11, 'match_total_11.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_11,  c("person_id","num_of_prior_visits"))\
\
mt11_matched_measures3= f[match_total_11]\
mt11_matched_measures4 <- mt11_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt11_matched_measures4)\
\
setkeyv(mt11_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt11_control_conditions= conditions2[mt11_matched_measures4]\
\
mt11_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-index visits for the matched controls\
#Pre index\
mt11_cont_pre_index <- match_total_11[,c(1,4)]\
mt11_cont_pre_index$pre <- mt11_cont_pre_index[, 2] -1\
mt11_cont_pre_index2 <- mt11_cont_pre_index[,c(1,3)]\
colnames(mt11_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt11_cont_pre_index2)\
setkeyv(mt11_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt11_matched_pre_measures= f[mt11_cont_pre_index2]\
\
mt11_matched_pre_measures2 <- mt11_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt11_matched_pre_measures2)\
\
setkeyv(mt11_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt11_control_conditions_pre= conditions2[mt11_matched_pre_measures2]\
\
mt11_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt11_cont_post_index <- match_total_11[,c(1,4)]\
mt11_cont_post_index$post <- mt11_cont_pre_index[, 2] +1\
mt11_cont_post_index2 <- mt11_cont_post_index[,c(1,3)]\
colnames(mt11_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt11_cont_post_index2)\
setkeyv(mt11_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt11_matched_post_measures= f[mt11_cont_post_index2]\
\
mt11_matched_post_measures2 <- mt11_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt11_matched_post_measures2)\
\
setkeyv(mt11_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt11_control_conditions_post= conditions2[mt11_matched_post_measures2]\
\
mt11_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt11_control_conditions_post= mt11_control_conditions_post[!mt11_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt11_control_conditions_post$Timing_Class = '3'\
mt11_control_conditions_pre$Timing_Class = '1'\
mt11_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_11$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_11$person_id)]\
\
#Combine all clinical observations from the 8th set\
full_con_11 <- rbind(mt11_control_conditions_pre, mt11_control_conditions, mt11_control_conditions_post)\
setDT(full_con_11)\
full_con_11[,.N,by=person_id]\
\
## 3480-3530 days old\
#males\
\
case56_m <- subset(case_pop_m, index_age >=3480 & index_age <3530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case56_m)\
control56_m <- subset(control_pop_m, index_age >=3470 & index_age<3540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control56_m)\
match_age56m <- rbind(case56_m, control56_m)\
setDT(match_age56m)\
\
m_age56m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age56m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age56m$factor\
m56 <- as.data.table(r)\
m56$ID2 <- seq.int(nrow(m56))\
\
match_full111 <- cbind(match_age56m, m56)\
match_full111 = match_full111[!match_full111$r== 'NA',]\
\
md_controls56m <- subset(match_full111, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases56m <- subset(match_full111, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases56m[,.N,by=person_id]\
md_controls56m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls111 <-md_controls56m[order(person_id)]\
md_controls111[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_56m <- subset(md_controls111, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_56m <- subset(md_controls111, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_56m2 <- multi_56m[,c(1,2,3,4)]\
multi_56m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full111$person_id)]\
\
##Rematch the used PIDs\
control56_m_d2 <- subset(control_pop_m, index_age >=3470 & index_age<3540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control56_m_d2)\
match_age56m_d2 <- rbind(multi_56m2, control56_m_d2)\
m_age56m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age56m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age56m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full111_d2 <- cbind(match_age56m_d2, r2)\
match_full111_d2 = match_full111_d2[!match_full111_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_56m <- unique_56m[,c(1,2,3,4,5,6,7)]\
match_full111_d3 <-rbind(unique_56m, match_full111_d2)\
match_full111_d3 <- subset(match_full111_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full111_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full111_d3$person_id)]\
\
#females\
case56_f <- subset(case_pop_f, index_age >=3480 & index_age < 3530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case56_f)\
control56_f <- subset(control_pop_f, index_age >=3470 & index_age<3540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control56_f)\
match_age56f <- rbind(case56_f, control56_f)\
setDT(match_age56f)\
\
m_age56f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age56f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age56f$factor\
f56 <- as.data.table(r)\
f56$ID2 <- seq.int(nrow(f56))\
\
match_full112 <- cbind(match_age56f, f56)\
match_full112 = match_full112[!match_full112$r== 'NA',]\
\
md_controls56f <- subset(match_full112, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases56f <- subset(match_full112, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases56f[,.N,by=person_id]\
md_controls56f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls112 <-md_controls56f[order(person_id)]\
md_controls112[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_56f <- subset(md_controls112, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_56f <- subset(md_controls112, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_56f2 <- multi_56f[,c(1,2,3,4)]\
multi_56f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full112$person_id)]\
\
##Rematch the used PIDs\
\
control56_f_d2 <- subset(control_pop_f, index_age >=3470 & index_age<3540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control56_f_d2)\
match_age56f_d2 <- rbind(multi_56f2, control56_f_d2)\
m_age56f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age56f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age56f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full112_d2 <- cbind(match_age56f_d2, r2)\
match_full112_d2 = match_full112_d2[!match_full112_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_56f <- unique_56f[,c(1,2,3,4,5,6,7)]\
match_full112_d3 <-rbind(unique_56f, match_full112_d2)\
match_full112_d3 <- subset(match_full112_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full112_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full112_d3$person_id)]\
\
## 3530-3580 days old\
#males\
\
case57_m <- subset(case_pop_m, index_age >=3530 & index_age <3580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case57_m)\
control57_m <- subset(control_pop_m, index_age >=3520 & index_age<3590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control57_m)\
match_age57m <- rbind(case57_m, control57_m)\
setDT(match_age57m)\
\
m_age57m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age57m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age57m$factor\
m57 <- as.data.table(r)\
m57$ID2 <- seq.int(nrow(m57))\
\
match_full113 <- cbind(match_age57m, m57)\
match_full113 = match_full113[!match_full113$r== 'NA',]\
\
md_controls57m <- subset(match_full113, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases57m <- subset(match_full113, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases57m[,.N,by=person_id]\
md_controls57m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls57m$person_id)]\
\
#females\
case57_f <- subset(case_pop_f, index_age >=3530 & index_age < 3580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case57_f)\
control57_f <- subset(control_pop_f, index_age >=3520 & index_age<3590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control57_f)\
match_age57f <- rbind(case57_f, control57_f)\
setDT(match_age57f)\
\
m_age57f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age57f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age57f$factor\
f57 <- as.data.table(r)\
f57$ID2 <- seq.int(nrow(f57))\
\
match_full114 <- cbind(match_age57f, f57)\
match_full114 = match_full114[!match_full114$r== 'NA',]\
\
md_controls57f <- subset(match_full114, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases57f <- subset(match_full114, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases57f[,.N,by=person_id]\
md_controls57f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls114 <-md_controls57f[order(person_id)]\
md_controls114[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_57f <- subset(md_controls114, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_57f <- subset(md_controls114, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_57f2 <- multi_57f[,c(1,2,3,4)]\
multi_57f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full114$person_id)]\
\
##Rematch the used PIDs\
\
control57_f_d2 <- subset(control_pop_f, index_age >=3520 & index_age<3590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control57_f_d2)\
match_age57f_d2 <- rbind(multi_57f2, control57_f_d2)\
m_age57f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age57f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age57f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full114_d2 <- cbind(match_age57f_d2, r2)\
match_full114_d2 = match_full114_d2[!match_full114_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_57f <- unique_57f[,c(1,2,3,4,5,6,7)]\
match_full114_d3 <-rbind(unique_57f, match_full114_d2)\
match_full114_d3 <- subset(match_full114_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full114_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full114_d3$person_id)]\
\
## 3580-3630 days old\
#males\
\
case58_m <- subset(case_pop_m, index_age >=3580 & index_age <3630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case58_m)\
control58_m <- subset(control_pop_m, index_age >=3570 & index_age<3640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control58_m)\
match_age58m <- rbind(case58_m, control58_m)\
setDT(match_age58m)\
\
m_age58m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age58m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age58m$factor\
m58 <- as.data.table(r)\
m58$ID2 <- seq.int(nrow(m58))\
\
match_full115 <- cbind(match_age58m, m58)\
match_full115 = match_full115[!match_full115$r== 'NA',]\
\
md_controls58m <- subset(match_full115, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases58m <- subset(match_full115, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases58m[,.N,by=person_id]\
md_controls58m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls115 <-md_controls58m[order(person_id)]\
md_controls115[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_58m <- subset(md_controls115, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_58m <- subset(md_controls115, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_58m2 <- multi_58m[,c(1,2,3,4)]\
multi_58m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full115$person_id)]\
\
##Rematch the used PIDs\
control58_m_d2 <- subset(control_pop_m, index_age >=3570 & index_age<3640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control58_m_d2)\
match_age58m_d2 <- rbind(multi_58m2, control58_m_d2)\
m_age58m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age58m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age58m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full115_d2 <- cbind(match_age58m_d2, r2)\
match_full115_d2 = match_full115_d2[!match_full115_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_58m <- unique_58m[,c(1,2,3,4,5,6,7)]\
match_full115_d3 <-rbind(unique_58m, match_full115_d2)\
match_full115_d3 <- subset(match_full115_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full115_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full115_d3$person_id)]\
\
#Rematch the duplicate\
md_controls115 <-match_full115_d3[order(person_id)]\
md_controls115[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_58m <- subset(md_controls115, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_58m <- subset(md_controls115, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_58m2 <- multi_58m[,c(1,2,3,4)]\
multi_58m2$casecont = 'case'\
\
##Rematch the used PIDs\
control58_m_d2 <- subset(control_pop_m, index_age >=3570 & index_age<3640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control58_m_d2)\
match_age58m_d2 <- rbind(multi_58m2, control58_m_d2)\
m_age58m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age58m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age58m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full115_d2 <- cbind(match_age58m_d2, r2)\
match_full115_d2 = match_full115_d2[!match_full115_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_58m <- unique_58m[,c(1,2,3,4,5,6,7)]\
match_full115_d3 <-rbind(unique_58m, match_full115_d2)\
match_full115_d3 <- subset(match_full115_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full115_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full115_d3$person_id)]\
\
#females\
case58_f <- subset(case_pop_f, index_age >=3580 & index_age < 3630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case58_f)\
control58_f <- subset(control_pop_f, index_age >=3570 & index_age<3640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control58_f)\
match_age58f <- rbind(case58_f, control58_f)\
setDT(match_age58f)\
\
m_age58f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age58f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age58f$factor\
f58 <- as.data.table(r)\
f58$ID2 <- seq.int(nrow(f58))\
\
match_full116 <- cbind(match_age58f, f58)\
match_full116 = match_full116[!match_full116$r== 'NA',]\
\
md_controls58f <- subset(match_full116, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases58f <- subset(match_full116, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases58f[,.N,by=person_id]\
md_controls58f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls116 <-md_controls58f[order(person_id)]\
md_controls116[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_58f <- subset(md_controls116, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_58f <- subset(md_controls116, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_58f2 <- multi_58f[,c(1,2,3,4)]\
multi_58f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full116$person_id)]\
\
##Rematch the used PIDs\
\
control58_f_d2 <- subset(control_pop_f, index_age >=3570 & index_age<3640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control58_f_d2)\
match_age58f_d2 <- rbind(multi_58f2, control58_f_d2)\
m_age58f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age58f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age58f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full116_d2 <- cbind(match_age58f_d2, r2)\
match_full116_d2 = match_full116_d2[!match_full116_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_58f <- unique_58f[,c(1,2,3,4,5,6,7)]\
match_full116_d3 <-rbind(unique_58f, match_full116_d2)\
match_full116_d3 <- subset(match_full116_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full116_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full116_d3$person_id)]\
\
## 3630-3680 days old\
#males\
\
case59_m <- subset(case_pop_m, index_age >=3630 & index_age <3680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case59_m)\
control59_m <- subset(control_pop_m, index_age >=3620 & index_age<3690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control59_m)\
match_age59m <- rbind(case59_m, control59_m)\
setDT(match_age59m)\
\
m_age59m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age59m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age59m$factor\
m59 <- as.data.table(r)\
m59$ID2 <- seq.int(nrow(m59))\
\
match_full117 <- cbind(match_age59m, m59)\
match_full117 = match_full117[!match_full117$r== 'NA',]\
\
md_controls59m <- subset(match_full117, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases59m <- subset(match_full117, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases59m[,.N,by=person_id]\
md_controls59m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls59m$person_id)]\
\
#females\
case59_f <- subset(case_pop_f, index_age >=3630 & index_age < 3680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case59_f)\
control59_f <- subset(control_pop_f, index_age >=3620 & index_age<3690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control59_f)\
match_age59f <- rbind(case59_f, control59_f)\
setDT(match_age59f)\
\
m_age59f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age59f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age59f$factor\
f59 <- as.data.table(r)\
f59$ID2 <- seq.int(nrow(f59))\
\
match_full118 <- cbind(match_age59f, f59)\
match_full118 = match_full118[!match_full118$r== 'NA',]\
\
md_controls59f <- subset(match_full118, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases59f <- subset(match_full118, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases59f[,.N,by=person_id]\
md_controls59f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls118 <-md_controls59f[order(person_id)]\
md_controls118[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_59f <- subset(md_controls118, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_59f <- subset(md_controls118, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_59f2 <- multi_59f[,c(1,2,3,4)]\
multi_59f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full118$person_id)]\
\
##Rematch the used PIDs\
\
control59_f_d2 <- subset(control_pop_f, index_age >=3620 & index_age<3690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control59_f_d2)\
match_age59f_d2 <- rbind(multi_59f2, control59_f_d2)\
m_age59f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age59f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age59f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full118_d2 <- cbind(match_age59f_d2, r2)\
match_full118_d2 = match_full118_d2[!match_full118_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_59f <- unique_59f[,c(1,2,3,4,5,6,7)]\
match_full118_d3 <-rbind(unique_59f, match_full118_d2)\
match_full118_d3 <- subset(match_full118_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full118_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full118_d3$person_id)]\
\
## 3680-3730 days old\
#males\
\
case60_m <- subset(case_pop_m, index_age >=3680 & index_age <3730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case60_m)\
control60_m <- subset(control_pop_m, index_age >=3670 & index_age<3740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control60_m)\
match_age60m <- rbind(case60_m, control60_m)\
setDT(match_age60m)\
\
m_age60m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age60m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age60m$factor\
m60 <- as.data.table(r)\
m60$ID2 <- seq.int(nrow(m60))\
\
match_full119 <- cbind(match_age60m, m60)\
match_full119 = match_full119[!match_full119$r== 'NA',]\
\
md_controls60m <- subset(match_full119, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases60m <- subset(match_full119, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases60m[,.N,by=person_id]\
md_controls60m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls119 <-md_controls60m[order(person_id)]\
md_controls119[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_60m <- subset(md_controls119, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_60m <- subset(md_controls119, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_60m2 <- multi_60m[,c(1,2,3,4)]\
multi_60m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full119$person_id)]\
\
##Rematch the used PIDs\
control60_m_d2 <- subset(control_pop_m, index_age >=3670 & index_age<3740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control60_m_d2)\
match_age60m_d2 <- rbind(multi_60m2, control60_m_d2)\
m_age60m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age60m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age60m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full119_d2 <- cbind(match_age60m_d2, r2)\
match_full119_d2 = match_full119_d2[!match_full119_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_60m <- unique_60m[,c(1,2,3,4,5,6,7)]\
match_full119_d3 <-rbind(unique_60m, match_full119_d2)\
match_full119_d3 <- subset(match_full119_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full119_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full119_d3$person_id)]\
\
#females\
case60_f <- subset(case_pop_f, index_age >=3680 & index_age <3730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case60_f)\
control60_f <- subset(control_pop_f, index_age >=3670 & index_age<3740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control60_f)\
match_age60f <- rbind(case60_f, control60_f)\
setDT(match_age60f)\
\
m_age60f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age60f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age60f$factor\
f60 <- as.data.table(r)\
f60$ID2 <- seq.int(nrow(f60))\
\
match_full120 <- cbind(match_age60f, f60)\
match_full120 = match_full120[!match_full120$r== 'NA',]\
\
md_controls60f <- subset(match_full120, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases60f <- subset(match_full120, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases60f[,.N,by=person_id]\
md_controls60f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls120 <-md_controls60f[order(person_id)]\
md_controls120[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_60f <- subset(md_controls120, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_60f <- subset(md_controls120, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_60f2 <- multi_60f[,c(1,2,3,4)]\
multi_60f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full120$person_id)]\
\
##Rematch the used PIDs\
\
control60_f_d2 <- subset(control_pop_f, index_age >=3670 & index_age<3740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control60_f_d2)\
match_age60f_d2 <- rbind(multi_60f2, control60_f_d2)\
m_age60f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age60f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age60f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full120_d2 <- cbind(match_age60f_d2, r2)\
match_full120_d2 = match_full120_d2[!match_full120_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_60f <- unique_60f[,c(1,2,3,4,5,6,7)]\
match_full120_d3 <-rbind(unique_60f, match_full120_d2)\
match_full120_d3 <- subset(match_full120_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full120_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full120_d3$person_id)]\
\
##combine all matched data: round 12\
\
colnames(match_full111_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full112_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls57m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full114_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full115_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full116_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls59m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full118_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full119_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full120_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_12 <- rbind(match_full111_d3, match_full112_d3, md_controls57m, match_full114_d3, match_full115_d3, match_full116_d3, md_controls59m, match_full118_d3, match_full119_d3, match_full120_d3)\
setDT(match_total_12)\
\
##One duplicate match; rematch this\
md_controls_tot12 <-match_total_12[order(person_id)]\
md_controls_tot12[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_tot12 <- subset(md_controls_tot12, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID, num_matches))\
\
unique_tot12 <- subset(md_controls_tot12, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID, num_matches))\
\
multi_tot12_m  = multi_tot12[!multi_tot12$gender== 8532,]\
multi_tot12_f = multi_tot12[!multi_tot12$gender== 8507,]\
unique_tot12_m  = unique_tot12[!unique_tot12$gender== 8532,]\
unique_tot12_f = unique_tot12[!unique_tot12$gender== 8507,]\
\
multi_tot12_m <- multi_tot12_m[,c(1,2,3,4)]\
multi_tot12_m$casecont = 'case'\
multi_tot12_f <- multi_tot12_f[,c(1,2,3,4)]\
multi_tot12_f$casecont = 'case'\
\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_total_12$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_12$person_id)]\
\
##Rematch the used PIDs\
\
controltot12m_d2 <- subset(control_pop_m, index_age >=3620 & index_age<3690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(controltot12m_d2)\
match_tot12m_d2 <- rbind(multi_tot12_m, controltot12m_d2)\
m_tot12m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_tot12m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_tot12m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_fulltot12m_d2 <- cbind(match_tot12m_d2, r2)\
match_fulltot12m_d2 = match_fulltot12m_d2[!match_fulltot12m_d2$r== 'NA',]\
\
controltot12f_d2 <- subset(control_pop_f, index_age >=3520 & index_age<3590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(controltot12f_d2)\
match_tot12f_d2 <- rbind(multi_tot12_f, controltot12f_d2)\
m_tot12f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_tot12f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_tot12f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_fulltot12f_d2 <- cbind(match_tot12f_d2, r2)\
match_fulltot12f_d2 = match_fulltot12f_d2[!match_fulltot12f_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_tot12 <- unique_tot12[,c(1,2,3,4,5,6,7)]\
colnames(match_fulltot12m_d2) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_fulltot12f_d2) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_fulltot12_d3 <-rbind(unique_tot12, match_fulltot12m_d2, match_fulltot12f_d2)\
match_fulltot12_d3 <- subset(match_fulltot12_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID))\
\
match_fulltot12_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_fulltot12_d3$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_fulltot12_d3$person_id)]\
\
match_total_12 <- setDT(match_fulltot12_d3)\
\
write.csv(match_total_12, 'match_total_12.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_12,  c("person_id","num_of_prior_visits"))\
\
mt12_matched_measures3= f[match_total_12]\
mt12_matched_measures4 <- mt12_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt12_matched_measures4)\
\
setkeyv(mt12_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt12_control_conditions= conditions2[mt12_matched_measures4]\
\
mt12_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt12_cont_pre_index <- match_total_12[,c(1,4)]\
mt12_cont_pre_index$pre <- mt12_cont_pre_index[, 2] -1\
mt12_cont_pre_index2 <- mt12_cont_pre_index[,c(1,3)]\
colnames(mt12_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt12_cont_pre_index2)\
setkeyv(mt12_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt12_matched_pre_measures= f[mt12_cont_pre_index2]\
\
mt12_matched_pre_measures2 <- mt12_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt12_matched_pre_measures2)\
\
setkeyv(mt12_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt12_control_conditions_pre= conditions2[mt12_matched_pre_measures2]\
\
mt12_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt12_cont_post_index <- match_total_12[,c(1,4)]\
mt12_cont_post_index$post <- mt12_cont_pre_index[, 2] +1\
mt12_cont_post_index2 <- mt12_cont_post_index[,c(1,3)]\
colnames(mt12_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt12_cont_post_index2)\
setkeyv(mt12_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt12_matched_post_measures= f[mt12_cont_post_index2]\
\
mt12_matched_post_measures2 <- mt12_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt12_matched_post_measures2)\
\
setkeyv(mt12_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt12_control_conditions_post= conditions2[mt12_matched_post_measures2]\
\
mt12_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt12_control_conditions_post= mt12_control_conditions_post[!mt12_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt12_control_conditions_post$Timing_Class = '3'\
mt12_control_conditions_pre$Timing_Class = '1'\
mt12_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_12$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_12$person_id)]\
\
#Combine all clinical observations from the 10th set\
full_con_12 <- rbind(mt12_control_conditions_pre, mt12_control_conditions, mt12_control_conditions_post)\
setDT(full_con_12)\
full_con_12[,.N,by=person_id]\
\
## 3730-3780 days old\
#males\
\
case61_m <- subset(case_pop_m, index_age >=3730 & index_age <3780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case61_m)\
control61_m <- subset(control_pop_m, index_age >=3720 & index_age<3790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control61_m)\
match_age61m <- rbind(case61_m, control61_m)\
setDT(match_age61m)\
\
m_age61m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age61m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age61m$factor\
m61 <- as.data.table(r)\
m61$ID2 <- seq.int(nrow(m61))\
\
match_full121 <- cbind(match_age61m, m61)\
match_full121 = match_full121[!match_full121$r== 'NA',]\
\
md_controls61m <- subset(match_full121, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases61m <- subset(match_full121, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases61m[,.N,by=person_id]\
md_controls61m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls121 <-md_controls61m[order(person_id)]\
md_controls121[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_61m <- subset(md_controls121, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_61m <- subset(md_controls121, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_61m2 <- multi_61m[,c(1,2,3,4)]\
multi_61m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full121$person_id)]\
\
##Rematch the used PIDs\
control61_m_d2 <- subset(control_pop_m, index_age >=3720 & index_age<3790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control61_m_d2)\
match_age61m_d2 <- rbind(multi_61m2, control61_m_d2)\
m_age61m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age61m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age61m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full121_d2 <- cbind(match_age61m_d2, r2)\
match_full121_d2 = match_full121_d2[!match_full121_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_61m <- unique_61m[,c(1,2,3,4,5,6,7)]\
match_full121_d3 <-rbind(unique_61m, match_full121_d2)\
match_full121_d3 <- subset(match_full121_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full121_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full121_d3$person_id)]\
\
#females\
case61_f <- subset(case_pop_f, index_age >=3730 & index_age <3780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case61_f)\
control61_f <- subset(control_pop_f, index_age >=3720 & index_age<3790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control61_f)\
match_age61f <- rbind(case61_f, control61_f)\
setDT(match_age61f)\
\
m_age61f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age61f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age61f$factor\
f61 <- as.data.table(r)\
f61$ID2 <- seq.int(nrow(f61))\
\
match_full122 <- cbind(match_age61f, f61)\
match_full122 = match_full122[!match_full122$r== 'NA',]\
\
md_controls61f <- subset(match_full122, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases61f <- subset(match_full122, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases61f[,.N,by=person_id]\
md_controls61f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls122 <-md_controls61f[order(person_id)]\
md_controls122[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_61f <- subset(md_controls122, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_61f <- subset(md_controls122, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_61f2 <- multi_61f[,c(1,2,3,4)]\
multi_61f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full122$person_id)]\
\
##Rematch the used PIDs\
\
control61_f_d2 <- subset(control_pop_f, index_age >=3720 & index_age<3790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control61_f_d2)\
match_age61f_d2 <- rbind(multi_61f2, control61_f_d2)\
m_age61f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age61f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age61f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full122_d2 <- cbind(match_age61f_d2, r2)\
match_full122_d2 = match_full122_d2[!match_full122_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_61f <- unique_61f[,c(1,2,3,4,5,6,7)]\
match_full122_d3 <-rbind(unique_61f, match_full122_d2)\
match_full122_d3 <- subset(match_full122_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full122_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full122_d3$person_id)]\
\
## 3780-3830 days old\
#males\
\
case62_m <- subset(case_pop_m, index_age >=3780 & index_age <3830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case62_m)\
control62_m <- subset(control_pop_m, index_age >=3770 & index_age<3840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control62_m)\
match_age62m <- rbind(case62_m, control62_m)\
setDT(match_age62m)\
\
m_age62m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age62m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age62m$factor\
m62 <- as.data.table(r)\
m62$ID2 <- seq.int(nrow(m62))\
\
match_full123 <- cbind(match_age62m, m62)\
match_full123 = match_full123[!match_full123$r== 'NA',]\
\
md_controls62m <- subset(match_full123, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases62m <- subset(match_full123, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases62m[,.N,by=person_id]\
md_controls62m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls123 <-md_controls62m[order(person_id)]\
md_controls123[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_62m <- subset(md_controls123, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_62m <- subset(md_controls123, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_62m2 <- multi_62m[,c(1,2,3,4)]\
multi_62m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full123$person_id)]\
\
##Rematch the used PIDs\
control62_m_d2 <- subset(control_pop_m, index_age >=3770 & index_age<3840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control62_m_d2)\
match_age62m_d2 <- rbind(multi_62m2, control62_m_d2)\
m_age62m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age62m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age62m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full123_d2 <- cbind(match_age62m_d2, r2)\
match_full123_d2 = match_full123_d2[!match_full123_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_62m <- unique_62m[,c(1,2,3,4,5,6,7)]\
match_full123_d3 <-rbind(unique_62m, match_full123_d2)\
match_full123_d3 <- subset(match_full123_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full123_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full123_d3$person_id)]\
\
#females\
case62_f <- subset(case_pop_f, index_age >=3780 & index_age <3830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case62_f)\
control62_f <- subset(control_pop_f, index_age >=3770 & index_age<3840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control62_f)\
match_age62f <- rbind(case62_f, control62_f)\
setDT(match_age62f)\
\
m_age62f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age62f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age62f$factor\
f62 <- as.data.table(r)\
f62$ID2 <- seq.int(nrow(f62))\
\
match_full124 <- cbind(match_age62f, f62)\
match_full124 = match_full124[!match_full124$r== 'NA',]\
\
md_controls62f <- subset(match_full124, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases62f <- subset(match_full124, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases62f[,.N,by=person_id]\
md_controls62f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls124 <-md_controls62f[order(person_id)]\
md_controls124[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_62f <- subset(md_controls124, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_62f <- subset(md_controls124, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_62f2 <- multi_62f[,c(1,2,3,4)]\
multi_62f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full124$person_id)]\
\
##Rematch the used PIDs\
\
control62_f_d2 <- subset(control_pop_f, index_age >=3770 & index_age<3840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control62_f_d2)\
match_age62f_d2 <- rbind(multi_62f2, control62_f_d2)\
m_age62f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age62f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age62f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full124_d2 <- cbind(match_age62f_d2, r2)\
match_full124_d2 = match_full124_d2[!match_full124_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_62f <- unique_62f[,c(1,2,3,4,5,6,7)]\
match_full124_d3 <-rbind(unique_62f, match_full124_d2)\
match_full124_d3 <- subset(match_full124_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full124_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full124_d3$person_id)]\
\
## 3830-3880 days old\
#males\
\
case63_m <- subset(case_pop_m, index_age >=3830 & index_age <3880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case63_m)\
control63_m <- subset(control_pop_m, index_age >=3820 & index_age<3890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control63_m)\
match_age63m <- rbind(case63_m, control63_m)\
setDT(match_age63m)\
\
m_age63m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age63m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age63m$factor\
m63 <- as.data.table(r)\
m63$ID2 <- seq.int(nrow(m63))\
\
match_full125 <- cbind(match_age63m, m63)\
match_full125 = match_full125[!match_full125$r== 'NA',]\
\
md_controls63m <- subset(match_full125, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases63m <- subset(match_full125, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases63m[,.N,by=person_id]\
md_controls63m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls125 <-md_controls63m[order(person_id)]\
md_controls125[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_63m <- subset(md_controls125, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_63m <- subset(md_controls125, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_63m2 <- multi_63m[,c(1,2,3,4)]\
multi_63m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full125$person_id)]\
\
##Rematch the used PIDs\
control63_m_d2 <- subset(control_pop_m, index_age >=3820 & index_age<3890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control63_m_d2)\
match_age63m_d2 <- rbind(multi_63m2, control63_m_d2)\
m_age63m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age63m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age63m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full125_d2 <- cbind(match_age63m_d2, r2)\
match_full125_d2 = match_full125_d2[!match_full125_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_63m <- unique_63m[,c(1,2,3,4,5,6,7)]\
match_full125_d3 <-rbind(unique_63m, match_full125_d2)\
match_full125_d3 <- subset(match_full125_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full125_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full125_d3$person_id)]\
\
#females\
case63_f <- subset(case_pop_f, index_age >=3830 & index_age <3880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case63_f)\
control63_f <- subset(control_pop_f, index_age >=3820 & index_age<3890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control63_f)\
match_age63f <- rbind(case63_f, control63_f)\
setDT(match_age63f)\
\
m_age63f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age63f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age63f$factor\
f63 <- as.data.table(r)\
f63$ID2 <- seq.int(nrow(f63))\
\
match_full126 <- cbind(match_age63f, f63)\
match_full126 = match_full126[!match_full126$r== 'NA',]\
\
md_controls63f <- subset(match_full126, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases63f <- subset(match_full126, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases63f[,.N,by=person_id]\
md_controls63f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls126 <-md_controls63f[order(person_id)]\
md_controls126[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_63f <- subset(md_controls126, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_63f <- subset(md_controls126, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_63f2 <- multi_63f[,c(1,2,3,4)]\
multi_63f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full126$person_id)]\
\
##Rematch the used PIDs\
\
control63_f_d2 <- subset(control_pop_f, index_age >=3820 & index_age<3890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control63_f_d2)\
match_age63f_d2 <- rbind(multi_63f2, control63_f_d2)\
m_age63f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age63f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age63f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full126_d2 <- cbind(match_age63f_d2, r2)\
match_full126_d2 = match_full126_d2[!match_full126_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_63f <- unique_63f[,c(1,2,3,4,5,6,7)]\
match_full126_d3 <-rbind(unique_63f, match_full126_d2)\
match_full126_d3 <- subset(match_full126_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full126_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full126_d3$person_id)]\
\
## 3880-3930 days old\
#males\
\
case64_m <- subset(case_pop_m, index_age >=3880 & index_age <3930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case64_m)\
control64_m <- subset(control_pop_m, index_age >=3870 & index_age<3940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control64_m)\
match_age64m <- rbind(case64_m, control64_m)\
setDT(match_age64m)\
\
m_age64m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age64m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age64m$factor\
m64 <- as.data.table(r)\
m64$ID2 <- seq.int(nrow(m64))\
\
match_full127 <- cbind(match_age64m, m64)\
match_full127 = match_full127[!match_full127$r== 'NA',]\
\
md_controls64m <- subset(match_full127, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases64m <- subset(match_full127, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases64m[,.N,by=person_id]\
md_controls64m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls127 <-md_controls64m[order(person_id)]\
md_controls127[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_64m <- subset(md_controls127, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_64m <- subset(md_controls127, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_64m2 <- multi_64m[,c(1,2,3,4)]\
multi_64m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full127$person_id)]\
\
##Rematch the used PIDs\
control64_m_d2 <- subset(control_pop_m,  index_age >=3870 & index_age<3940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control64_m_d2)\
match_age64m_d2 <- rbind(multi_64m2, control64_m_d2)\
m_age64m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age64m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age64m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full127_d2 <- cbind(match_age64m_d2, r2)\
match_full127_d2 = match_full127_d2[!match_full127_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_64m <- unique_64m[,c(1,2,3,4,5,6,7)]\
match_full127_d3 <-rbind(unique_64m, match_full127_d2)\
match_full127_d3 <- subset(match_full127_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full127_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full127_d3$person_id)]\
\
#females\
case64_f <- subset(case_pop_f, index_age >=3880 & index_age <3930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case64_f)\
control64_f <- subset(control_pop_f, index_age >=3870 & index_age<3940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control64_f)\
match_age64f <- rbind(case64_f, control64_f)\
setDT(match_age64f)\
\
m_age64f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age64f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age64f$factor\
f64 <- as.data.table(r)\
f64$ID2 <- seq.int(nrow(f64))\
\
match_full128 <- cbind(match_age64f, f64)\
match_full128 = match_full128[!match_full128$r== 'NA',]\
\
md_controls64f <- subset(match_full128, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases64f <- subset(match_full128, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases64f[,.N,by=person_id]\
md_controls64f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls128 <-md_controls64f[order(person_id)]\
md_controls128[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_64f <- subset(md_controls128, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_64f <- subset(md_controls128, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_64f2 <- multi_64f[,c(1,2,3,4)]\
multi_64f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full128$person_id)]\
\
##Rematch the used PIDs\
control64_f_d2 <- subset(control_pop_f, index_age >=3870 & index_age<3940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control64_f_d2)\
match_age64f_d2 <- rbind(multi_64f2, control64_f_d2)\
m_age64f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age64f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age64f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full128_d2 <- cbind(match_age64f_d2, r2)\
match_full128_d2 = match_full128_d2[!match_full128_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_64f <- unique_64f[,c(1,2,3,4,5,6,7)]\
match_full128_d3 <-rbind(unique_64f, match_full128_d2)\
match_full128_d3 <- subset(match_full128_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full128_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full128_d3$person_id)]\
\
## 3930-3980 days old\
#males\
\
case65_m <- subset(case_pop_m, index_age >=3930 & index_age <3980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case65_m)\
control65_m <- subset(control_pop_m, index_age >=3920 & index_age<3990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control65_m)\
match_age65m <- rbind(case65_m, control65_m)\
setDT(match_age65m)\
\
m_age65m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age65m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age65m$factor\
m65 <- as.data.table(r)\
m65$ID2 <- seq.int(nrow(m65))\
\
match_full129 <- cbind(match_age65m, m65)\
match_full129 = match_full129[!match_full129$r== 'NA',]\
\
md_controls65m <- subset(match_full129, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases65m <- subset(match_full129, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases65m[,.N,by=person_id]\
md_controls65m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls129 <-md_controls65m[order(person_id)]\
md_controls129[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_65m <- subset(md_controls129, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_65m <- subset(md_controls129, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_65m2 <- multi_65m[,c(1,2,3,4)]\
multi_65m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full129$person_id)]\
\
##Rematch the used PIDs\
control65_m_d2 <- subset(control_pop_m, index_age >=3920 & index_age<3990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control65_m_d2)\
match_age65m_d2 <- rbind(multi_65m2, control65_m_d2)\
m_age65m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age65m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age65m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full129_d2 <- cbind(match_age65m_d2, r2)\
match_full129_d2 = match_full129_d2[!match_full129_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_65m <- unique_65m[,c(1,2,3,4,5,6,7)]\
match_full129_d3 <-rbind(unique_65m, match_full129_d2)\
match_full129_d3 <- subset(match_full129_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full129_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full129_d3$person_id)]\
\
#females\
case65_f <- subset(case_pop_f, index_age >=3930 & index_age <3980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case65_f)\
control65_f <- subset(control_pop_f, index_age >=3920 & index_age<3990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control65_f)\
match_age65f <- rbind(case65_f, control65_f)\
setDT(match_age65f)\
\
m_age65f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age65f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age65f$factor\
f65 <- as.data.table(r)\
f65$ID2 <- seq.int(nrow(f65))\
\
match_full130 <- cbind(match_age65f, f65)\
match_full130 = match_full130[!match_full130$r== 'NA',]\
\
md_controls65f <- subset(match_full130, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases65f <- subset(match_full130, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases65f[,.N,by=person_id]\
md_controls65f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls130 <-md_controls65f[order(person_id)]\
md_controls130[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_65f <- subset(md_controls130, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_65f <- subset(md_controls130, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_65f2 <- multi_65f[,c(1,2,3,4)]\
multi_65f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full130$person_id)]\
\
##Rematch the used PIDs\
control65_f_d2 <- subset(control_pop_f, index_age >=3920 & index_age<3990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control65_f_d2)\
match_age65f_d2 <- rbind(multi_65f2, control65_f_d2)\
m_age65f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age65f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age65f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full130_d2 <- cbind(match_age65f_d2, r2)\
match_full130_d2 = match_full130_d2[!match_full130_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_65f <- unique_65f[,c(1,2,3,4,5,6,7)]\
match_full130_d3 <-rbind(unique_65f, match_full130_d2)\
match_full130_d3 <- subset(match_full130_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full130_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full130_d3$person_id)]\
##combine all matched data: round 13\
\
colnames(match_full121_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full122_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full123_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full124_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full125_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full126_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full127_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full128_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full129_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full130_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_13 <- rbind(match_full121_d3, match_full122_d3, match_full123_d3, match_full124_d3, match_full125_d3, match_full126_d3, match_full127_d3, match_full128_d3, match_full129_d3, match_full130_d3)\
setDT(match_total_13)\
\
match_total_13[,.N,by=person_id]\
\
write.csv(match_total_13, 'match_total_13.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_13,  c("person_id","num_of_prior_visits"))\
\
mt13_matched_measures3= f[match_total_13]\
mt13_matched_measures4 <- mt13_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt13_matched_measures4)\
\
setkeyv(mt13_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt13_control_conditions= conditions2[mt13_matched_measures4]\
\
mt13_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-index visits for the matched controls\
#Pre index\
mt13_cont_pre_index <- match_total_13[,c(1,4)]\
mt13_cont_pre_index$pre <- mt13_cont_pre_index[, 2] -1\
mt13_cont_pre_index2 <- mt13_cont_pre_index[,c(1,3)]\
colnames(mt13_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt13_cont_pre_index2)\
setkeyv(mt13_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt13_matched_pre_measures= f[mt13_cont_pre_index2]\
\
mt13_matched_pre_measures2 <- mt13_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt13_matched_pre_measures2)\
\
setkeyv(mt13_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt13_control_conditions_pre= conditions2[mt13_matched_pre_measures2]\
\
mt13_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt13_cont_post_index <- match_total_13[,c(1,4)]\
mt13_cont_post_index$post <- mt13_cont_pre_index[, 2] +1\
mt13_cont_post_index2 <- mt13_cont_post_index[,c(1,3)]\
colnames(mt13_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt13_cont_post_index2)\
setkeyv(mt13_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt13_matched_post_measures= f[mt13_cont_post_index2]\
\
mt13_matched_post_measures2 <- mt13_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt13_matched_post_measures2)\
\
setkeyv(mt13_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt13_control_conditions_post= conditions2[mt13_matched_post_measures2]\
\
mt13_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt13_control_conditions_post= mt13_control_conditions_post[!mt13_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt13_control_conditions_post$Timing_Class = '3'\
mt13_control_conditions_pre$Timing_Class = '1'\
mt13_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_13$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_13$person_id)]\
\
#Combine all clinical observations from the 13th set\
full_con_13 <- rbind(mt13_control_conditions_pre, mt13_control_conditions, mt13_control_conditions_post)\
setDT(full_con_13)\
full_con_13[,.N,by=person_id]\
\
## 3980-4030 days old\
#males\
\
case66_m <- subset(case_pop_m, index_age >=3980 & index_age <4030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case66_m)\
control66_m <- subset(control_pop_m, index_age >=3970 & index_age<4040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control66_m)\
match_age66m <- rbind(case66_m, control66_m)\
setDT(match_age66m)\
\
m_age66m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age66m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age66m$factor\
m66 <- as.data.table(r)\
m66$ID2 <- seq.int(nrow(m66))\
\
match_full131 <- cbind(match_age66m, m66)\
match_full131 = match_full131[!match_full131$r== 'NA',]\
\
md_controls66m <- subset(match_full131, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases66m <- subset(match_full131, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases66m[,.N,by=person_id]\
md_controls66m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls131 <-md_controls66m[order(person_id)]\
md_controls131[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_66m <- subset(md_controls131, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_66m <- subset(md_controls131, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_66m2 <- multi_66m[,c(1,2,3,4)]\
multi_66m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full131$person_id)]\
\
##Rematch the used PIDs\
control66_m_d2 <- subset(control_pop_m, index_age >=3970 & index_age<4040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control66_m_d2)\
match_age66m_d2 <- rbind(multi_66m2, control66_m_d2)\
m_age66m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age66m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age66m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full131_d2 <- cbind(match_age66m_d2, r2)\
match_full131_d2 = match_full131_d2[!match_full131_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_66m <- unique_66m[,c(1,2,3,4,5,6,7)]\
match_full131_d3 <-rbind(unique_66m, match_full131_d2)\
match_full131_d3 <- subset(match_full131_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full131_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full131_d3$person_id)]\
\
#females\
case66_f <- subset(case_pop_f, index_age >=3980 & index_age <4030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case66_f)\
control66_f <- subset(control_pop_f, index_age >=3970 & index_age<4040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control66_f)\
match_age66f <- rbind(case66_f, control66_f)\
setDT(match_age66f)\
\
m_age66f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age66f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age66f$factor\
f66 <- as.data.table(r)\
f66$ID2 <- seq.int(nrow(f66))\
\
match_full132 <- cbind(match_age66f, f66)\
match_full132 = match_full132[!match_full132$r== 'NA',]\
\
md_controls66f <- subset(match_full132, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases66f <- subset(match_full132, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases66f[,.N,by=person_id]\
md_controls66f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls66f$person_id)]\
\
## 4030-4080 days old\
#males\
\
case67_m <- subset(case_pop_m, index_age >=4030 & index_age <4080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case67_m)\
control67_m <- subset(control_pop_m, index_age >=4020 & index_age<4090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control67_m)\
match_age67m <- rbind(case67_m, control67_m)\
setDT(match_age67m)\
\
m_age67m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age67m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age67m$factor\
m67 <- as.data.table(r)\
m67$ID2 <- seq.int(nrow(m67))\
\
match_full133 <- cbind(match_age67m, m67)\
match_full133 = match_full133[!match_full133$r== 'NA',]\
\
md_controls67m <- subset(match_full133, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases67m <- subset(match_full133, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases67m[,.N,by=person_id]\
md_controls67m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls133 <-md_controls67m[order(person_id)]\
md_controls133[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_67m <- subset(md_controls133, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_67m <- subset(md_controls133, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_67m2 <- multi_67m[,c(1,2,3,4)]\
multi_67m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full133$person_id)]\
\
##Rematch the used PIDs\
control67_m_d2 <- subset(control_pop_m, index_age >=4020 & index_age<4090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control67_m_d2)\
match_age67m_d2 <- rbind(multi_67m2, control67_m_d2)\
m_age67m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age67m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age67m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full133_d2 <- cbind(match_age67m_d2, r2)\
match_full133_d2 = match_full133_d2[!match_full133_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_67m <- unique_67m[,c(1,2,3,4,5,6,7)]\
match_full133_d3 <-rbind(unique_67m, match_full133_d2)\
match_full133_d3 <- subset(match_full133_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full133_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full133_d3$person_id)]\
\
\
#females\
case67_f <- subset(case_pop_f, index_age >=4030 & index_age <4080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case67_f)\
control67_f <- subset(control_pop_f, index_age >=4020 & index_age<4090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control67_f)\
match_age67f <- rbind(case67_f, control67_f)\
setDT(match_age67f)\
\
m_age67f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age67f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age67f$factor\
f67 <- as.data.table(r)\
f67$ID2 <- seq.int(nrow(f67))\
\
match_full134 <- cbind(match_age67f, f67)\
match_full134 = match_full134[!match_full134$r== 'NA',]\
\
md_controls67f <- subset(match_full134, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases67f <- subset(match_full134, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases67f[,.N,by=person_id]\
md_controls67f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls134 <-md_controls67f[order(person_id)]\
md_controls134[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_67f <- subset(md_controls134, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_67f <- subset(md_controls134, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_67f2 <- multi_67f[,c(1,2,3,4)]\
multi_67f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full134$person_id)]\
\
##Rematch the used PIDs\
control67_f_d2 <- subset(control_pop_f, index_age >=4020 & index_age<4090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control67_f_d2)\
match_age67f_d2 <- rbind(multi_67f2, control67_f_d2)\
m_age67f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age67f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age67f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full134_d2 <- cbind(match_age67f_d2, r2)\
match_full134_d2 = match_full134_d2[!match_full134_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_67f <- unique_67f[,c(1,2,3,4,5,6,7)]\
match_full134_d3 <-rbind(unique_67f, match_full134_d2)\
match_full134_d3 <- subset(match_full134_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full134_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full134_d3$person_id)]\
\
## 4080-4130 days old\
#males\
\
case68_m <- subset(case_pop_m, index_age >=4080 & index_age <4130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case68_m)\
control68_m <- subset(control_pop_m, index_age >=4070 & index_age<4140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control68_m)\
match_age68m <- rbind(case68_m, control68_m)\
setDT(match_age68m)\
\
m_age68m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age68m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age68m$factor\
m68 <- as.data.table(r)\
m68$ID2 <- seq.int(nrow(m68))\
\
match_full135 <- cbind(match_age68m, m68)\
match_full135 = match_full135[!match_full135$r== 'NA',]\
\
md_controls68m <- subset(match_full135, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases68m <- subset(match_full135, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases68m[,.N,by=person_id]\
md_controls68m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls135 <-md_controls68m[order(person_id)]\
md_controls135[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_68m <- subset(md_controls135, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_68m <- subset(md_controls135, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_68m2 <- multi_68m[,c(1,2,3,4)]\
multi_68m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full135$person_id)]\
\
##Rematch the used PIDs\
control68_m_d2 <- subset(control_pop_m, index_age >=4070 & index_age<4140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control68_m_d2)\
match_age68m_d2 <- rbind(multi_68m2, control68_m_d2)\
m_age68m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age68m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age68m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full135_d2 <- cbind(match_age68m_d2, r2)\
match_full135_d2 = match_full135_d2[!match_full135_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_68m <- unique_68m[,c(1,2,3,4,5,6,7)]\
match_full135_d3 <-rbind(unique_68m, match_full135_d2)\
match_full135_d3 <- subset(match_full135_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full135_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full135_d3$person_id)]\
\
#females\
case68_f <- subset(case_pop_f, index_age >=4080 & index_age <4130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case68_f)\
control68_f <- subset(control_pop_f, index_age >=4070 & index_age<4140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control68_f)\
match_age68f <- rbind(case68_f, control68_f)\
setDT(match_age68f)\
\
m_age68f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age68f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age68f$factor\
f68 <- as.data.table(r)\
f68$ID2 <- seq.int(nrow(f68))\
\
match_full136 <- cbind(match_age68f, f68)\
match_full136 = match_full136[!match_full136$r== 'NA',]\
\
md_controls68f <- subset(match_full136, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases68f <- subset(match_full136, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases68f[,.N,by=person_id]\
md_controls68f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls136 <-md_controls68f[order(person_id)]\
md_controls136[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_68f <- subset(md_controls136, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_68f <- subset(md_controls136, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_68f2 <- multi_68f[,c(1,2,3,4)]\
multi_68f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full136$person_id)]\
\
##Rematch the used PIDs\
control68_f_d2 <- subset(control_pop_f, index_age >=4070 & index_age<4140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control68_f_d2)\
match_age68f_d2 <- rbind(multi_68f2, control68_f_d2)\
m_age68f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age68f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age68f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full136_d2 <- cbind(match_age68f_d2, r2)\
match_full136_d2 = match_full136_d2[!match_full136_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_68f <- unique_68f[,c(1,2,3,4,5,6,7)]\
match_full136_d3 <-rbind(unique_68f, match_full136_d2)\
match_full136_d3 <- subset(match_full136_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full136_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full136_d3$person_id)]\
\
## 4130-4180 days old\
#males\
\
case69_m <- subset(case_pop_m, index_age >=4130 & index_age <4180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case69_m)\
control69_m <- subset(control_pop_m, index_age >=4120 & index_age<4190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control69_m)\
match_age69m <- rbind(case69_m, control69_m)\
setDT(match_age69m)\
\
m_age69m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age69m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age69m$factor\
m69 <- as.data.table(r)\
m69$ID2 <- seq.int(nrow(m69))\
\
match_full137 <- cbind(match_age69m, m69)\
match_full137 = match_full137[!match_full137$r== 'NA',]\
\
md_controls69m <- subset(match_full137, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases69m <- subset(match_full137, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases69m[,.N,by=person_id]\
md_controls69m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls137 <-md_controls69m[order(person_id)]\
md_controls137[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_69m <- subset(md_controls137, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_69m <- subset(md_controls137, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_69m2 <- multi_69m[,c(1,2,3,4)]\
multi_69m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full137$person_id)]\
\
##Rematch the used PIDs\
control69_m_d2 <- subset(control_pop_m, index_age >=4120 & index_age<4190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control69_m_d2)\
match_age69m_d2 <- rbind(multi_69m2, control69_m_d2)\
m_age69m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age69m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age69m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full137_d2 <- cbind(match_age69m_d2, r2)\
match_full137_d2 = match_full137_d2[!match_full137_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_69m <- unique_69m[,c(1,2,3,4,5,6,7)]\
match_full137_d3 <-rbind(unique_69m, match_full137_d2)\
match_full137_d3 <- subset(match_full137_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full137_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full137_d3$person_id)]\
\
#females\
case69_f <- subset(case_pop_f, index_age >=4130 & index_age <4180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case69_f)\
control69_f <- subset(control_pop_f, index_age >=4120 & index_age<4190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control69_f)\
match_age69f <- rbind(case69_f, control69_f)\
setDT(match_age69f)\
\
m_age69f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age69f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age69f$factor\
f69 <- as.data.table(r)\
f69$ID2 <- seq.int(nrow(f69))\
\
match_full138 <- cbind(match_age69f, f69)\
match_full138 = match_full138[!match_full138$r== 'NA',]\
\
md_controls69f <- subset(match_full138, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases69f <- subset(match_full138, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases69f[,.N,by=person_id]\
md_controls69f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls138 <-md_controls69f[order(person_id)]\
md_controls138[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_69f <- subset(md_controls138, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_69f <- subset(md_controls138, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_69f2 <- multi_69f[,c(1,2,3,4)]\
multi_69f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full138$person_id)]\
\
##Rematch the used PIDs\
control69_f_d2 <- subset(control_pop_f, index_age >=4120 & index_age<4190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control69_f_d2)\
match_age69f_d2 <- rbind(multi_69f2, control69_f_d2)\
m_age69f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age69f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age69f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full138_d2 <- cbind(match_age69f_d2, r2)\
match_full138_d2 = match_full138_d2[!match_full138_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_69f <- unique_69f[,c(1,2,3,4,5,6,7)]\
match_full138_d3 <-rbind(unique_69f, match_full138_d2)\
match_full138_d3 <- subset(match_full138_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full138_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full138_d3$person_id)]\
\
## 4180-4230 days old\
#males\
\
case70_m <- subset(case_pop_m, index_age >=4180 & index_age <4230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case70_m)\
control70_m <- subset(control_pop_m, index_age >=4170 & index_age<4240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control70_m)\
match_age70m <- rbind(case70_m, control70_m)\
setDT(match_age70m)\
\
m_age70m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age70m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age70m$factor\
m70 <- as.data.table(r)\
m70$ID2 <- seq.int(nrow(m70))\
\
match_full139 <- cbind(match_age70m, m70)\
match_full139 = match_full139[!match_full139$r== 'NA',]\
\
md_controls70m <- subset(match_full139, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases70m <- subset(match_full139, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases70m[,.N,by=person_id]\
md_controls70m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls139 <-md_controls70m[order(person_id)]\
md_controls139[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_70m <- subset(md_controls139, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_70m <- subset(md_controls139, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_70m2 <- multi_70m[,c(1,2,3,4)]\
multi_70m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full139$person_id)]\
\
##Rematch the used PIDs\
control70_m_d2 <- subset(control_pop_m, index_age >=4170 & index_age<4240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control70_m_d2)\
match_age70m_d2 <- rbind(multi_70m2, control70_m_d2)\
m_age70m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age70m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age70m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full139_d2 <- cbind(match_age70m_d2, r2)\
match_full139_d2 = match_full139_d2[!match_full139_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_70m <- unique_70m[,c(1,2,3,4,5,6,7)]\
match_full139_d3 <-rbind(unique_70m, match_full139_d2)\
match_full139_d3 <- subset(match_full139_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full139_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full139_d3$person_id)]\
\
#females\
case70_f <- subset(case_pop_f, index_age >=4180 & index_age <4230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case70_f)\
control70_f <- subset(control_pop_f, index_age >=4170 & index_age<4240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control70_f)\
match_age70f <- rbind(case70_f, control70_f)\
setDT(match_age70f)\
\
m_age70f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age70f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age70f$factor\
f70 <- as.data.table(r)\
f70$ID2 <- seq.int(nrow(f70))\
\
match_full140 <- cbind(match_age70f, f70)\
match_full140 = match_full140[!match_full140$r== 'NA',]\
\
md_controls70f <- subset(match_full140, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases70f <- subset(match_full140, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases70f[,.N,by=person_id]\
md_controls70f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls70f$person_id)]\
\
##combine all matched data: round 14\
\
colnames(match_full131_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls66f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full133_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full134_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full135_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full136_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full137_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full138_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full139_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls70f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_14 <- rbind(match_full131_d3,  md_controls66f, match_full133_d3, match_full134_d3, match_full135_d3, match_full136_d3, match_full137_d3, match_full138_d3, match_full139_d3, md_controls70f)\
setDT(match_total_14)\
\
match_total_14[,.N,by=person_id]\
\
write.csv(match_total_14, 'match_total_14.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_14,  c("person_id","num_of_prior_visits"))\
\
mt14_matched_measures3= f[match_total_14]\
mt14_matched_measures4 <- mt14_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt14_matched_measures4)\
\
setkeyv(mt14_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt14_control_conditions= conditions2[mt14_matched_measures4]\
\
mt14_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-index visits for the matched controls\
#Pre index\
mt14_cont_pre_index <- match_total_14[,c(1,4)]\
mt14_cont_pre_index$pre <- mt14_cont_pre_index[, 2] -1\
mt14_cont_pre_index2 <- mt14_cont_pre_index[,c(1,3)]\
colnames(mt14_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt14_cont_pre_index2)\
setkeyv(mt14_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt14_matched_pre_measures= f[mt14_cont_pre_index2]\
\
mt14_matched_pre_measures2 <- mt14_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt14_matched_pre_measures2)\
\
setkeyv(mt14_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt14_control_conditions_pre= conditions2[mt14_matched_pre_measures2]\
\
mt14_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt14_cont_post_index <- match_total_14[,c(1,4)]\
mt14_cont_post_index$post <- mt14_cont_pre_index[, 2] +1\
mt14_cont_post_index2 <- mt14_cont_post_index[,c(1,3)]\
colnames(mt14_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt14_cont_post_index2)\
setkeyv(mt14_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt14_matched_post_measures= f[mt14_cont_post_index2]\
\
mt14_matched_post_measures2 <- mt14_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt14_matched_post_measures2)\
\
setkeyv(mt14_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt14_control_conditions_post= conditions2[mt14_matched_post_measures2]\
\
mt14_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt14_control_conditions_post= mt14_control_conditions_post[!mt14_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt14_control_conditions_post$Timing_Class = '3'\
mt14_control_conditions_pre$Timing_Class = '1'\
mt14_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_14$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_14$person_id)]\
\
#Combine all clinical observations from the 13th set\
full_con_14 <- rbind(mt14_control_conditions_pre, mt14_control_conditions, mt14_control_conditions_post)\
setDT(full_con_14)\
full_con_14[f,.N,by=person_id]\
\
## 4230-4280 days old\
#males\
\
case71_m <- subset(case_pop_m, index_age >=4230 & index_age <4280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case71_m)\
control71_m <- subset(control_pop_m, index_age >=4220 & index_age<4290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control71_m)\
match_age71m <- rbind(case71_m, control71_m)\
setDT(match_age71m)\
\
m_age71m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age71m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age71m$factor\
m71 <- as.data.table(r)\
m71$ID2 <- seq.int(nrow(m71))\
\
match_full141 <- cbind(match_age71m, m71)\
match_full141 = match_full141[!match_full141$r== 'NA',]\
\
md_controls71m <- subset(match_full141, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases71m <- subset(match_full141, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases71m[,.N,by=person_id]\
md_controls71m[,.N,by=person_id]\
\
#females\
case71_f <- subset(case_pop_f, index_age >=4230 & index_age <4280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case71_f)\
control71_f <- subset(control_pop_f, index_age >=4220 & index_age<4290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control71_f)\
match_age71f <- rbind(case71_f, control71_f)\
setDT(match_age71f)\
\
m_age71f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age71f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age71f$factor\
f71 <- as.data.table(r)\
f71$ID2 <- seq.int(nrow(f71))\
\
match_full142 <- cbind(match_age71f, f71)\
match_full142 = match_full142[!match_full142$r== 'NA',]\
\
md_controls71f <- subset(match_full142, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases71f <- subset(match_full142, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases71f[,.N,by=person_id]\
md_controls71f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls142 <-md_controls71f[order(person_id)]\
md_controls142[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_71f <- subset(md_controls142, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_71f <- subset(md_controls142, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_71f2 <- multi_71f[,c(1,2,3,4)]\
multi_71f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full142$person_id)]\
\
##Rematch the used PIDs\
control71_f_d2 <- subset(control_pop_f, index_age >=4220 & index_age<4290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control71_f_d2)\
match_age71f_d2 <- rbind(multi_71f2, control71_f_d2)\
m_age71f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age71f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age71f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full142_d2 <- cbind(match_age71f_d2, r2)\
match_full142_d2 = match_full142_d2[!match_full142_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_71f <- unique_71f[,c(1,2,3,4,5,6,7)]\
match_full142_d3 <-rbind(unique_71f, match_full142_d2)\
match_full142_d3 <- subset(match_full142_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full142_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full142_d3$person_id)]\
\
## 4280-4330 days old\
#males\
\
case72_m <- subset(case_pop_m, index_age >=4280 & index_age <4330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case72_m)\
control72_m <- subset(control_pop_m, index_age >=4270 & index_age<4340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control72_m)\
match_age72m <- rbind(case72_m, control72_m)\
setDT(match_age72m)\
\
m_age72m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age72m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age72m$factor\
m72 <- as.data.table(r)\
m72$ID2 <- seq.int(nrow(m72))\
\
match_full143 <- cbind(match_age72m, m72)\
match_full143 = match_full143[!match_full143$r== 'NA',]\
\
md_controls72m <- subset(match_full143, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases72m <- subset(match_full143, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases72m[,.N,by=person_id]\
md_controls72m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls143 <-md_controls72m[order(person_id)]\
md_controls143[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_72m <- subset(md_controls143, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_72m <- subset(md_controls143, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_72m2 <- multi_72m[,c(1,2,3,4)]\
multi_72m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full143$person_id)]\
\
##Rematch the used PIDs\
control72_m_d2 <- subset(control_pop_m, index_age >=4270 & index_age<4340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control72_m_d2)\
match_age72m_d2 <- rbind(multi_72m2, control72_m_d2)\
m_age72m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age72m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age72m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full143_d2 <- cbind(match_age72m_d2, r2)\
match_full143_d2 = match_full143_d2[!match_full143_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_72m <- unique_72m[,c(1,2,3,4,5,6,7)]\
match_full143_d3 <-rbind(unique_72m, match_full143_d2)\
match_full143_d3 <- subset(match_full143_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full143_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full143_d3$person_id)]\
\
#females\
case72_f <- subset(case_pop_f, index_age >=4280 & index_age <4330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case72_f)\
control72_f <- subset(control_pop_f, index_age >=4270 & index_age<4340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control72_f)\
match_age72f <- rbind(case72_f, control72_f)\
setDT(match_age72f)\
\
m_age72f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age72f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age72f$factor\
f72 <- as.data.table(r)\
f72$ID2 <- seq.int(nrow(f72))\
\
match_full144 <- cbind(match_age72f, f72)\
match_full144 = match_full144[!match_full144$r== 'NA',]\
\
match_full144 <- cbind(match_age72f, f72)\
match_full144 = match_full144[!match_full142$r== 'NA',]\
\
md_controls72f <- subset(match_full144, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases72f <- subset(match_full144, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases72f[,.N,by=person_id]\
md_controls72f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls144 <-md_controls72f[order(person_id)]\
md_controls144[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_72f <- subset(md_controls144, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_72f <- subset(md_controls144, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_72f2 <- multi_72f[,c(1,2,3,4)]\
multi_72f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full144$person_id)]\
\
##Rematch the used PIDs\
control72_f_d2 <- subset(control_pop_f, index_age >=4270 & index_age<4340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control72_f_d2)\
match_age72f_d2 <- rbind(multi_72f2, control72_f_d2)\
m_age72f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age72f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age72f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full144_d2 <- cbind(match_age72f_d2, r2)\
match_full144_d2 = match_full144_d2[!match_full144_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_72f <- unique_72f[,c(1,2,3,4,5,6,7)]\
match_full144_d3 <-rbind(unique_72f, match_full144_d2)\
match_full144_d3 <- subset(match_full144_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full144_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full144_d3$person_id)]\
\
## 4330-4380 days old\
#males\
\
case73_m <- subset(case_pop_m, index_age >=4330 & index_age <4380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case73_m)\
control73_m <- subset(control_pop_m, index_age >=4320 & index_age<4390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control73_m)\
match_age73m <- rbind(case73_m, control73_m)\
setDT(match_age73m)\
\
m_age73m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age73m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age73m$factor\
m73 <- as.data.table(r)\
m73$ID2 <- seq.int(nrow(m73))\
\
match_full145 <- cbind(match_age73m, m73)\
match_full145 = match_full145[!match_full145$r== 'NA',]\
\
md_controls73m <- subset(match_full145, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases73m <- subset(match_full145, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases73m[,.N,by=person_id]\
md_controls73m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls145 <-md_controls73m[order(person_id)]\
md_controls145[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_73m <- subset(md_controls145, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_73m <- subset(md_controls145, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_73m2 <- multi_73m[,c(1,2,3,4)]\
multi_73m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full145$person_id)]\
\
##Rematch the used PIDs\
control73_m_d2 <- subset(control_pop_m, index_age >=4320 & index_age<4390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control73_m_d2)\
match_age73m_d2 <- rbind(multi_73m2, control73_m_d2)\
m_age73m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age73m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age73m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full145_d2 <- cbind(match_age73m_d2, r2)\
match_full145_d2 = match_full145_d2[!match_full145_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_73m <- unique_73m[,c(1,2,3,4,5,6,7)]\
match_full145_d3 <-rbind(unique_73m, match_full145_d2)\
match_full145_d3 <- subset(match_full145_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full145_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full145_d3$person_id)]\
\
#females\
case73_f <- subset(case_pop_f, index_age >=4330 & index_age <4380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case73_f)\
control73_f <- subset(control_pop_f, index_age >=4320 & index_age<4390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control73_f)\
match_age73f <- rbind(case73_f, control73_f)\
setDT(match_age73f)\
\
m_age73f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age73f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age73f$factor\
f73 <- as.data.table(r)\
f73$ID2 <- seq.int(nrow(f73))\
\
match_full146 <- cbind(match_age73f, f73)\
match_full146 = match_full146[!match_full146$r== 'NA',]\
\
md_controls73f <- subset(match_full146, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases73f <- subset(match_full146, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases73f[,.N,by=person_id]\
md_controls73f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls146 <-md_controls73f[order(person_id)]\
md_controls146[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_73f <- subset(md_controls146, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_73f <- subset(md_controls146, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_73f2 <- multi_73f[,c(1,2,3,4)]\
multi_73f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full146$person_id)]\
\
##Rematch the used PIDs\
control73_f_d2 <- subset(control_pop_f, index_age >=4320 & index_age<4390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control73_f_d2)\
match_age73f_d2 <- rbind(multi_73f2, control73_f_d2)\
m_age73f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age73f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age73f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full146_d2 <- cbind(match_age73f_d2, r2)\
match_full146_d2 = match_full146_d2[!match_full146_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_73f <- unique_73f[,c(1,2,3,4,5,6,7)]\
match_full146_d3 <-rbind(unique_73f, match_full146_d2)\
match_full146_d3 <- subset(match_full146_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full146_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full146_d3$person_id)]\
\
## 4380-4430 days old\
#males\
\
case74_m <- subset(case_pop_m, index_age >=4380 & index_age <4430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case74_m)\
control74_m <- subset(control_pop_m, index_age >=4370 & index_age<4440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control74_m)\
match_age74m <- rbind(case74_m, control74_m)\
setDT(match_age74m)\
\
m_age74m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age74m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age74m$factor\
m74 <- as.data.table(r)\
m74$ID2 <- seq.int(nrow(m74))\
\
match_full147 <- cbind(match_age74m, m74)\
match_full147 = match_full147[!match_full147$r== 'NA',]\
\
md_controls74m <- subset(match_full147, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases74m <- subset(match_full147, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases74m[,.N,by=person_id]\
md_controls74m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls74m$person_id)]\
\
#females\
case74_f <- subset(case_pop_f, index_age >=4380 & index_age <4430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case74_f)\
control74_f <- subset(control_pop_f, index_age >=4370 & index_age<4440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control74_f)\
match_age74f <- rbind(case74_f, control74_f)\
setDT(match_age74f)\
\
m_age74f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age74f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age74f$factor\
f74 <- as.data.table(r)\
f74$ID2 <- seq.int(nrow(f74))\
\
match_full148 <- cbind(match_age74f, f74)\
match_full148 = match_full148[!match_full148$r== 'NA',]\
\
md_controls74f <- subset(match_full148, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases74f <- subset(match_full148, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases74f[,.N,by=person_id]\
md_controls74f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls74f$person_id)]\
\
## 4430-4480 days old\
#males\
\
case75_m <- subset(case_pop_m, index_age >=4430 & index_age <4480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case75_m)\
control75_m <- subset(control_pop_m, index_age >=4420 & index_age<4490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control75_m)\
match_age75m <- rbind(case75_m, control75_m)\
setDT(match_age75m)\
\
m_age75m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age75m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age75m$factor\
m75 <- as.data.table(r)\
m75$ID2 <- seq.int(nrow(m75))\
\
match_full149 <- cbind(match_age75m, m75)\
match_full149 = match_full149[!match_full149$r== 'NA',]\
\
md_controls75m <- subset(match_full149, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases75m <- subset(match_full149, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases75m[,.N,by=person_id]\
md_controls75m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls149 <-md_controls75m[order(person_id)]\
md_controls149[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_75m <- subset(md_controls149, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_75m <- subset(md_controls149, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_75m2 <- multi_75m[,c(1,2,3,4)]\
multi_75m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full149$person_id)]\
\
##Rematch the used PIDs\
control75_m_d2 <- subset(control_pop_m, index_age >=4420 & index_age<4490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control75_m_d2)\
match_age75m_d2 <- rbind(multi_75m2, control75_m_d2)\
m_age75m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age75m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age75m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full149_d2 <- cbind(match_age75m_d2, r2)\
match_full149_d2 = match_full149_d2[!match_full149_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_75m <- unique_75m[,c(1,2,3,4,5,6,7)]\
match_full149_d3 <-rbind(unique_75m, match_full149_d2)\
match_full149_d3 <- subset(match_full149_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full149_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full149_d3$person_id)]\
\
#females\
case75_f <- subset(case_pop_f, index_age >=4430 & index_age <4480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case75_f)\
control75_f <- subset(control_pop_f, index_age >=4420 & index_age<4490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control75_f)\
match_age75f <- rbind(case75_f, control75_f)\
setDT(match_age75f)\
\
m_age75f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age75f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age75f$factor\
f75 <- as.data.table(r)\
f75$ID2 <- seq.int(nrow(f75))\
\
match_full150 <- cbind(match_age75f, f75)\
match_full150 = match_full150[!match_full150$r== 'NA',]\
\
md_controls75f <- subset(match_full150, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases75f <- subset(match_full150, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases75f[,.N,by=person_id]\
md_controls75f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls150 <-md_controls75f[order(person_id)]\
md_controls150[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_75f <- subset(md_controls150, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_75f <- subset(md_controls150, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_75f2 <- multi_75f[,c(1,2,3,4)]\
multi_75f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full150$person_id)]\
\
##Rematch the used PIDs\
control75_f_d2 <- subset(control_pop_f, index_age >=4420 & index_age<4490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control75_f_d2)\
match_age75f_d2 <- rbind(multi_75f2, control75_f_d2)\
m_age75f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age75f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age75f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full150_d2 <- cbind(match_age75f_d2, r2)\
match_full150_d2 = match_full150_d2[!match_full150_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_75f <- unique_75f[,c(1,2,3,4,5,6,7)]\
match_full150_d3 <-rbind(unique_75f, match_full150_d2)\
match_full150_d3 <- subset(match_full150_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full150_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full150_d3$person_id)]\
\
\
##combine all matched data: round 15\
\
colnames(md_controls71m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full142_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full143_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full144_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full145_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full146_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls74m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls74f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full149_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full150_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_15 <- rbind(md_controls71m,  match_full142_d3, match_full143_d3, match_full144_d3, match_full145_d3, match_full146_d3, md_controls74m, md_controls74f, match_full149_d3, match_full150_d3)\
setDT(match_total_15)\
\
##One duplicate match; rematch this\
md_controls_tot15 <-match_total_15[order(person_id)]\
md_controls_tot15[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_tot15 <- subset(md_controls_tot15, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID, num_matches))\
\
unique_tot15 <- subset(md_controls_tot15, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID, num_matches))\
\
multi_tot15 <- multi_tot15[,c(1,2,3,4)]\
multi_tot15$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_total_15$person_id)]\
\
##Rematch the used PIDs\
\
controltot15_d2 <- subset(control_pop_m, index_age >=4300 & index_age<4460, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(controltot15_d2)\
match_tot15_d2 <- rbind(multi_tot15, controltot15_d2)\
m_tot15_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_tot15_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_tot15_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_fulltot15_d2 <- cbind(match_tot15_d2, r2)\
match_fulltot15_d2 = match_fulltot15_d2[!match_fulltot15_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_tot15 <- unique_tot15[,c(1,2,3,4,5,6,7)]\
colnames(match_fulltot15_d2) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_fulltot15_d3 <-rbind(unique_tot15, match_fulltot15_d2)\
match_fulltot15_d3 <- subset(match_fulltot15_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_fulltot15_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_fulltot15_d3$person_id)]\
\
match_total_15 <- setDT(match_fulltot15_d3)\
\
write.csv(match_total_15, 'match_total_15.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_15,  c("person_id","num_of_prior_visits"))\
\
mt15_matched_measures3= f[match_total_15]\
mt15_matched_measures4 <- mt15_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt15_matched_measures4)\
\
setkeyv(mt15_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt15_control_conditions= conditions2[mt15_matched_measures4]\
\
mt15_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt15_cont_pre_index <- match_total_15[,c(1,4)]\
mt15_cont_pre_index$pre <- mt15_cont_pre_index[, 2] -1\
mt15_cont_pre_index2 <- mt15_cont_pre_index[,c(1,3)]\
colnames(mt15_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt15_cont_pre_index2)\
setkeyv(mt15_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt15_matched_pre_measures= f[mt15_cont_pre_index2]\
\
mt15_matched_pre_measures2 <- mt15_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt15_matched_pre_measures2)\
\
setkeyv(mt15_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt15_control_conditions_pre= conditions2[mt15_matched_pre_measures2]\
\
mt15_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt15_cont_post_index <- match_total_15[,c(1,4)]\
mt15_cont_post_index$post <- mt15_cont_pre_index[, 2] +1\
mt15_cont_post_index2 <- mt15_cont_post_index[,c(1,3)]\
colnames(mt15_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt15_cont_post_index2)\
setkeyv(mt15_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt15_matched_post_measures= f[mt15_cont_post_index2]\
\
mt15_matched_post_measures2 <- mt15_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt15_matched_post_measures2)\
\
setkeyv(mt15_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt15_control_conditions_post= conditions2[mt15_matched_post_measures2]\
\
mt15_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt15_control_conditions_post= mt15_control_conditions_post[!mt15_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt15_control_conditions_post$Timing_Class = '3'\
mt15_control_conditions_pre$Timing_Class = '1'\
mt15_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_15$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_15$person_id)]\
\
#Combine all clinical observations from the 10th set\
full_con_15 <- rbind(mt15_control_conditions_pre, mt15_control_conditions, mt15_control_conditions_post)\
setDT(full_con_15)\
full_con_15[,.N,by=person_id]\
\
## 4480-4530 days old\
#males\
\
case76_m <- subset(case_pop_m, index_age >=4480 & index_age <4530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case76_m)\
control76_m <- subset(control_pop_m, index_age >=4470 & index_age<4540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control76_m)\
match_age76m <- rbind(case76_m, control76_m)\
setDT(match_age76m)\
\
m_age76m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age76m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age76m$factor\
m76 <- as.data.table(r)\
m76$ID2 <- seq.int(nrow(m76))\
\
match_full151 <- cbind(match_age76m, m76)\
match_full151 = match_full151[!match_full151$r== 'NA',]\
\
md_controls76m <- subset(match_full151, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases76m <- subset(match_full151, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases76m[,.N,by=person_id]\
md_controls76m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls151 <-md_controls76m[order(person_id)]\
md_controls151[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_76m <- subset(md_controls151, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_76m <- subset(md_controls151, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_76m2 <- multi_76m[,c(1,2,3,4)]\
multi_76m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full151$person_id)]\
\
##Rematch the used PIDs\
control76_m_d2 <- subset(control_pop_m, index_age >=4470 & index_age<4540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control76_m_d2)\
match_age76m_d2 <- rbind(multi_76m2, control76_m_d2)\
m_age76m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age76m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age76m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full151_d2 <- cbind(match_age76m_d2, r2)\
match_full151_d2 = match_full151_d2[!match_full151_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_76m <- unique_76m[,c(1,2,3,4,5,6,7)]\
match_full151_d3 <-rbind(unique_76m, match_full151_d2)\
match_full151_d3 <- subset(match_full151_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full151_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full151_d3$person_id)]\
\
#females\
case76_f <- subset(case_pop_f, index_age >=4480 & index_age <4530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case76_f)\
control76_f <- subset(control_pop_f, index_age >=4470 & index_age<4540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control76_f)\
match_age76f <- rbind(case76_f, control76_f)\
setDT(match_age76f)\
\
m_age76f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age76f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age76f$factor\
f76 <- as.data.table(r)\
f76$ID2 <- seq.int(nrow(f76))\
\
match_full152 <- cbind(match_age76f, f76)\
match_full152 = match_full152[!match_full152$r== 'NA',]\
\
md_controls76f <- subset(match_full152, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases76f <- subset(match_full152, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases76f[,.N,by=person_id]\
md_controls76f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls152 <-md_controls76f[order(person_id)]\
md_controls152[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_76f <- subset(md_controls152, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_76f <- subset(md_controls152, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_76f2 <- multi_76f[,c(1,2,3,4)]\
multi_76f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full152$person_id)]\
\
##Rematch the used PIDs\
control76_f_d2 <- subset(control_pop_f, index_age >=4470 & index_age<4540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control76_f_d2)\
match_age76f_d2 <- rbind(multi_76f2, control76_f_d2)\
m_age76f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age76f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age76f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full152_d2 <- cbind(match_age76f_d2, r2)\
match_full152_d2 = match_full152_d2[!match_full152_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_76f <- unique_76f[,c(1,2,3,4,5,6,7)]\
match_full152_d3 <-rbind(unique_76f, match_full152_d2)\
match_full152_d3 <- subset(match_full152_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full152_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full152_d3$person_id)]\
\
## 4530-4580 days old\
#males\
\
case77_m <- subset(case_pop_m, index_age >=4530 & index_age <4580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case77_m)\
control77_m <- subset(control_pop_m, index_age >=4520 & index_age<4590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control77_m)\
match_age77m <- rbind(case77_m, control77_m)\
setDT(match_age77m)\
\
m_age77m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age77m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age77m$factor\
m77 <- as.data.table(r)\
m77$ID2 <- seq.int(nrow(m77))\
\
match_full153 <- cbind(match_age77m, m77)\
match_full153 = match_full153[!match_full153$r== 'NA',]\
\
md_controls77m <- subset(match_full153, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases77m <- subset(match_full153, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases77m[,.N,by=person_id]\
md_controls77m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls153 <-md_controls77m[order(person_id)]\
md_controls153[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_77m <- subset(md_controls153, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_77m <- subset(md_controls153, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_77m2 <- multi_77m[,c(1,2,3,4)]\
multi_77m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full153$person_id)]\
\
##Rematch the used PIDs\
control77_m_d2 <- subset(control_pop_m, index_age >=4520 & index_age<4590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control77_m_d2)\
match_age77m_d2 <- rbind(multi_77m2, control77_m_d2)\
m_age77m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age77m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age77m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full153_d2 <- cbind(match_age77m_d2, r2)\
match_full153_d2 = match_full153_d2[!match_full153_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_77m <- unique_77m[,c(1,2,3,4,5,6,7)]\
match_full153_d3 <-rbind(unique_77m, match_full153_d2)\
match_full153_d3 <- subset(match_full153_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full153_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full153_d3$person_id)]\
\
#Rematch the duplicate\
md_controls153 <-match_full153_d3[order(person_id)]\
md_controls153[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_77m <- subset(md_controls153, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_77m <- subset(md_controls153, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_77m2 <- multi_77m[,c(1,2,3,4)]\
multi_77m2$casecont = 'case'\
\
##Rematch the used PIDs\
control77_m_d2 <- subset(control_pop_m, index_age >=4520 & index_age<4590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control77_m_d2)\
match_age77m_d2 <- rbind(multi_77m2, control77_m_d2)\
m_age77m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age77m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age77m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full153_d2 <- cbind(match_age77m_d2, r2)\
match_full153_d2 = match_full153_d2[!match_full153_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_77m <- unique_77m[,c(1,2,3,4,5,6,7)]\
match_full153_d3 <-rbind(unique_77m, match_full153_d2)\
match_full153_d3 <- subset(match_full153_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full153_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full153_d3$person_id)]\
\
#females\
case77_f <- subset(case_pop_f, index_age >=4530 & index_age <4580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case77_f)\
control77_f <- subset(control_pop_f, index_age >=4520 & index_age<4590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control77_f)\
match_age77f <- rbind(case77_f, control77_f)\
setDT(match_age77f)\
\
m_age77f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age77f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age77f$factor\
f77 <- as.data.table(r)\
f77$ID2 <- seq.int(nrow(f77))\
\
match_full154 <- cbind(match_age77f, f77)\
match_full154 = match_full154[!match_full154$r== 'NA',]\
\
md_controls77f <- subset(match_full154, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases77f <- subset(match_full154, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases77f[,.N,by=person_id]\
md_controls77f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls154 <-md_controls77f[order(person_id)]\
md_controls154[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_77f <- subset(md_controls154, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_77f <- subset(md_controls154, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_77f2 <- multi_77f[,c(1,2,3,4)]\
multi_77f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full154$person_id)]\
\
##Rematch the used PIDs\
control77_f_d2 <- subset(control_pop_f, index_age >=4520 & index_age<4590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control77_f_d2)\
match_age77f_d2 <- rbind(multi_77f2, control77_f_d2)\
m_age77f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age77f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age77f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full154_d2 <- cbind(match_age77f_d2, r2)\
match_full154_d2 = match_full154_d2[!match_full154_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_77f <- unique_77f[,c(1,2,3,4,5,6,7)]\
match_full154_d3 <-rbind(unique_77f, match_full154_d2)\
match_full154_d3 <- subset(match_full154_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full154_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full154_d3$person_id)]\
\
## 4580-4630 days old\
#males\
\
case78_m <- subset(case_pop_m, index_age >=4580 & index_age <4630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case78_m)\
control78_m <- subset(control_pop_m, index_age >=4570 & index_age<4640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control78_m)\
match_age78m <- rbind(case78_m, control78_m)\
setDT(match_age78m)\
\
m_age78m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age78m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age78m$factor\
m78 <- as.data.table(r)\
m78$ID2 <- seq.int(nrow(m78))\
\
match_full155 <- cbind(match_age78m, m78)\
match_full155 = match_full155[!match_full155$r== 'NA',]\
\
md_controls78m <- subset(match_full155, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases78m <- subset(match_full155, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases78m[,.N,by=person_id]\
md_controls78m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls155 <-md_controls78m[order(person_id)]\
md_controls155[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_78m <- subset(md_controls155, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_78m <- subset(md_controls155, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_78m2 <- multi_78m[,c(1,2,3,4)]\
multi_78m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full155$person_id)]\
\
##Rematch the used PIDs\
control78_m_d2 <- subset(control_pop_m, index_age >=4570 & index_age<4640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control78_m_d2)\
match_age78m_d2 <- rbind(multi_78m2, control78_m_d2)\
m_age78m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age78m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age78m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full155_d2 <- cbind(match_age78m_d2, r2)\
match_full155_d2 = match_full155_d2[!match_full155_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_78m <- unique_78m[,c(1,2,3,4,5,6,7)]\
match_full155_d3 <-rbind(unique_78m, match_full155_d2)\
match_full155_d3 <- subset(match_full155_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full155_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full155_d3$person_id)]\
\
#females\
case78_f <- subset(case_pop_f, index_age >=4580 & index_age <4630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case78_f)\
control78_f <- subset(control_pop_f, index_age >=4570 & index_age<4640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control78_f)\
match_age78f <- rbind(case78_f, control78_f)\
setDT(match_age78f)\
\
m_age78f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age78f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age78f$factor\
f78 <- as.data.table(r)\
f78$ID2 <- seq.int(nrow(f78))\
\
match_full156 <- cbind(match_age78f, f78)\
match_full156 = match_full156[!match_full156$r== 'NA',]\
\
md_controls78f <- subset(match_full156, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases78f <- subset(match_full156, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases78f[,.N,by=person_id]\
md_controls78f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls156 <-md_controls78f[order(person_id)]\
md_controls156[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_78f <- subset(md_controls156, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_78f <- subset(md_controls156, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_78f2 <- multi_78f[,c(1,2,3,4)]\
multi_78f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full156$person_id)]\
\
##Rematch the used PIDs\
control78_f_d2 <- subset(control_pop_f, index_age >=4570 & index_age<4640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control78_f_d2)\
match_age78f_d2 <- rbind(multi_78f2, control78_f_d2)\
m_age78f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age78f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age78f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full156_d2 <- cbind(match_age78f_d2, r2)\
match_full156_d2 = match_full156_d2[!match_full156_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_78f <- unique_78f[,c(1,2,3,4,5,6,7)]\
match_full156_d3 <-rbind(unique_78f, match_full156_d2)\
match_full156_d3 <- subset(match_full156_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full156_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full156_d3$person_id)]\
\
## 4630-4680 days old\
#males\
\
case79_m <- subset(case_pop_m, index_age >=4630 & index_age <4680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case79_m)\
control79_m <- subset(control_pop_m, index_age >=4620 & index_age<4690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control79_m)\
match_age79m <- rbind(case79_m, control79_m)\
setDT(match_age79m)\
\
m_age79m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age79m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age79m$factor\
m79 <- as.data.table(r)\
m79$ID2 <- seq.int(nrow(m79))\
\
match_full157 <- cbind(match_age79m, m79)\
match_full157 = match_full157[!match_full157$r== 'NA',]\
\
md_controls79m <- subset(match_full157, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases79m <- subset(match_full157, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases79m[,.N,by=person_id]\
md_controls79m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls157 <-md_controls79m[order(person_id)]\
md_controls157[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_79m <- subset(md_controls157, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_79m <- subset(md_controls157, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_79m2 <- multi_79m[,c(1,2,3,4)]\
multi_79m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full157$person_id)]\
\
##Rematch the used PIDs\
control79_m_d2 <- subset(control_pop_m, index_age >=4620 & index_age<4690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control79_m_d2)\
match_age79m_d2 <- rbind(multi_79m2, control79_m_d2)\
m_age79m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age79m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age79m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full157_d2 <- cbind(match_age79m_d2, r2)\
match_full157_d2 = match_full157_d2[!match_full157_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_79m <- unique_79m[,c(1,2,3,4,5,6,7)]\
match_full157_d3 <-rbind(unique_79m, match_full157_d2)\
match_full157_d3 <- subset(match_full157_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full157_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full157_d3$person_id)]\
\
#females\
case79_f <- subset(case_pop_f,index_age >=4630 & index_age <4680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case79_f)\
control79_f <- subset(control_pop_f, index_age >=4620 & index_age<4690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control79_f)\
match_age79f <- rbind(case79_f, control79_f)\
setDT(match_age79f)\
\
m_age79f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age79f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age79f$factor\
f79 <- as.data.table(r)\
f79$ID2 <- seq.int(nrow(f79))\
\
match_full158 <- cbind(match_age79f, f79)\
match_full158 = match_full158[!match_full158$r== 'NA',]\
\
md_controls79f <- subset(match_full158, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases79f <- subset(match_full158, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases79f[,.N,by=person_id]\
md_controls79f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls158 <-md_controls79f[order(person_id)]\
md_controls158[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_79f <- subset(md_controls158, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_79f <- subset(md_controls158, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_79f2 <- multi_79f[,c(1,2,3,4)]\
multi_79f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full158$person_id)]\
\
##Rematch the used PIDs\
control79_f_d2 <- subset(control_pop_f,  index_age >=4620 & index_age<4690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control79_f_d2)\
match_age79f_d2 <- rbind(multi_79f2, control79_f_d2)\
m_age79f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age79f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age79f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full158_d2 <- cbind(match_age79f_d2, r2)\
match_full158_d2 = match_full158_d2[!match_full158_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_79f <- unique_79f[,c(1,2,3,4,5,6,7)]\
match_full158_d3 <-rbind(unique_79f, match_full158_d2)\
match_full158_d3 <- subset(match_full158_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full158_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full158_d3$person_id)]\
\
## 4680-4730 days old\
#males\
\
case80_m <- subset(case_pop_m, index_age >=4680 & index_age <4730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case80_m)\
control80_m <- subset(control_pop_m, index_age >=4670 & index_age<4740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control80_m)\
match_age80m <- rbind(case80_m, control80_m)\
setDT(match_age80m)\
\
m_age80m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age80m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age80m$factor\
m80 <- as.data.table(r)\
m80$ID2 <- seq.int(nrow(m80))\
\
match_full159 <- cbind(match_age80m, m80)\
match_full159 = match_full159[!match_full159$r== 'NA',]\
\
md_controls80m <- subset(match_full159, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases80m <- subset(match_full159, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases80m[,.N,by=person_id]\
md_controls80m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls159 <-md_controls80m[order(person_id)]\
md_controls159[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_80m <- subset(md_controls159, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_80m <- subset(md_controls159, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_80m2 <- multi_80m[,c(1,2,3,4)]\
multi_80m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full159$person_id)]\
\
##Rematch the used PIDs\
control80_m_d2 <- subset(control_pop_m, index_age >=4670 & index_age<4740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control80_m_d2)\
match_age80m_d2 <- rbind(multi_80m2, control80_m_d2)\
m_age80m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age80m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age80m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full159_d2 <- cbind(match_age80m_d2, r2)\
match_full159_d2 = match_full159_d2[!match_full159_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_80m <- unique_80m[,c(1,2,3,4,5,6,7)]\
match_full159_d3 <-rbind(unique_80m, match_full159_d2)\
match_full159_d3 <- subset(match_full159_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full159_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full159_d3$person_id)]\
\
#females\
case80_f <- subset(case_pop_f,index_age >=4680 & index_age <4730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case80_f)\
control80_f <- subset(control_pop_f, index_age >=4670 & index_age<4740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control80_f)\
match_age80f <- rbind(case80_f, control80_f)\
setDT(match_age80f)\
\
m_age80f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age80f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age80f$factor\
f80 <- as.data.table(r)\
f80$ID2 <- seq.int(nrow(f80))\
\
match_full160 <- cbind(match_age80f, f80)\
match_full160 = match_full160[!match_full160$r== 'NA',]\
\
md_controls80f <- subset(match_full160, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases80f <- subset(match_full160, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases80f[,.N,by=person_id]\
md_controls80f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls160 <-md_controls80f[order(person_id)]\
md_controls160[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_80f <- subset(md_controls160, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_80f <- subset(md_controls160, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_80f2 <- multi_80f[,c(1,2,3,4)]\
multi_80f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full160$person_id)]\
\
##Rematch the used PIDs\
control80_f_d2 <- subset(control_pop_f,  index_age >=4670 & index_age<4740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control80_f_d2)\
match_age80f_d2 <- rbind(multi_80f2, control80_f_d2)\
m_age80f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age80f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age80f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full160_d2 <- cbind(match_age80f_d2, r2)\
match_full160_d2 = match_full160_d2[!match_full160_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_80f <- unique_80f[,c(1,2,3,4,5,6,7)]\
match_full160_d3 <-rbind(unique_80f, match_full160_d2)\
match_full160_d3 <- subset(match_full160_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full160_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full160_d3$person_id)]\
\
##combine all matched data: round 16\
\
colnames(match_full151_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full152_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full153_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full154_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full155_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full156_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full157_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full158_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full159_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full160_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_16 <- rbind(match_full151_d3,  match_full152_d3, match_full153_d3, match_full154_d3, match_full155_d3, match_full156_d3, match_full157_d3, match_full158_d3, match_full159_d3, match_full160_d3)\
setDT(match_total_16)\
match_total_16[,.N,by=person_id]\
write.csv(match_total_16, 'match_total_16.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_16,  c("person_id","num_of_prior_visits"))\
\
mt16_matched_measures3= f[match_total_16]\
mt16_matched_measures4 <- mt16_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt16_matched_measures4)\
\
setkeyv(mt16_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt16_control_conditions= conditions2[mt16_matched_measures4]\
\
mt16_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt16_cont_pre_index <- match_total_16[,c(1,4)]\
mt16_cont_pre_index$pre <- mt16_cont_pre_index[, 2] -1\
mt16_cont_pre_index2 <- mt16_cont_pre_index[,c(1,3)]\
colnames(mt16_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt16_cont_pre_index2)\
setkeyv(mt16_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt16_matched_pre_measures= f[mt16_cont_pre_index2]\
\
mt16_matched_pre_measures2 <- mt16_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt16_matched_pre_measures2)\
\
setkeyv(mt16_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt16_control_conditions_pre= conditions2[mt16_matched_pre_measures2]\
\
mt16_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt16_cont_post_index <- match_total_16[,c(1,4)]\
mt16_cont_post_index$post <- mt16_cont_pre_index[, 2] +1\
mt16_cont_post_index2 <- mt16_cont_post_index[,c(1,3)]\
colnames(mt16_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt16_cont_post_index2)\
setkeyv(mt16_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt16_matched_post_measures= f[mt16_cont_post_index2]\
\
mt16_matched_post_measures2 <- mt16_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt16_matched_post_measures2)\
\
setkeyv(mt16_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt16_control_conditions_post= conditions2[mt16_matched_post_measures2]\
\
mt16_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt16_control_conditions_post= mt16_control_conditions_post[!mt16_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt16_control_conditions_post$Timing_Class = '3'\
mt16_control_conditions_pre$Timing_Class = '1'\
mt16_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_16$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_16$person_id)]\
\
#Combine all clinical observations from the 16th set\
full_con_16 <- rbind(mt16_control_conditions_pre, mt16_control_conditions, mt16_control_conditions_post)\
setDT(full_con_16)\
full_con_16[,.N,by=person_id]\
\
## 4730-4780 days old\
#males\
\
case81_m <- subset(case_pop_m, index_age >=4730 & index_age <4780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case81_m)\
control81_m <- subset(control_pop_m, index_age >=4720 & index_age<4790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control81_m)\
match_age81m <- rbind(case81_m, control81_m)\
setDT(match_age81m)\
\
m_age81m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age81m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age81m$factor\
m81 <- as.data.table(r)\
m81$ID2 <- seq.int(nrow(m81))\
\
match_full161 <- cbind(match_age81m, m81)\
match_full161 = match_full161[!match_full161$r== 'NA',]\
\
md_controls81m <- subset(match_full161, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases81m <- subset(match_full161, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases81m[,.N,by=person_id]\
md_controls81m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls161 <-md_controls81m[order(person_id)]\
md_controls161[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_81m <- subset(md_controls161, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_81m <- subset(md_controls161, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_81m2 <- multi_81m[,c(1,2,3,4)]\
multi_81m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full161$person_id)]\
\
##Rematch the used PIDs\
control81_m_d2 <- subset(control_pop_m, index_age >=4720 & index_age<4790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control81_m_d2)\
match_age81m_d2 <- rbind(multi_81m2, control81_m_d2)\
m_age81m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age81m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age81m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full161_d2 <- cbind(match_age81m_d2, r2)\
match_full161_d2 = match_full161_d2[!match_full161_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_81m <- unique_81m[,c(1,2,3,4,5,6,7)]\
match_full161_d3 <-rbind(unique_81m, match_full161_d2)\
match_full161_d3 <- subset(match_full161_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full161_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full161_d3$person_id)]\
\
#females\
case81_f <- subset(case_pop_f,index_age >=4730 & index_age <4780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case81_f)\
control81_f <- subset(control_pop_f, index_age >=4720 & index_age<4790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control81_f)\
match_age81f <- rbind(case81_f, control81_f)\
setDT(match_age81f)\
\
m_age81f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age81f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age81f$factor\
f81 <- as.data.table(r)\
f81$ID2 <- seq.int(nrow(f81))\
\
match_full162 <- cbind(match_age81f, f81)\
match_full162 = match_full162[!match_full162$r== 'NA',]\
\
md_controls81f <- subset(match_full162, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases81f <- subset(match_full162, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases81f[,.N,by=person_id]\
md_controls81f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls81f$person_id)]\
\
## 4780-4830 days old\
#males\
\
case82_m <- subset(case_pop_m, index_age >=4780 & index_age <4830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case82_m)\
control82_m <- subset(control_pop_m, index_age >=4770 & index_age<4840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control82_m)\
match_age82m <- rbind(case82_m, control82_m)\
setDT(match_age82m)\
\
m_age82m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age82m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age82m$factor\
m82 <- as.data.table(r)\
m82$ID2 <- seq.int(nrow(m82))\
\
match_full163 <- cbind(match_age82m, m82)\
match_full163 = match_full163[!match_full163$r== 'NA',]\
\
md_controls82m <- subset(match_full163, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases82m <- subset(match_full163, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases82m[,.N,by=person_id]\
md_controls82m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls163 <-md_controls82m[order(person_id)]\
md_controls163[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_82m <- subset(md_controls163, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_82m <- subset(md_controls163, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_82m2 <- multi_82m[,c(1,2,3,4)]\
multi_82m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full163$person_id)]\
\
##Rematch the used PIDs\
control82_m_d2 <- subset(control_pop_m, index_age >=4770 & index_age<4840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control82_m_d2)\
match_age82m_d2 <- rbind(multi_82m2, control82_m_d2)\
m_age82m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age82m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age82m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full163_d2 <- cbind(match_age82m_d2, r2)\
match_full163_d2 = match_full163_d2[!match_full163_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_82m <- unique_82m[,c(1,2,3,4,5,6,7)]\
match_full163_d3 <-rbind(unique_82m, match_full163_d2)\
match_full163_d3 <- subset(match_full163_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full163_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full163_d3$person_id)]\
\
#females\
case82_f <- subset(case_pop_f,index_age >=4780 & index_age <4830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case82_f)\
control82_f <- subset(control_pop_f, index_age >=4770 & index_age<4840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control82_f)\
match_age82f <- rbind(case82_f, control82_f)\
setDT(match_age82f)\
\
m_age82f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age82f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age82f$factor\
f82 <- as.data.table(r)\
f82$ID2 <- seq.int(nrow(f82))\
\
match_full164 <- cbind(match_age82f, f82)\
match_full164 = match_full164[!match_full164$r== 'NA',]\
\
md_controls82f <- subset(match_full164, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases82f <- subset(match_full164, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases82f[,.N,by=person_id]\
md_controls82f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls82f$person_id)]\
\
## 4830-4880 days old\
#males\
case83_m <- subset(case_pop_m, index_age >=4830 & index_age <4880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case83_m)\
control83_m <- subset(control_pop_m, index_age >=4820 & index_age<4890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control83_m)\
match_age83m <- rbind(case83_m, control83_m)\
setDT(match_age83m)\
\
m_age83m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age83m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age83m$factor\
m83 <- as.data.table(r)\
m83$ID2 <- seq.int(nrow(m83))\
\
match_full165 <- cbind(match_age83m, m83)\
match_full165 = match_full165[!match_full165$r== 'NA',]\
\
md_controls83m <- subset(match_full165, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases83m <- subset(match_full165, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases83m[,.N,by=person_id]\
md_controls83m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls165 <-md_controls83m[order(person_id)]\
md_controls165[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_83m <- subset(md_controls165, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_83m <- subset(md_controls165, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_83m2 <- multi_83m[,c(1,2,3,4)]\
multi_83m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full165$person_id)]\
\
##Rematch the used PIDs\
control83_m_d2 <- subset(control_pop_m, index_age >=4820 & index_age<4890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control83_m_d2)\
match_age83m_d2 <- rbind(multi_83m2, control83_m_d2)\
m_age83m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age83m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age83m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full165_d2 <- cbind(match_age83m_d2, r2)\
match_full165_d2 = match_full165_d2[!match_full165_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_83m <- unique_83m[,c(1,2,3,4,5,6,7)]\
match_full165_d3 <-rbind(unique_83m, match_full165_d2)\
match_full165_d3 <- subset(match_full165_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full165_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full165_d3$person_id)]\
\
\
#females\
case83_f <- subset(case_pop_f, index_age >=4830 & index_age <4880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case83_f)\
control83_f <- subset(control_pop_f, index_age >=4820 & index_age<4890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control83_f)\
match_age83f <- rbind(case83_f, control83_f)\
setDT(match_age83f)\
\
m_age83f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age83f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age83f$factor\
f83 <- as.data.table(r)\
f83$ID2 <- seq.int(nrow(f83))\
\
match_full166 <- cbind(match_age83f, f83)\
match_full166 = match_full166[!match_full166$r== 'NA',]\
\
md_controls83f <- subset(match_full166, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases83f <- subset(match_full166, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases83f[,.N,by=person_id]\
md_controls83f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls83f$person_id)]\
\
\
## 4880-4930 days old\
#males\
\
case84_m <- subset(case_pop_m, index_age >=4880 & index_age <4930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case84_m)\
control84_m <- subset(control_pop_m, index_age >=4870 & index_age<4940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control84_m)\
match_age84m <- rbind(case84_m, control84_m)\
setDT(match_age84m)\
\
m_age84m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age84m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age84m$factor\
m84 <- as.data.table(r)\
m84$ID2 <- seq.int(nrow(m84))\
\
match_full167 <- cbind(match_age84m, m84)\
match_full167 = match_full167[!match_full167$r== 'NA',]\
\
md_controls84m <- subset(match_full167, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases84m <- subset(match_full167, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases84m[,.N,by=person_id]\
md_controls84m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls84m$person_id)]\
\
#females\
case84_f <- subset(case_pop_f, index_age >=4880 & index_age <4930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case84_f)\
control84_f <- subset(control_pop_f, index_age >=4870 & index_age<4940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control84_f)\
match_age84f <- rbind(case84_f, control84_f)\
setDT(match_age84f)\
\
m_age84f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age84f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age84f$factor\
f84 <- as.data.table(r)\
f84$ID2 <- seq.int(nrow(f84))\
\
match_full168 <- cbind(match_age84f, f84)\
match_full168 = match_full168[!match_full168$r== 'NA',]\
\
md_controls84f <- subset(match_full168, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases84f <- subset(match_full168, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases84f[,.N,by=person_id]\
md_controls84f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls84f$person_id)]\
\
## 4930-4980 days old\
#males\
\
case85_m <- subset(case_pop_m, index_age >=4930 & index_age <4980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case85_m)\
control85_m <- subset(control_pop_m, index_age >=4920 & index_age<4990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control85_m)\
match_age85m <- rbind(case85_m, control85_m)\
setDT(match_age85m)\
\
m_age85m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age85m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age85m$factor\
m85 <- as.data.table(r)\
m85$ID2 <- seq.int(nrow(m85))\
\
match_full169 <- cbind(match_age85m, m85)\
match_full169 = match_full169[!match_full169$r== 'NA',]\
\
md_controls85m <- subset(match_full169, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases85m <- subset(match_full169, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases85m[,.N,by=person_id]\
md_controls85m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls169 <-md_controls85m[order(person_id)]\
md_controls169[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_85m <- subset(md_controls169, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_85m <- subset(md_controls169, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_85m2 <- multi_85m[,c(1,2,3,4)]\
multi_85m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full169$person_id)]\
\
##Rematch the used PIDs\
control85_m_d2 <- subset(control_pop_m, index_age >=4920 & index_age<4990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control85_m_d2)\
match_age85m_d2 <- rbind(multi_85m2, control85_m_d2)\
m_age85m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age85m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age85m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full169_d2 <- cbind(match_age85m_d2, r2)\
match_full169_d2 = match_full169_d2[!match_full169_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_85m <- unique_85m[,c(1,2,3,4,5,6,7)]\
match_full169_d3 <-rbind(unique_85m, match_full169_d2)\
match_full169_d3 <- subset(match_full169_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full169_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full169_d3$person_id)]\
\
#females\
case85_f <- subset(case_pop_f, index_age >=4930 & index_age <4980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case85_f)\
control85_f <- subset(control_pop_f, index_age >=4920 & index_age<4990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control85_f)\
match_age85f <- rbind(case85_f, control85_f)\
setDT(match_age85f)\
\
m_age85f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age85f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age85f$factor\
f85 <- as.data.table(r)\
f85$ID2 <- seq.int(nrow(f85))\
\
match_full170 <- cbind(match_age85f, f85)\
match_full170 = match_full170[!match_full170$r== 'NA',]\
\
md_controls85f <- subset(match_full170, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases85f <- subset(match_full170, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases85f[,.N,by=person_id]\
md_controls85f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls170 <-md_controls85f[order(person_id)]\
md_controls170[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_85f <- subset(md_controls170, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_85f <- subset(md_controls170, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_85f2 <- multi_85f[,c(1,2,3,4)]\
multi_85f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full170$person_id)]\
\
##Rematch the used PIDs\
control85_f_d2 <- subset(control_pop_f,  index_age >=4920 & index_age<4990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control85_f_d2)\
match_age85f_d2 <- rbind(multi_85f2, control85_f_d2)\
m_age85f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age85f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age85f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full170_d2 <- cbind(match_age85f_d2, r2)\
match_full170_d2 = match_full170_d2[!match_full170_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_85f <- unique_85f[,c(1,2,3,4,5,6,7)]\
match_full170_d3 <-rbind(unique_85f, match_full170_d2)\
match_full170_d3 <- subset(match_full170_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full170_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full170_d3$person_id)]\
\
##combine all matched data: round 17\
\
colnames(match_full161_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls81f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full163_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls82f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full165_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls83f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls84m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls84f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full169_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full170_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_17 <- rbind(match_full161_d3, md_controls81f, match_full163_d3, md_controls82f, match_full165_d3, md_controls83f, md_controls84m, md_controls84f, match_full169_d3, match_full170_d3)\
setDT(match_total_17)\
match_total_17[,.N,by=person_id]\
write.csv(match_total_17, 'match_total_17.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_17,  c("person_id","num_of_prior_visits"))\
\
mt17_matched_measures3= f[match_total_17]\
mt17_matched_measures4 <- mt17_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt17_matched_measures4)\
\
setkeyv(mt17_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt17_control_conditions= conditions2[mt17_matched_measures4]\
\
mt17_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt17_cont_pre_index <- match_total_17[,c(1,4)]\
mt17_cont_pre_index$pre <- mt17_cont_pre_index[, 2] -1\
mt17_cont_pre_index2 <- mt17_cont_pre_index[,c(1,3)]\
colnames(mt17_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt17_cont_pre_index2)\
setkeyv(mt17_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt17_matched_pre_measures= f[mt17_cont_pre_index2]\
\
mt17_matched_pre_measures2 <- mt17_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt17_matched_pre_measures2)\
\
setkeyv(mt17_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt17_control_conditions_pre= conditions2[mt17_matched_pre_measures2]\
\
mt17_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt17_cont_post_index <- match_total_17[,c(1,4)]\
mt17_cont_post_index$post <- mt17_cont_pre_index[, 2] +1\
mt17_cont_post_index2 <- mt17_cont_post_index[,c(1,3)]\
colnames(mt17_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt17_cont_post_index2)\
setkeyv(mt17_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt17_matched_post_measures= f[mt17_cont_post_index2]\
\
mt17_matched_post_measures2 <- mt17_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt17_matched_post_measures2)\
\
setkeyv(mt17_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt17_control_conditions_post= conditions2[mt17_matched_post_measures2]\
\
mt17_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt17_control_conditions_post= mt17_control_conditions_post[!mt17_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt17_control_conditions_post$Timing_Class = '3'\
mt17_control_conditions_pre$Timing_Class = '1'\
mt17_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_17$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_17$person_id)]\
\
#Combine all clinical observations from the 16th set\
full_con_17 <- rbind(mt17_control_conditions_pre, mt17_control_conditions, mt17_control_conditions_post)\
setDT(full_con_17)\
full_con_17[,.N,by=person_id]\
\
## 4980-5030 days old\
#males\
\
case86_m <- subset(case_pop_m, index_age >=4980 & index_age <5030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case86_m)\
control86_m <- subset(control_pop_m, index_age >=4970 & index_age<5040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control86_m)\
match_age86m <- rbind(case86_m, control86_m)\
setDT(match_age86m)\
\
m_age86m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age86m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age86m$factor\
m86 <- as.data.table(r)\
m86$ID2 <- seq.int(nrow(m86))\
\
match_full171 <- cbind(match_age86m, m86)\
match_full171 = match_full171[!match_full171$r== 'NA',]\
\
md_controls86m <- subset(match_full171, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases86m <- subset(match_full171, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases86m[,.N,by=person_id]\
md_controls86m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls171 <-md_controls86m[order(person_id)]\
md_controls171[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_86m <- subset(md_controls171, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_86m <- subset(md_controls171, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_86m2 <- multi_86m[,c(1,2,3,4)]\
multi_86m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full171$person_id)]\
\
##Rematch the used PIDs\
control86_m_d2 <- subset(control_pop_m, index_age >=4970 & index_age<5040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control86_m_d2)\
match_age86m_d2 <- rbind(multi_86m2, control86_m_d2)\
m_age86m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age86m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age86m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full171_d2 <- cbind(match_age86m_d2, r2)\
match_full171_d2 = match_full171_d2[!match_full171_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_86m <- unique_86m[,c(1,2,3,4,5,6,7)]\
match_full171_d3 <-rbind(unique_86m, match_full171_d2)\
match_full171_d3 <- subset(match_full171_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full171_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full171_d3$person_id)]\
\
#females\
case86_f <- subset(case_pop_f, index_age >=4980 & index_age <5030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case86_f)\
control86_f <- subset(control_pop_f, index_age >=4970 & index_age<5040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control86_f)\
match_age86f <- rbind(case86_f, control86_f)\
setDT(match_age86f)\
\
m_age86f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age86f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age86f$factor\
f86 <- as.data.table(r)\
f86$ID2 <- seq.int(nrow(f86))\
\
match_full172 <- cbind(match_age86f, f86)\
match_full172 = match_full172[!match_full172$r== 'NA',]\
\
md_controls86f <- subset(match_full172, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases86f <- subset(match_full172, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases86f[,.N,by=person_id]\
md_controls86f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls172 <-md_controls86f[order(person_id)]\
md_controls172[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_86f <- subset(md_controls172, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_86f <- subset(md_controls172, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_86f2 <- multi_86f[,c(1,2,3,4)]\
multi_86f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full172$person_id)]\
\
##Rematch the used PIDs\
control86_f_d2 <- subset(control_pop_f, index_age >=4970 & index_age<5040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control86_f_d2)\
match_age86f_d2 <- rbind(multi_86f2, control86_f_d2)\
m_age86f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age86f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age86f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full172_d2 <- cbind(match_age86f_d2, r2)\
match_full172_d2 = match_full172_d2[!match_full172_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_86f <- unique_86f[,c(1,2,3,4,5,6,7)]\
match_full172_d3 <-rbind(unique_86f, match_full172_d2)\
match_full172_d3 <- subset(match_full172_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full172_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full172_d3$person_id)]\
\
## 5030-5080 days old\
#males\
\
case87_m <- subset(case_pop_m, index_age >=5030 & index_age <5080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case87_m)\
control87_m <- subset(control_pop_m, index_age >=5020 & index_age<5090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control87_m)\
match_age87m <- rbind(case87_m, control87_m)\
setDT(match_age87m)\
\
m_age87m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age87m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age87m$factor\
m87 <- as.data.table(r)\
m87$ID2 <- seq.int(nrow(m87))\
\
match_full173 <- cbind(match_age87m, m87)\
match_full173 = match_full173[!match_full173$r== 'NA',]\
\
md_controls87m <- subset(match_full173, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases87m <- subset(match_full173, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases87m[,.N,by=person_id]\
md_controls87m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls173 <-md_controls87m[order(person_id)]\
md_controls173[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_87m <- subset(md_controls173, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_87m <- subset(md_controls173, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_87m2 <- multi_87m[,c(1,2,3,4)]\
multi_87m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full173$person_id)]\
\
##Rematch the used PIDs\
control87_m_d2 <- subset(control_pop_m, index_age >=5020 & index_age<5090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control87_m_d2)\
match_age87m_d2 <- rbind(multi_87m2, control87_m_d2)\
m_age87m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age87m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age87m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full173_d2 <- cbind(match_age87m_d2, r2)\
match_full173_d2 = match_full173_d2[!match_full173_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_87m <- unique_87m[,c(1,2,3,4,5,6,7)]\
match_full173_d3 <-rbind(unique_87m, match_full173_d2)\
match_full173_d3 <- subset(match_full173_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full173_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full173_d3$person_id)]\
\
#females\
case87_f <- subset(case_pop_f, index_age >=5030 & index_age <5080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case87_f)\
control87_f <- subset(control_pop_f, index_age >=5020 & index_age<5090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control87_f)\
match_age87f <- rbind(case87_f, control87_f)\
setDT(match_age87f)\
\
m_age87f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age87f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age87f$factor\
f87 <- as.data.table(r)\
f87$ID2 <- seq.int(nrow(f87))\
\
match_full174 <- cbind(match_age87f, f87)\
match_full174 = match_full174[!match_full174$r== 'NA',]\
\
md_controls87f <- subset(match_full174, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases87f <- subset(match_full174, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases87f[,.N,by=person_id]\
md_controls87f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls174 <-md_controls87f[order(person_id)]\
md_controls174[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_87f <- subset(md_controls174, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_87f <- subset(md_controls174, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_87f2 <- multi_87f[,c(1,2,3,4)]\
multi_87f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full174$person_id)]\
\
##Rematch the used PIDs\
control87_f_d2 <- subset(control_pop_f, index_age >=5020 & index_age<5090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control87_f_d2)\
match_age87f_d2 <- rbind(multi_87f2, control87_f_d2)\
m_age87f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age87f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age87f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full174_d2 <- cbind(match_age87f_d2, r2)\
match_full174_d2 = match_full174_d2[!match_full174_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_87f <- unique_87f[,c(1,2,3,4,5,6,7)]\
match_full174_d3 <-rbind(unique_87f, match_full174_d2)\
match_full174_d3 <- subset(match_full174_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full174_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full174_d3$person_id)]\
\
## 5080-5130 days old\
#males\
\
case88_m <- subset(case_pop_m, index_age >=5080 & index_age <5130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case88_m)\
control88_m <- subset(control_pop_m, index_age >=5070 & index_age<5140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control88_m)\
match_age88m <- rbind(case88_m, control88_m)\
setDT(match_age88m)\
\
m_age88m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age88m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age88m$factor\
m88 <- as.data.table(r)\
m88$ID2 <- seq.int(nrow(m88))\
\
match_full175 <- cbind(match_age88m, m88)\
match_full175 = match_full175[!match_full175$r== 'NA',]\
\
md_controls88m <- subset(match_full175, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases88m <- subset(match_full175, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases88m[,.N,by=person_id]\
md_controls88m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls88m$person_id)]\
\
#females\
case88_f <- subset(case_pop_f, index_age >=5080 & index_age <5130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case88_f)\
control88_f <- subset(control_pop_f, index_age >=5070 & index_age<5140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control88_f)\
match_age88f <- rbind(case88_f, control88_f)\
setDT(match_age88f)\
\
m_age88f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age88f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age88f$factor\
f88 <- as.data.table(r)\
f88$ID2 <- seq.int(nrow(f88))\
\
match_full176 <- cbind(match_age88f, f88)\
match_full176 = match_full176[!match_full176$r== 'NA',]\
\
md_controls88f <- subset(match_full176, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases88f <- subset(match_full176, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases88f[,.N,by=person_id]\
md_controls88f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls88f$person_id)]\
\
## 5130-5180 days old\
#males\
\
case89_m <- subset(case_pop_m, index_age >=5130 & index_age <5180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case89_m)\
control89_m <- subset(control_pop_m, index_age >=5120 & index_age<5190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control89_m)\
match_age89m <- rbind(case89_m, control89_m)\
setDT(match_age89m)\
\
m_age89m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age89m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age89m$factor\
m89 <- as.data.table(r)\
m89$ID2 <- seq.int(nrow(m89))\
\
match_full177 <- cbind(match_age89m, m89)\
match_full177 = match_full177[!match_full177$r== 'NA',]\
\
md_controls89m <- subset(match_full177, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases89m <- subset(match_full177, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases89m[,.N,by=person_id]\
md_controls89m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls177 <-md_controls89m[order(person_id)]\
md_controls177[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_89m <- subset(md_controls177, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_89m <- subset(md_controls177, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_89m2 <- multi_89m[,c(1,2,3,4)]\
multi_89m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full177$person_id)]\
\
##Rematch the used PIDs\
control89_m_d2 <- subset(control_pop_m, index_age >=5120 & index_age<5190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control89_m_d2)\
match_age89m_d2 <- rbind(multi_89m2, control89_m_d2)\
m_age89m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age89m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age89m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full177_d2 <- cbind(match_age89m_d2, r2)\
match_full177_d2 = match_full177_d2[!match_full177_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_89m <- unique_89m[,c(1,2,3,4,5,6,7)]\
match_full177_d3 <-rbind(unique_89m, match_full177_d2)\
match_full177_d3 <- subset(match_full177_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full177_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full177_d3$person_id)]\
\
#females\
case89_f <- subset(case_pop_f, index_age >=5130 & index_age <5180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case89_f)\
control89_f <- subset(control_pop_f, index_age >=5120 & index_age<5190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control89_f)\
match_age89f <- rbind(case89_f, control89_f)\
setDT(match_age89f)\
\
m_age89f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age89f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age89f$factor\
f89 <- as.data.table(r)\
f89$ID2 <- seq.int(nrow(f89))\
\
match_full178 <- cbind(match_age89f, f89)\
match_full178 = match_full178[!match_full178$r== 'NA',]\
\
md_controls89f <- subset(match_full178, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases89f <- subset(match_full178, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases89f[,.N,by=person_id]\
md_controls89f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls178 <-md_controls89f[order(person_id)]\
md_controls178[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_89f <- subset(md_controls178, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_89f <- subset(md_controls178, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_89f2 <- multi_89f[,c(1,2,3,4)]\
multi_89f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full178$person_id)]\
\
##Rematch the used PIDs\
control89_f_d2 <- subset(control_pop_f, index_age >=5120 & index_age<5190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control89_f_d2)\
match_age89f_d2 <- rbind(multi_89f2, control89_f_d2)\
m_age89f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age89f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age89f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full178_d2 <- cbind(match_age89f_d2, r2)\
match_full178_d2 = match_full178_d2[!match_full178_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_89f <- unique_89f[,c(1,2,3,4,5,6,7)]\
match_full178_d3 <-rbind(unique_89f, match_full178_d2)\
match_full178_d3 <- subset(match_full178_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full178_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full178_d3$person_id)]\
\
## 5180-5230 days old\
#males\
\
case90_m <- subset(case_pop_m, index_age >=5180 & index_age <5230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case90_m)\
control90_m <- subset(control_pop_m, index_age >=5170 & index_age<5240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control90_m)\
match_age90m <- rbind(case90_m, control90_m)\
setDT(match_age90m)\
\
m_age90m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age90m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age90m$factor\
m90 <- as.data.table(r)\
m90$ID2 <- seq.int(nrow(m90))\
\
match_full179 <- cbind(match_age90m, m90)\
match_full179 = match_full179[!match_full179$r== 'NA',]\
\
md_controls90m <- subset(match_full179, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases90m <- subset(match_full179, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases90m[,.N,by=person_id]\
md_controls90m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls179 <-md_controls90m[order(person_id)]\
md_controls179[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_90m <- subset(md_controls179, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_90m <- subset(md_controls179, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_90m2 <- multi_90m[,c(1,2,3,4)]\
multi_90m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full179$person_id)]\
\
##Rematch the used PIDs\
control90_m_d2 <- subset(control_pop_m, index_age >=5170 & index_age<5240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control90_m_d2)\
match_age90m_d2 <- rbind(multi_90m2, control90_m_d2)\
m_age90m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age90m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age90m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full179_d2 <- cbind(match_age90m_d2, r2)\
match_full179_d2 = match_full179_d2[!match_full179_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_90m <- unique_90m[,c(1,2,3,4,5,6,7)]\
match_full179_d3 <-rbind(unique_90m, match_full179_d2)\
match_full179_d3 <- subset(match_full179_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full179_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full179_d3$person_id)]\
\
#females\
case90_f <- subset(case_pop_f, index_age >=5180 & index_age <5230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case90_f)\
control90_f <- subset(control_pop_f, index_age >=5170 & index_age<5240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control90_f)\
match_age90f <- rbind(case90_f, control90_f)\
setDT(match_age90f)\
\
m_age90f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age90f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age90f$factor\
f90 <- as.data.table(r)\
f90$ID2 <- seq.int(nrow(f90))\
\
match_full180 <- cbind(match_age90f, f90)\
match_full180 = match_full180[!match_full180$r== 'NA',]\
\
md_controls90f <- subset(match_full180, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases90f <- subset(match_full180, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases90f[,.N,by=person_id]\
md_controls90f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls180 <-md_controls90f[order(person_id)]\
md_controls180[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_90f <- subset(md_controls180, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_90f <- subset(md_controls180, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_90f2 <- multi_90f[,c(1,2,3,4)]\
multi_90f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full180$person_id)]\
\
##Rematch the used PIDs\
control90_f_d2 <- subset(control_pop_f, index_age >=5170 & index_age<5240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control90_f_d2)\
match_age90f_d2 <- rbind(multi_90f2, control90_f_d2)\
m_age90f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age90f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age90f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full180_d2 <- cbind(match_age90f_d2, r2)\
match_full180_d2 = match_full180_d2[!match_full180_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_90f <- unique_90f[,c(1,2,3,4,5,6,7)]\
match_full180_d3 <-rbind(unique_90f, match_full180_d2)\
match_full180_d3 <- subset(match_full180_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full180_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full180_d3$person_id)]\
\
##combine all matched data: round 18\
\
colnames(match_full171_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full172_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full173_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full174_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls88m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls88f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full177_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full178_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full179_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full180_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_18 <- rbind(match_full171_d3,  match_full172_d3, match_full173_d3, match_full174_d3, md_controls88m, md_controls88f,match_full177_d3, match_full178_d3, match_full179_d3, match_full180_d3)\
setDT(match_total_18)\
match_total_18[,.N,by=person_id]\
write.csv(match_total_18, 'match_total_18.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_18,  c("person_id","num_of_prior_visits"))\
\
mt18_matched_measures3= f[match_total_18]\
mt18_matched_measures4 <- mt18_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt18_matched_measures4)\
\
setkeyv(mt18_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt18_control_conditions= conditions2[mt18_matched_measures4]\
\
mt18_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt18_cont_pre_index <- match_total_18[,c(1,4)]\
mt18_cont_pre_index$pre <- mt18_cont_pre_index[, 2] -1\
mt18_cont_pre_index2 <- mt18_cont_pre_index[,c(1,3)]\
colnames(mt18_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt18_cont_pre_index2)\
setkeyv(mt18_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt18_matched_pre_measures= f[mt18_cont_pre_index2]\
\
mt18_matched_pre_measures2 <- mt18_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt18_matched_pre_measures2)\
\
setkeyv(mt18_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt18_control_conditions_pre= conditions2[mt18_matched_pre_measures2]\
\
mt18_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt18_cont_post_index <- match_total_18[,c(1,4)]\
mt18_cont_post_index$post <- mt18_cont_pre_index[, 2] +1\
mt18_cont_post_index2 <- mt18_cont_post_index[,c(1,3)]\
colnames(mt18_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt18_cont_post_index2)\
setkeyv(mt18_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt18_matched_post_measures= f[mt18_cont_post_index2]\
\
mt18_matched_post_measures2 <- mt18_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt18_matched_post_measures2)\
\
setkeyv(mt18_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt18_control_conditions_post= conditions2[mt18_matched_post_measures2]\
\
mt18_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt18_control_conditions_post= mt18_control_conditions_post[!mt18_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt18_control_conditions_post$Timing_Class = '3'\
mt18_control_conditions_pre$Timing_Class = '1'\
mt18_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_18$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_18$person_id)]\
\
#Combine all clinical observations from the 16th set\
full_con_18 <- rbind(mt18_control_conditions_pre, mt18_control_conditions, mt18_control_conditions_post)\
setDT(full_con_18)\
full_con_18[,.N,by=person_id]\
\
## 5230-5280 days old\
#males\
\
case91_m <- subset(case_pop_m, index_age >=5230 & index_age <5280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case91_m)\
control91_m <- subset(control_pop_m, index_age >=5220 & index_age<5290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control91_m)\
match_age91m <- rbind(case91_m, control91_m)\
setDT(match_age91m)\
\
m_age91m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age91m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age91m$factor\
m91 <- as.data.table(r)\
m91$ID2 <- seq.int(nrow(m91))\
\
match_full181 <- cbind(match_age91m, m91)\
match_full181 = match_full181[!match_full181$r== 'NA',]\
\
md_controls91m <- subset(match_full181, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases91m <- subset(match_full181, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases91m[,.N,by=person_id]\
md_controls91m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls91m$person_id)]\
\
#females\
case91_f <- subset(case_pop_f, index_age >=5230 & index_age <5280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case91_f)\
control91_f <- subset(control_pop_f, index_age >=5220 & index_age<5290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control91_f)\
match_age91f <- rbind(case91_f, control91_f)\
setDT(match_age91f)\
\
m_age91f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age91f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age91f$factor\
f91 <- as.data.table(r)\
f91$ID2 <- seq.int(nrow(f91))\
\
match_full182 <- cbind(match_age91f, f91)\
match_full182 = match_full182[!match_full182$r== 'NA',]\
\
md_controls91f <- subset(match_full182, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases91f <- subset(match_full182, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases91f[,.N,by=person_id]\
md_controls91f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls91f$person_id)]\
\
## 5280-5330 days old\
#males\
\
case92_m <- subset(case_pop_m, index_age >=5280 & index_age <5330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case92_m)\
control92_m <- subset(control_pop_m, index_age >=5270 & index_age<5340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control92_m)\
match_age92m <- rbind(case92_m, control92_m)\
setDT(match_age92m)\
\
m_age92m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age92m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age92m$factor\
m92 <- as.data.table(r)\
m92$ID2 <- seq.int(nrow(m92))\
\
match_full183 <- cbind(match_age92m, m92)\
match_full183 = match_full183[!match_full183$r== 'NA',]\
\
md_controls92m <- subset(match_full183, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases92m <- subset(match_full183, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases92m[,.N,by=person_id]\
md_controls92m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls183 <-md_controls92m[order(person_id)]\
md_controls183[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_92m <- subset(md_controls183, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_92m <- subset(md_controls183, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_92m2 <- multi_92m[,c(1,2,3,4)]\
multi_92m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full183$person_id)]\
\
##Rematch the used PIDs\
control92_m_d2 <- subset(control_pop_m, index_age >=5270 & index_age<5340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control92_m_d2)\
match_age92m_d2 <- rbind(multi_92m2, control92_m_d2)\
m_age92m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age92m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age92m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full183_d2 <- cbind(match_age92m_d2, r2)\
match_full183_d2 = match_full183_d2[!match_full183_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_92m <- unique_92m[,c(1,2,3,4,5,6,7)]\
match_full183_d3 <-rbind(unique_92m, match_full183_d2)\
match_full183_d3 <- subset(match_full183_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full183_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full183_d3$person_id)]\
\
#females\
case92_f <- subset(case_pop_f,index_age >=5280 & index_age <5330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case92_f)\
control92_f <- subset(control_pop_f, index_age >=5270 & index_age<5340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control92_f)\
match_age92f <- rbind(case92_f, control92_f)\
setDT(match_age92f)\
\
m_age92f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age92f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age92f$factor\
f92 <- as.data.table(r)\
f92$ID2 <- seq.int(nrow(f92))\
\
match_full184 <- cbind(match_age92f, f92)\
match_full184 = match_full184[!match_full184$r== 'NA',]\
\
md_controls92f <- subset(match_full184, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases92f <- subset(match_full184, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases92f[,.N,by=person_id]\
md_controls92f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls184 <-md_controls92f[order(person_id)]\
md_controls184[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_92f <- subset(md_controls184, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_92f <- subset(md_controls184, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_92f2 <- multi_92f[,c(1,2,3,4)]\
multi_92f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full184$person_id)]\
\
##Rematch the used PIDs\
control92_f_d2 <- subset(control_pop_f, index_age >=5270 & index_age<5340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control92_f_d2)\
match_age92f_d2 <- rbind(multi_92f2, control92_f_d2)\
m_age92f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age92f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age92f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full184_d2 <- cbind(match_age92f_d2, r2)\
match_full184_d2 = match_full184_d2[!match_full184_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_92f <- unique_92f[,c(1,2,3,4,5,6,7)]\
match_full184_d3 <-rbind(unique_92f, match_full184_d2)\
match_full184_d3 <- subset(match_full184_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full184_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full184_d3$person_id)]\
\
## 5330-5380 days old\
#males\
\
case93_m <- subset(case_pop_m, index_age >=5330 & index_age <5380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case93_m)\
control93_m <- subset(control_pop_m, index_age >=5320 & index_age<5390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control93_m)\
match_age93m <- rbind(case93_m, control93_m)\
setDT(match_age93m)\
\
m_age93m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age93m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age93m$factor\
m93 <- as.data.table(r)\
m93$ID2 <- seq.int(nrow(m93))\
\
match_full185 <- cbind(match_age93m, m93)\
match_full185 = match_full185[!match_full185$r== 'NA',]\
\
md_controls93m <- subset(match_full185, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases93m <- subset(match_full185, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases93m[,.N,by=person_id]\
md_controls93m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls185 <-md_controls93m[order(person_id)]\
md_controls185[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_93m <- subset(md_controls185, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_93m <- subset(md_controls185, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_93m2 <- multi_93m[,c(1,2,3,4)]\
multi_93m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full185$person_id)]\
\
##Rematch the used PIDs\
control93_m_d2 <- subset(control_pop_m, index_age >=5320 & index_age<5390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control93_m_d2)\
match_age93m_d2 <- rbind(multi_93m2, control93_m_d2)\
m_age93m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age93m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age93m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full185_d2 <- cbind(match_age93m_d2, r2)\
match_full185_d2 = match_full185_d2[!match_full185_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_93m <- unique_93m[,c(1,2,3,4,5,6,7)]\
match_full185_d3 <-rbind(unique_93m, match_full185_d2)\
match_full185_d3 <- subset(match_full185_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full185_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full185_d3$person_id)]\
\
#females\
case93_f <- subset(case_pop_f,index_age >=5330 & index_age <5380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case93_f)\
control93_f <- subset(control_pop_f, index_age >=5320 & index_age<5390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control93_f)\
match_age93f <- rbind(case93_f, control93_f)\
setDT(match_age93f)\
\
m_age93f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age93f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age93f$factor\
f93 <- as.data.table(r)\
f93$ID2 <- seq.int(nrow(f93))\
match_full186 <- cbind(match_age93f, f93)\
match_full186 = match_full186[!match_full186$r== 'NA',]\
\
md_controls93f <- subset(match_full186, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases93f <- subset(match_full186, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases93f[,.N,by=person_id]\
md_controls93f[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% md_controls93f$person_id)]\
\
## 5380-5430 days old\
#males\
\
case94_m <- subset(case_pop_m, index_age >=5380 & index_age <5430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case94_m)\
control94_m <- subset(control_pop_m, index_age >=5370 & index_age<5440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control94_m)\
match_age94m <- rbind(case94_m, control94_m)\
setDT(match_age94m)\
\
m_age94m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age94m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age94m$factor\
m94 <- as.data.table(r)\
m94$ID2 <- seq.int(nrow(m94))\
\
match_full187 <- cbind(match_age94m, m94)\
match_full187 = match_full187[!match_full187$r== 'NA',]\
\
md_controls94m <- subset(match_full187, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases94m <- subset(match_full187, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases94m[,.N,by=person_id]\
md_controls94m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls187 <-md_controls94m[order(person_id)]\
md_controls187[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_94m <- subset(md_controls187, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_94m <- subset(md_controls187, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_94m2 <- multi_94m[,c(1,2,3,4)]\
multi_94m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full187$person_id)]\
\
##Rematch the used PIDs\
control94_m_d2 <- subset(control_pop_m, index_age >=5370 & index_age<5440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control94_m_d2)\
match_age94m_d2 <- rbind(multi_94m2, control94_m_d2)\
m_age94m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age94m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age94m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full187_d2 <- cbind(match_age94m_d2, r2)\
match_full187_d2 = match_full187_d2[!match_full187_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_94m <- unique_94m[,c(1,2,3,4,5,6,7)]\
match_full187_d3 <-rbind(unique_94m, match_full187_d2)\
match_full187_d3 <- subset(match_full187_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full187_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full187_d3$person_id)]\
\
#females\
case94_f <- subset(case_pop_f,index_age >=5380 & index_age <5430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case94_f)\
control94_f <- subset(control_pop_f, index_age >=5370 & index_age<5440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control94_f)\
match_age94f <- rbind(case94_f, control94_f)\
setDT(match_age94f)\
\
m_age94f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age94f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age94f$factor\
f94 <- as.data.table(r)\
f94$ID2 <- seq.int(nrow(f94))\
\
match_full188 <- cbind(match_age94f, f94)\
match_full188 = match_full188[!match_full188$r== 'NA',]\
\
md_controls94f <- subset(match_full188, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases94f <- subset(match_full188, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases94f[,.N,by=person_id]\
md_controls94f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls188 <-md_controls94f[order(person_id)]\
md_controls188[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_94f <- subset(md_controls188, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_94f <- subset(md_controls188, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_94f2 <- multi_94f[,c(1,2,3,4)]\
multi_94f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full188$person_id)]\
\
##Rematch the used PIDs\
control94_f_d2 <- subset(control_pop_f, index_age >=5370 & index_age<5440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control94_f_d2)\
match_age94f_d2 <- rbind(multi_94f2, control94_f_d2)\
m_age94f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age94f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age94f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full188_d2 <- cbind(match_age94f_d2, r2)\
match_full188_d2 = match_full188_d2[!match_full188_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_94f <- unique_94f[,c(1,2,3,4,5,6,7)]\
match_full188_d3 <-rbind(unique_94f, match_full188_d2)\
match_full188_d3 <- subset(match_full188_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full188_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full188_d3$person_id)]\
\
## 5430-5480 days old\
#males\
\
case95_m <- subset(case_pop_m, index_age >=5430 & index_age <5480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case95_m)\
control95_m <- subset(control_pop_m, index_age >=5420 & index_age<5490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control95_m)\
match_age95m <- rbind(case95_m, control95_m)\
setDT(match_age95m)\
\
m_age95m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age95m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age95m$factor\
m95 <- as.data.table(r)\
m95$ID2 <- seq.int(nrow(m95))\
\
match_full189 <- cbind(match_age95m, m95)\
match_full189 = match_full189[!match_full189$r== 'NA',]\
\
md_controls95m <- subset(match_full189, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases95m <- subset(match_full189, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases95m[,.N,by=person_id]\
md_controls95m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls189 <-md_controls95m[order(person_id)]\
md_controls189[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_95m <- subset(md_controls189, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_95m <- subset(md_controls189, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_95m2 <- multi_95m[,c(1,2,3,4)]\
multi_95m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full189$person_id)]\
\
##Rematch the used PIDs\
control95_m_d2 <- subset(control_pop_m, index_age >=5420 & index_age<5490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control95_m_d2)\
match_age95m_d2 <- rbind(multi_95m2, control95_m_d2)\
m_age95m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age95m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age95m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full189_d2 <- cbind(match_age95m_d2, r2)\
match_full189_d2 = match_full189_d2[!match_full189_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_95m <- unique_95m[,c(1,2,3,4,5,6,7)]\
match_full189_d3 <-rbind(unique_95m, match_full189_d2)\
match_full189_d3 <- subset(match_full189_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full189_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full189_d3$person_id)]\
\
#females\
case95_f <- subset(case_pop_f,index_age >=5430 & index_age <5480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case95_f)\
control95_f <- subset(control_pop_f, index_age >=5420 & index_age<5490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control95_f)\
match_age95f <- rbind(case95_f, control95_f)\
setDT(match_age95f)\
\
m_age95f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age95f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age95f$factor\
f95 <- as.data.table(r)\
f95$ID2 <- seq.int(nrow(f95))\
\
match_full190 <- cbind(match_age95f, f95)\
match_full190 = match_full190[!match_full190$r== 'NA',]\
\
md_controls95f <- subset(match_full190, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases95f <- subset(match_full190, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases95f[,.N,by=person_id]\
md_controls95f[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% md_controls95f$person_id)]\
\
##combine all matched data: round 19\
\
colnames(md_controls91m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls91f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full183_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full184_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full185_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls93f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full187_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full188_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full189_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls95f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_19 <- rbind(md_controls91m,  md_controls91f, match_full183_d3, match_full184_d3, match_full185_d3, md_controls93f, match_full187_d3, match_full188_d3, match_full189_d3, md_controls95f)\
setDT(match_total_19)\
match_total_19[,.N,by=person_id]\
write.csv(match_total_19, 'match_total_19.csv')\
\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_19,  c("person_id","num_of_prior_visits"))\
\
mt19_matched_measures3= f[match_total_19]\
mt19_matched_measures4 <- mt19_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt19_matched_measures4)\
\
setkeyv(mt19_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt19_control_conditions= conditions2[mt19_matched_measures4]\
\
mt19_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt19_cont_pre_index <- match_total_19[,c(1,4)]\
mt19_cont_pre_index$pre <- mt19_cont_pre_index[, 2] -1\
mt19_cont_pre_index2 <- mt19_cont_pre_index[,c(1,3)]\
colnames(mt19_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt19_cont_pre_index2)\
setkeyv(mt19_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt19_matched_pre_measures= f[mt19_cont_pre_index2]\
\
mt19_matched_pre_measures2 <- mt19_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt19_matched_pre_measures2)\
\
setkeyv(mt19_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt19_control_conditions_pre= conditions2[mt19_matched_pre_measures2]\
\
mt19_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt19_cont_post_index <- match_total_19[,c(1,4)]\
mt19_cont_post_index$post <- mt19_cont_pre_index[, 2] +1\
mt19_cont_post_index2 <- mt19_cont_post_index[,c(1,3)]\
colnames(mt19_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt19_cont_post_index2)\
setkeyv(mt19_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt19_matched_post_measures= f[mt19_cont_post_index2]\
\
mt19_matched_post_measures2 <- mt19_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt19_matched_post_measures2)\
\
setkeyv(mt19_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt19_control_conditions_post= conditions2[mt19_matched_post_measures2]\
\
mt19_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt19_control_conditions_post= mt19_control_conditions_post[!mt19_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt19_control_conditions_post$Timing_Class = '3'\
mt19_control_conditions_pre$Timing_Class = '1'\
mt19_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_19$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_19$person_id)]\
\
#Combine all clinical observations from the 16th set\
full_con_19 <- rbind(mt19_control_conditions_pre, mt19_control_conditions, mt19_control_conditions_post)\
setDT(full_con_19)\
full_con_19[,.N,by=person_id]\
\
## 5480-5530 days old\
#males\
\
case96_m <- subset(case_pop_m, index_age >=5480 & index_age <5530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case96_m)\
control96_m <- subset(control_pop_m, index_age >=5470 & index_age<5540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control96_m)\
match_age96m <- rbind(case96_m, control96_m)\
setDT(match_age96m)\
\
m_age96m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age96m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age96m$factor\
m96 <- as.data.table(r)\
m96$ID2 <- seq.int(nrow(m96))\
\
match_full191 <- cbind(match_age96m, m96)\
match_full191 = match_full191[!match_full191$r== 'NA',]\
\
md_controls96m <- subset(match_full191, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases96m <- subset(match_full191, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases96m[,.N,by=person_id]\
md_controls96m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls191 <-md_controls96m[order(person_id)]\
md_controls191[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_96m <- subset(md_controls191, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_96m <- subset(md_controls191, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_96m2 <- multi_96m[,c(1,2,3,4)]\
multi_96m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full191$person_id)]\
\
##Rematch the used PIDs\
control96_m_d2 <- subset(control_pop_m, index_age >=5470 & index_age<5540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control96_m_d2)\
match_age96m_d2 <- rbind(multi_96m2, control96_m_d2)\
m_age96m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age96m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age96m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full191_d2 <- cbind(match_age96m_d2, r2)\
match_full191_d2 = match_full191_d2[!match_full191_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_96m <- unique_96m[,c(1,2,3,4,5,6,7)]\
match_full191_d3 <-rbind(unique_96m, match_full191_d2)\
match_full191_d3 <- subset(match_full191_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full191_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full191_d3$person_id)]\
\
#females\
case96_f <- subset(case_pop_f,index_age >=5480 & index_age <5530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case96_f)\
control96_f <- subset(control_pop_f, index_age >=5470 & index_age<5540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control96_f)\
match_age96f <- rbind(case96_f, control96_f)\
setDT(match_age96f)\
\
m_age96f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age96f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age96f$factor\
f96 <- as.data.table(r)\
f96$ID2 <- seq.int(nrow(f96))\
\
match_full192 <- cbind(match_age96f, f96)\
match_full192 = match_full192[!match_full192$r== 'NA',]\
\
md_controls96f <- subset(match_full192, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases96f <- subset(match_full192, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases96f[,.N,by=person_id]\
md_controls96f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls192 <-md_controls96f[order(person_id)]\
md_controls192[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_96f <- subset(md_controls192, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_96f <- subset(md_controls192, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_96f2 <- multi_96f[,c(1,2,3,4)]\
multi_96f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full192$person_id)]\
\
##Rematch the used PIDs\
control96_f_d2 <- subset(control_pop_f, index_age >=5470 & index_age<5540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control96_f_d2)\
match_age96f_d2 <- rbind(multi_96f2, control96_f_d2)\
m_age96f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age96f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age96f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full192_d2 <- cbind(match_age96f_d2, r2)\
match_full192_d2 = match_full192_d2[!match_full192_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_96f <- unique_96f[,c(1,2,3,4,5,6,7)]\
match_full192_d3 <-rbind(unique_96f, match_full192_d2)\
match_full192_d3 <- subset(match_full192_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full192_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full192_d3$person_id)]\
\
## 5530-5580 days old\
#males\
\
case97_m <- subset(case_pop_m, index_age >=5530 & index_age <5580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case97_m)\
control97_m <- subset(control_pop_m, index_age >=5520 & index_age<5590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control97_m)\
match_age97m <- rbind(case97_m, control97_m)\
setDT(match_age97m)\
\
m_age97m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age97m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age97m$factor\
m97 <- as.data.table(r)\
m97$ID2 <- seq.int(nrow(m97))\
\
match_full193 <- cbind(match_age97m, m97)\
match_full193 = match_full193[!match_full193$r== 'NA',]\
\
md_controls97m <- subset(match_full193, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases97m <- subset(match_full193, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases97m[,.N,by=person_id]\
md_controls97m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls193 <-md_controls97m[order(person_id)]\
md_controls193[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_97m <- subset(md_controls193, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_97m <- subset(md_controls193, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_97m2 <- multi_97m[,c(1,2,3,4)]\
multi_97m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full193$person_id)]\
\
##Rematch the used PIDs\
control97_m_d2 <- subset(control_pop_m, index_age >=5520 & index_age<5590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control97_m_d2)\
match_age97m_d2 <- rbind(multi_97m2, control97_m_d2)\
m_age97m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age97m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age97m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full193_d2 <- cbind(match_age97m_d2, r2)\
match_full193_d2 = match_full193_d2[!match_full193_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_97m <- unique_97m[,c(1,2,3,4,5,6,7)]\
match_full193_d3 <-rbind(unique_97m, match_full193_d2)\
match_full193_d3 <- subset(match_full193_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full193_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full193_d3$person_id)]\
\
#females\
case97_f <- subset(case_pop_f,index_age >=5530 & index_age <5580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case97_f)\
control97_f <- subset(control_pop_f, index_age >=5520 & index_age<5590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control97_f)\
match_age97f <- rbind(case97_f, control97_f)\
setDT(match_age97f)\
\
m_age97f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age97f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age97f$factor\
f97 <- as.data.table(r)\
f97$ID2 <- seq.int(nrow(f97))\
\
match_full194 <- cbind(match_age97f, f97)\
match_full194 = match_full194[!match_full194$r== 'NA',]\
\
md_controls97f <- subset(match_full194, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases97f <- subset(match_full194, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases97f[,.N,by=person_id]\
md_controls97f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls194 <-md_controls97f[order(person_id)]\
md_controls194[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_97f <- subset(md_controls194, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_97f <- subset(md_controls194, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_97f2 <- multi_97f[,c(1,2,3,4)]\
multi_97f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full194$person_id)]\
\
##Rematch the used PIDs\
control97_f_d2 <- subset(control_pop_f, index_age >=5520 & index_age<5590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control97_f_d2)\
match_age97f_d2 <- rbind(multi_97f2, control97_f_d2)\
m_age97f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age97f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age97f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full194_d2 <- cbind(match_age97f_d2, r2)\
match_full194_d2 = match_full194_d2[!match_full194_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_97f <- unique_97f[,c(1,2,3,4,5,6,7)]\
match_full194_d3 <-rbind(unique_97f, match_full194_d2)\
match_full194_d3 <- subset(match_full194_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full194_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full194_d3$person_id)]\
\
## 5580-5630 days old\
#males\
\
case98_m <- subset(case_pop_m, index_age >=5580 & index_age <5630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case98_m)\
control98_m <- subset(control_pop_m, index_age >=5570 & index_age<5640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control98_m)\
match_age98m <- rbind(case98_m, control98_m)\
setDT(match_age98m)\
\
m_age98m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age98m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age98m$factor\
m98 <- as.data.table(r)\
m98$ID2 <- seq.int(nrow(m98))\
\
match_full195 <- cbind(match_age98m, m98)\
match_full195 = match_full195[!match_full195$r== 'NA',]\
\
md_controls98m <- subset(match_full195, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases98m <- subset(match_full195, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases98m[,.N,by=person_id]\
md_controls98m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls195 <-md_controls98m[order(person_id)]\
md_controls195[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_98m <- subset(md_controls195, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_98m <- subset(md_controls195, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_98m2 <- multi_98m[,c(1,2,3,4)]\
multi_98m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full195$person_id)]\
\
##Rematch the used PIDs\
control98_m_d2 <- subset(control_pop_m, index_age >=5570 & index_age<5640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control98_m_d2)\
match_age98m_d2 <- rbind(multi_98m2, control98_m_d2)\
m_age98m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age98m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age98m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full195_d2 <- cbind(match_age98m_d2, r2)\
match_full195_d2 = match_full195_d2[!match_full195_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_98m <- unique_98m[,c(1,2,3,4,5,6,7)]\
match_full195_d3 <-rbind(unique_98m, match_full195_d2)\
match_full195_d3 <- subset(match_full195_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full195_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full195_d3$person_id)]\
\
#females\
case98_f <- subset(case_pop_f,index_age >=5580 & index_age <5630, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case98_f)\
control98_f <- subset(control_pop_f, index_age >=5570 & index_age<5640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control98_f)\
match_age98f <- rbind(case98_f, control98_f)\
setDT(match_age98f)\
\
m_age98f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age98f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age98f$factor\
f98 <- as.data.table(r)\
f98$ID2 <- seq.int(nrow(f98))\
\
match_full196 <- cbind(match_age98f, f98)\
match_full196 = match_full196[!match_full196$r== 'NA',]\
\
md_controls98f <- subset(match_full196, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases98f <- subset(match_full196, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases98f[,.N,by=person_id]\
md_controls98f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls196 <-md_controls98f[order(person_id)]\
md_controls196[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_98f <- subset(md_controls196, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_98f <- subset(md_controls196, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_98f2 <- multi_98f[,c(1,2,3,4)]\
multi_98f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full196$person_id)]\
\
##Rematch the used PIDs\
control98_f_d2 <- subset(control_pop_f, index_age >=5570 & index_age<5640, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control98_f_d2)\
match_age98f_d2 <- rbind(multi_98f2, control98_f_d2)\
m_age98f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age98f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age98f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full196_d2 <- cbind(match_age98f_d2, r2)\
match_full196_d2 = match_full196_d2[!match_full196_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_98f <- unique_98f[,c(1,2,3,4,5,6,7)]\
match_full196_d3 <-rbind(unique_98f, match_full196_d2)\
match_full196_d3 <- subset(match_full196_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full196_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full196_d3$person_id)]\
\
## 5630-5680 days old\
#males\
\
case99_m <- subset(case_pop_m, index_age >=5630 & index_age <5680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case99_m)\
control99_m <- subset(control_pop_m, index_age >=5620 & index_age<5690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control99_m)\
match_age99m <- rbind(case99_m, control99_m)\
setDT(match_age99m)\
\
m_age99m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age99m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age99m$factor\
m99 <- as.data.table(r)\
m99$ID2 <- seq.int(nrow(m99))\
\
match_full197 <- cbind(match_age99m, m99)\
match_full197 = match_full197[!match_full197$r== 'NA',]\
\
md_controls99m <- subset(match_full197, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases99m <- subset(match_full197, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases99m[,.N,by=person_id]\
md_controls99m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls197 <-md_controls99m[order(person_id)]\
md_controls197[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_99m <- subset(md_controls197, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_99m <- subset(md_controls197, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_99m2 <- multi_99m[,c(1,2,3,4)]\
multi_99m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full197$person_id)]\
\
##Rematch the used PIDs\
control99_m_d2 <- subset(control_pop_m, index_age >=5620 & index_age<5690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control99_m_d2)\
match_age99m_d2 <- rbind(multi_99m2, control99_m_d2)\
m_age99m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age99m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age99m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full197_d2 <- cbind(match_age99m_d2, r2)\
match_full197_d2 = match_full197_d2[!match_full197_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_99m <- unique_99m[,c(1,2,3,4,5,6,7)]\
match_full197_d3 <-rbind(unique_99m, match_full197_d2)\
match_full197_d3 <- subset(match_full197_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full197_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full197_d3$person_id)]\
\
#females\
case99_f <- subset(case_pop_f, index_age >=5630 & index_age <5680, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case99_f)\
control99_f <- subset(control_pop_f, index_age >=5620 & index_age<5690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control99_f)\
match_age99f <- rbind(case99_f, control99_f)\
setDT(match_age99f)\
\
m_age99f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age99f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age99f$factor\
f99 <- as.data.table(r)\
f99$ID2 <- seq.int(nrow(f99))\
\
match_full198 <- cbind(match_age99f, f99)\
match_full198 = match_full198[!match_full198$r== 'NA',]\
\
md_controls99f <- subset(match_full198, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases99f <- subset(match_full198, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases99f[,.N,by=person_id]\
md_controls99f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls198 <-md_controls99f[order(person_id)]\
md_controls198[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_99f <- subset(md_controls198, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_99f <- subset(md_controls198, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_99f2 <- multi_99f[,c(1,2,3,4)]\
multi_99f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full198$person_id)]\
\
##Rematch the used PIDs\
control99_f_d2 <- subset(control_pop_f, index_age >=5620 & index_age<5690, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control99_f_d2)\
match_age99f_d2 <- rbind(multi_99f2, control99_f_d2)\
m_age99f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age99f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age99f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full198_d2 <- cbind(match_age99f_d2, r2)\
match_full198_d2 = match_full198_d2[!match_full198_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_99f <- unique_99f[,c(1,2,3,4,5,6,7)]\
match_full198_d3 <-rbind(unique_99f, match_full198_d2)\
match_full198_d3 <- subset(match_full198_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full198_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full198_d3$person_id)]\
\
## 5680-5730 days old\
#males\
\
case100_m <- subset(case_pop_m, index_age >=5680 & index_age <5730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case100_m)\
control100_m <- subset(control_pop_m, index_age >=5670 & index_age<5740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control100_m)\
match_age100m <- rbind(case100_m, control100_m)\
setDT(match_age100m)\
\
m_age100m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age100m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age100m$factor\
m100 <- as.data.table(r)\
m100$ID2 <- seq.int(nrow(m100))\
\
match_full199 <- cbind(match_age100m, m100)\
match_full199 = match_full199[!match_full199$r== 'NA',]\
\
md_controls100m <- subset(match_full199, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases100m <- subset(match_full199, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases100m[,.N,by=person_id]\
md_controls100m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls199 <-md_controls100m[order(person_id)]\
md_controls199[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_100m <- subset(md_controls199, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_100m <- subset(md_controls199, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_100m2 <- multi_100m[,c(1,2,3,4)]\
multi_100m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full199$person_id)]\
\
##Rematch the used PIDs\
control100_m_d2 <- subset(control_pop_m, index_age >=5670 & index_age<5740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control100_m_d2)\
match_age100m_d2 <- rbind(multi_100m2, control100_m_d2)\
m_age100m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age100m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age100m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full199_d2 <- cbind(match_age100m_d2, r2)\
match_full199_d2 = match_full199_d2[!match_full199_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_100m <- unique_100m[,c(1,2,3,4,5,6,7)]\
match_full199_d3 <-rbind(unique_100m, match_full199_d2)\
match_full199_d3 <- subset(match_full199_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full199_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full199_d3$person_id)]\
\
#females\
case100_f <- subset(case_pop_f, index_age >=5680 & index_age <5730, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case100_f)\
control100_f <- subset(control_pop_f, index_age >=5670 & index_age<5740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control100_f)\
match_age100f <- rbind(case100_f, control100_f)\
setDT(match_age100f)\
\
m_age100f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age100f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age100f$factor\
f100 <- as.data.table(r)\
f100$ID2 <- seq.int(nrow(f100))\
\
match_full200 <- cbind(match_age100f, f100)\
match_full200 = match_full200[!match_full200$r== 'NA',]\
\
md_controls100f <- subset(match_full200, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases100f <- subset(match_full200, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases100f[,.N,by=person_id]\
md_controls100f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls200 <-md_controls100f[order(person_id)]\
md_controls200[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_100f <- subset(md_controls200, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_100f <- subset(md_controls200, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_100f2 <- multi_100f[,c(1,2,3,4)]\
multi_100f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full200$person_id)]\
\
##Rematch the used PIDs\
control100_f_d2 <- subset(control_pop_f, index_age >=5670 & index_age<5740, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control100_f_d2)\
match_age100f_d2 <- rbind(multi_100f2, control100_f_d2)\
m_age100f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age100f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age100f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full200_d2 <- cbind(match_age100f_d2, r2)\
match_full200_d2 = match_full200_d2[!match_full200_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_100f <- unique_100f[,c(1,2,3,4,5,6,7)]\
match_full200_d3 <-rbind(unique_100f, match_full200_d2)\
match_full200_d3 <- subset(match_full200_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full200_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full200_d3$person_id)]\
\
##combine all matched data: round 20\
\
colnames(match_full191_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full192_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full193_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full194_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full195_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full196_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full197_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full198_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full199_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full200_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_20 <- rbind(match_full191_d3, match_full192_d3, match_full193_d3, match_full194_d3, match_full195_d3, match_full196_d3, match_full197_d3, match_full198_d3, match_full199_d3, match_full200_d3)\
setDT(match_total_20)\
match_total_20[,.N,by=person_id]\
write.csv(match_total_20, 'match_total_20.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_20,  c("person_id","num_of_prior_visits"))\
\
mt20_matched_measures3= f[match_total_20]\
mt20_matched_measures4 <- mt20_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt20_matched_measures4)\
\
setkeyv(mt20_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt20_control_conditions= conditions2[mt20_matched_measures4]\
\
mt20_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt20_cont_pre_index <- match_total_20[,c(1,4)]\
mt20_cont_pre_index$pre <- mt20_cont_pre_index[, 2] -1\
mt20_cont_pre_index2 <- mt20_cont_pre_index[,c(1,3)]\
colnames(mt20_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt20_cont_pre_index2)\
setkeyv(mt20_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt20_matched_pre_measures= f[mt20_cont_pre_index2]\
\
mt20_matched_pre_measures2 <- mt20_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt20_matched_pre_measures2)\
\
setkeyv(mt20_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt20_control_conditions_pre= conditions2[mt20_matched_pre_measures2]\
\
mt20_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt20_cont_post_index <- match_total_20[,c(1,4)]\
mt20_cont_post_index$post <- mt20_cont_pre_index[, 2] +1\
mt20_cont_post_index2 <- mt20_cont_post_index[,c(1,3)]\
colnames(mt20_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt20_cont_post_index2)\
setkeyv(mt20_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt20_matched_post_measures= f[mt20_cont_post_index2]\
\
mt20_matched_post_measures2 <- mt20_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt20_matched_post_measures2)\
\
setkeyv(mt20_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt20_control_conditions_post= conditions2[mt20_matched_post_measures2]\
\
mt20_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt20_control_conditions_post= mt20_control_conditions_post[!mt20_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt20_control_conditions_post$Timing_Class = '3'\
mt20_control_conditions_pre$Timing_Class = '1'\
mt20_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_20$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_20$person_id)]\
\
#Combine all clinical observations from the 16th set\
full_con_20 <- rbind(mt20_control_conditions_pre, mt20_control_conditions, mt20_control_conditions_post)\
setDT(full_con_20)\
full_con_20[,.N,by=person_id]\
\
##Combine all clinical observations from the second ten sets\
\
set2_full_con <- rbind(full_con_11, full_con_12, full_con_13, full_con_14, full_con_15, full_con_16, full_con_17, full_con_18, full_con_19, full_con_20)\
setDT(set2_full_con)\
set2_full_con[,.N,by=person_id]\
\
write.csv(set2_full_con, 'set2_full_con.csv')\
\
#Confirm there are no duplicates\
full <- rbind(set1_full_con, set2_full_con)\
full[,.N,by=person_id]\
setDT(full)\
control_pop_m <- control_pop_m[!(person_id %in% full$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% full$person_id)]\
\
## 5730-5780 days old\
#males\
\
case101_m <- subset(case_pop_m, index_age >=5730 & index_age <5780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case101_m)\
control101_m <- subset(control_pop_m, index_age >=5720 & index_age<5790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control101_m)\
match_age101m <- rbind(case101_m, control101_m)\
setDT(match_age101m)\
\
m_age101m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age101m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age101m$factor\
m101 <- as.data.table(r)\
m101$ID2 <- seq.int(nrow(m101))\
\
match_full201 <- cbind(match_age101m, m101)\
match_full201 = match_full201[!match_full201$r== 'NA',]\
\
md_controls101m <- subset(match_full201, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases101m <- subset(match_full201, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases101m[,.N,by=person_id]\
md_controls101m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls201 <-md_controls101m[order(person_id)]\
md_controls201[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_101m <- subset(md_controls201, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_101m <- subset(md_controls201, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_101m2 <- multi_101m[,c(1,2,3,4)]\
multi_101m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full201$person_id)]\
\
##Rematch the used PIDs\
control101_m_d2 <- subset(control_pop_m, index_age >=5720 & index_age<5790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control101_m_d2)\
match_age101m_d2 <- rbind(multi_101m2, control101_m_d2)\
m_age101m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age101m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age101m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full201_d2 <- cbind(match_age101m_d2, r2)\
match_full201_d2 = match_full201_d2[!match_full201_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_101m <- unique_101m[,c(1,2,3,4,5,6,7)]\
match_full201_d3 <-rbind(unique_101m, match_full201_d2)\
match_full201_d3 <- subset(match_full201_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full201_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full201_d3$person_id)]\
\
#females\
case101_f <- subset(case_pop_f, index_age >=5730 & index_age <5780, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case101_f)\
control101_f <- subset(control_pop_f,index_age >=5720 & index_age<5790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control101_f)\
match_age101f <- rbind(case101_f, control101_f)\
setDT(match_age101f)\
\
m_age101f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age101f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age101f$factor\
f101 <- as.data.table(r)\
f101$ID2 <- seq.int(nrow(f101))\
\
match_full202 <- cbind(match_age101f, f101)\
match_full202 = match_full202[!match_full202$r== 'NA',]\
\
md_controls101f <- subset(match_full202, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases101f <- subset(match_full202, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases101f[,.N,by=person_id]\
md_controls101f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls202 <-md_controls101f[order(person_id)]\
md_controls202[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_101f <- subset(md_controls202, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_101f <- subset(md_controls202, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_101f2 <- multi_101f[,c(1,2,3,4)]\
multi_101f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full202$person_id)]\
\
##Rematch the used PIDs\
control101_f_d2 <- subset(control_pop_f, index_age >=5720 & index_age<5790, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control101_f_d2)\
match_age101f_d2 <- rbind(multi_101f2, control101_f_d2)\
m_age101f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age101f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age101f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full202_d2 <- cbind(match_age101f_d2, r2)\
match_full202_d2 = match_full202_d2[!match_full202_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_101f <- unique_101f[,c(1,2,3,4,5,6,7)]\
match_full202_d3 <-rbind(unique_101f, match_full202_d2)\
match_full202_d3 <- subset(match_full202_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full202_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full202_d3$person_id)]\
\
## 5780-5830 days old\
#males\
\
case102_m <- subset(case_pop_m, index_age >=5780 & index_age <5830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case102_m)\
control102_m <- subset(control_pop_m, index_age >=5770 & index_age<5840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control102_m)\
match_age102m <- rbind(case102_m, control102_m)\
setDT(match_age102m)\
\
m_age102m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age102m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age102m$factor\
m102 <- as.data.table(r)\
m102$ID2 <- seq.int(nrow(m102))\
\
match_full203 <- cbind(match_age102m, m102)\
match_full203 = match_full203[!match_full203$r== 'NA',]\
\
md_controls102m <- subset(match_full203, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases102m <- subset(match_full203, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases102m[,.N,by=person_id]\
md_controls102m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls203 <-md_controls102m[order(person_id)]\
md_controls203[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_102m <- subset(md_controls203, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_102m <- subset(md_controls203, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_102m2 <- multi_102m[,c(1,2,3,4)]\
multi_102m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full203$person_id)]\
\
##Rematch the used PIDs\
control102_m_d2 <- subset(control_pop_m, index_age >=5770 & index_age<5840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control102_m_d2)\
match_age102m_d2 <- rbind(multi_102m2, control102_m_d2)\
m_age102m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age102m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age102m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full203_d2 <- cbind(match_age102m_d2, r2)\
match_full203_d2 = match_full203_d2[!match_full203_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_102m <- unique_102m[,c(1,2,3,4,5,6,7)]\
match_full203_d3 <-rbind(unique_102m, match_full203_d2)\
match_full203_d3 <- subset(match_full203_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full203_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full203_d3$person_id)]\
\
#females\
case102_f <- subset(case_pop_f, index_age >=5780 & index_age <5830, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case102_f)\
control102_f <- subset(control_pop_f,index_age >=5770 & index_age<5840, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control102_f)\
match_age102f <- rbind(case102_f, control102_f)\
setDT(match_age102f)\
\
m_age102f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age102f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age102f$factor\
f102 <- as.data.table(r)\
f102$ID2 <- seq.int(nrow(f102))\
\
match_full204 <- cbind(match_age102f, f102)\
match_full204 = match_full204[!match_full204$r== 'NA',]\
\
md_controls102f <- subset(match_full204, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases102f <- subset(match_full204, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases102f[,.N,by=person_id]\
md_controls102f[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% md_controls102f$person_id)]\
\
## 5830-5880 days old\
#males\
\
case103_m <- subset(case_pop_m, index_age >=5830 & index_age <5880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case103_m)\
control103_m <- subset(control_pop_m, index_age >=5820 & index_age<5890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control103_m)\
match_age103m <- rbind(case103_m, control103_m)\
setDT(match_age103m)\
\
m_age103m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age103m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age103m$factor\
m103 <- as.data.table(r)\
m103$ID2 <- seq.int(nrow(m103))\
\
match_full205 <- cbind(match_age103m, m103)\
match_full205 = match_full205[!match_full205$r== 'NA',]\
\
md_controls103m <- subset(match_full205, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases103m <- subset(match_full205, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases103m[,.N,by=person_id]\
md_controls103m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls205 <-md_controls103m[order(person_id)]\
md_controls205[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_103m <- subset(md_controls205, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_103m <- subset(md_controls205, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_103m2 <- multi_103m[,c(1,2,3,4)]\
multi_103m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full205$person_id)]\
\
##Rematch the used PIDs\
control103_m_d2 <- subset(control_pop_m, index_age >=5820 & index_age<5890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control103_m_d2)\
match_age103m_d2 <- rbind(multi_103m2, control103_m_d2)\
m_age103m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age103m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age103m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full205_d2 <- cbind(match_age103m_d2, r2)\
match_full205_d2 = match_full205_d2[!match_full205_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_103m <- unique_103m[,c(1,2,3,4,5,6,7)]\
match_full205_d3 <-rbind(unique_103m, match_full205_d2)\
match_full205_d3 <- subset(match_full205_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full205_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full205_d3$person_id)]\
\
#females\
case103_f <- subset(case_pop_f, index_age >=5830 & index_age <5880, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case103_f)\
control103_f <- subset(control_pop_f,index_age >=5820 & index_age<5890, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control103_f)\
match_age103f <- rbind(case103_f, control103_f)\
setDT(match_age103f)\
\
m_age103f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age103f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age103f$factor\
f103 <- as.data.table(r)\
f103$ID2 <- seq.int(nrow(f103))\
\
match_full206 <- cbind(match_age103f, f103)\
match_full206 = match_full206[!match_full206$r== 'NA',]\
\
md_controls103f <- subset(match_full206, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases103f <- subset(match_full206, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases103f[,.N,by=person_id]\
md_controls103f[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% md_controls103f$person_id)]\
\
## 5880-5930 days old\
#males\
\
case104_m <- subset(case_pop_m, index_age >=5880 & index_age <5930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case104_m)\
control104_m <- subset(control_pop_m, index_age >=5870 & index_age<5940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control104_m)\
match_age104m <- rbind(case104_m, control104_m)\
setDT(match_age104m)\
\
m_age104m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age104m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age104m$factor\
m104 <- as.data.table(r)\
m104$ID2 <- seq.int(nrow(m104))\
\
match_full207 <- cbind(match_age104m, m104)\
match_full207 = match_full207[!match_full207$r== 'NA',]\
\
md_controls104m <- subset(match_full207, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases104m <- subset(match_full207, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases104m[,.N,by=person_id]\
md_controls104m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls207 <-md_controls104m[order(person_id)]\
md_controls207[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_104m <- subset(md_controls207, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_104m <- subset(md_controls207, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_104m2 <- multi_104m[,c(1,2,3,4)]\
multi_104m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full207$person_id)]\
\
##Rematch the used PIDs\
control104_m_d2 <- subset(control_pop_m, index_age >=5870 & index_age<5940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control104_m_d2)\
match_age104m_d2 <- rbind(multi_104m2, control104_m_d2)\
m_age104m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age104m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age104m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full207_d2 <- cbind(match_age104m_d2, r2)\
match_full207_d2 = match_full207_d2[!match_full207_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_104m <- unique_104m[,c(1,2,3,4,5,6,7)]\
match_full207_d3 <-rbind(unique_104m, match_full207_d2)\
match_full207_d3 <- subset(match_full207_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full207_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full207_d3$person_id)]\
\
#females\
case104_f <- subset(case_pop_f, index_age >=5880 & index_age <5930, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case104_f)\
control104_f <- subset(control_pop_f,index_age >=5870 & index_age<5940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control104_f)\
match_age104f <- rbind(case104_f, control104_f)\
setDT(match_age104f)\
\
m_age104f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age104f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age104f$factor\
f104 <- as.data.table(r)\
f104$ID2 <- seq.int(nrow(f104))\
\
match_full208 <- cbind(match_age104f, f104)\
match_full208 = match_full208[!match_full208$r== 'NA',]\
\
md_controls104f <- subset(match_full208, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases104f <- subset(match_full208, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases104f[,.N,by=person_id]\
md_controls104f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls208 <-md_controls104f[order(person_id)]\
md_controls208[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_104f <- subset(md_controls208, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_104f <- subset(md_controls208, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_104f2 <- multi_104f[,c(1,2,3,4)]\
multi_104f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full208$person_id)]\
\
##Rematch the used PIDs\
control104_f_d2 <- subset(control_pop_f,index_age >=5870 & index_age<5940, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control104_f_d2)\
match_age104f_d2 <- rbind(multi_104f2, control104_f_d2)\
m_age104f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age104f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age104f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full208_d2 <- cbind(match_age104f_d2, r2)\
match_full208_d2 = match_full208_d2[!match_full208_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_104f <- unique_104f[,c(1,2,3,4,5,6,7)]\
match_full208_d3 <-rbind(unique_104f, match_full208_d2)\
match_full208_d3 <- subset(match_full208_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full208_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full208_d3$person_id)]\
\
## 5930-5980 days old\
#males\
\
case105_m <- subset(case_pop_m, index_age >=5930 & index_age <5980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case105_m)\
control105_m <- subset(control_pop_m, index_age >=5920 & index_age<5990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control105_m)\
match_age105m <- rbind(case105_m, control105_m)\
setDT(match_age105m)\
\
m_age105m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age105m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age105m$factor\
m105 <- as.data.table(r)\
m105$ID2 <- seq.int(nrow(m105))\
\
match_full209 <- cbind(match_age105m, m105)\
match_full209 = match_full209[!match_full209$r== 'NA',]\
\
md_controls105m <- subset(match_full209, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases105m <- subset(match_full209, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases105m[,.N,by=person_id]\
md_controls105m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls209 <-md_controls105m[order(person_id)]\
md_controls209[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_105m <- subset(md_controls209, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_105m <- subset(md_controls209, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_105m2 <- multi_105m[,c(1,2,3,4)]\
multi_105m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full209$person_id)]\
\
##Rematch the used PIDs\
control105_m_d2 <- subset(control_pop_m, index_age >=5920 & index_age<5990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control105_m_d2)\
match_age105m_d2 <- rbind(multi_105m2, control105_m_d2)\
m_age105m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age105m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age105m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full209_d2 <- cbind(match_age105m_d2, r2)\
match_full209_d2 = match_full209_d2[!match_full209_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_105m <- unique_105m[,c(1,2,3,4,5,6,7)]\
match_full209_d3 <-rbind(unique_105m, match_full209_d2)\
match_full209_d3 <- subset(match_full209_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full209_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full209_d3$person_id)]\
\
#females\
case105_f <- subset(case_pop_f, index_age >=5930 & index_age <5980, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case105_f)\
control105_f <- subset(control_pop_f,index_age >=5920 & index_age<5990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control105_f)\
match_age105f <- rbind(case105_f, control105_f)\
setDT(match_age105f)\
\
m_age105f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age105f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age105f$factor\
f105 <- as.data.table(r)\
f105$ID2 <- seq.int(nrow(f105))\
\
match_full210 <- cbind(match_age105f, f105)\
match_full210 = match_full210[!match_full210$r== 'NA',]\
\
md_controls105f <- subset(match_full210, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases105f <- subset(match_full210, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases105f[,.N,by=person_id]\
md_controls105f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls210 <-md_controls105f[order(person_id)]\
md_controls210[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_105f <- subset(md_controls210, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_105f <- subset(md_controls210, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_105f2 <- multi_105f[,c(1,2,3,4)]\
multi_105f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full210$person_id)]\
\
##Rematch the used PIDs\
control105_f_d2 <- subset(control_pop_f,index_age >=5920 & index_age<5990, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control105_f_d2)\
match_age105f_d2 <- rbind(multi_105f2, control105_f_d2)\
m_age105f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age105f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age105f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full210_d2 <- cbind(match_age105f_d2, r2)\
match_full210_d2 = match_full210_d2[!match_full210_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_105f <- unique_105f[,c(1,2,3,4,5,6,7)]\
match_full210_d3 <-rbind(unique_105f, match_full210_d2)\
match_full210_d3 <- subset(match_full210_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full210_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full210_d3$person_id)]\
\
\
##combine all matched data: round 21\
\
colnames(match_full201_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full202_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full203_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls102f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full205_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls103f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full207_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full208_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full209_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full210_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_21 <- rbind(match_full201_d3, match_full202_d3, match_full203_d3, md_controls102f, match_full205_d3, md_controls103f, match_full207_d3, match_full208_d3, match_full209_d3, match_full210_d3)\
setDT(match_total_21)\
match_total_21[,.N,by=person_id]\
write.csv(match_total_21, 'match_total_21.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_21,  c("person_id","num_of_prior_visits"))\
\
mt21_matched_measures3= f[match_total_21]\
mt21_matched_measures4 <- mt21_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt21_matched_measures4)\
\
setkeyv(mt21_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt21_control_conditions= conditions2[mt21_matched_measures4]\
\
mt21_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt21_cont_pre_index <- match_total_21[,c(1,4)]\
mt21_cont_pre_index$pre <- mt21_cont_pre_index[, 2] -1\
mt21_cont_pre_index2 <- mt21_cont_pre_index[,c(1,3)]\
colnames(mt21_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt21_cont_pre_index2)\
setkeyv(mt21_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt21_matched_pre_measures= f[mt21_cont_pre_index2]\
\
mt21_matched_pre_measures2 <- mt21_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt20_matched_pre_measures2)\
\
setkeyv(mt21_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt21_control_conditions_pre= conditions2[mt21_matched_pre_measures2]\
\
mt21_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt21_cont_post_index <- match_total_21[,c(1,4)]\
mt21_cont_post_index$post <- mt21_cont_pre_index[, 2] +1\
mt21_cont_post_index2 <- mt21_cont_post_index[,c(1,3)]\
colnames(mt21_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt21_cont_post_index2)\
setkeyv(mt21_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt21_matched_post_measures= f[mt21_cont_post_index2]\
\
mt21_matched_post_measures2 <- mt21_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt21_matched_post_measures2)\
\
setkeyv(mt21_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt21_control_conditions_post= conditions2[mt21_matched_post_measures2]\
\
mt21_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt21_control_conditions_post= mt21_control_conditions_post[!mt21_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt21_control_conditions_post$Timing_Class = '3'\
mt21_control_conditions_pre$Timing_Class = '1'\
mt21_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_21$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_21$person_id)]\
\
#Combine all clinical observations from the 16th set\
full_con_21 <- rbind(mt21_control_conditions_pre, mt21_control_conditions, mt21_control_conditions_post)\
setDT(full_con_21)\
full_con_21[,.N,by=person_id]\
\
## 5980-6030 days old\
#males\
\
case106_m <- subset(case_pop_m, index_age >=5980 & index_age <6030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case106_m)\
control106_m <- subset(control_pop_m, index_age >=5970 & index_age<6040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control106_m)\
match_age106m <- rbind(case106_m, control106_m)\
setDT(match_age106m)\
\
m_age106m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age106m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age106m$factor\
m106 <- as.data.table(r)\
m106$ID2 <- seq.int(nrow(m106))\
\
match_full211 <- cbind(match_age106m, m106)\
match_full211 = match_full211[!match_full211$r== 'NA',]\
\
md_controls106m <- subset(match_full211, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases106m <- subset(match_full211, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases106m[,.N,by=person_id]\
md_controls106m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls211 <-md_controls106m[order(person_id)]\
md_controls211[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_106m <- subset(md_controls211, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_106m <- subset(md_controls211, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_106m2 <- multi_106m[,c(1,2,3,4)]\
multi_106m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full211$person_id)]\
\
##Rematch the used PIDs\
control106_m_d2 <- subset(control_pop_m, index_age >=5970 & index_age<6040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control106_m_d2)\
match_age106m_d2 <- rbind(multi_106m2, control106_m_d2)\
m_age106m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age106m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age106m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full211_d2 <- cbind(match_age106m_d2, r2)\
match_full211_d2 = match_full211_d2[!match_full211_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_106m <- unique_106m[,c(1,2,3,4,5,6,7)]\
match_full211_d3 <-rbind(unique_106m, match_full211_d2)\
match_full211_d3 <- subset(match_full211_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full211_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full211_d3$person_id)]\
\
#females\
case106_f <- subset(case_pop_f, index_age >=5980 & index_age <6030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case106_f)\
control106_f <- subset(control_pop_f, index_age >=5970 & index_age<6040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control106_f)\
match_age106f <- rbind(case106_f, control106_f)\
setDT(match_age106f)\
\
m_age106f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age106f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age106f$factor\
f106 <- as.data.table(r)\
f106$ID2 <- seq.int(nrow(f106))\
\
match_full212 <- cbind(match_age106f, f106)\
match_full212 = match_full212[!match_full212$r== 'NA',]\
\
md_controls106f <- subset(match_full212, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases106f <- subset(match_full212, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases106f[,.N,by=person_id]\
md_controls106f[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% md_controls106f$person_id)]\
\
## 6030-6080 days old\
#males\
\
case107_m <- subset(case_pop_m, index_age >=6030 & index_age <6080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case107_m)\
control107_m <- subset(control_pop_m, index_age >=6020 & index_age<6090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control107_m)\
match_age107m <- rbind(case107_m, control107_m)\
setDT(match_age107m)\
\
m_age107m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age107m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age107m$factor\
m107 <- as.data.table(r)\
m107$ID2 <- seq.int(nrow(m107))\
\
match_full213 <- cbind(match_age107m, m107)\
match_full213 = match_full213[!match_full213$r== 'NA',]\
\
md_controls107m <- subset(match_full213, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases107m <- subset(match_full213, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases107m[,.N,by=person_id]\
md_controls107m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls213 <-md_controls107m[order(person_id)]\
md_controls213[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_107m <- subset(md_controls213, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_107m <- subset(md_controls213, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_107m2 <- multi_107m[,c(1,2,3,4)]\
multi_107m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full213$person_id)]\
\
##Rematch the used PIDs\
control107_m_d2 <- subset(control_pop_m, index_age >=6020 & index_age<6090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control107_m_d2)\
match_age107m_d2 <- rbind(multi_107m2, control107_m_d2)\
m_age107m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age107m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age107m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full213_d2 <- cbind(match_age107m_d2, r2)\
match_full213_d2 = match_full213_d2[!match_full213_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_107m <- unique_107m[,c(1,2,3,4,5,6,7)]\
match_full213_d3 <-rbind(unique_107m, match_full213_d2)\
match_full213_d3 <- subset(match_full213_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full213_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full213_d3$person_id)]\
\
#females\
case107_f <- subset(case_pop_f, index_age  >=6030 & index_age <6080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case107_f)\
control107_f <- subset(control_pop_f,index_age >=6020 & index_age<6090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control107_f)\
match_age107f <- rbind(case107_f, control107_f)\
setDT(match_age107f)\
\
m_age107f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age107f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age107f$factor\
f107 <- as.data.table(r)\
f107$ID2 <- seq.int(nrow(f107))\
\
match_full214 <- cbind(match_age107f, f107)\
match_full214 = match_full214[!match_full214$r== 'NA',]\
\
md_controls107f <- subset(match_full214, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases107f <- subset(match_full214, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases107f[,.N,by=person_id]\
md_controls107f[,.N,by=person_id]\
\
\
#Count the number of times each person ID was used\
md_controls214 <-md_controls107f[order(person_id)]\
md_controls214[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_107f <- subset(md_controls214, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_107f <- subset(md_controls214, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_107f2 <- multi_107f[,c(1,2,3,4)]\
multi_107f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full214$person_id)]\
\
##Rematch the used PIDs\
control107_f_d2 <- subset(control_pop_f, index_age >=6020 & index_age<6090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control107_f_d2)\
match_age107f_d2 <- rbind(multi_107f2, control107_f_d2)\
m_age107f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age107f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age107f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full214_d2 <- cbind(match_age107f_d2, r2)\
match_full214_d2 = match_full214_d2[!match_full214_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_107f <- unique_107f[,c(1,2,3,4,5,6,7)]\
match_full214_d3 <-rbind(unique_107f, match_full214_d2)\
match_full214_d3 <- subset(match_full214_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full214_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full214_d3$person_id)]\
\
## 6080-6130 days old\
#males\
\
case108_m <- subset(case_pop_m, index_age >=6080 & index_age <6130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case108_m)\
control108_m <- subset(control_pop_m, index_age >=6070 & index_age<6140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control108_m)\
match_age108m <- rbind(case108_m, control108_m)\
setDT(match_age108m)\
\
m_age108m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age108m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age108m$factor\
m108 <- as.data.table(r)\
m108$ID2 <- seq.int(nrow(m108))\
\
match_full215 <- cbind(match_age108m, m108)\
match_full215 = match_full215[!match_full215$r== 'NA',]\
\
md_controls108m <- subset(match_full215, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases108m <- subset(match_full215, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases108m[,.N,by=person_id]\
md_controls108m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls215 <-md_controls108m[order(person_id)]\
md_controls215[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_108m <- subset(md_controls215, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_108m <- subset(md_controls215, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_108m2 <- multi_108m[,c(1,2,3,4)]\
multi_108m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full215$person_id)]\
\
##Rematch the used PIDs\
control108_m_d2 <- subset(control_pop_m, index_age >=6070 & index_age<6140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control108_m_d2)\
match_age108m_d2 <- rbind(multi_108m2, control108_m_d2)\
m_age108m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age108m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age108m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full215_d2 <- cbind(match_age108m_d2, r2)\
match_full215_d2 = match_full215_d2[!match_full215_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_108m <- unique_108m[,c(1,2,3,4,5,6,7)]\
match_full215_d3 <-rbind(unique_108m, match_full215_d2)\
match_full215_d3 <- subset(match_full215_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full215_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full215_d3$person_id)]\
\
#females\
case108_f <- subset(case_pop_f, index_age >=6080 & index_age <6130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case108_f)\
control108_f <- subset(control_pop_f,index_age >=6070 & index_age<6140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control108_f)\
match_age108f <- rbind(case108_f, control108_f)\
setDT(match_age108f)\
\
m_age108f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age108f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age108f$factor\
f108 <- as.data.table(r)\
f108$ID2 <- seq.int(nrow(f108))\
\
match_full216 <- cbind(match_age108f, f108)\
match_full216 = match_full216[!match_full216$r== 'NA',]\
\
md_controls108f <- subset(match_full216, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases108f <- subset(match_full216, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases108f[,.N,by=person_id]\
md_controls108f[,.N,by=person_id]\
\
\
#Count the number of times each person ID was used\
md_controls216 <-md_controls108f[order(person_id)]\
md_controls216[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_108f <- subset(md_controls216, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_108f <- subset(md_controls216, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_108f2 <- multi_108f[,c(1,2,3,4)]\
multi_108f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full216$person_id)]\
\
##Rematch the used PIDs\
control108_f_d2 <- subset(control_pop_f, index_age >=6070 & index_age<6140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control108_f_d2)\
match_age108f_d2 <- rbind(multi_108f2, control108_f_d2)\
m_age108f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age108f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age108f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full216_d2 <- cbind(match_age108f_d2, r2)\
match_full216_d2 = match_full216_d2[!match_full216_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_108f <- unique_108f[,c(1,2,3,4,5,6,7)]\
match_full216_d3 <-rbind(unique_108f, match_full216_d2)\
match_full216_d3 <- subset(match_full216_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full216_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full216_d3$person_id)]\
\
## 6130-6180 days old\
#males\
\
case109_m <- subset(case_pop_m, index_age >=6130 & index_age <6180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case109_m)\
control109_m <- subset(control_pop_m, index_age >=6120 & index_age<6190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control109_m)\
match_age109m <- rbind(case109_m, control109_m)\
setDT(match_age109m)\
\
m_age109m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age109m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age109m$factor\
m109 <- as.data.table(r)\
m109$ID2 <- seq.int(nrow(m109))\
\
match_full217 <- cbind(match_age109m, m109)\
match_full217 = match_full217[!match_full217$r== 'NA',]\
\
md_controls109m <- subset(match_full217, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases109m <- subset(match_full217, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases109m[,.N,by=person_id]\
md_controls109m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls217 <-md_controls109m[order(person_id)]\
md_controls217[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_109m <- subset(md_controls217, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_109m <- subset(md_controls217, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_109m2 <- multi_109m[,c(1,2,3,4)]\
multi_109m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full217$person_id)]\
\
##Rematch the used PIDs\
control109_m_d2 <- subset(control_pop_m, index_age >=6120 & index_age<6190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control109_m_d2)\
match_age109m_d2 <- rbind(multi_109m2, control109_m_d2)\
m_age109m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age109m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age109m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full217_d2 <- cbind(match_age109m_d2, r2)\
match_full217_d2 = match_full217_d2[!match_full217_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_109m <- unique_109m[,c(1,2,3,4,5,6,7)]\
match_full217_d3 <-rbind(unique_109m, match_full217_d2)\
match_full217_d3 <- subset(match_full217_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full217_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full217_d3$person_id)]\
\
#females\
case109_f <- subset(case_pop_f, index_age >=6130 & index_age <6180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case109_f)\
control109_f <- subset(control_pop_f,index_age >=6120 & index_age<6190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control109_f)\
match_age109f <- rbind(case109_f, control109_f)\
setDT(match_age109f)\
\
m_age109f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age109f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age109f$factor\
f109 <- as.data.table(r)\
f109$ID2 <- seq.int(nrow(f109))\
\
match_full218 <- cbind(match_age109f, f109)\
match_full218 = match_full218[!match_full218$r== 'NA',]\
\
md_controls109f <- subset(match_full218, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases109f <- subset(match_full218, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases109f[,.N,by=person_id]\
md_controls109f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls218 <-md_controls109f[order(person_id)]\
md_controls218[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_109f <- subset(md_controls218, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_109f <- subset(md_controls218, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_109f2 <- multi_109f[,c(1,2,3,4)]\
multi_109f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full218$person_id)]\
\
##Rematch the used PIDs\
control109_f_d2 <- subset(control_pop_f, index_age >=6120 & index_age<6190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control109_f_d2)\
match_age109f_d2 <- rbind(multi_109f2, control109_f_d2)\
m_age109f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age109f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age109f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full218_d2 <- cbind(match_age109f_d2, r2)\
match_full218_d2 = match_full218_d2[!match_full218_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_109f <- unique_109f[,c(1,2,3,4,5,6,7)]\
match_full218_d3 <-rbind(unique_109f, match_full218_d2)\
match_full218_d3 <- subset(match_full218_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full218_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full218_d3$person_id)]\
\
## 6180-6230 days old\
#males\
\
case110_m <- subset(case_pop_m, index_age >=6180 & index_age <6230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case110_m)\
control110_m <- subset(control_pop_m, index_age >=6170 & index_age<6240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control110_m)\
match_age110m <- rbind(case110_m, control110_m)\
setDT(match_age110m)\
\
m_age110m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age110m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age110m$factor\
m110 <- as.data.table(r)\
m110$ID2 <- seq.int(nrow(m110))\
\
match_full219 <- cbind(match_age110m, m110)\
match_full219 = match_full219[!match_full219$r== 'NA',]\
\
md_controls110m <- subset(match_full219, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases110m <- subset(match_full219, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases110m[,.N,by=person_id]\
md_controls110m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls219 <-md_controls110m[order(person_id)]\
md_controls219[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_110m <- subset(md_controls219, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_110m <- subset(md_controls219, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_110m2 <- multi_110m[,c(1,2,3,4)]\
multi_110m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full219$person_id)]\
\
##Rematch the used PIDs\
control110_m_d2 <- subset(control_pop_m, index_age >=6170 & index_age<6240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control110_m_d2)\
match_age110m_d2 <- rbind(multi_110m2, control110_m_d2)\
m_age110m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age110m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age110m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full219_d2 <- cbind(match_age110m_d2, r2)\
match_full219_d2 = match_full219_d2[!match_full219_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_110m <- unique_110m[,c(1,2,3,4,5,6,7)]\
match_full219_d3 <-rbind(unique_110m, match_full219_d2)\
match_full219_d3 <- subset(match_full219_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full219_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full219_d3$person_id)]\
\
#females\
case110_f <- subset(case_pop_f, index_age >=6180 & index_age <6230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case110_f)\
control110_f <- subset(control_pop_f, index_age >=6170 & index_age<6240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control110_f)\
match_age110f <- rbind(case110_f, control110_f)\
setDT(match_age110f)\
\
m_age110f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age110f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age110f$factor\
f110 <- as.data.table(r)\
f110$ID2 <- seq.int(nrow(f110))\
\
match_full220 <- cbind(match_age110f, f110)\
match_full220 = match_full220[!match_full220$r== 'NA',]\
\
md_controls110f <- subset(match_full220, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases110f <- subset(match_full220, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases110f[,.N,by=person_id]\
md_controls110f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls220 <-md_controls110f[order(person_id)]\
md_controls220[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_110f <- subset(md_controls220, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_110f <- subset(md_controls220, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_110f2 <- multi_110f[,c(1,2,3,4)]\
multi_110f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full220$person_id)]\
\
##Rematch the used PIDs\
control110_f_d2 <- subset(control_pop_f, index_age >=6170 & index_age<6240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control110_f_d2)\
match_age110f_d2 <- rbind(multi_110f2, control110_f_d2)\
m_age110f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age110f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age110f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full220_d2 <- cbind(match_age110f_d2, r2)\
match_full220_d2 = match_full220_d2[!match_full220_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_110f <- unique_110f[,c(1,2,3,4,5,6,7)]\
match_full220_d3 <-rbind(unique_110f, match_full220_d2)\
match_full220_d3 <- subset(match_full220_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full220_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full220_d3$person_id)]\
##combine all matched data: round 22\
\
colnames(match_full211_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls106f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full213_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full214_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full215_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full216_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full217_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full218_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full219_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full220_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_22 <- rbind(match_full211_d3, md_controls106f, match_full213_d3, match_full214_d3, match_full215_d3, match_full216_d3, match_full217_d3, match_full218_d3, match_full219_d3, match_full220_d3)\
setDT(match_total_22)\
match_total_22[,.N,by=person_id]\
write.csv(match_total_22, 'match_total_22.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_22,  c("person_id","num_of_prior_visits"))\
\
mt22_matched_measures3= f[match_total_22]\
mt22_matched_measures4 <- mt22_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt22_matched_measures4)\
\
setkeyv(mt22_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt22_control_conditions= conditions2[mt22_matched_measures4]\
\
mt22_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt22_cont_pre_index <- match_total_22[,c(1,4)]\
mt22_cont_pre_index$pre <- mt22_cont_pre_index[, 2] -1\
mt22_cont_pre_index2 <- mt22_cont_pre_index[,c(1,3)]\
colnames(mt22_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt22_cont_pre_index2)\
setkeyv(mt22_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt22_matched_pre_measures= f[mt22_cont_pre_index2]\
\
mt22_matched_pre_measures2 <- mt22_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt20_matched_pre_measures2)\
\
setkeyv(mt22_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt22_control_conditions_pre= conditions2[mt22_matched_pre_measures2]\
\
mt22_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt22_cont_post_index <- match_total_22[,c(1,4)]\
mt22_cont_post_index$post <- mt22_cont_pre_index[, 2] +1\
mt22_cont_post_index2 <- mt22_cont_post_index[,c(1,3)]\
colnames(mt22_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt22_cont_post_index2)\
setkeyv(mt22_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt22_matched_post_measures= f[mt22_cont_post_index2]\
\
mt22_matched_post_measures2 <- mt22_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt22_matched_post_measures2)\
\
setkeyv(mt22_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt22_control_conditions_post= conditions2[mt22_matched_post_measures2]\
\
mt22_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt22_control_conditions_post= mt22_control_conditions_post[!mt22_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt22_control_conditions_post$Timing_Class = '3'\
mt22_control_conditions_pre$Timing_Class = '1'\
mt22_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_22$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_22$person_id)]\
\
#Combine all clinical observations from the 16th set\
full_con_22 <- rbind(mt22_control_conditions_pre, mt22_control_conditions, mt22_control_conditions_post)\
setDT(full_con_22)\
full_con_22[,.N,by=person_id]\
\
## 6230-6280 days old\
#males\
\
case111_m <- subset(case_pop_m, index_age >=6230 & index_age <6280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case111_m)\
control111_m <- subset(control_pop_m, index_age >=6220 & index_age<6290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control111_m)\
match_age111m <- rbind(case111_m, control111_m)\
setDT(match_age111m)\
\
m_age111m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age111m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age111m$factor\
m111 <- as.data.table(r)\
m111$ID2 <- seq.int(nrow(m111))\
\
match_full221 <- cbind(match_age111m, m111)\
match_full221 = match_full221[!match_full221$r== 'NA',]\
\
md_controls111m <- subset(match_full221, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases111m <- subset(match_full221, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases111m[,.N,by=person_id]\
md_controls111m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls221 <-md_controls111m[order(person_id)]\
md_controls221[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_111m <- subset(md_controls221, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_111m <- subset(md_controls221, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_111m2 <- multi_111m[,c(1,2,3,4)]\
multi_111m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full221$person_id)]\
\
##Rematch the used PIDs\
control111_m_d2 <- subset(control_pop_m, index_age >=6220 & index_age<6290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control111_m_d2)\
match_age111m_d2 <- rbind(multi_111m2, control111_m_d2)\
m_age111m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age111m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age111m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full221_d2 <- cbind(match_age111m_d2, r2)\
match_full221_d2 = match_full221_d2[!match_full221_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_111m <- unique_111m[,c(1,2,3,4,5,6,7)]\
match_full221_d3 <-rbind(unique_111m, match_full221_d2)\
match_full221_d3 <- subset(match_full221_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full221_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full221_d3$person_id)]\
\
#females\
case111_f <- subset(case_pop_f, index_age >=6230 & index_age <6280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case111_f)\
control111_f <- subset(control_pop_f, index_age >=6220 & index_age<6290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control111_f)\
match_age111f <- rbind(case111_f, control111_f)\
setDT(match_age111f)\
\
m_age111f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age111f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age111f$factor\
f111 <- as.data.table(r)\
f111$ID2 <- seq.int(nrow(f111))\
\
match_full222 <- cbind(match_age111f, f111)\
match_full222 = match_full222[!match_full222$r== 'NA',]\
\
md_controls111f <- subset(match_full222, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases111f <- subset(match_full222, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases111f[,.N,by=person_id]\
md_controls111f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls222 <-md_controls111f[order(person_id)]\
md_controls222[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_111f <- subset(md_controls222, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_111f <- subset(md_controls222, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_111f2 <- multi_111f[,c(1,2,3,4)]\
multi_111f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full222$person_id)]\
\
##Rematch the used PIDs\
control111_f_d2 <- subset(control_pop_f, index_age >=6220 & index_age<6290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control111_f_d2)\
match_age111f_d2 <- rbind(multi_111f2, control111_f_d2)\
m_age111f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age111f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age111f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full222_d2 <- cbind(match_age111f_d2, r2)\
match_full222_d2 = match_full222_d2[!match_full222_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_111f <- unique_111f[,c(1,2,3,4,5,6,7)]\
match_full222_d3 <-rbind(unique_111f, match_full222_d2)\
match_full222_d3 <- subset(match_full222_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full222_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full222_d3$person_id)]\
\
#6280-6330 days old\
#males\
\
case112_m <- subset(case_pop_m, index_age >=6280 & index_age <6330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case112_m)\
control112_m <- subset(control_pop_m, index_age >=6270 & index_age<6340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control112_m)\
match_age112m <- rbind(case112_m, control112_m)\
setDT(match_age112m)\
\
m_age112m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age112m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age112m$factor\
m112 <- as.data.table(r)\
m112$ID2 <- seq.int(nrow(m112))\
\
match_full223 <- cbind(match_age112m, m112)\
match_full223 = match_full223[!match_full223$r== 'NA',]\
\
md_controls112m <- subset(match_full223, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases112m <- subset(match_full223, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases112m[,.N,by=person_id]\
md_controls112m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls223 <-md_controls112m[order(person_id)]\
md_controls223[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_112m <- subset(md_controls223, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_112m <- subset(md_controls223, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_112m2 <- multi_112m[,c(1,2,3,4)]\
multi_112m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full223$person_id)]\
\
##Rematch the used PIDs\
control112_m_d2 <- subset(control_pop_m, index_age >=6220 & index_age<6290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control112_m_d2)\
match_age112m_d2 <- rbind(multi_112m2, control112_m_d2)\
m_age112m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age112m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age112m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full223_d2 <- cbind(match_age112m_d2, r2)\
match_full223_d2 = match_full223_d2[!match_full223_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_112m <- unique_112m[,c(1,2,3,4,5,6,7)]\
match_full223_d3 <-rbind(unique_112m, match_full223_d2)\
match_full223_d3 <- subset(match_full223_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full223_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full223_d3$person_id)]\
\
#females\
case112_f <- subset(case_pop_f, index_age >=6280 & index_age <6330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case112_f)\
control112_f <- subset(control_pop_f, index_age >=6270 & index_age<6340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control112_f)\
match_age112f <- rbind(case112_f, control112_f)\
setDT(match_age112f)\
\
m_age112f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age112f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age112f$factor\
f112 <- as.data.table(r)\
f112$ID2 <- seq.int(nrow(f112))\
\
match_full224 <- cbind(match_age112f, f112)\
match_full224 = match_full224[!match_full224$r== 'NA',]\
\
md_controls112f <- subset(match_full224, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases112f <- subset(match_full224, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases112f[,.N,by=person_id]\
md_controls112f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls224 <-md_controls112f[order(person_id)]\
md_controls224[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_112f <- subset(md_controls224, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_112f <- subset(md_controls224, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_112f2 <- multi_112f[,c(1,2,3,4)]\
multi_112f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full224$person_id)]\
\
##Rematch the used PIDs\
control112_f_d2 <- subset(control_pop_f, index_age >=6270 & index_age<6340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control112_f_d2)\
match_age112f_d2 <- rbind(multi_112f2, control112_f_d2)\
m_age112f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age112f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age112f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full224_d2 <- cbind(match_age112f_d2, r2)\
match_full224_d2 = match_full224_d2[!match_full224_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_112f <- unique_112f[,c(1,2,3,4,5,6,7)]\
match_full224_d3 <-rbind(unique_112f, match_full224_d2)\
match_full224_d3 <- subset(match_full224_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full224_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full224_d3$person_id)]\
\
#6330-6380 days old\
#males\
\
case113_m <- subset(case_pop_m, index_age >=6330 & index_age <6380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case113_m)\
control113_m <- subset(control_pop_m, index_age >=6320 & index_age<6390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control113_m)\
match_age113m <- rbind(case113_m, control113_m)\
setDT(match_age113m)\
\
m_age113m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age113m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age113m$factor\
m113 <- as.data.table(r)\
m113$ID2 <- seq.int(nrow(m113))\
\
match_full225 <- cbind(match_age113m, m113)\
match_full225 = match_full225[!match_full225$r== 'NA',]\
\
md_controls113m <- subset(match_full225, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases113m <- subset(match_full225, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases113m[,.N,by=person_id]\
md_controls113m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls225 <-md_controls113m[order(person_id)]\
md_controls225[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_113m <- subset(md_controls225, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_113m <- subset(md_controls225, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_113m2 <- multi_113m[,c(1,2,3,4)]\
multi_113m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full225$person_id)]\
\
##Rematch the used PIDs\
control113_m_d2 <- subset(control_pop_m, index_age >=6320 & index_age<6390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control113_m_d2)\
match_age113m_d2 <- rbind(multi_113m2, control113_m_d2)\
m_age113m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age113m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age113m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full225_d2 <- cbind(match_age113m_d2, r2)\
match_full225_d2 = match_full225_d2[!match_full225_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_113m <- unique_113m[,c(1,2,3,4,5,6,7)]\
match_full225_d3 <-rbind(unique_113m, match_full225_d2)\
match_full225_d3 <- subset(match_full225_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full225_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full225_d3$person_id)]\
\
#females\
case113_f <- subset(case_pop_f, index_age >=6330 & index_age <6380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case113_f)\
control113_f <- subset(control_pop_f, index_age >=6320 & index_age<6390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control113_f)\
match_age113f <- rbind(case113_f, control113_f)\
setDT(match_age113f)\
\
m_age113f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age113f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age113f$factor\
f113 <- as.data.table(r)\
f113$ID2 <- seq.int(nrow(f113))\
\
match_full226 <- cbind(match_age113f, f113)\
match_full226 = match_full226[!match_full226$r== 'NA',]\
\
md_controls113f <- subset(match_full226, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases113f <- subset(match_full226, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases113f[,.N,by=person_id]\
md_controls113f[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% md_controls113f$person_id)]\
\
#6380-6430 days old\
#males\
\
case114_m <- subset(case_pop_m, index_age >=6380 & index_age <6430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case114_m)\
control114_m <- subset(control_pop_m, index_age >=6370 & index_age<6440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control114_m)\
match_age114m <- rbind(case114_m, control114_m)\
setDT(match_age114m)\
\
m_age114m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age114m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age114m$factor\
m114 <- as.data.table(r)\
m114$ID2 <- seq.int(nrow(m114))\
\
match_full227 <- cbind(match_age114m, m114)\
match_full227 = match_full227[!match_full227$r== 'NA',]\
\
md_controls114m <- subset(match_full227, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases114m <- subset(match_full227, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases114m[,.N,by=person_id]\
md_controls114m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls114m$person_id)]\
\
#females\
case114_f <- subset(case_pop_f, index_age >=6380 & index_age <6430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case114_f)\
control114_f <- subset(control_pop_f, index_age >=6370 & index_age<6440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control114_f)\
match_age114f <- rbind(case114_f, control114_f)\
setDT(match_age114f)\
\
m_age114f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age114f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age114f$factor\
f114 <- as.data.table(r)\
f114$ID2 <- seq.int(nrow(f114))\
\
match_full228 <- cbind(match_age114f, f114)\
match_full228 = match_full228[!match_full228$r== 'NA',]\
\
md_controls114f <- subset(match_full228, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases114f <- subset(match_full228, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases114f[,.N,by=person_id]\
md_controls114f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls228 <-md_controls114f[order(person_id)]\
md_controls228[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_114f <- subset(md_controls228, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_114f <- subset(md_controls228, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_114f2 <- multi_114f[,c(1,2,3,4)]\
multi_114f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full228$person_id)]\
\
##Rematch the used PIDs\
control114_f_d2 <- subset(control_pop_f, index_age >=6370 & index_age<6440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control114_f_d2)\
match_age114f_d2 <- rbind(multi_114f2, control114_f_d2)\
m_age114f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age114f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age114f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full228_d2 <- cbind(match_age114f_d2, r2)\
match_full228_d2 = match_full228_d2[!match_full228_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_114f <- unique_114f[,c(1,2,3,4,5,6,7)]\
match_full228_d3 <-rbind(unique_114f, match_full228_d2)\
match_full228_d3 <- subset(match_full228_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full228_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full228_d3$person_id)]\
\
#6430-6480 days old\
#males\
\
case115_m <- subset(case_pop_m, index_age >=6430 & index_age <6480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case115_m)\
control115_m <- subset(control_pop_m, index_age >=6420 & index_age<6490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control115_m)\
match_age115m <- rbind(case115_m, control115_m)\
setDT(match_age115m)\
\
m_age115m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age115m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age115m$factor\
m115 <- as.data.table(r)\
m115$ID2 <- seq.int(nrow(m115))\
\
match_full229 <- cbind(match_age115m, m115)\
match_full229 = match_full229[!match_full229$r== 'NA',]\
\
md_controls115m <- subset(match_full229, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases115m <- subset(match_full229, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases115m[,.N,by=person_id]\
md_controls115m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls229 <-md_controls115m[order(person_id)]\
md_controls229[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_115m <- subset(md_controls229, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_115m <- subset(md_controls229, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_115m2 <- multi_115m[,c(1,2,3,4)]\
multi_115m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full229$person_id)]\
\
##Rematch the used PIDs\
control115_m_d2 <- subset(control_pop_m, index_age >=6420 & index_age<6490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control115_m_d2)\
match_age115m_d2 <- rbind(multi_115m2, control115_m_d2)\
m_age115m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age115m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age115m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full229_d2 <- cbind(match_age115m_d2, r2)\
match_full229_d2 = match_full229_d2[!match_full229_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_115m <- unique_115m[,c(1,2,3,4,5,6,7)]\
match_full229_d3 <-rbind(unique_115m, match_full229_d2)\
match_full229_d3 <- subset(match_full229_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full229_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full229_d3$person_id)]\
\
#females\
case115_f <- subset(case_pop_f, index_age >=6430 & index_age <6480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case115_f)\
control115_f <- subset(control_pop_f, index_age >=6420 & index_age<6490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control115_f)\
match_age115f <- rbind(case115_f, control115_f)\
setDT(match_age115f)\
\
m_age115f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age115f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age115f$factor\
f115 <- as.data.table(r)\
f115$ID2 <- seq.int(nrow(f115))\
\
match_full230 <- cbind(match_age115f, f115)\
match_full230 = match_full230[!match_full230$r== 'NA',]\
\
md_controls115f <- subset(match_full230, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases115f <- subset(match_full230, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases115f[,.N,by=person_id]\
md_controls115f[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% md_controls115f$person_id)]\
\
#6480-6530 days old\
#males\
\
case116_m <- subset(case_pop_m, index_age >=6480 & index_age <6530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case116_m)\
control116_m <- subset(control_pop_m, index_age >=6470 & index_age<6540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control116_m)\
match_age116m <- rbind(case116_m, control116_m)\
setDT(match_age116m)\
\
m_age116m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age116m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age116m$factor\
m116 <- as.data.table(r)\
m116$ID2 <- seq.int(nrow(m116))\
\
match_full231 <- cbind(match_age116m, m116)\
match_full231 = match_full231[!match_full231$r== 'NA',]\
\
md_controls116m <- subset(match_full231, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases116m <- subset(match_full231, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases116m[,.N,by=person_id]\
md_controls116m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls116m$person_id)]\
\
#females\
case116_f <- subset(case_pop_f, index_age >=6480 & index_age <6530, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case116_f)\
control116_f <- subset(control_pop_f, index_age >=6470 & index_age<6540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control116_f)\
match_age116f <- rbind(case116_f, control116_f)\
setDT(match_age116f)\
\
m_age116f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age116f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age116f$factor\
f116 <- as.data.table(r)\
f116$ID2 <- seq.int(nrow(f116))\
\
match_full232 <- cbind(match_age116f, f116)\
match_full232 = match_full232[!match_full232$r== 'NA',]\
\
md_controls116f <- subset(match_full232, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases116f <- subset(match_full232, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases116f[,.N,by=person_id]\
md_controls116f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls232 <-md_controls116f[order(person_id)]\
md_controls232[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_116f <- subset(md_controls232, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_116f <- subset(md_controls232, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_116f2 <- multi_116f[,c(1,2,3,4)]\
multi_116f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full232$person_id)]\
\
##Rematch the used PIDs\
control116_f_d2 <- subset(control_pop_f, index_age >=6470 & index_age<6540, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control116_f_d2)\
match_age116f_d2 <- rbind(multi_116f2, control116_f_d2)\
m_age116f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age116f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age116f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full232_d2 <- cbind(match_age116f_d2, r2)\
match_full232_d2 = match_full232_d2[!match_full232_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_116f <- unique_116f[,c(1,2,3,4,5,6,7)]\
match_full232_d3 <-rbind(unique_116f, match_full232_d2)\
match_full232_d3 <- subset(match_full232_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full232_d3[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full232_d3$person_id)]\
\
#6530-6580 days old\
#males\
\
case117_m <- subset(case_pop_m, index_age >=6530 & index_age <6580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case117_m)\
control117_m <- subset(control_pop_m, index_age >=6520 & index_age<6590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control117_m)\
match_age117m <- rbind(case117_m, control117_m)\
setDT(match_age117m)\
\
m_age117m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age117m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age117m$factor\
m117 <- as.data.table(r)\
m117$ID2 <- seq.int(nrow(m117))\
\
match_full233 <- cbind(match_age117m, m117)\
match_full233 = match_full233[!match_full233$r== 'NA',]\
\
md_controls117m <- subset(match_full233, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases117m <- subset(match_full233, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases117m[,.N,by=person_id]\
md_controls117m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls117m$person_id)]\
\
#females\
\
case117_f <- subset(case_pop_f, index_age >=6530 & index_age <6580, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case117_f)\
control117_f <- subset(control_pop_f, index_age >=6520 & index_age<6590, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control117_f)\
match_age117f <- rbind(case117_f, control117_f)\
setDT(match_age117f)\
\
m_age117f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age117f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age117f$factor\
f117 <- as.data.table(r)\
f117$ID2 <- seq.int(nrow(f117))\
\
match_full234 <- cbind(match_age117f, f117)\
match_full234 = match_full234[!match_full234$r== 'NA',]\
\
md_controls117f <- subset(match_full234, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases117f <- subset(match_full234, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases117f[,.N,by=person_id]\
md_controls117f[,.N,by=person_id]\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% md_controls117f$person_id)]\
\
##combine all matched data: round 23\
\
colnames(match_full221_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full222_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full223_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full224_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full225_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls113f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls114m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full228_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full229_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls115f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls116m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full232_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls117m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls117f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_23 <- rbind(match_full221_d3, match_full222_d3, match_full223_d3, match_full224_d3, match_full225_d3, md_controls113f, md_controls114m, match_full228_d3, match_full229_d3, md_controls115f, md_controls116m, match_full232_d3, md_controls117m, md_controls117f)\
setDT(match_total_23)\
match_total_23[,.N,by=person_id]\
write.csv(match_total_23, 'match_total_23.csv')\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_23,  c("person_id","num_of_prior_visits"))\
\
mt23_matched_measures3= f[match_total_23]\
mt23_matched_measures4 <- mt23_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt23_matched_measures4)\
\
setkeyv(mt23_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt23_control_conditions= conditions2[mt23_matched_measures4]\
\
mt23_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt23_cont_pre_index <- match_total_23[,c(1,4)]\
mt23_cont_pre_index$pre <- mt23_cont_pre_index[, 2] -1\
mt23_cont_pre_index2 <- mt23_cont_pre_index[,c(1,3)]\
colnames(mt23_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt23_cont_pre_index2)\
setkeyv(mt23_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt23_matched_pre_measures= f[mt23_cont_pre_index2]\
\
mt23_matched_pre_measures2 <- mt23_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt23_matched_pre_measures2)\
\
setkeyv(mt23_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt23_control_conditions_pre= conditions2[mt23_matched_pre_measures2]\
\
mt23_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt23_cont_post_index <- match_total_23[,c(1,4)]\
mt23_cont_post_index$post <- mt23_cont_pre_index[, 2] +1\
mt23_cont_post_index2 <- mt23_cont_post_index[,c(1,3)]\
colnames(mt23_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt23_cont_post_index2)\
setkeyv(mt23_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt23_matched_post_measures= f[mt23_cont_post_index2]\
\
mt23_matched_post_measures2 <- mt23_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt23_matched_post_measures2)\
\
setkeyv(mt23_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt23_control_conditions_post= conditions2[mt23_matched_post_measures2]\
\
mt23_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt23_control_conditions_post= mt23_control_conditions_post[!mt23_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt23_control_conditions_post$Timing_Class = '3'\
mt23_control_conditions_pre$Timing_Class = '1'\
mt23_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_23$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_23$person_id)]\
\
#Combine all clinical observations from the 16th set\
full_con_23 <- rbind(mt23_control_conditions_pre, mt23_control_conditions, mt23_control_conditions_post)\
setDT(full_con_23)\
full_con_23[,.N,by=person_id]\
\
##Rbind conditions from the last 3 sets\
\
full_set_3 <- rbind(full_con_21, full_con_22, full_con_23)\
setDT(full_set_3)\
full_set_3[,.N,by=person_id]\
\
full[,.N,by=person_id]\
##Rbind all observations\
\
full_total <- rbind(full, full_set_3)\
setDT(full_total)\
full_total [,.N,by=person_id]\
\
write.csv(full_total, 'full_total.csv')\
\
mcf <- subset(full_total, Timing_Class== '1')\
matched_controls_final <- mcf[,c(1,6,8,9)]\
matched_controls_final2 <- matched_controls_final[!duplicated(matched_controls_final), ]\
View(matched_controls_final2)\
\
matched_controls_final2[,.N,by=person_id]\
mcf[,.N,by=person_id]\
\
##\
matched_controls_gender<- mcf[,c(1,6)]\
matched_controls_gender <- matched_controls_gender[!duplicated(matched_controls_gender), ]\
\
mc_m  = matched_controls_gender[!matched_controls_gender$gender== 8532,]\
mc_f = matched_controls_gender[!matched_controls_gender$gender== 8507,]\
\
full_g <- full[,c(1,6)]\
full_g <- full_g[!duplicated(full_g), ]\
full_m  = full_g[!full_g$gender== 8532,]\
full_f = full_g[!full_g$gender== 8507,]\
\
part1_m <- subset(case_pop_m, index_age < 5730, select=c(person_id, gender))\
part1_f <- subset(case_pop_f, index_age < 5730, select=c(person_id, gender))\
\
## Data cleaning to resolve mistakes\
##Incorrect matching of gender in Match Total 10\
\
matched_controls = read.csv('~/full_total.csv')\
match_total10 = read.csv('~/match_total_10.csv')\
setDT(match_total10)\
match_total10[,.N,by=(gender=='8532')]\
\
case10_m <- subset(case_pop_m, index_age >=2980 & index_age <3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
case10_f <- subset(case_pop_f, index_age >=2980 & index_age <3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
View(case10_m)\
View(case10_f)\
\
setDT(matched_controls)\
setDT(mc2)\
mc2 <- matched_controls[!(person_id %in% match_total10$person_id)]\
mc2[,.N,by=person_id]\
match_total10[,.N,by=person_id]\
matched_controls[,.N,by=person_id]\
\
cpf2 <- case_pop_f[!(person_id %in% case10_f$person_id)]\
cpm2 <- case_pop_m[!(person_id %in% case10_m$person_id)]\
\
\
match10_conditions <- matched_controls[(person_id %in% match_total10$person_id)]\
\
control_pop_f <- control_pop_f[!(person_id %in% mc2$person_id)]\
control_pop_m <- control_pop_m[!(person_id %in% mc2$person_id)]\
\
\
\
## 2980-3030 days old\
#males\
\
case46_m <- subset(case_pop_m, index_age >=2980 & index_age <3030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case46_m)\
control46_m <- subset(control_pop_m, index_age >=2970 & index_age<3040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control46_m)\
match_age46m <- rbind(case46_m, control46_m)\
setDT(match_age46m)\
\
m_age46m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age46m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age46m$factor\
m46 <- as.data.table(r)\
m46$ID2 <- seq.int(nrow(m46))\
\
match_full91 <- cbind(match_age46m, m46)\
match_full91 = match_full91[!match_full91$r== 'NA',]\
\
md_controls46m <- subset(match_full91, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases46m <- subset(match_full91, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases46m[,.N,by=person_id]\
md_controls46m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls91 <-md_controls46m[order(person_id)]\
md_controls91[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_46m <- subset(md_controls91, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_46m <- subset(md_controls91, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_46m2 <- multi_46m[,c(1,2,3,4)]\
multi_46m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full91$person_id)]\
\
##Rematch the used PIDs\
\
control46_m_d2 <- subset(control_pop_m, index_age >=2970 & index_age<3040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control46_m_d2)\
match_age46m_d2 <- rbind(multi_46m2, control46_m_d2)\
m_age46m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age46m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age46m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full91_d2 <- cbind(match_age46m_d2, r2)\
match_full91_d2 = match_full91_d2[!match_full91_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_46m <- unique_46m[,c(1,2,3,4,5,6,7)]\
match_full91_d3 <-rbind(unique_46m, match_full91_d2)\
match_full91_d3 <- subset(match_full91_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full91_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full91_d3$person_id)]\
\
#females\
case46_f <- subset(case_pop_f, index_age >=2980 & index_age < 3030, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case46_f)\
control46_f <- subset(control_pop_f, index_age >=2970 & index_age<3040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control46_f)\
match_age46f <- rbind(case46_f, control46_f)\
setDT(match_age46f)\
\
m_age46f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age46f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age46f$factor\
f46 <- as.data.table(r)\
f46$ID2 <- seq.int(nrow(f46))\
\
match_full92 <- cbind(match_age46f, f46)\
match_full92 = match_full92[!match_full92$r== 'NA',]\
\
md_controls46f <- subset(match_full92, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases46f <- subset(match_full92, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases46f[,.N,by=person_id]\
md_controls46f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls92 <-md_controls46f[order(person_id)]\
md_controls92[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_46f <- subset(md_controls92, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_46f <- subset(md_controls92, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_46f2 <- multi_46f[,c(1,2,3,4)]\
multi_46f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full92$person_id)]\
\
##Rematch the used PIDs\
\
control46_f_d2 <- subset(control_pop_f, index_age >=2970 & index_age<3040, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control46_f_d2)\
match_age46f_d2 <- rbind(multi_46f2, control46_f_d2)\
m_age46f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age46f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age46f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full92_d2 <- cbind(match_age46f_d2, r2)\
match_full92_d2 = match_full92_d2[!match_full92_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_46f <- unique_46f[,c(1,2,3,4,5,6,7)]\
match_full92_d3 <-rbind(unique_46f, match_full92_d2)\
match_full92_d3 <- subset(match_full92_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full92_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full92_d3$person_id)]\
\
## 3030-3080 days old\
#males\
\
case47_m <- subset(case_pop_m, index_age >=3030 & index_age <3080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case47_m)\
control47_m <- subset(control_pop_m, index_age >=3020 & index_age<3090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control47_m)\
match_age47m <- rbind(case47_m, control47_m)\
setDT(match_age47m)\
\
m_age47m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age47m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age47m$factor\
m47 <- as.data.table(r)\
m47$ID2 <- seq.int(nrow(m47))\
\
match_full93 <- cbind(match_age47m, m47)\
match_full93 = match_full93[!match_full93$r== 'NA',]\
\
md_controls47m <- subset(match_full93, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases47m <- subset(match_full93, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases47m[,.N,by=person_id]\
md_controls47m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls93 <-md_controls47m[order(person_id)]\
md_controls93[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_47m <- subset(md_controls93, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_47m <- subset(md_controls93, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_47m2 <- multi_47m[,c(1,2,3,4)]\
multi_47m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full93$person_id)]\
\
##Rematch the used PIDs\
\
control47_m_d2 <- subset(control_pop_m, index_age >=3020 & index_age<3090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control47_m_d2)\
match_age47m_d2 <- rbind(multi_47m2, control47_m_d2)\
m_age47m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age47m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age47m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full93_d2 <- cbind(match_age47m_d2, r2)\
match_full93_d2 = match_full93_d2[!match_full93_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_47m <- unique_47m[,c(1,2,3,4,5,6,7)]\
match_full93_d3 <-rbind(unique_47m, match_full93_d2)\
match_full93_d3 <- subset(match_full93_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full93_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full93_d3$person_id)]\
\
#females\
case47_f <- subset(case_pop_f, index_age >=3030 & index_age < 3080, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case47_f)\
control47_f <- subset(control_pop_f, index_age >=3020 & index_age<3090, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control47_f)\
match_age47f <- rbind(case47_f, control47_f)\
setDT(match_age47f)\
\
m_age47f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age47f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age47f$factor\
f47 <- as.data.table(r)\
f47$ID2 <- seq.int(nrow(f47))\
\
match_full94 <- cbind(match_age47f, f47)\
match_full94 = match_full94[!match_full94$r== 'NA',]\
\
md_controls47f <- subset(match_full94, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases47f <- subset(match_full94, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases47f[,.N,by=person_id]\
md_controls47f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls47f$person_id)]\
\
## 3080-3130 days old\
#males\
\
case48_m <- subset(case_pop_m, index_age >=3080 & index_age <3130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case48_m)\
control48_m <- subset(control_pop_m, index_age >=3070 & index_age<3140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control48_m)\
match_age48m <- rbind(case48_m, control48_m)\
setDT(match_age48m)\
\
m_age48m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age48m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age48m$factor\
m48 <- as.data.table(r)\
m48$ID2 <- seq.int(nrow(m48))\
\
match_full95 <- cbind(match_age48m, m48)\
match_full95 = match_full95[!match_full95$r== 'NA',]\
\
md_controls48m <- subset(match_full95, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases48m <- subset(match_full95, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases48m[,.N,by=person_id]\
md_controls48m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls48m$person_id)]\
\
\
#females\
case48_f <- subset(case_pop_f, index_age >=3080 & index_age < 3130, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case48_f)\
control48_f <- subset(control_pop_f, index_age >=3070 & index_age<3140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control48_f)\
match_age48f <- rbind(case48_f, control48_f)\
setDT(match_age48f)\
\
m_age48f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age48f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age48f$factor\
f48 <- as.data.table(r)\
f48$ID2 <- seq.int(nrow(f48))\
\
match_full96 <- cbind(match_age48f, f48)\
match_full96 = match_full96[!match_full96$r== 'NA',]\
\
md_controls48f <- subset(match_full96, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases48f <- subset(match_full96, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases48f[,.N,by=person_id]\
md_controls48f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls96 <-md_controls48f[order(person_id)]\
md_controls96[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_48f <- subset(md_controls96, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_48f <- subset(md_controls96, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_48f2 <- multi_48f[,c(1,2,3,4)]\
multi_48f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full96$person_id)]\
\
##Rematch the used PIDs\
\
control48_f_d2 <- subset(control_pop_f, index_age >=3070 & index_age<3140, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control48_f_d2)\
match_age48f_d2 <- rbind(multi_48f2, control48_f_d2)\
m_age48f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age48f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age48f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full96_d2 <- cbind(match_age48f_d2, r2)\
match_full96_d2 = match_full96_d2[!match_full96_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_48f <- unique_48f[,c(1,2,3,4,5,6,7)]\
match_full96_d3 <-rbind(unique_48f, match_full96_d2)\
match_full96_d3 <- subset(match_full96_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full96_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full96_d3$person_id)]\
\
## 3130-3180 days old\
#males\
\
case49_m <- subset(case_pop_m, index_age >=3130 & index_age <3180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case49_m)\
control49_m <- subset(control_pop_m, index_age >=3120 & index_age<3190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control49_m)\
match_age49m <- rbind(case49_m, control49_m)\
setDT(match_age49m)\
\
m_age49m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age49m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age49m$factor\
m49 <- as.data.table(r)\
m49$ID2 <- seq.int(nrow(m49))\
\
match_full97 <- cbind(match_age49m, m49)\
match_full97 = match_full97[!match_full97$r== 'NA',]\
\
md_controls49m <- subset(match_full97, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases49m <- subset(match_full97, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases49m[,.N,by=person_id]\
md_controls49m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls49m$person_id)]\
\
#Count the number of times each person ID was used\
md_controls97 <-md_controls49m[order(person_id)]\
md_controls97[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_49m <- subset(md_controls97, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_49m <- subset(md_controls97, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_49m2 <- multi_49m[,c(1,2,3,4)]\
multi_49m2$casecont = 'case'\
\
##Rematch the used PIDs\
\
control49_m_d2 <- subset(control_pop_m, index_age >=3120 & index_age<3190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control49_m_d2)\
match_age49m_d2 <- rbind(multi_49m2, control49_m_d2)\
m_age49m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age49m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age49m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full97_d2 <- cbind(match_age49m_d2, r2)\
match_full97_d2 = match_full97_d2[!match_full97_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_49m <- unique_49m[,c(1,2,3,4,5,6,7)]\
match_full97_d3 <-rbind(unique_49m, match_full97_d2)\
match_full97_d3 <- subset(match_full97_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full97_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full97_d3$person_id)]\
\
View(match_full97_d3)\
\
#females\
case49_f <- subset(case_pop_f, index_age >=3130 & index_age < 3180, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case49_f)\
control49_f <- subset(control_pop_f, index_age >=3120 & index_age<3190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control49_f)\
match_age49f <- rbind(case49_f, control49_f)\
setDT(match_age49f)\
\
m_age49f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age49f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age49f$factor\
f49 <- as.data.table(r)\
f49$ID2 <- seq.int(nrow(f49))\
\
match_full98 <- cbind(match_age49f, f49)\
match_full98 = match_full98[!match_full98$r== 'NA',]\
\
md_controls49f <- subset(match_full98, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases49f <- subset(match_full98, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases49f[,.N,by=person_id]\
md_controls49f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls98 <-md_controls49f[order(person_id)]\
md_controls98[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_49f <- subset(md_controls98, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_49f <- subset(md_controls98, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_49f2 <- multi_49f[,c(1,2,3,4)]\
multi_49f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full98$person_id)]\
\
##Rematch the used PIDs\
\
control49_f_d2 <- subset(control_pop_f, index_age >=3120 & index_age<3190, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control49_f_d2)\
match_age49f_d2 <- rbind(multi_49f2, control49_f_d2)\
m_age49f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age49f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age49f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full98_d2 <- cbind(match_age49f_d2, r2)\
match_full98_d2 = match_full98_d2[!match_full98_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_49f <- unique_49f[,c(1,2,3,4,5,6,7)]\
match_full98_d3 <-rbind(unique_49f, match_full98_d2)\
match_full98_d3 <- subset(match_full98_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full98_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full98_d3$person_id)]\
\
## 3180-3230 days old\
#males\
\
case50_m <- subset(case_pop_m, index_age >=3180 & index_age <3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case50_m)\
control50_m <- subset(control_pop_m, index_age >=3170 & index_age<3240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control50_m)\
match_age50m <- rbind(case50_m, control50_m)\
setDT(match_age50m)\
\
m_age50m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age50m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age50m$factor\
m50 <- as.data.table(r)\
m50$ID2 <- seq.int(nrow(m50))\
\
match_full99 <- cbind(match_age50m, m50)\
match_full99 = match_full99[!match_full99$r== 'NA',]\
\
md_controls50m <- subset(match_full99, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases50m <- subset(match_full99, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases50m[,.N,by=person_id]\
md_controls50m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% md_controls50m$person_id)]\
\
#Count the number of times each person ID was used\
md_controls99 <-md_controls50m[order(person_id)]\
md_controls99[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_50m <- subset(md_controls99, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_50m <- subset(md_controls99, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_50m2 <- multi_50m[,c(1,2,3,4)]\
multi_50m2$casecont = 'case'\
\
##Rematch the used PIDs\
\
control50_m_d2 <- subset(control_pop_m, index_age >=3170 & index_age<3240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control50_m_d2)\
match_age50m_d2 <- rbind(multi_50m2, control50_m_d2)\
m_age50m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age50m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age50m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full99_d2 <- cbind(match_age50m_d2, r2)\
match_full99_d2 = match_full99_d2[!match_full99_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_50m <- unique_50m[,c(1,2,3,4,5,6,7)]\
match_full99_d3 <-rbind(unique_50m, match_full99_d2)\
match_full99_d3 <- subset(match_full99_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full99_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full99_d3$person_id)]\
\
View(match_full99_d3)\
\
\
#females\
case50_f <- subset(case_pop_f, index_age >=3180 & index_age < 3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case50_f)\
control50_f <- subset(control_pop_f, index_age >=3170 & index_age<3240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control50_f)\
match_age50f <- rbind(case50_f, control50_f)\
setDT(match_age50f)\
\
m_age50f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age50f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age50f$factor\
f50 <- as.data.table(r)\
f50$ID2 <- seq.int(nrow(f50))\
\
match_full100 <- cbind(match_age50f, f50)\
match_full100 = match_full100[!match_full100$r== 'NA',]\
\
md_controls50f <- subset(match_full100, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases50f <- subset(match_full100, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases50f[,.N,by=person_id]\
md_controls50f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls100 <-md_controls50f[order(person_id)]\
md_controls100[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_50f <- subset(md_controls100, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_50f <- subset(md_controls100, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_50f2 <- multi_50f[,c(1,2,3,4)]\
multi_50f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full100$person_id)]\
\
##Rematch the used PIDs\
\
control50_f_d2 <- subset(control_pop_f, index_age >=3170 & index_age<3240, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control50_f_d2)\
match_age50f_d2 <- rbind(multi_50f2, control50_f_d2)\
m_age50f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age50f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age50f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full100_d2 <- cbind(match_age50f_d2, r2)\
match_full100_d2 = match_full100_d2[!match_full100_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_50f <- unique_50f[,c(1,2,3,4,5,6,7)]\
match_full100_d3 <-rbind(unique_50f, match_full100_d2)\
match_full100_d3 <- subset(match_full100_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full100_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full100_d3$person_id)]\
\
##combine all matched data: round 10\
\
colnames(match_full91_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full92_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full93_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls47f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls48m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full96_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full97_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full98_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full99_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full100_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_10 <- rbind(match_full91_d3, match_full92_d3, match_full93_d3, md_controls47f, md_controls48m, match_full96_d3, match_full97_d3, match_full98_d3, match_full99_d3, match_full100_d3)\
setDT(match_total_10)\
\
match_total_10[,.N,by=person_id]\
\
match_total_10[,.N,by=(gender=='8532')]\
\
case10_m <- subset(case_pop_m, index_age >=2980 & index_age <3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
case10_f <- subset(case_pop_f, index_age >=2980 & index_age <3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
View(case10_m)\
View(case10_f)\
\
write.csv(match_total_10, '2match_total_10.csv')\
setDT(match_total_10)\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_10,  c("person_id","num_of_prior_visits"))\
\
mt10_matched_measures3= f[match_total_10]\
mt10_matched_measures4 <- mt10_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt10_matched_measures4)\
\
setkeyv(mt10_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt10_control_conditions= conditions2[mt10_matched_measures4]\
\
mt10_control_conditions[,.N,by=person_id]\
mt10_control_conditions[,.N,by=(gender_concept_id=='8532')]\
\
## Work on obtaining the pre- and post-indec visits for the matched controls\
#Pre index\
mt10_cont_pre_index <- match_total_10[,c(1,4)]\
mt10_cont_pre_index$pre <- mt10_cont_pre_index[, 2] -1\
mt10_cont_pre_index2 <- mt10_cont_pre_index[,c(1,3)]\
colnames(mt10_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt10_cont_pre_index2)\
setkeyv(mt10_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt10_matched_pre_measures= f[mt10_cont_pre_index2]\
\
mt10_matched_pre_measures2 <- mt10_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt10_matched_pre_measures2)\
\
setkeyv(mt10_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt10_control_conditions_pre= conditions2[mt10_matched_pre_measures2]\
\
mt10_control_conditions_pre[,.N,by=person_id]\
mt10_control_conditions_pre[,.N,by=(gender_concept_id=='8532')]\
\
#Post index\
mt10_cont_post_index <- match_total_10[,c(1,4)]\
mt10_cont_post_index$post <- mt10_cont_pre_index[, 2] +1\
mt10_cont_post_index2 <- mt10_cont_post_index[,c(1,3)]\
colnames(mt10_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt10_cont_post_index2)\
setkeyv(mt10_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt10_matched_post_measures= f[mt10_cont_post_index2]\
\
mt10_matched_post_measures2 <- mt10_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt10_matched_post_measures2)\
\
setkeyv(mt10_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt10_control_conditions_post= conditions2[mt10_matched_post_measures2]\
\
mt10_control_conditions_post[,.N,by=person_id]\
mt10_control_conditions_post[,.N,by=(gender_concept_id=='8532')]\
##Eliminate patients who did not have a post-index visit\
mt10_control_conditions_post= mt10_control_conditions_post[!mt10_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt10_control_conditions_post$Timing_Class = '3'\
mt10_control_conditions_pre$Timing_Class = '1'\
mt10_control_conditions$Timing_Class = '2'\
\
#Double check that I have eliminated controls already matched from full control pool\
\
control_pop_m <- control_pop_m[!(person_id %in% match_total_10$person_id)]\
control_pop_f <- control_pop_f[!(person_id %in% match_total_10$person_id)]\
\
#Combine all clinical observations from the 10th set\
full_con_10 <- rbind(mt10_control_conditions_pre, mt10_control_conditions, mt10_control_conditions_post)\
setDT(full_con_10)\
full_con_10[,.N,by=person_id]\
\
full_con_10[,.N,by=(gender_concept_id=='8532')]\
\
match_total_10[,.N,by=(gender=='8532')]\
\
case10_m <- subset(case_pop_m, index_age >=2980 & index_age <3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
case10_f <- subset(case_pop_f, index_age >=2980 & index_age <3230, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
View(case10_m)\
View(case10_f)\
mc2 <- mc2[,c(2,3,4,5,6,7,8,9,10,11)]\
full_con_10 <- full_con_10[,c(1,2,3,4,5,6,7,8,9,11)]\
\
##Make index age numeric\
full_con_10[, index_age := as.numeric(index_age)]\
mc2[, index_age := as.numeric(index_age)]\
\
final_mc <- rbind(mc2, full_con_10)\
setDT(final_mc)\
final_mc[,.N,by=person_id]\
final_mc[,.N,by=(gender_concept_id=='8532')]\
\
mc2[,.N,by=(gender_concept_id=='8532')]\
\
mc2[,.N,by=person_id]\
\
matched_controls_2gender2<- final_mc[,c(1,6)]\
matched_controls_2gender2 <- matched_controls_2gender2[!duplicated(matched_controls_2gender2), ]\
matched_controls_2gender2[,.N,by=(gender_concept_id=='8532')]\
\
mc_m2  = matched_controls_2gender2[!matched_controls_2gender2$gender_concept_id== 8532,]\
mc_f2 = matched_controls_2gender2[!matched_controls_2gender2$gender_concept_id== 8507,]\
\
write.csv(final_mc, "final_matched_controls.csv")\
\
\
\
##Incorrect matching in Match Total 15\
case15_m <- subset(case_pop_m, index_age >=4230 & index_age <4480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
case15_f <- subset(case_pop_f, index_age >=4230 & index_age <4480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
View(case15_m)\
View(case15_f)\
\
match_total15 = read.csv('~/match_total_15.csv')\
matched_cont= read.csv('~/final_matched_controls.csv')\
setDT(match_total15)\
setDT(matched_cont)\
mc3 <- matched_cont[!(person_id %in% match_total15$person_id)]\
mc3[,.N,by=person_id]\
match_total15[,.N,by=person_id]\
control_pop_f <- control_f_storage[!(person_id %in% mc3$person_id)]\
control_pop_m <- control_m_storage[!(person_id %in% mc3$person_id)]\
\
## 4230-4280 days old\
#males\
\
case71_m <- subset(case_pop_m, index_age >=4230 & index_age <4280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case71_m)\
control71_m <- subset(control_pop_m, index_age >=4220 & index_age<4290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control71_m)\
match_age71m <- rbind(case71_m, control71_m)\
setDT(match_age71m)\
\
m_age71m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age71m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age71m$factor\
m71 <- as.data.table(r)\
m71$ID2 <- seq.int(nrow(m71))\
\
match_full141 <- cbind(match_age71m, m71)\
match_full141 = match_full141[!match_full141$r== 'NA',]\
\
md_controls71m <- subset(match_full141, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases71m <- subset(match_full141, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases71m[,.N,by=person_id]\
md_controls71m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls141 <-md_controls71m[order(person_id)]\
md_controls141[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_71m <- subset(md_controls141, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_71m <- subset(md_controls141, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_71m2 <- multi_71m[,c(1,2,3,4)]\
multi_71m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full141$person_id)]\
\
##Rematch the used PIDs\
control71_m_d2 <- subset(control_pop_m, index_age >=4220 & index_age<4290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control71_m_d2)\
match_age71m_d2 <- rbind(multi_71m2, control71_m_d2)\
m_age71m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age71m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age71m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full141_d2 <- cbind(match_age71m_d2, r2)\
match_full141_d2 = match_full141_d2[!match_full141_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_71m <- unique_71m[,c(1,2,3,4,5,6,7)]\
match_full141_d3 <-rbind(unique_71m, match_full141_d2)\
match_full141_d3 <- subset(match_full141_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full141_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full141_d3$person_id)]\
\
#females\
case71_f <- subset(case_pop_f, index_age >=4230 & index_age <4280, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case71_f)\
control71_f <- subset(control_pop_f, index_age >=4220 & index_age<4290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control71_f)\
match_age71f <- rbind(case71_f, control71_f)\
setDT(match_age71f)\
\
m_age71f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age71f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age71f$factor\
f71 <- as.data.table(r)\
f71$ID2 <- seq.int(nrow(f71))\
\
match_full142 <- cbind(match_age71f, f71)\
match_full142 = match_full142[!match_full142$r== 'NA',]\
\
md_controls71f <- subset(match_full142, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases71f <- subset(match_full142, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases71f[,.N,by=person_id]\
md_controls71f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls142 <-md_controls71f[order(person_id)]\
md_controls142[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_71f <- subset(md_controls142, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_71f <- subset(md_controls142, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_71f2 <- multi_71f[,c(1,2,3,4)]\
multi_71f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full142$person_id)]\
\
##Rematch the used PIDs\
control71_f_d2 <- subset(control_pop_f, index_age >=4220 & index_age<4290, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control71_f_d2)\
match_age71f_d2 <- rbind(multi_71f2, control71_f_d2)\
m_age71f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age71f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age71f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full142_d2 <- cbind(match_age71f_d2, r2)\
match_full142_d2 = match_full142_d2[!match_full142_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_71f <- unique_71f[,c(1,2,3,4,5,6,7)]\
match_full142_d3 <-rbind(unique_71f, match_full142_d2)\
match_full142_d3 <- subset(match_full142_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full142_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full142_d3$person_id)]\
\
## 4280-4330 days old\
#males\
\
case72_m <- subset(case_pop_m, index_age >=4280 & index_age <4330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case72_m)\
control72_m <- subset(control_pop_m, index_age >=4270 & index_age<4340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control72_m)\
match_age72m <- rbind(case72_m, control72_m)\
setDT(match_age72m)\
\
m_age72m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age72m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age72m$factor\
m72 <- as.data.table(r)\
m72$ID2 <- seq.int(nrow(m72))\
\
match_full143 <- cbind(match_age72m, m72)\
match_full143 = match_full143[!match_full143$r== 'NA',]\
\
md_controls72m <- subset(match_full143, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases72m <- subset(match_full143, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases72m[,.N,by=person_id]\
md_controls72m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls143 <-md_controls72m[order(person_id)]\
md_controls143[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_72m <- subset(md_controls143, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_72m <- subset(md_controls143, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_72m2 <- multi_72m[,c(1,2,3,4)]\
multi_72m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full143$person_id)]\
\
##Rematch the used PIDs\
control72_m_d2 <- subset(control_pop_m, index_age >=4270 & index_age<4340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control72_m_d2)\
match_age72m_d2 <- rbind(multi_72m2, control72_m_d2)\
m_age72m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age72m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age72m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full143_d2 <- cbind(match_age72m_d2, r2)\
match_full143_d2 = match_full143_d2[!match_full143_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_72m <- unique_72m[,c(1,2,3,4,5,6,7)]\
match_full143_d3 <-rbind(unique_72m, match_full143_d2)\
match_full143_d3 <- subset(match_full143_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full143_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full143_d3$person_id)]\
\
#females\
case72_f <- subset(case_pop_f, index_age >=4280 & index_age <4330, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case72_f)\
control72_f <- subset(control_pop_f, index_age >=4270 & index_age<4340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control72_f)\
match_age72f <- rbind(case72_f, control72_f)\
setDT(match_age72f)\
\
m_age72f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age72f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age72f$factor\
f72 <- as.data.table(r)\
f72$ID2 <- seq.int(nrow(f72))\
\
match_full144 <- cbind(match_age72f, f72)\
match_full144 = match_full144[!match_full144$r== 'NA',]\
\
match_full144 <- cbind(match_age72f, f72)\
match_full144 = match_full144[!match_full144$r== 'NA',]\
\
md_controls72f <- subset(match_full144, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases72f <- subset(match_full144, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases72f[,.N,by=person_id]\
md_controls72f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls144 <-md_controls72f[order(person_id)]\
md_controls144[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_72f <- subset(md_controls144, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_72f <- subset(md_controls144, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_72f2 <- multi_72f[,c(1,2,3,4)]\
multi_72f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full144$person_id)]\
\
##Rematch the used PIDs\
control72_f_d2 <- subset(control_pop_f, index_age >=4270 & index_age<4340, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control72_f_d2)\
match_age72f_d2 <- rbind(multi_72f2, control72_f_d2)\
m_age72f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age72f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age72f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full144_d2 <- cbind(match_age72f_d2, r2)\
match_full144_d2 = match_full144_d2[!match_full144_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_72f <- unique_72f[,c(1,2,3,4,5,6,7)]\
match_full144_d3 <-rbind(unique_72f, match_full144_d2)\
match_full144_d3 <- subset(match_full144_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full144_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full144_d3$person_id)]\
\
## 4330-4380 days old\
#males\
\
case73_m <- subset(case_pop_m, index_age >=4330 & index_age <4380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case73_m)\
control73_m <- subset(control_pop_m, index_age >=4320 & index_age<4390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control73_m)\
match_age73m <- rbind(case73_m, control73_m)\
setDT(match_age73m)\
\
m_age73m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age73m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age73m$factor\
m73 <- as.data.table(r)\
m73$ID2 <- seq.int(nrow(m73))\
\
match_full145 <- cbind(match_age73m, m73)\
match_full145 = match_full145[!match_full145$r== 'NA',]\
\
md_controls73m <- subset(match_full145, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases73m <- subset(match_full145, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases73m[,.N,by=person_id]\
md_controls73m[,.N,by=person_id]\
\
control_pop_m <- control_pop_m[!(person_id %in% md_controls73m$person_id)]\
\
#females\
case73_f <- subset(case_pop_f, index_age >=4330 & index_age <4380, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case73_f)\
control73_f <- subset(control_pop_f, index_age >=4320 & index_age<4390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control73_f)\
match_age73f <- rbind(case73_f, control73_f)\
setDT(match_age73f)\
\
m_age73f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age73f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age73f$factor\
f73 <- as.data.table(r)\
f73$ID2 <- seq.int(nrow(f73))\
\
match_full146 <- cbind(match_age73f, f73)\
match_full146 = match_full146[!match_full146$r== 'NA',]\
\
md_controls73f <- subset(match_full146, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases73f <- subset(match_full146, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases73f[,.N,by=person_id]\
md_controls73f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls146 <-md_controls73f[order(person_id)]\
md_controls146[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_73f <- subset(md_controls146, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_73f <- subset(md_controls146, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_73f2 <- multi_73f[,c(1,2,3,4)]\
multi_73f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full146$person_id)]\
\
##Rematch the used PIDs\
control73_f_d2 <- subset(control_pop_f, index_age >=4320 & index_age<4390, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control73_f_d2)\
match_age73f_d2 <- rbind(multi_73f2, control73_f_d2)\
m_age73f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age73f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age73f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full146_d2 <- cbind(match_age73f_d2, r2)\
match_full146_d2 = match_full146_d2[!match_full146_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_73f <- unique_73f[,c(1,2,3,4,5,6,7)]\
match_full146_d3 <-rbind(unique_73f, match_full146_d2)\
match_full146_d3 <- subset(match_full146_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full146_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full146_d3$person_id)]\
\
## 4380-4430 days old\
#males\
\
case74_m <- subset(case_pop_m, index_age >=4380 & index_age <4430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case74_m)\
control74_m <- subset(control_pop_m, index_age >=4370 & index_age<4440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control74_m)\
match_age74m <- rbind(case74_m, control74_m)\
setDT(match_age74m)\
\
m_age74m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age74m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age74m$factor\
m74 <- as.data.table(r)\
m74$ID2 <- seq.int(nrow(m74))\
\
match_full147 <- cbind(match_age74m, m74)\
match_full147 = match_full147[!match_full147$r== 'NA',]\
\
md_controls74m <- subset(match_full147, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases74m <- subset(match_full147, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases74m[,.N,by=person_id]\
md_controls74m[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full147$person_id)]\
\
#Count the number of times each person ID was used\
md_controls147 <-md_controls74m[order(person_id)]\
md_controls147[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_74m <- subset(md_controls147, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_74m <- subset(md_controls147, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_74m2 <- multi_74m[,c(1,2,3,4)]\
multi_74m2$casecont = 'case'\
\
##Rematch the used PIDs\
control74_m_d2 <- subset(control_pop_m, index_age >=4370 & index_age<4440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control74_m_d2)\
match_age74m_d2 <- rbind(multi_74m2, control74_m_d2)\
m_age74m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age74m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age74m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full147_d2 <- cbind(match_age74m_d2, r2)\
match_full147_d2 = match_full147_d2[!match_full147_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_74m <- unique_74m[,c(1,2,3,4,5,6,7)]\
match_full147_d3 <-rbind(unique_74m, match_full147_d2)\
match_full147_d3 <- subset(match_full147_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full147_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full147_d3$person_id)]\
\
\
\
#females\
case74_f <- subset(case_pop_f, index_age >=4380 & index_age <4430, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case74_f)\
control74_f <- subset(control_pop_f, index_age >=4370 & index_age<4440, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control74_f)\
match_age74f <- rbind(case74_f, control74_f)\
setDT(match_age74f)\
\
m_age74f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age74f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age74f$factor\
f74 <- as.data.table(r)\
f74$ID2 <- seq.int(nrow(f74))\
\
match_full148 <- cbind(match_age74f, f74)\
match_full148 = match_full148[!match_full148$r== 'NA',]\
\
md_controls74f <- subset(match_full148, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases74f <- subset(match_full148, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases74f[,.N,by=person_id]\
md_controls74f[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% md_controls74f$person_id)]\
\
## 4430-4480 days old\
#males\
\
case75_m <- subset(case_pop_m, index_age >=4430 & index_age <4480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case75_m)\
control75_m <- subset(control_pop_m, index_age >=4420 & index_age<4490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control75_m)\
match_age75m <- rbind(case75_m, control75_m)\
setDT(match_age75m)\
\
m_age75m <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age75m, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age75m$factor\
m75 <- as.data.table(r)\
m75$ID2 <- seq.int(nrow(m75))\
\
match_full149 <- cbind(match_age75m, m75)\
match_full149 = match_full149[!match_full149$r== 'NA',]\
\
md_controls75m <- subset(match_full149, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases75m <- subset(match_full149, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases75m[,.N,by=person_id]\
md_controls75m[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls149 <-md_controls75m[order(person_id)]\
md_controls149[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_75m <- subset(md_controls149, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_75m <- subset(md_controls149, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_75m2 <- multi_75m[,c(1,2,3,4)]\
multi_75m2$casecont = 'case'\
\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full149$person_id)]\
\
##Rematch the used PIDs\
control75_m_d2 <- subset(control_pop_m, index_age >=4420 & index_age<4490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control75_m_d2)\
match_age75m_d2 <- rbind(multi_75m2, control75_m_d2)\
m_age75m_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age75m_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age75m_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full149_d2 <- cbind(match_age75m_d2, r2)\
match_full149_d2 = match_full149_d2[!match_full149_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_75m <- unique_75m[,c(1,2,3,4,5,6,7)]\
match_full149_d3 <-rbind(unique_75m, match_full149_d2)\
match_full149_d3 <- subset(match_full149_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full149_d3[,.N,by=person_id]\
#Remove the used control Person IDs\
control_pop_m <- control_pop_m[!(person_id %in% match_full149_d3$person_id)]\
\
#females\
case75_f <- subset(case_pop_f, index_age >=4430 & index_age <4480, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(case75_f)\
control75_f <- subset(control_pop_f, index_age >=4420 & index_age<4490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control75_f)\
match_age75f <- rbind(case75_f, control75_f)\
setDT(match_age75f)\
\
m_age75f <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age75f, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age75f$factor\
f75 <- as.data.table(r)\
f75$ID2 <- seq.int(nrow(f75))\
\
match_full150 <- cbind(match_age75f, f75)\
match_full150 = match_full150[!match_full150$r== 'NA',]\
\
md_controls75f <- subset(match_full150, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
md_cases75f <- subset(match_full150, casecont== 'case', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
md_cases75f[,.N,by=person_id]\
md_controls75f[,.N,by=person_id]\
\
#Count the number of times each person ID was used\
md_controls150 <-md_controls75f[order(person_id)]\
md_controls150[, num_matches := seq(1, nrow(.SD)) - 1, by = person_id]\
\
multi_75f <- subset(md_controls150, num_matches >0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
unique_75f <- subset(md_controls150, num_matches==0, select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2, num_matches))\
\
multi_75f2 <- multi_75f[,c(1,2,3,4)]\
multi_75f2$casecont = 'case'\
\
#Eliminate controls already matched from full control pool\
control_pop_f <- control_pop_f[!(person_id %in% match_full150$person_id)]\
\
##Rematch the used PIDs\
control75_f_d2 <- subset(control_pop_f, index_age >=4420 & index_age<4490, select=c(person_id, gender, index_age, num_of_prior_visits, casecont))\
setDT(control75_f_d2)\
match_age75f_d2 <- rbind(multi_75f2, control75_f_d2)\
m_age75f_d2 <- matchControls(casecont ~ index_age + num_of_prior_visits, match_age75f_d2, contlabel = "cont", caselabel = "case", replace = FALSE)\
r <- m_age75f_d2$factor\
r2 <- as.data.table(r)\
r2$ID2 <- seq.int(nrow(r2))\
\
match_full150_d2 <- cbind(match_age75f_d2, r2)\
match_full150_d2 = match_full150_d2[!match_full150_d2$r== 'NA',]\
\
##Combine the two sets of controls\
unique_75f <- unique_75f[,c(1,2,3,4,5,6,7)]\
match_full150_d3 <-rbind(unique_75f, match_full150_d2)\
match_full150_d3 <- subset(match_full150_d3, casecont== 'cont', select=c(person_id, gender, index_age, num_of_prior_visits, casecont, r, ID2))\
\
match_full150_d3[,.N,by=person_id]\
\
#Remove the used control Person IDs\
control_pop_f <- control_pop_f[!(person_id %in% match_full150_d3$person_id)]\
\
\
##combine all matched data: round 15\
\
colnames(match_full141_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full142_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full143_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full144_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls73m) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full146_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full147_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(md_controls74f) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full149_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
colnames(match_full150_d3) <- c("person_id","gender", "index_age", "num_of_prior_visits", "casecont", "r", "ID")\
\
match_total_15 <- rbind(match_full141_d3,  match_full142_d3, match_full143_d3, match_full144_d3, md_controls73m, match_full146_d3, match_full147_d3, md_controls74f, match_full149_d3, match_full150_d3)\
setDT(match_total_15)\
\
match_total_15[,.N,by=person_id]\
write.csv(match_total_15, "2match_total_15.csv")\
\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
setkeyv(match_total_15,  c("person_id","num_of_prior_visits"))\
\
mt15_matched_measures3= f[match_total_15]\
mt15_matched_measures4 <- mt15_matched_measures3[,c(1,2,3,4,5,6)]\
setDT(mt15_matched_measures4)\
\
setkeyv(mt15_matched_measures4,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt15_control_conditions= conditions2[mt15_matched_measures4]\
\
mt15_control_conditions[,.N,by=person_id]\
\
## Work on obtaining the pre- and post-index visits for the matched controls\
#Pre index\
mt15_cont_pre_index <- match_total_15[,c(1,4)]\
mt15_cont_pre_index$pre <- mt15_cont_pre_index[, 2] -1\
mt15_cont_pre_index2 <- mt15_cont_pre_index[,c(1,3)]\
colnames(mt15_cont_pre_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt15_cont_pre_index2)\
setkeyv(mt15_cont_pre_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt15_matched_pre_measures= f[mt15_cont_pre_index2]\
\
mt15_matched_pre_measures2 <- mt15_matched_pre_measures[,c(1,2,3,4,5,6)]\
setDT(mt15_matched_pre_measures2)\
\
setkeyv(mt15_matched_pre_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt15_control_conditions_pre= conditions2[mt15_matched_pre_measures2]\
\
mt15_control_conditions_pre[,.N,by=person_id]\
\
#Post index\
mt15_cont_post_index <- match_total_15[,c(1,4)]\
mt15_cont_post_index$post <- mt15_cont_pre_index[, 2] +1\
mt15_cont_post_index2 <- mt15_cont_post_index[,c(1,3)]\
colnames(mt15_cont_post_index2) <- c("person_id", "num_of_prior_visits")\
setDT(mt15_cont_post_index2)\
setkeyv(mt15_cont_post_index2,  c("person_id","num_of_prior_visits"))\
setkeyv(f,  c("person_id","num_of_prior_visits"))\
\
mt15_matched_post_measures= f[mt15_cont_post_index2]\
\
mt15_matched_post_measures2 <- mt15_matched_post_measures[,c(1,2,3,4,5,6)]\
setDT(mt15_matched_post_measures2)\
\
setkeyv(mt15_matched_post_measures2,  c("person_id","condition_start_date"))\
setkeyv(conditions2,  c("person_id","condition_start_date"))\
\
mt15_control_conditions_post= conditions2[mt15_matched_post_measures2]\
\
mt15_control_conditions_post[,.N,by=person_id]\
\
##Eliminate patients who did not have a post-index visit\
mt15_control_conditions_post= mt15_control_conditions_post[!mt15_control_conditions_post$index_age=='NA',]\
\
##Add the Timing Class label to each data frame indicating "pre" "index" or "post" (in the same way as with the cases)\
mt15_control_conditions_post$Timing_Class = '3'\
mt15_control_conditions_pre$Timing_Class = '1'\
mt15_control_conditions$Timing_Class = '2'\
\
#Combine all clinical observations from the 13th set\
full_con_15 <- rbind(mt15_control_conditions_pre, mt15_control_conditions, mt15_control_conditions_post)\
setDT(full_con_15)\
full_con_15[,.N,by=person_id]\
\
#Select correct columns \
\
mc3 <- mc3[,c(2,3,4,5,6,7,8,9,10,11)]\
\
##Make index age numeric\
full_con_15[, index_age := as.numeric(index_age)]\
mc3[, index_age := as.numeric(index_age)]\
\
#R bind the two DTs\
matches_final_cont <- rbind(mc3, full_con_15)\
setDT(matches_final_cont)\
matches_final_cont[,.N,by=person_id]\
\
match_total_15[,.N,by=(gender=='8532')]\
View(matches_final_cont)\
matches_gender <- matches_final_cont[,c(1,6)]\
matches_gender <- matches_gender[!duplicated(matches_gender ), ]\
setDT(matches_gender)\
matches_gender[,.N,by=(gender_concept_id=='8532')]\
\
\
write.csv(matches_final_cont, 'final_matched_controls2.csv')\
}